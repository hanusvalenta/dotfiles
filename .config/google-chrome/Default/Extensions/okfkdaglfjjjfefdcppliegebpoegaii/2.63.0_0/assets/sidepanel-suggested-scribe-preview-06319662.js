import"./modulepreload-polyfill-3cfb730f.js";import{j as i,c as Q}from"./Icon-f3e43e02.js";import{r as l,R as tt}from"./index-8b3efc3f.js";import{c as it}from"./client-2e7161fd.js";import{u as Ae,P as st}from"./react-redux-52a3bd12.js";import"./useToast-35be614d.js";import{T as rt}from"./Toaster-4f59bb56.js";import{w as at,x as nt,z as Y,C as L,m as O,D as De,F as ot,G as ct,H as lt,I as dt,s as mt}from"./store-f163b43d.js";import{p as ut}from"./production-ca86ce5a.js";import{i as ht,j as pt,k as We,l as gt}from"./index-eeca2896.js";import{B as ft,t as _t,g as wt}from"./Badge-4b362304.js";import{D as bt}from"./DocumentIcon-1c27b6c5.js";import{D as xt,a as Le}from"./dwEvents-216a2e01.js";import{u as yt}from"./useBackgroundReduxState-bd3d6a86.js";import{u as vt}from"./useDWDiscardFeedback-50aef435.js";import{g as jt,i as Oe,h as Fe}from"./dwResultsDB-a3d52d5f.js";import{g as ge,p as kt}from"./dwScreenshotsDB-956b9f9a.js";import{l as Pe}from"./dw-telemetry-83cc94a3.js";import{B as le}from"./Button-97d280d1.js";import{T as St}from"./Toolbar-58c4db6f.js";import"./_commonjsHelpers-de833af9.js";import"./index-3744168d.js";import"./index-3e4171d5.js";import"./index-9279c646.js";import"./index-0b89f2da.js";import"./index-025f2019.js";import"./v4-c70744d4.js";import"./index-e309a1d1.js";import"./TextArea-cc3d5eef.js";import"./index-50993b56.js";import"./index-24f6db5b.js";import"./appTagUtils-f127d137.js";const Nt="FB923C",qe=(a,r)=>{const m=Math.floor(r*255).toString(16).padStart(2,"0");return`${a}${m}`},Et=({x:a,y:r,color:m,animate:x})=>{const f=m||Nt;return i.jsx("div",{"data-testid":"action-click-target",className:Q("pointer-events-none absolute left-0 top-0 size-11 overflow-hidden rounded-full border-2 transition-transform duration-300 will-change-[translate] group-hover:scale-125",x?"transition-[translate,transform]":"transition-transform"),style:{translate:`calc(-50% + ${a}px) calc(-50% + ${r}px)`,borderColor:qe(`#${f}`,.75),backgroundColor:qe(`#${f}`,.5)}})},It=.3,Mt=1.5,je=.1,Ct=({scale:a,minScale:r=It,maxScale:m=Mt,onChange:x,className:f})=>{const e=u=>Math.round(u*10)/10,V=l.useCallback(u=>D=>{D.stopPropagation();const w=a+(u==="in"?je:-je),F=e(w),p=F<r&&r||F>m&&m||F;(u==="in"&&F<=m||u==="out"&&F>=r)&&x(p)},[a,r,m,x]);return i.jsxs("div",{className:Q("flex flex-col space-y-1 absolute bottom-2 right-2 z-1 bg-slate-800 bg-opacity-30 backdrop-blur-sm rounded-full p-1.5",f),children:[i.jsx(le,{className:Q("flex items-center justify-center w-7 h-7 text-white rounded-full",a+je>m?"opacity-50 cursor-not-allowed":"hover:bg-slate-700/50"),onClick:V("in"),disabled:a+je>m,title:"Zoom in",icon:ht,variant:"ghost",size:"small"}),i.jsx(le,{className:Q("flex items-center justify-center w-7 h-7 text-white rounded-full",a<=r?"opacity-50 cursor-not-allowed":"hover:bg-slate-700/50"),onClick:V("out"),disabled:a<=r,title:"Zoom out",icon:pt,variant:"ghost",size:"small"})]})},Rt=.7,ze=.3,$e=1.5,ke=a=>a&&typeof a=="object"&&"x"in a&&"y"in a&&typeof a.x=="number"&&typeof a.y=="number",He=({screenshot:a,clickPosition:r,altText:m="",className:x})=>{var we,be;const f=l.useRef(null),[e,V]=l.useState(!1),[u,D]=l.useState({x:0,y:0}),[w,F]=l.useState(Rt),[p,se]=l.useState({width:0,height:0}),[A,de]=l.useState(!1),[fe,re]=l.useState(window.devicePixelRatio||1),me=l.useRef(!1);l.useEffect(()=>{const n=()=>{re(window.devicePixelRatio||1)},_=window.matchMedia(`(resolution: ${window.devicePixelRatio}dppx)`);return _.addEventListener("change",n),()=>{_.removeEventListener("change",n)}},[]),l.useEffect(()=>{const n=()=>{D(_=>({..._}))};return window.addEventListener("resize",n),()=>window.removeEventListener("resize",n)},[]);const $=((we=f.current)==null?void 0:we.clientWidth)||0,M=((be=f.current)==null?void 0:be.clientHeight)||0,_e=p.width&&p.height?Math.max($/p.width,M/p.height):0,ee=Math.max(ze,_e||0),Se=p.width*w>$,Ne=p.height*w>M,ue=Se||Ne,P=l.useCallback((n,_)=>{const j=p.width*n,k=p.height*n,W=$-j,Z=M-k,ne=j>$?W/2:0,xe=k>M?Z/2:0;return{x:Math.min(Math.max(_.x,ne),-ne),y:Math.min(Math.max(_.y,xe),-xe)}},[p,$,M]);l.useEffect(()=>{A&&D(n=>P(w,n))},[A,P,w]),l.useCallback(()=>{if(ke(r)){const n=p.width/2,_=p.height/2,j=r.x,k=r.y;return{x:(n-j)*w,y:(_-k)*w}}return u},[r,p,w,u]);const ae=l.useCallback(n=>{if(!ue||n.button!==0)return;n.preventDefault(),V(!0);const _=n.clientX-u.x,j=n.clientY-u.y,k=Z=>{const ne=P(w,{x:Z.clientX-_,y:Z.clientY-j});D(ne)},W=()=>{V(!1),document.removeEventListener("mousemove",k),document.removeEventListener("mouseup",W)};document.addEventListener("mousemove",k),document.addEventListener("mouseup",W)},[ue,u,P]),B=r&&A?{x:r.x*w+u.x+($-p.width*w)/2,y:r.y*w+u.y+(M-p.height*w)/2}:null,Ee=n=>{const _=n.currentTarget,{naturalWidth:j}=_,{naturalHeight:k}=_;se({width:j,height:k}),de(!0)},T=l.useCallback(n=>{const _=n/w;if(ke(r)){const j=p.width/2,k=p.height/2,W=(j-r.x)*n,Z=(k-r.y)*n;D(P(n,{x:W,y:Z}))}else{const j=u.x*_,k=u.y*_;D(P(n,{x:j,y:k}))}F(n)},[r,p.height,p.width,P,w,u]);return l.useEffect(()=>{if(!(!A||p.width===0||p.height===0)){if(!me.current&&$>0&&M>0){const n=Math.min(Math.max(ee,ze),$e);if(ke(r)){const _=p.width/2,j=p.height/2,k=(_-r.x)*n,W=(j-r.y)*n;D(P(n,{x:k,y:W}))}else D(P(n,{x:0,y:0}));F(n),me.current=!0;return}if(w<ee){const n=Math.min(Math.max(ee,ze),$e);if(ke(r)){const _=p.width/2,j=p.height/2,k=(_-r.x)*n,W=(j-r.y)*n;D(P(n,{x:k,y:W}))}else{const _=n/w,j=u.x*_,k=u.y*_;D(P(n,{x:j,y:k}))}F(n)}else D(n=>P(w,n))}},[$,M,p.width,p.height,A,w,r,P,u.x,u.y,ee]),i.jsxs("div",{ref:f,className:Q("relative flex items-center justify-center overflow-hidden rounded-lg group",x),style:{height:"100%",width:"100%"},children:[i.jsxs("div",{className:"relative flex items-center justify-center bg-slate-100 h-full w-full",children:[a&&i.jsx("img",{src:a,alt:m,className:Q("select-none transition-opacity duration-300 max-w-none",!e&&"transition-[translate,scale] will-change-[translate,scale]",ue?e?"cursor-grabbing":"cursor-grab":"cursor-default"),style:{translate:`${u.x}px ${u.y}px`,scale:`${w}`,opacity:A?1:0},onMouseDown:ae,onLoad:Ee}),B&&A&&i.jsx(Et,{x:B.x,y:B.y,animate:!e}),A&&i.jsx(Ct,{scale:w,minScale:ee,maxScale:$e,onChange:T})]}),i.jsx("div",{className:"pointer-events-none absolute inset-0 rounded-lg shadow-inner"})]})},Te=({onBack:a,children:r,totalScribes:m,className:x})=>i.jsxs("div",{className:Q("flex flex-col h-screen pt-4",x),children:[i.jsx(St,{className:"px-4",onVisitWorkspaceDocuments:()=>{},onGoToOptionsPage:()=>{},onBack:a,showTeamSelector:!1,showHomeIcon:!1,showSettingsIcon:!1,centerContent:i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsx("h4",{className:"text-md font-semibold m-0",children:"Discovered Workflow"}),typeof m=="number"&&m>0&&i.jsx(ft,{children:m})]})}),r]}),ie=a=>{var m,x;if(!a)return"";const r=(x=(m=a==null?void 0:a.actions)==null?void 0:m[0])==null?void 0:x.url;if(r)try{return new URL(r).hostname.replace(/^www\./,"")}catch{}return""};function Dt(a){var x,f,e;const r=(f=(x=a==null?void 0:a.active_organization)==null?void 0:x.super_organization)==null?void 0:f.id,m=(e=a==null?void 0:a.active_organization)==null?void 0:e.id;return!r||!m?null:`${r}|${m}`}function Ke(a){if(a!=null){if(typeof a=="number")return a<2e12?a*1e3:a;if(typeof a=="string"){const r=a.trim();if(/^\d+$/.test(r)){const x=Number(r);return x<2e12?x*1e3:x}const m=Date.parse(r);return Number.isNaN(m)?void 0:m}}}const Pt=688,zt=384;function Ye(a){try{const r=Number(a==null?void 0:a.width),m=Number(a==null?void 0:a.height);if(!r||!m)return;const x=Pt/r,f=zt/m;return Math.max(x,f)*1.08}catch{return}}const $t=()=>{yt();const{shouldShowFeedback:a}=vt(),{userData:r}=Ae(at),m=Ae(nt),x=!!((m==null?void 0:m.lrr2025)??(m==null?void 0:m.lrr_2025)),f=l.useMemo(()=>Dt(r),[r]),[e,V]=l.useState(null),[u,D]=l.useState([]),[w,F]=l.useState([]),[p,se]=l.useState(!0),[A,de]=l.useState(!1),[fe,re]=l.useState(!1),[me,$]=l.useState(null),[M,_e]=l.useState(new Set),[ee,Se]=l.useState(null),[Ne,ue]=l.useState(""),[P,ae]=l.useState(!1),[B,Ee]=l.useState(0),[T,we]=l.useState(0);l.useEffect(()=>{const s=()=>{try{chrome.runtime.sendMessage({messageType:"getDWOptimizeState"},async v=>{chrome.runtime.lastError||v!=null&&v.isOptimizeConfigured&&await L(O.Home)})}catch{}};s();const h=v=>{(v==null?void 0:v.messageType)==="optionsChanged"&&s()};try{chrome.runtime.onMessage.addListener(h)}catch{}return()=>{try{chrome.runtime.onMessage.removeListener(h)}catch{}}},[]);const be=l.useRef(null),n=l.useRef(!1),_=l.useCallback(async s=>{var h;try{if(se(!0),!x)throw new Error("DW disabled");if(!f)throw new Error("Missing org context");const v=(h=await jt(f))==null?void 0:h.payload,S=(Array.isArray(v==null?void 0:v.scribes)?v.scribes:[]).find(o=>(o==null?void 0:o.suggestion_id)===s||(o==null?void 0:o.id)===s)||null;if(!S)throw new Error("Scribe not found");V(S),ue((S==null?void 0:S.description)||"");const U=[];for(const o of S.actions||[]){if(!(typeof(o==null?void 0:o.id)=="string"&&o.id.startsWith("stack_"))){const y=await ge(o.id),C=(o.description||o.current_description||o.short_description||"").trim()||(o.kind==="keyboard_sequence_action"?"Type here":o.kind||"Action");if(U.push({id:o.id,description:C,screenshot:y||void 0,type:o.type,kind:o.kind,url:o.url||"",position:o.position||void 0,has_screenshot:!!y}),!y)try{Pe("DW.Data.ScreenshotMissing",{actionId:o.id})}catch{}continue}const q=Array.isArray(o==null?void 0:o.actions)?o.actions:[];let oe;for(const y of q)typeof(y==null?void 0:y.stack_short_description)=="string"&&y.stack_short_description.trim()?oe=y.stack_short_description.trim():typeof(y==null?void 0:y.stack_description)=="string"&&y.stack_description.trim()&&(oe=y.stack_description.trim());let N=null,G=null;for(let y=q.length-1;y>=0;y-=1){const C=q[y],J=await ge(C==null?void 0:C.id);if(J){N=C,G=J;break}}!N&&q.length>0&&(N=q[q.length-1]);let H;for(let y=q.length-1;y>=0;y-=1){const C=q[y],J=((C==null?void 0:C.description)||(C==null?void 0:C.current_description)||"").trim();if(J){H=J;break}}const ye=oe&&oe.trim()||N&&(N.description||N.current_description)||H||"No description available";if(G)try{await kt(o.id,G)}catch{}else try{Pe("DW.Data.ScreenshotMissing",{actionId:o.id})}catch{}U.push({id:o.id,description:ye,screenshot:G||void 0,type:(N==null?void 0:N.type)||o.type,kind:(N==null?void 0:N.kind)||o.kind,url:(N==null?void 0:N.url)||o.url||"",position:(N==null?void 0:N.position)||void 0,has_screenshot:!!G})}D(U),F(U),_e(new Set),Y("suggested_scribe_loaded",{location:"sidepanel_suggested_scribe_preview",scribe_id:s,scribe_title:S==null?void 0:S.title,scribe_domain:ie(S),total_steps:U.length,remaining_scribes:T,has_screenshots:U.some(o=>o.screenshot),screenshot_count:U.filter(o=>o.screenshot).length}),await chrome.storage.local.set({previewScribeId:s});const he=new URLSearchParams(window.location.search);he.set("id",s),window.history.replaceState(null,"",`${window.location.pathname}?${he}`)}catch(v){const S=v instanceof Error?v.message:String(v);Y("suggested_scribe_load_failed",{location:"sidepanel_suggested_scribe_preview",scribe_id:s,error_message:S||"Unknown error occurred",remaining_scribes:T}),Se(s),$("An error occurred. Please go back.")}finally{se(!1)}},[x,f,T]);l.useEffect(()=>{if(!x||!f){se(!1);return}(async()=>{let s=new URLSearchParams(window.location.search).get("id");if(s||(s=(await chrome.storage.local.get(["previewScribeId"])).previewScribeId),s){try{if(f&&await Oe(f,s)){await chrome.storage.local.remove(["previewScribeId"]),await L(O.RecommendedScribes);return}}catch{}_(s)}else $("No scribe ID provided"),se(!1)})()},[_,x,f]),l.useEffect(()=>{const s=async h=>{if((h==null?void 0:h.messageType)==="dwHiddenUpdated")try{if(!f)return;const v=new URLSearchParams(window.location.search),S=await chrome.storage.local.get(["previewScribeId"]),U=v.get("id")||S.previewScribeId;if(!U)return;await Oe(f,U)&&(await chrome.storage.local.remove(["previewScribeId"]),await L(O.RecommendedScribes))}catch{}};try{chrome.runtime.onMessage.addListener(s)}catch{}return()=>{try{chrome.runtime.onMessage.removeListener(s)}catch{}}},[f]),l.useEffect(()=>{chrome.storage.local.get(["totalSuggestedScribes"]).then(s=>{Ee(s.totalSuggestedScribes||0)})},[]),l.useEffect(()=>{chrome.storage.local.get(["suggestedScribes","rejectionCount"]).then(s=>{we(s.suggestedScribes||0)})},[]);const j=async()=>{if(Y("suggested_scribe_preview_back_clicked",{location:"sidepanel_suggested_scribe_preview",scribe_id:e==null?void 0:e.id,scribe_title:e==null?void 0:e.title,scribe_domain:e==null?void 0:e.domain,total_steps:w.length,remaining_steps:u.length,deleted_steps_count:M.size,remaining_scribes:T}),me&&ee){await chrome.storage.local.remove(["previewScribeId"]),await L(O.RecommendedScribes);return}await chrome.storage.local.remove(["previewScribeId"]),T===1?await L(O.Home):await L(O.RecommendedScribes)},k=s=>{const h=u.find(S=>S.id===s);Y("suggested_scribe_step_deleted",{location:"sidepanel_suggested_scribe_preview",scribe_id:e==null?void 0:e.id,scribe_title:e==null?void 0:e.title,scribe_domain:e==null?void 0:e.domain,step_id:s,step_description:h==null?void 0:h.description,step_type:h==null?void 0:h.type,step_kind:h==null?void 0:h.kind,steps_remaining_after_delete:u.length-1,total_deleted_steps:M.size+1});const v=new Set(M);v.add(s),_e(v),D(u.filter(S=>S.id!==s))},W=async(s,h)=>{n.current=!0,Y(Le.REJECTION_FEEDBACK_SUBMITTED,{location:"sidepanel_suggested_scribe_preview",selected_reasons:s,reason_count:s.length,has_additional_feedback:!!h,additional_feedback_length:(h==null?void 0:h.length)||0}),await chrome.storage.local.set({showFeedbackToast:!0}),ae(!1),await chrome.storage.local.remove(["previewScribeId"]),await L(O.RecommendedScribes)},Z=async()=>{n.current=!0,Y(Le.REJECTION_FEEDBACK_SKIPPED,{location:"sidepanel_suggested_scribe_preview"}),ae(!1),await chrome.storage.local.remove(["previewScribeId"]),await L(O.RecommendedScribes)},ne=async s=>{ae(s),!s&&!n.current&&(await chrome.storage.local.remove(["previewScribeId"]),await L(O.RecommendedScribes)),s||(n.current=!1)},xe=async()=>{var s,h,v,S,U,he;if(e){Y("add_auto_captured_scribe_clicked",{location:"extension",document_id:e.id,scribe_title:e.title,scribe_domain:e.domain,original_steps_count:w.length,final_steps_count:u.length,deleted_steps_count:M.size,remaining_scribes_after_accept:T-1,progress_percentage:B>1?(B-T+1)/B*100:0});try{de(!0);const o=u.filter(c=>!M.has(c.id)),q=c=>new Promise((t,g)=>{const b=new FileReader;b.onloadend=()=>t(typeof b.result=="string"?b.result:""),b.onerror=()=>g(b.error),b.readAsDataURL(c)}),oe=async c=>{const t=async g=>{if(g instanceof Blob)return g;if(typeof g=="string"){if(g.startsWith("data:"))return(await fetch(g)).blob();try{const b=atob(g),E=b.length,R=new Uint8Array(E);for(let z=0;z<E;z++)R[z]=b.charCodeAt(z);return new Blob([R],{type:"image/png"})}catch{return new Blob([])}}return new Blob([])};try{const g=await t(c),b=await createImageBitmap(g),E=new OffscreenCanvas(Math.max(1,b.width),Math.max(1,b.height)),R=E.getContext("2d");R&&R.drawImage(b,0,0);const z=await E.convertToBlob({type:"image/jpeg",quality:1});return(await q(z)).split(",")[1]||""}catch{return(await q(await t(c))).split(",")[1]||""}},N=async c=>{const t=async g=>{if(g instanceof Blob)return g;if(typeof g=="string"){if(g.startsWith("data:"))return(await fetch(g)).blob();try{const b=atob(g),E=b.length,R=new Uint8Array(E);for(let z=0;z<E;z++)R[z]=b.charCodeAt(z);return new Blob([R],{type:"image/png"})}catch{return new Blob([])}}return new Blob([])};try{const g=await t(c),b=await createImageBitmap(g),E=new OffscreenCanvas(Math.max(1,b.width),Math.max(1,b.height)),R=E.getContext("2d");return R&&R.drawImage(b,0,0),await E.convertToBlob({type:"image/jpeg",quality:1})}catch{const g=await t(c);return g.type==="image/jpeg"?g:new Blob([g],{type:"image/jpeg"})}},G=async c=>{var b;if(!c)return null;const t=!!((b=r==null?void 0:r.active_organization)!=null&&b.smart_privacy_screen_enabled),g=(r==null?void 0:r.email)||null;try{if(t){const ce=await oe(c),te=await De.post("/sps/",{name:"screenshot",needs_redaction:"True",image_data:ce,email:g}),{uploaded_file:Me}=te.data||{};return{screenshot:Me}}const E=await De.post("/signed_urls/",{name:"a screenshot"}),{upload_url:R,internal_url:z,download_url:Ie}=E.data||{},pe=await N(c);return await ot(R,pe,"image/jpeg",{timeout:6e4}),{screenshot_url:z,download_url:Ie}}catch{return null}},H=[],ye=c=>{if(!c)return"instruction";const t=String(c).toLowerCase();return t==="mouse_click_action"||t==="keyboard_action"||t==="keyboard_sequence_action"||t==="keyboard_combination_action"||t==="instruction"?t:t.includes("click")?"mouse_click_action":t.includes("keyboard_sequence")?"keyboard_sequence_action":t.includes("keyboard_combination")?"keyboard_combination_action":t.includes("keyboard")?"keyboard_action":t};for(const c of o){if(!(typeof c.id=="string"&&c.id.startsWith("stack_"))){const{screenshot:I,id:X,kind:Ze,description:Ge,url:Je,position:Qe}=c,Ve=await G(I),Ce=ye(Ze),Ue=Ce==="mouse_click_action",ve=Ce.startsWith("keyboard_"),d=Array.isArray(e==null?void 0:e.actions)?e.actions.find(Re=>(Re==null?void 0:Re.id)===X):void 0;if(!d)try{Pe("DW.Data.ActionIdMismatch",{actionId:X})}catch{}const et={kind:Ce,description:Ge,url:Je||(d==null?void 0:d.url)||"",timestamp:Ke(d==null?void 0:d.timestamp),target_xpath:(d==null?void 0:d.target_xpath)||void 0,position:Ue||ve?Qe||(d==null?void 0:d.position):void 0,devicePixelRatio:d==null?void 0:d.devicePixelRatio,viewport:d==null?void 0:d.viewport,scrollPosition:d==null?void 0:d.scrollPosition,default_scale_factor:ve?Ye(d==null?void 0:d.viewport):void 0,button:d==null?void 0:d.button,click_count:d==null?void 0:d.click_count,show_position_indicator:Ue?!0:void 0,keys:ve?d==null?void 0:d.keys:void 0,count:ve?d==null?void 0:d.count:void 0,...Ve||{},tempId:X};H.push(et);continue}let t=null,g;const b=await ge(c.id),E=(s=e==null?void 0:e.actions)==null?void 0:s.find(I=>(I==null?void 0:I.id)===c.id),R=Array.isArray(E==null?void 0:E.actions)?E.actions:[];for(const I of R)if((I==null?void 0:I.kind)==="click"){const X=await ge(I.id);if(X){t=I,g=X;break}}if(!t)for(const I of R){const X=await ge(I.id);if(X){t=I,g=X;break}}if(!t&&b&&(g=b,t={kind:c.kind,url:c.url,position:c.position}),!t&&!c.description)continue;const z=await G(g),Ie=(((v=(h=e==null?void 0:e.actions)==null?void 0:h.find(I=>(I==null?void 0:I.id)===c.id))==null?void 0:v.description)||c.description||(t==null?void 0:t.description)||(t==null?void 0:t.current_description)||"").trim(),pe=ye(t==null?void 0:t.kind),ce=pe==="mouse_click_action",te=pe.startsWith("keyboard_"),Me={url:(t==null?void 0:t.url)||c.url||"",timestamp:Ke(t==null?void 0:t.timestamp),target_xpath:(t==null?void 0:t.target_xpath)||void 0,position:ce||te?t==null?void 0:t.position:void 0,kind:ce?"mouse_click_action":te?pe:"instruction",devicePixelRatio:t==null?void 0:t.devicePixelRatio,viewport:t==null?void 0:t.viewport,scrollPosition:t==null?void 0:t.scrollPosition,default_scale_factor:te?Ye(t==null?void 0:t.viewport):void 0,button:t==null?void 0:t.button,click_count:t==null?void 0:t.click_count,show_position_indicator:ce?!0:void 0,keys:te?t==null?void 0:t.keys:void 0,count:te?t==null?void 0:t.count:void 0,description:Ie||(ce&&(t!=null&&t.url)?`Navigate to ${t.url}`:"Instruction"),...z||{},tempId:c.id};H.push(Me)}if(H.length>0&&H[0].kind!=="instruction"){const c=H.find(t=>!!t.url)||H[0];H.unshift({kind:"instruction",description:c.url?`Navigate to ${c.url}`:"Start",url:c.url,tempId:`instr_${Date.now()}`})}const y=(S=r==null?void 0:r.active_organization)==null?void 0:S.id;if(!y)throw new Error("No active organization found");const C={name:e.title,actions:H,recorder_type:"web",recorder_os:ct(),created_with_copilot:!1,create_with_id:!0,id:crypto!=null&&crypto.randomUUID?crypto.randomUUID():`${Date.now()}`,entry_point:"extension",insert_before_action:null,organization_id:y,task_id:"",transcribed_audio:null,capture_type:lt.ExtensionAutoCapture},J=Ne||e.description;J&&(C.description=J);const K=await De.post("/scribe_file/",C);if(!(K!=null&&K.status)||!(K.status>=200&&K.status<300))throw new Error("Failed to create scribe");Y("suggested_scribe_created_successfully",{location:"sidepanel_suggested_scribe_preview",scribe_id:e==null?void 0:e.suggestion_id,scribe_title:e==null?void 0:e.title,scribe_domain:ie(e)});try{const c=(e==null?void 0:e.suggestion_id)||(e==null?void 0:e.id);f&&c&&await Fe(f,c)}catch{}try{const c=(U=K==null?void 0:K.data)==null?void 0:U.id,t=(he=K==null?void 0:K.data)==null?void 0:he.name;c&&t&&chrome.tabs.create({url:dt(c,t)})}catch{}try{chrome.runtime.sendMessage({messageType:"dwHiddenUpdated"})}catch{}await chrome.storage.local.remove(["previewScribeId"]),T<=1?await L(O.Home):await L(O.RecommendedScribes),de(!1)}catch(o){Y("suggested_scribe_accept_failed",{location:"sidepanel_suggested_scribe_preview",scribe_id:e==null?void 0:e.suggestion_id,scribe_title:e==null?void 0:e.title,scribe_domain:ie(e),error_message:o instanceof Error?o.message:"Unknown error",final_steps_count:u.length,deleted_steps_count:M.size}),$(o instanceof Error?o.message:"Unknown error occurred"),de(!1)}}},Xe=async()=>{if(e){Y("auto_captured_scribe_clicked",{location:"extension",document_id:e.id,scribe_title:e.title,scribe_domain:e.domain,original_steps_count:w.length,final_steps_count:u.length,deleted_steps_count:M.size,remaining_scribes_after_reject:T-1,progress_percentage:B>1?(B-T+1)/B*100:0});try{re(!0);try{const s=(e==null?void 0:e.suggestion_id)||(e==null?void 0:e.id);f&&s&&await Fe(f,s)}catch{}try{chrome.runtime.sendMessage({messageType:"dwHiddenUpdated"})}catch{}await a()?(ae(!0),re(!1)):(await chrome.storage.local.remove(["previewScribeId"]),await L(O.RecommendedScribes),re(!1))}catch(s){Y("suggested_scribe_reject_failed",{location:"sidepanel_suggested_scribe_preview",scribe_id:e==null?void 0:e.suggestion_id,scribe_title:e==null?void 0:e.title,scribe_domain:ie(e),error_message:s instanceof Error?s.message:"Unknown error",final_steps_count:u.length,deleted_steps_count:M.size}),$(s instanceof Error?s.message:"Unknown error occurred"),re(!1)}}};return p?i.jsx(Te,{onBack:j,children:i.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center",children:[i.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-slate-800 mb-6"}),i.jsx("p",{className:"text-base text-slate-600",children:"Loading scribe preview..."})]})}):me?i.jsx(Te,{onBack:j,children:i.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center p-6",children:[i.jsx("div",{className:"text-center text-slate-700",children:i.jsx("p",{className:"text-base font-medium",children:"An error occurred. Please go back."})}),i.jsx(le,{variant:"secondary",onClick:j,className:"mt-4",children:"Back to Suggestions"})]})}):i.jsxs(i.Fragment,{children:[i.jsx(Te,{onBack:j,totalScribes:T,className:"bg-slate-50 pb-2",children:i.jsxs("div",{ref:be,className:"flex-1 overflow-y-auto pb-[60px] px-4",children:[i.jsxs("div",{className:"flex-none px-4 py-4 bg-slate-50",children:[e&&i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsx(bt,{logo:{name:_t[ie(e)]||ie(e),icon_url:wt(ie(e),64,!0)}}),i.jsx("h2",{className:"m-0 text-lg font-semibold text-slate-900",children:e.title})]}),i.jsx("div",{className:"mt-3"})]}),u.length===0?i.jsx("div",{className:"flex flex-col items-center justify-center h-full",children:i.jsx("p",{className:"text-slate-600",children:"No steps found in this scribe."})}):i.jsx("div",{className:"space-y-6",children:u.map((s,h)=>i.jsxs("div",{className:"p-4 bg-white rounded-2xl shadow overflow-hidden relative",children:[i.jsxs("div",{className:"flex justify-between",children:[i.jsxs("div",{className:"flex items-center",children:[i.jsx("div",{className:" items-center flex-shrink-0 h-8 w-8 bg-brand-50 text-brand-500 rounded-full flex justify-center font-bold text-base mr-3",children:h+1}),i.jsx("div",{className:"public-sans md:text-base text-sm text-slate-800 p1",children:s.description})]}),i.jsx(le,{onClick:()=>k(s.id),className:Q("h-8 w-8 p-0","hover:text-red-500","focus:text-red-500"),title:"Remove this step",icon:We,variant:"ghost",size:"small"})]}),s.screenshot&&i.jsx("div",{className:"pt-4",children:i.jsx("div",{className:"rounded overflow-hidden",style:{height:"165px"},children:typeof s.screenshot=="string"?i.jsx(He,{screenshot:s.screenshot,clickPosition:s.position,altText:`Step ${h+1}: ${s.description}`,className:"w-full h-full"}):typeof s.screenshot=="object"&&s.screenshot instanceof Blob?i.jsx(He,{screenshot:URL.createObjectURL(s.screenshot),clickPosition:s.position,altText:`Step ${h+1}: ${s.description}`,className:"w-full h-full"}):i.jsx("div",{className:"h-full flex items-center justify-center bg-slate-200 text-slate-500 text-sm",children:"Screenshot unavailable"})})})]},s.id))})]})}),i.jsx("div",{className:"flex-none p-4 fixed bottom-0 left-0 right-0 backdrop-blur-xs bg-gradient-to-t from-white to-white/0",children:i.jsx("div",{className:"flex flex-col space-y-2",children:i.jsxs("div",{className:"flex space-x-2",children:[i.jsx(le,{variant:"secondary",className:"flex-1",onClick:Xe,disabled:A||fe,icon:We,children:i.jsxs("div",{className:"flex items-center justify-center gap-2",children:[fe&&i.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-2 border-slate-200 border-b-slate-800"}),i.jsx("span",{children:"Discard"})]})}),i.jsx(le,{variant:"primary",className:"flex-1",onClick:xe,disabled:A||fe||u.length===0,icon:gt,children:i.jsxs("div",{className:"flex items-center justify-center gap-2",children:[A&&i.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-2 border-white/20 border-b-white/100"}),i.jsx("span",{children:"Add Scribe"})]})})]})})}),i.jsx(xt,{open:P,onOpenChange:ne,title:"Why did you discard that Scribe?",subtitle:"Select all that are applicable.",reasons:["Topic already documented","Topic not worth saving","Steps or screenshots inaccurate","Too much effort to edit","Other"],onSubmit:W,onSkip:Z})]})},Tt=()=>i.jsxs(tt.StrictMode,{children:[i.jsx("style",{type:"text/css",children:ut}),i.jsxs(st,{store:mt,children:[i.jsx($t,{}),i.jsx(rt,{})]})]}),Be=document.getElementById("root");Be&&it(Be).render(i.jsx(Tt,{}));
