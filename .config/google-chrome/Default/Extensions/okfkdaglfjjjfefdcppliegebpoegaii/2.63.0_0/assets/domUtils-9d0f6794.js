import{cd as p,s as l,cI as c,a$ as m,F as _,t as f}from"./store-f163b43d.js";const h=200;function I(a){if(!a)return"";const r=a.indexOf(">");return r===-1?null:a.substring(0,r+1)}function S(a,r,n,o,d,u){return a.post("/signed_urls/",{name:"a dom",file_type:"html"}).then(t=>{const{data:{internal_url:e,upload_url:s}}=t;return{internal_url:e,upload_url:s}}).then(({internal_url:t,upload_url:e})=>(l.dispatch(c({tempId:n,partialAction:{dom_url:t,dom_upload_status:m.UPLOAD_STATUS.WAITING}})),_(e,o,"text/html",{timeout:6e4}).then(s=>({res:s,upload_url:e})))).then(({res:t,upload_url:e})=>{if(t.ok){const s={scribeId:r,timestamp:d},i={status:t.status,statusText:t.statusText,url:e,headers:Object.fromEntries(t.headers.entries()),config:{url:e,data:{}},request:{}};return p("dom_upload_succeeded",{dom_data:s,url:e}),f("dom_upload_succeeded",i),l.dispatch(c({tempId:n,partialAction:{dom_upload_status:m.UPLOAD_STATUS.SUCCESS}})),t}throw new Error(`DOM upload failed with status ${t.status}`)}).catch(t=>{throw l.dispatch(c({tempId:n,partialAction:{failed_ss:!0,dom_upload_status:m.UPLOAD_STATUS.ERROR}})),t})}async function A({domString:a,name:r,email:n,scribeId:o,actionId:d,timestamp:u,api:t}){const e="/sps/",s={dom_data:a,name:r||"adom",email:n,needs_redaction:!0,scribeId:o,actionId:d,timestamp:u,file_type:"html"},i=await t.post(e,s);if(!i||!i.data)throw new Error("Failed to upload DOM for SPS redaction");return l.dispatch(c({tempId:d,partialAction:{dom_url:i.data.internal_url,dom_upload_status:m.UPLOAD_STATUS.WAITING}})),i.data}const T=async(a,r,n,o,d,u,t=null,e=!1,s=null)=>{if(o){if(u>h){p("dom_upload_failed",{dom_data:{timestamp:d,scribeId:r,retries:u},error:t,reason:"retry_count_exceeded"});return}return e?A({domString:o,name:"adom",email:s,scribeId:r,actionId:n,timestamp:d,api:a}):S(a,r,n,o,d)}},O=()=>{try{return Object.values(window.self.location.ancestorOrigins).some(a=>a.includes("extension://"))}catch{return!1}};export{I as g,O as i,T as u};
