import{f as O,g as M}from"./index.esm-e3d6f8ec.js";import{b4 as U,b5 as G,a$ as v,b6 as j,b0 as z,b2 as V}from"./store-f163b43d.js";import{g as P}from"./domUtils-9d0f6794.js";import{g as Y}from"./getTargetElementAttributes-3f1109f1.js";import{b as J}from"./options-d8a3c135.js";import{m as Q}from"./index-24f6db5b.js";import{v as L}from"./v4-c70744d4.js";import"./_commonjsHelpers-de833af9.js";import"./index-8b3efc3f.js";import"./appTagUtils-f127d137.js";var Z=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};Z.SENTRY_RELEASE={id:"1305c76edd7b4291b80d5f57cd104316065124a5"};const ee=e=>{if(!e)return"";const m=[];let c=0;for(;m.length<2&&c<=e.length;){let i=e.indexOf(`
`,c);i===-1&&(i=e.length);let a=e.slice(c,i);a.endsWith("\r")&&(a=a.slice(0,-1)),a.trim().length!==0&&m.push(a),c=i+1}const d=c<e.length;return m.join(`
`)+(d?"\u2026":"")},f=window!==window.top,A=1e3,X="data-long-running-recorder-frame-path-id";let _=!1,y=!1;const k=500,te=5,ne=3e3;let t=null;const T=()=>{(t==null?void 0:t.timeoutId)!=null&&clearTimeout(t.timeoutId),t!=null&&t.selectElement&&(t!=null&&t.selectChangeListener)&&t.selectElement.removeEventListener("change",t.selectChangeListener,{capture:!0}),t=null};let x=0;const oe=1e3,ae=e=>{if(!e)return!1;if(e instanceof HTMLInputElement&&e.type==="password")return!0;const m=["cc-number","cc-exp","cc-csc"];return!!(e instanceof HTMLInputElement&&m.includes(e.autocomplete))},D=async()=>{if(!f)return{left:0,top:0};const e=L(),m=e;return new Promise((c,d)=>{var o;let i=!1;const a=setTimeout(()=>{var n;if(!i){window.removeEventListener("message",l),console.warn("Falling back to simple offset calculation due to timeout");const r=((n=window.frameElement)==null?void 0:n.getBoundingClientRect())||{left:0,top:0};c({left:r.left,top:r.top})}},A),l=n=>{var r;((r=n.data)==null?void 0:r.iframeOffsetResponseId)===e&&(i=!0,window.removeEventListener("message",l),clearTimeout(a),c({left:n.data.left,top:n.data.top}))};window.addEventListener("message",l);try{if(window.parent){const n={tempFramePathId:m,iframeOffsetRequestId:e,left:0,top:0};window.parent.postMessage(n,"*")}else throw new Error("Cannot access parent frame")}catch{clearTimeout(a),window.removeEventListener("message",l),console.warn("Failed to send message to parent frame, falling back to simple offset");const n=((o=window.frameElement)==null?void 0:o.getBoundingClientRect())||{left:0,top:0};c({left:n.left,top:n.top})}})};window.addEventListener("message",async e=>{var m,c;if(!(!e.source||!e.data)){if((m=e.data)!=null&&m.iframeOffsetRequestId){const d=e.source,i=[...document.querySelectorAll("iframe")].find(u=>u.contentWindow===d);if(!i){console.warn("Could not find source iframe for offset calculation");return}const a=`${X}-${e.data.tempFramePathId}`;i.setAttribute(a,e.data.tempFramePathId),setTimeout(()=>{i==null||i.removeAttribute(a)},A);const l=i.getBoundingClientRect(),o=l.left,n=l.top,r=e.data.left+o,s=e.data.top+n;if(f)try{window.parent.postMessage({tempFramePathId:e.data.tempFramePathId,iframeOffsetRequestId:e.data.iframeOffsetRequestId,left:r,top:s},"*")}catch{console.warn("Failed to propagate offset message upward")}else{const u={tempFramePathId:e.data.tempFramePathId,iframeOffsetResponseId:e.data.iframeOffsetRequestId,left:r,top:s};i.contentWindow&&i.contentWindow.postMessage(u,"*")}}if((c=e.data)!=null&&c.iframeOffsetResponseId){const d=`${X}-${e.data.tempFramePathId}`,i=[...document.querySelectorAll("iframe")].find(a=>a.getAttribute(d)===e.data.tempFramePathId);if(i!=null&&i.contentWindow){i.removeAttribute(d);try{i.contentWindow.postMessage({iframeOffsetResponseId:e.data.iframeOffsetResponseId,left:e.data.left,top:e.data.top},"*")}catch{console.warn("Failed to propagate offset message downward")}}}}});const F=()=>{if(location.ancestorOrigins&&location.ancestorOrigins.length>0)return location.ancestorOrigins[location.ancestorOrigins.length-1];if(!f)return location.origin},W=async e=>{var S,C;if(ae(document.activeElement)||!e.key||U(e.key))return;const m=Date.now(),{key:c,code:d,shiftKey:i,altKey:a,ctrlKey:l,metaKey:o}=e,n=G(c,d),r=window.devicePixelRatio||1;let s=null;try{e.target&&(s=O(e.target))}catch{}const u=Y(e.target),p=M(e.target,{ignoreId:!0});let g=null;const h=document.activeElement;if(h){let b={left:0,top:0};try{b=await D()}catch(H){if(console.warn("Failed to get accumulated frame offset for keyboard event:",H),f&&window.frameElement){const R=window.frameElement.getBoundingClientRect();b={left:R.left,top:R.top}}}const I=h.getBoundingClientRect(),$=6;g={x:(I.left+Math.min($,Math.max(0,I.width/10))+b.left)*r,y:(I.top+I.height/2+b.top)*r}}const E={id:L(),type:"long_running_recorder_action",kind:v.KEYBOARD_ACTIONS.PRESS,direction:v.KEY_DIRECTIONS.DOWN,modifiers:{shiftKey:i,altKey:a,ctrlKey:l,metaKey:o},target_selector:s,target_xpath:p,target_tag:(S=e.target)==null?void 0:S.tagName,target_element:P((((C=e.target)==null?void 0:C.outerHTML)||"").replace(/\s(?:src|style)="[^"]*"/gi,"")),target_element_attributes:u,key:j(n,!0),timestamp:m,url:window.location.href,top_frame_origin:F(),devicePixelRatio:r,position:g,viewport:{width:window.innerWidth,height:window.innerHeight},wasInIframe:f,scrollPosition:{x:window.scrollX,y:window.scrollY}};chrome.runtime.sendMessage({messageType:"long_running_recorder_action",action:E})},re=e=>!e||typeof e!="string"?e:e.startsWith("Click ")?e.replace(/^Click\s/,"Double-click "):e==="Click here."?"Double-click here.":e,w=async(e,m,c)=>{const{timestamp:d}=e,i=window.devicePixelRatio||1;let a={left:0,top:0};try{a=await D()}catch{if(f&&window.frameElement){const g=window.frameElement.getBoundingClientRect();a={left:g.left,top:g.top}}}let l=null;try{e.target&&(l=O(e.target))}catch{}const o=e.target,n=Y(o||{}),r=M(o,{ignoreId:!0}),s=z(o),u=c??(m===2?re(s):s),p={id:L(),type:"long_running_recorder_action",kind:v.MOUSE_ACTIONS.CLICK,click_count:m,button:v.BUTTON_FROM_NUMBER[e.button]??"left",...e.earlyScreenshotTimestamp?{earlyScreenshotTimestamp:e.earlyScreenshotTimestamp}:{},position:{x:(e.clientX+a.left)*i,y:(e.clientY+a.top)*i},viewport:{width:window.innerWidth,height:window.innerHeight},wasInIframe:f,scrollPosition:{x:window.scrollX,y:window.scrollY},description:u,devicePixelRatio:i,target_selector:l,target_xpath:r,target_tag:o==null?void 0:o.tagName,target_element:o?P((o.outerHTML||"").replace(/\s(?:src|style)="[^"]*"/gi,"")):void 0,target_text:o?ee(o.innerText||o.textContent||"").substring(0,2048):"",target_element_attributes:n,timestamp:d,url:window.location.href,top_frame_origin:F()};chrome.runtime.sendMessage({messageType:"long_running_recorder_action",action:p})},K=async e=>{const m=Date.now(),c=e.button===0;let d=null;if(m-x>oe)try{const a=new Promise(n=>{Q.send("earlyScreenshot").then(r=>n(r??null))}),l=64,o=Date.now()+l;for(;Date.now()<o;);d=await a,d&&(x=m)}catch{}if(!c){w({timestamp:m,clientX:e.clientX,clientY:e.clientY,button:e.button,target:e.target||null,earlyScreenshotTimestamp:d},1);return}if(t){const a=m-t.timestamp,l=e.clientX-t.clientX,o=e.clientY-t.clientY,n=Math.sqrt(l*l+o*o);if(a<=k&&n<=te){t.timeoutId!=null&&clearTimeout(t.timeoutId);const s=e.target||t.target,u=d??t.earlyScreenshotTimestamp??null;w({timestamp:m,clientX:e.clientX,clientY:e.clientY,button:e.button,target:s,earlyScreenshotTimestamp:u},2),T();return}const r={...t};r.timeoutId!=null&&clearTimeout(r.timeoutId),w({timestamp:r.timestamp,clientX:r.clientX,clientY:r.clientY,button:r.button,target:r.target,earlyScreenshotTimestamp:r.earlyScreenshotTimestamp},1),T()}t={timestamp:m,clientX:e.clientX,clientY:e.clientY,button:e.button,target:e.target||null,timeoutId:null,earlyScreenshotTimestamp:d,selectElement:null,selectChangeListener:null};const i=e.target||null;if(i&&i.tagName==="SELECT"){const a=i,l=o=>{var h,E;if(_||!y){a.removeEventListener("change",l,{capture:!0}),(t==null?void 0:t.timeoutId)!=null&&clearTimeout(t.timeoutId),t=null;return}a.removeEventListener("change",l,{capture:!0});const n=t?{...t}:null;(t==null?void 0:t.timeoutId)!=null&&clearTimeout(t.timeoutId),t=null;const r=o.target,s=((E=(h=r==null?void 0:r.options)==null?void 0:h[r.selectedIndex])==null?void 0:E.text)||"",u=(r==null?void 0:r.value)||"",p=(s||u).trim(),g=p?`Select the "${p}" option.`:"Select option";V(()=>{w({timestamp:Date.now(),clientX:(n==null?void 0:n.clientX)??e.clientX,clientY:(n==null?void 0:n.clientY)??e.clientY,button:(n==null?void 0:n.button)??e.button,target:a,earlyScreenshotTimestamp:null},1,g)})};a.addEventListener("change",l,{once:!0,capture:!0}),t&&(t.selectElement=a,t.selectChangeListener=l),t.timeoutId=window.setTimeout(()=>{if(a.removeEventListener("change",l,{capture:!0}),!t)return;const o={...t};t=null,w({timestamp:o.timestamp,clientX:o.clientX,clientY:o.clientY,button:o.button,target:o.target,earlyScreenshotTimestamp:o.earlyScreenshotTimestamp},1)},ne)}else t.timeoutId=window.setTimeout(()=>{if(!t)return;t.selectElement&&t.selectChangeListener&&t.selectElement.removeEventListener("change",t.selectChangeListener,{capture:!0});const a={...t};t=null,w({timestamp:a.timestamp,clientX:a.clientX,clientY:a.clientY,button:a.button,target:a.target,earlyScreenshotTimestamp:a.earlyScreenshotTimestamp},1)},k)},B=()=>{chrome.runtime.onMessage.addListener(e=>{e.messageType==="startRecording"||e.messageType==="browserStartRecording"||e.messageType==="openGuideMeSidepanel"||e.messageType==="guideMeStepForward"||e.messageType==="getGuideMeSessionId"||e.messageType==="startCopilot"||e.messageType==="startCopilotSearch"||e.messageType==="recaptureStep"||e.messageType==="currentVisibleAction"?(_=!0,T(),ie()):(e.messageType==="endRecording"||e.messageType==="optionsChanged"||e.messageType==="browserDeleteRecording"||e.messageType==="browserCompleteCapture")&&(_=!1,T(),N())}),N()},N=()=>{y||_||(document.addEventListener("pointerdown",K,{capture:!0}),document.addEventListener("keydown",W,{capture:!0}),y=!0)},ie=()=>{y&&(T(),document.removeEventListener("pointerdown",K,{capture:!0}),document.removeEventListener("keydown",W,{capture:!0}),y=!1)},se=async()=>{const e=await new Promise(c=>{try{chrome.runtime.sendMessage({messageType:"getDWOptimizeState"},d=>{if(chrome.runtime.lastError){c(!1);return}c(!!(d!=null&&d.isDWActive))})}catch{c(!1)}}),m=await J("recordingControlsPreference")==="floating-button";if(!e||m)return!1;try{const[c,d]=await Promise.all([new Promise(o=>{chrome.runtime.sendMessage({messageType:"getAllowedDomains"},n=>{o(Array.isArray(n==null?void 0:n.allowedDomains)?n.allowedDomains:[])})}),new Promise(o=>{chrome.runtime.sendMessage({messageType:"getAllowedAppTags"},n=>{const r=(Array.isArray(n==null?void 0:n.allowedAppTags)?n==null?void 0:n.allowedAppTags:[]).flatMap(s=>{const u=(s==null?void 0:s.domain)||"",p=(s==null?void 0:s.multi_root_domains_urls)||[],g=(s==null?void 0:s.root_domain_url)||"";return Array.from(new Set([u,...p,g])).filter(Boolean)});o(r)})})]),i=[...c,...d];if(!i||i.length===0)return!1;const a=window.location.hostname.toLowerCase();let l=null;if(window===window.top)l=a;else if(location.ancestorOrigins&&location.ancestorOrigins.length>0)try{const o=location.ancestorOrigins[location.ancestorOrigins.length-1];l=new URL(o).hostname.toLowerCase()}catch{}return!!(o=>{if(!o)return!1;const n=o.toLowerCase();return i.some(r=>{if(!r)return!1;const s=r.toLowerCase();return n===s||n.startsWith("www.")&&n.slice(4)===s||s.startsWith("www.")&&n===s.slice(4)?!0:n.endsWith(`.${s}`)})})(l)}catch(c){return console.warn("[Long Running Recorder] Failed to read allowed domains",c),!1}},q=()=>{se().then(e=>{e&&(document.readyState==="loading"?document.addEventListener("DOMContentLoaded",B):B())}).catch(e=>{console.warn("[Long Running Recorder] Error while checking enablement",e)})};chrome.runtime.onMessage.addListener(e=>{e.messageType==="optionsChanged"&&q()}),q();
