var hi=Object.defineProperty;var mi=(e,t,r)=>t in e?hi(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var Ye=(e,t,r)=>(mi(e,typeof t!="symbol"?t+"":t,r),r);var pi;import{b8 as $r,b9 as fi,ba as hs,bb as jr,bc as U,bd as at,be as me,bf as yi,bg as ge,bh as ms,bi as Wr,bj as _i,bk as fs,bl as pt,bm as qr,bn as Br,bo as gt,bp as ys,bq as wi,br as vi,bs as bi,bt as Si,bu as ne,bv as Ti,bw as _s,bx as ws,by as zr,bz as vs,bA as Ei,bB as Ii,bC as ki,bD as Di,bE as Gr,bF as bs,bG as Ci,bH as Ss,bI as Xe,bJ as sr,bK as Vr,bL as Pe,bM as Ai,bN as Ri,bO as Hr,bP as ar,A as W,bQ as Kr,bR as Ts,bS as Oi,bT as Li,bU as Yr,bV as Pi,bW as xi,bX as Mi,bY as X,bZ as Ni,b_ as Fi,b$ as Es,c0 as Is,c1 as Ui,c2 as $i,c3 as ks,c4 as Ds,al as Q,ay as Pt,s as d,ag as fe,c5 as Cs,c6 as As,c7 as Je,c8 as le,y as ji,c9 as Wi,ca as qi,cb as ot,U as K,cc as Bi,$ as Xr,E as de,aq as xt,cd as P,ce as zi,cf as Gi,cg as Vi,ch as Hi,ci as Ki,R as Rs,cj as Yi,ck as Xi,cl as ke,cm as Ji,a as Qi,cn as Z,S as Qe,co as ht,cp as it,cq as or,D as j,ax as Mt,cr as ir,cs as mt,ct as Zi,cu as ec,cv as tc,cw as rc,F as nc,cx as sc,cy as ac,cz as Jr,cA as oc,cB as ic,cC as cc,w as Ne,x as Se,V as lc,cD as Qr,cE as Os,a$ as ee,cF as Be,cG as Zr,cH as Ls,t as G,cI as Ps,f as Y,cJ as en,cK as xs,cL as Fe,cM as tn,cN as dc,cO as uc,J as Ms,cP as pc,cQ as gc,cR as Nt,cS as hc,cT as mc,P as fc,cU as ft,cV as yc,au as _c,cW as wc,cX as rn,cY as Ns,cZ as vc,j as Fs,aj as ct,ah as De,m as se,o as Ce,c_ as Ft,c$ as Us,d0 as Ut,d1 as $s,d2 as js,d3 as bc,d4 as nn,d5 as Sc,K as Tc,d6 as Ec,d7 as Ic,d8 as kc,d9 as Dc,da as Cc,aV as Ac,db as Ws,dc as qs,dd as yt,de as sn,df as _t,dg as wt,dh as Bs,di as Rc,p as Oc,i as Lc,dj as Pc,dk as an,dl as zs,dm as on,dn as xc,dp as Mc,dq as Nc,dr as Fc,Q as Gs,ds as Uc,dt as $c,a5 as jc,du as Vs,dv as Hs,dw as Ks,dx as Wc,dy as qc,dz as cr,aB as Bc,dA as cn,dB as ln,dC as lr,ad as dr,dD as dn,dE as un,dF as $t,dG as pn,dH as zc,dI as Gc,dJ as Vc,dK as Hc,dL as Kc,dM as Ys,aA as Yc,dN as Xc,dO as Jc,dP as Qc,dQ as Xs,a9 as Zc,dR as el,dS as tl,dT as rl,dU as jt,dV as Js,dW as nl,dX as sl,dY as gn,dZ as al,d_ as ol,d$ as Qs,e0 as Zs,e1 as il,e2 as cl,e3 as ll,e4 as hn,e5 as dl,e6 as ea,C as ul,e7 as pl,e8 as gl,e9 as hl,a8 as ml,ea as mn,eb as fl,ec as yl,ed as ta,ee as ra}from"./store-f163b43d.js";import{a as na}from"./browserContext-85999045.js";import{m as _l,e as wl}from"./index-24f6db5b.js";import{E as ur}from"./entry-point-enums-c196ff5e.js";import{a as fn,s as yn,b as sa,g as aa}from"./allowedDomainsDB-163b9f7f.js";import{g as vl,s as Wt,m as pr,n as bl,M as oa,b as Sl,j as ia,o as ca,e as Tl,q as El}from"./util-e36b51ae.js";import{c as Il,g as kl,a as la}from"./appTagUtils-f127d137.js";import{v as ze}from"./v4-c70744d4.js";import{l as J}from"./dw-telemetry-83cc94a3.js";import{c as gr,g as Dl}from"./_commonjsHelpers-de833af9.js";import{g as Cl,b as da,s as _n,a as Al}from"./options-d8a3c135.js";import{a as ua,b as Rl,u as Ol,c as Ll,d as Pl,o as pa,e as xl}from"./scribeLiveUtils-a357dd05.js";import{V as wn}from"./messages-bb434fe1.js";import{shouldStreamUrl as Ml}from"./index.ts-4012a8b5.js";import{g as qt,d as ga,p as Nl,o as Fl,a as Ul,c as $l,b as jl}from"./dwResultsDB-a3d52d5f.js";import{u as Wl,m as ql,c as Bl,a as zl,b as Gl}from"./dwActionLoggingDB-f05b22f9.js";import{o as Vl,a as Hl,c as Kl,p as Yl}from"./dwScreenshotsDB-956b9f9a.js";import{u as Xl}from"./domUtils-9d0f6794.js";import"./index-8b3efc3f.js";import"./domCopyAnnotate-a2b92afc.js";import"./getTargetElementAttributes-3f1109f1.js";function ha(e,t,r=!1){const n=e.handlers,s=(a,i,o)=>{if(a&&typeof a=="object"&&"type"in a&&n[a.type]){const p=n[a.type];try{const u=y=>{o(y)},h=y=>{const w=y instanceof Error?y.message:y;o({error:w})},m=a.payload;return p(m,i,u,h)!==!1}catch(u){console.error(`Error in typed message handler for ${a.type}:`,u);const h=u instanceof Error?u.message:String(u);return o({error:h}),!1}}return t(a,i,o)};r?chrome.runtime.onMessageExternal.addListener(s):chrome.runtime.onMessage.addListener(s)}function Jl(e,t){ha(e,t,!1)}function Ql(e,t){ha(e,t,!0)}function Zl(e,t,r=250,n,s,a,i){if(!a.exception||!a.exception.values||!i||!$r(i.originalException,Error))return;const o=a.exception.values.length>0?a.exception.values[a.exception.values.length-1]:void 0;o&&(a.exception.values=ed(vn(e,t,s,i.originalException,n,a.exception.values,o,0),r))}function vn(e,t,r,n,s,a,i,o){if(a.length>=r+1)return a;let p=[...a];if($r(n[s],Error)){ma(i,o);const u=e(t,n[s]),h=p.length;fa(u,s,h,o),p=vn(e,t,r,n[s],s,[u,...p],u,h)}return Array.isArray(n.errors)&&n.errors.forEach((u,h)=>{if($r(u,Error)){ma(i,o);const m=e(t,u),y=p.length;fa(m,`errors[${h}]`,y,o),p=vn(e,t,r,u,s,[m,...p],m,y)}}),p}function ma(e,t){e.mechanism=e.mechanism||{type:"generic",handled:!0},e.mechanism={...e.mechanism,...e.type==="AggregateError"&&{is_exception_group:!0},exception_id:t}}function fa(e,t,r,n){e.mechanism=e.mechanism||{type:"generic",handled:!0},e.mechanism={...e.mechanism,type:"chained",source:t,exception_id:r,parent_id:n}}function ed(e,t){return e.map(r=>(r.value&&(r.value=fi(r.value,t)),r))}const td=/^(?:(\w+):)\/\/(?:(\w+)(?::(\w+)?)?@)([\w.-]+)(?::(\d+))?\/(.+)/;function rd(e){return e==="http"||e==="https"}function Bt(e,t=!1){const{host:r,path:n,pass:s,port:a,projectId:i,protocol:o,publicKey:p}=e;return`${o}://${p}${t&&s?`:${s}`:""}@${r}${a?`:${a}`:""}/${n&&`${n}/`}${i}`}function nd(e){const t=td.exec(e);if(!t){hs(()=>{console.error(`Invalid Sentry Dsn: ${e}`)});return}const[r,n,s="",a,i="",o]=t.slice(1);let p="",u=o;const h=u.split("/");if(h.length>1&&(p=h.slice(0,-1).join("/"),u=h.pop()),u){const m=u.match(/^\d+/);m&&(u=m[0])}return ya({host:a,pass:s,path:p,projectId:u,port:i,protocol:r,publicKey:n})}function ya(e){return{protocol:e.protocol,publicKey:e.publicKey||"",pass:e.pass||"",host:e.host,port:e.port||"",path:e.path||"",projectId:e.projectId}}function sd(e){if(!jr)return!0;const{port:t,projectId:r,protocol:n}=e;return["protocol","publicKey","host","projectId"].find(s=>e[s]?!1:(U.error(`Invalid Sentry Dsn: ${s} missing`),!0))?!1:r.match(/^\d+$/)?rd(n)?t&&isNaN(parseInt(t,10))?(U.error(`Invalid Sentry Dsn: Invalid port ${t}`),!1):!0:(U.error(`Invalid Sentry Dsn: Invalid protocol ${n}`),!1):(U.error(`Invalid Sentry Dsn: Invalid projectId ${r}`),!1)}function ad(e){const t=typeof e=="string"?nd(e):ya(e);if(!(!t||!sd(t)))return t}class Ue extends Error{constructor(t,r="warn"){super(t),this.message=t,this.name=new.target.prototype.constructor.name,Object.setPrototypeOf(this,new.target.prototype),this.logLevel=r}}const hr={},_a={};function lt(e,t){hr[e]=hr[e]||[],hr[e].push(t)}function dt(e,t){_a[e]||(t(),_a[e]=!0)}function xe(e,t){const r=e&&hr[e];if(r)for(const n of r)try{n(t)}catch(s){jr&&U.error(`Error while triggering instrumentation handler.
Type: ${e}
Name: ${at(n)}
Error:`,s)}}function od(e){const t="console";lt(t,e),dt(t,id)}function id(){"console"in me&&yi.forEach(function(e){e in me.console&&ge(me.console,e,function(t){return ms[e]=t,function(...r){xe("console",{args:r,level:e});const n=ms[e];n&&n.apply(me.console,r)}})})}const vt=me,cd=1e3;let wa,bn,Sn;function ld(e){const t="dom";lt(t,e),dt(t,dd)}function dd(){if(!vt.document)return;const e=xe.bind(null,"dom"),t=va(e,!0);vt.document.addEventListener("click",t,!1),vt.document.addEventListener("keypress",t,!1),["EventTarget","Node"].forEach(r=>{const n=vt[r]&&vt[r].prototype;!n||!n.hasOwnProperty||!n.hasOwnProperty("addEventListener")||(ge(n,"addEventListener",function(s){return function(a,i,o){if(a==="click"||a=="keypress")try{const p=this,u=p.__sentry_instrumentation_handlers__=p.__sentry_instrumentation_handlers__||{},h=u[a]=u[a]||{refCount:0};if(!h.handler){const m=va(e);h.handler=m,s.call(this,a,m,o)}h.refCount++}catch{}return s.call(this,a,i,o)}}),ge(n,"removeEventListener",function(s){return function(a,i,o){if(a==="click"||a=="keypress")try{const p=this,u=p.__sentry_instrumentation_handlers__||{},h=u[a];h&&(h.refCount--,h.refCount<=0&&(s.call(this,a,h.handler,o),h.handler=void 0,delete u[a]),Object.keys(u).length===0&&delete p.__sentry_instrumentation_handlers__)}catch{}return s.call(this,a,i,o)}}))})}function ud(e){if(e.type!==bn)return!1;try{if(!e.target||e.target._sentryId!==Sn)return!1}catch{}return!0}function pd(e,t){return e!=="keypress"?!1:!t||!t.tagName?!0:!(t.tagName==="INPUT"||t.tagName==="TEXTAREA"||t.isContentEditable)}function va(e,t=!1){return r=>{if(!r||r._sentryCaptured)return;const n=gd(r);if(pd(r.type,n))return;Wr(r,"_sentryCaptured",!0),n&&!n._sentryId&&Wr(n,"_sentryId",_i());const s=r.type==="keypress"?"input":r.type;ud(r)||(e({event:r,name:s,global:t}),bn=r.type,Sn=n?n._sentryId:void 0),clearTimeout(wa),wa=vt.setTimeout(()=>{Sn=void 0,bn=void 0},cd)}}function gd(e){try{return e.target}catch{return null}}const Tn=fs();function ba(){if(!("fetch"in Tn))return!1;try{return new Headers,new Request("http://www.example.com"),new Response,!0}catch{return!1}}function En(e){return e&&/^function fetch\(\)\s+\{\s+\[native code\]\s+\}$/.test(e.toString())}function hd(){if(typeof EdgeRuntime=="string")return!0;if(!ba())return!1;if(En(Tn.fetch))return!0;let e=!1;const t=Tn.document;if(t&&typeof t.createElement=="function")try{const r=t.createElement("iframe");r.hidden=!0,t.head.appendChild(r),r.contentWindow&&r.contentWindow.fetch&&(e=En(r.contentWindow.fetch)),t.head.removeChild(r)}catch(r){jr&&U.warn("Could not create sandbox iframe for pure fetch check, bailing to window.fetch: ",r)}return e}function md(e){const t="fetch";lt(t,e),dt(t,fd)}function fd(){hd()&&ge(me,"fetch",function(e){return function(...t){const{method:r,url:n}=yd(t),s={args:t,fetchData:{method:r,url:n},startTimestamp:Date.now()};return xe("fetch",{...s}),e.apply(me,t).then(a=>{const i={...s,endTimestamp:Date.now(),response:a};return xe("fetch",i),a},a=>{const i={...s,endTimestamp:Date.now(),error:a};throw xe("fetch",i),a})}})}function In(e,t){return!!e&&typeof e=="object"&&!!e[t]}function Sa(e){return typeof e=="string"?e:e?In(e,"url")?e.url:e.toString?e.toString():"":""}function yd(e){if(e.length===0)return{method:"GET",url:""};if(e.length===2){const[r,n]=e;return{url:Sa(r),method:In(n,"method")?String(n.method).toUpperCase():"GET"}}const t=e[0];return{url:Sa(t),method:In(t,"method")?String(t.method).toUpperCase():"GET"}}let mr=null;function _d(e){const t="error";lt(t,e),dt(t,wd)}function wd(){mr=me.onerror,me.onerror=function(e,t,r,n,s){return xe("error",{column:n,error:s,line:r,msg:e,url:t}),mr&&!mr.__SENTRY_LOADER__?mr.apply(this,arguments):!1},me.onerror.__SENTRY_INSTRUMENTED__=!0}let fr=null;function vd(e){const t="unhandledrejection";lt(t,e),dt(t,bd)}function bd(){fr=me.onunhandledrejection,me.onunhandledrejection=function(e){return xe("unhandledrejection",e),fr&&!fr.__SENTRY_LOADER__?fr.apply(this,arguments):!0},me.onunhandledrejection.__SENTRY_INSTRUMENTED__=!0}const yr=fs();function Sd(){const e=yr.chrome,t=e&&e.app&&e.app.runtime,r="history"in yr&&!!yr.history.pushState&&!!yr.history.replaceState;return!t&&r}const zt=me;let _r;function Ta(e){const t="history";lt(t,e),dt(t,Td)}function Td(){if(!Sd())return;const e=zt.onpopstate;zt.onpopstate=function(...r){const n=zt.location.href,s=_r;if(_r=n,xe("history",{from:s,to:n}),e)try{return e.apply(this,r)}catch{}};function t(r){return function(...n){const s=n.length>2?n[2]:void 0;if(s){const a=_r,i=String(s);_r=i,xe("history",{from:a,to:i})}return r.apply(this,n)}}ge(zt.history,"pushState",t),ge(zt.history,"replaceState",t)}const Ed=me,Gt="__sentry_xhr_v3__";function Id(e){const t="xhr";lt(t,e),dt(t,kd)}function kd(){if(!Ed.XMLHttpRequest)return;const e=XMLHttpRequest.prototype;ge(e,"open",function(t){return function(...r){const n=Date.now(),s=pt(r[0])?r[0].toUpperCase():void 0,a=Dd(r[1]);if(!s||!a)return t.apply(this,r);this[Gt]={method:s,url:a,request_headers:{}},s==="POST"&&a.match(/sentry_key/)&&(this.__sentry_own_request__=!0);const i=()=>{const o=this[Gt];if(o&&this.readyState===4){try{o.status_code=this.status}catch{}const p={args:[s,a],endTimestamp:Date.now(),startTimestamp:n,xhr:this};xe("xhr",p)}};return"onreadystatechange"in this&&typeof this.onreadystatechange=="function"?ge(this,"onreadystatechange",function(o){return function(...p){return i(),o.apply(this,p)}}):this.addEventListener("readystatechange",i),ge(this,"setRequestHeader",function(o){return function(...p){const[u,h]=p,m=this[Gt];return m&&pt(u)&&pt(h)&&(m.request_headers[u.toLowerCase()]=h),o.apply(this,p)}}),t.apply(this,r)}}),ge(e,"send",function(t){return function(...r){const n=this[Gt];if(!n)return t.apply(this,r);r[0]!==void 0&&(n.body=r[0]);const s={args:[n.method,n.url],startTimestamp:Date.now(),xhr:this};return xe("xhr",s),t.apply(this,r)}})}function Dd(e){if(pt(e))return e;try{return e.toString()}catch{}}function Cd(){return"npm"}function Ad(e){const t=[];function r(){return e===void 0||t.length<e}function n(i){return t.splice(t.indexOf(i),1)[0]}function s(i){if(!r())return qr(new Ue("Not adding Promise because buffer limit was reached."));const o=i();return t.indexOf(o)===-1&&t.push(o),o.then(()=>n(o)).then(null,()=>n(o).then(null,()=>{})),o}function a(i){return new Br((o,p)=>{let u=t.length;if(!u)return o(!0);const h=setTimeout(()=>{i&&i>0&&o(!1)},i);t.forEach(m=>{gt(m).then(()=>{--u||(clearTimeout(h),o(!0))},p)})})}return{$:t,add:s,drain:a}}function kn(e){if(!e)return{};const t=e.match(/^(([^:/?#]+):)?(\/\/([^/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?$/);if(!t)return{};const r=t[6]||"",n=t[8]||"";return{host:t[4],path:t[5],protocol:t[2],search:r,hash:n,relative:t[5]+r+n}}const Rd=["fatal","error","warning","log","info","debug"];function Od(e){return e==="warn"?"warning":Rd.includes(e)?e:"log"}function bt(e,t=[]){return[e,t]}function Ld(e,t){const[r,n]=e;return[r,[...n,t]]}function Ea(e,t){const r=e[1];for(const n of r){const s=n[0].type;if(t(n,s))return!0}return!1}function Dn(e,t){return(t||new TextEncoder).encode(e)}function Pd(e,t){const[r,n]=e;let s=JSON.stringify(r);function a(i){typeof s=="string"?s=typeof i=="string"?s+i:[Dn(s,t),i]:s.push(typeof i=="string"?Dn(i,t):i)}for(const i of n){const[o,p]=i;if(a(`
${JSON.stringify(o)}
`),typeof p=="string"||p instanceof Uint8Array)a(p);else{let u;try{u=JSON.stringify(p)}catch{u=JSON.stringify(wi(p))}a(u)}}return typeof s=="string"?s:xd(s)}function xd(e){const t=e.reduce((s,a)=>s+a.length,0),r=new Uint8Array(t);let n=0;for(const s of e)r.set(s,n),n+=s.length;return r}function Md(e,t){const r=typeof e.data=="string"?Dn(e.data,t):e.data;return[ys({type:"attachment",length:r.length,filename:e.filename,content_type:e.contentType,attachment_type:e.attachmentType}),r]}const Nd={session:"session",sessions:"session",attachment:"attachment",transaction:"transaction",event:"error",client_report:"internal",user_report:"default",profile:"profile",replay_event:"replay",replay_recording:"replay",check_in:"monitor",feedback:"feedback",span:"span",statsd:"metric_bucket"};function Ia(e){return Nd[e]}function ka(e){if(!e||!e.sdk)return;const{name:t,version:r}=e.sdk;return{name:t,version:r}}function Fd(e,t,r,n){const s=e.sdkProcessingMetadata&&e.sdkProcessingMetadata.dynamicSamplingContext;return{event_id:e.event_id,sent_at:new Date().toISOString(),...t&&{sdk:t},...!!r&&n&&{dsn:Bt(n)},...s&&{trace:ys({...s})}}}function Ud(e,t,r){const n=[{type:"client_report"},{timestamp:r||vi(),discarded_events:e}];return bt(t?{dsn:t}:{},[n])}const $d=60*1e3;function jd(e,t=Date.now()){const r=parseInt(`${e}`,10);if(!isNaN(r))return r*1e3;const n=Date.parse(`${e}`);return isNaN(n)?$d:n-t}function Wd(e,t){return e[t]||e.all||0}function qd(e,t,r=Date.now()){return Wd(e,t)>r}function Bd(e,{statusCode:t,headers:r},n=Date.now()){const s={...e},a=r&&r["x-sentry-rate-limits"],i=r&&r["retry-after"];if(a)for(const o of a.trim().split(",")){const[p,u,,,h]=o.split(":",5),m=parseInt(p,10),y=(isNaN(m)?60:m)*1e3;if(!u)s.all=n+y;else for(const w of u.split(";"))w==="metric_bucket"?(!h||h.split(";").includes("custom"))&&(s[w]=n+y):s[w]=n+y}else i?s.all=n+jd(i,n):t===429&&(s.all=n+60*1e3);return s}function zd(e,t){return t&&(e.sdk=e.sdk||{},e.sdk.name=e.sdk.name||t.name,e.sdk.version=e.sdk.version||t.version,e.sdk.integrations=[...e.sdk.integrations||[],...t.integrations||[]],e.sdk.packages=[...e.sdk.packages||[],...t.packages||[]]),e}function Gd(e,t,r,n){const s=ka(r),a={sent_at:new Date().toISOString(),...s&&{sdk:s},...!!n&&t&&{dsn:Bt(t)}},i="aggregates"in e?[{type:"sessions"},e]:[{type:"session"},e.toJSON()];return bt(a,[i])}function Vd(e,t,r,n){const s=ka(r),a=e.type&&e.type!=="replay_event"?e.type:"event";zd(e,r&&r.sdk);const i=Fd(e,s,n,t);return delete e.sdkProcessingMetadata,bt(i,[[{type:a},e]])}const Hd="7";function Kd(e){const t=e.protocol?`${e.protocol}:`:"",r=e.port?`:${e.port}`:"";return`${t}//${e.host}${r}${e.path?`/${e.path}`:""}/api/`}function Yd(e){return`${Kd(e)}${e.projectId}/envelope/`}function Xd(e,t){return bi({sentry_key:e.publicKey,sentry_version:Hd,...t&&{sentry_client:`${t.name}/${t.version}`}})}function Jd(e,t={}){const r=typeof t=="string"?t:t.tunnel,n=typeof t=="string"||!t._metadata?void 0:t._metadata.sdk;return r||`${Yd(e)}?${Xd(e,n)}`}const Da=[];function Qd(e){const t={};return e.forEach(r=>{const{name:n}=r,s=t[n];s&&!s.isDefaultInstance&&r.isDefaultInstance||(t[n]=r)}),Object.keys(t).map(r=>t[r])}function Zd(e){const t=e.defaultIntegrations||[],r=e.integrations;t.forEach(i=>{i.isDefaultInstance=!0});let n;Array.isArray(r)?n=[...t,...r]:typeof r=="function"?n=Si(r(t)):n=t;const s=Qd(n),a=tu(s,i=>i.name==="Debug");if(a!==-1){const[i]=s.splice(a,1);s.push(i)}return s}function eu(e,t){const r={};return t.forEach(n=>{n&&Aa(e,n,r)}),r}function Ca(e,t){for(const r of t)r&&r.afterAllSetup&&r.afterAllSetup(e)}function Aa(e,t,r){if(r[t.name]){ne&&U.log(`Integration skipped because it was already installed: ${t.name}`);return}if(r[t.name]=t,Da.indexOf(t.name)===-1&&(t.setupOnce(Ti,_s),Da.push(t.name)),t.setup&&typeof t.setup=="function"&&t.setup(e),e.on&&typeof t.preprocessEvent=="function"){const n=t.preprocessEvent.bind(t);e.on("preprocessEvent",(s,a)=>n(s,a,e))}if(e.addEventProcessor&&typeof t.processEvent=="function"){const n=t.processEvent.bind(t),s=Object.assign((a,i)=>n(a,i,e),{id:t.name});e.addEventProcessor(s)}ne&&U.log(`Integration installed: ${t.name}`)}function tu(e,t){for(let r=0;r<e.length;r++)if(t(e[r])===!0)return r;return-1}function Ze(e,t){return Object.assign(function(...r){return t(...r)},{id:e})}function ru(e){let t="";for(const r of e){const n=Object.entries(r.tags),s=n.length>0?`|#${n.map(([a,i])=>`${a}:${i}`).join(",")}`:"";t+=`${r.name}@${r.unit}:${r.metric}|${r.metricType}${s}|T${r.timestamp}
`}return t}function nu(e,t,r,n){const s={sent_at:new Date().toISOString()};r&&r.sdk&&(s.sdk={name:r.sdk.name,version:r.sdk.version}),n&&t&&(s.dsn=Bt(t));const a=su(e);return bt(s,[a])}function su(e){const t=ru(e);return[{type:"statsd",length:t.length},t]}const Ra="Not capturing exception because it's already been captured.";class au{constructor(t){if(this._options=t,this._integrations={},this._integrationsInitialized=!1,this._numProcessing=0,this._outcomes={},this._hooks={},this._eventProcessors=[],t.dsn?this._dsn=ad(t.dsn):ne&&U.warn("No DSN provided, client will not send events."),this._dsn){const r=Jd(this._dsn,t);this._transport=t.transport({tunnel:this._options.tunnel,recordDroppedEvent:this.recordDroppedEvent.bind(this),...t.transportOptions,url:r})}}captureException(t,r,n){if(ws(t)){ne&&U.log(Ra);return}let s=r&&r.event_id;return this._process(this.eventFromException(t,r).then(a=>this._captureEvent(a,r,n)).then(a=>{s=a})),s}captureMessage(t,r,n,s){let a=n&&n.event_id;const i=bs(t)?t:String(t),o=zr(t)?this.eventFromMessage(i,r,n):this.eventFromException(t,n);return this._process(o.then(p=>this._captureEvent(p,n,s)).then(p=>{a=p})),a}captureEvent(t,r,n){if(r&&r.originalException&&ws(r.originalException)){ne&&U.log(Ra);return}let s=r&&r.event_id;const a=(t.sdkProcessingMetadata||{}).capturedSpanScope;return this._process(this._captureEvent(t,r,a||n).then(i=>{s=i})),s}captureSession(t){typeof t.release!="string"?ne&&U.warn("Discarded session because of missing or non-string release"):(this.sendSession(t),vs(t,{init:!1}))}getDsn(){return this._dsn}getOptions(){return this._options}getSdkMetadata(){return this._options._metadata}getTransport(){return this._transport}flush(t){const r=this._transport;return r?(this.metricsAggregator&&this.metricsAggregator.flush(),this._isClientDoneProcessing(t).then(n=>r.flush(t).then(s=>n&&s))):gt(!0)}close(t){return this.flush(t).then(r=>(this.getOptions().enabled=!1,this.metricsAggregator&&this.metricsAggregator.close(),r))}getEventProcessors(){return this._eventProcessors}addEventProcessor(t){this._eventProcessors.push(t)}setupIntegrations(t){(t&&!this._integrationsInitialized||this._isEnabled()&&!this._integrationsInitialized)&&this._setupIntegrations()}init(){this._isEnabled()&&this._setupIntegrations()}getIntegrationById(t){return this.getIntegrationByName(t)}getIntegrationByName(t){return this._integrations[t]}getIntegration(t){try{return this._integrations[t.id]||null}catch{return ne&&U.warn(`Cannot retrieve integration ${t.id} from the current Client`),null}}addIntegration(t){const r=this._integrations[t.name];Aa(this,t,this._integrations),r||Ca(this,[t])}sendEvent(t,r={}){this.emit("beforeSendEvent",t,r);let n=Vd(t,this._dsn,this._options._metadata,this._options.tunnel);for(const a of r.attachments||[])n=Ld(n,Md(a,this._options.transportOptions&&this._options.transportOptions.textEncoder));const s=this._sendEnvelope(n);s&&s.then(a=>this.emit("afterSendEvent",t,a),null)}sendSession(t){const r=Gd(t,this._dsn,this._options._metadata,this._options.tunnel);this._sendEnvelope(r)}recordDroppedEvent(t,r,n){if(this._options.sendClientReports){const s=typeof n=="number"?n:1,a=`${t}:${r}`;ne&&U.log(`Recording outcome: "${a}"${s>1?` (${s} times)`:""}`),this._outcomes[a]=(this._outcomes[a]||0)+s}}captureAggregateMetrics(t){ne&&U.log(`Flushing aggregated metrics, number of metrics: ${t.length}`);const r=nu(t,this._dsn,this._options._metadata,this._options.tunnel);this._sendEnvelope(r)}on(t,r){this._hooks[t]||(this._hooks[t]=[]),this._hooks[t].push(r)}emit(t,...r){this._hooks[t]&&this._hooks[t].forEach(n=>n(...r))}_setupIntegrations(){const{integrations:t}=this._options;this._integrations=eu(this,t),Ca(this,t),this._integrationsInitialized=!0}_updateSessionFromEvent(t,r){let n=!1,s=!1;const a=r.exception&&r.exception.values;if(a){s=!0;for(const o of a){const p=o.mechanism;if(p&&p.handled===!1){n=!0;break}}}const i=t.status==="ok";(i&&t.errors===0||i&&n)&&(vs(t,{...n&&{status:"crashed"},errors:t.errors||Number(s||n)}),this.captureSession(t))}_isClientDoneProcessing(t){return new Br(r=>{let n=0;const s=1,a=setInterval(()=>{this._numProcessing==0?(clearInterval(a),r(!0)):(n+=s,t&&n>=t&&(clearInterval(a),r(!1)))},s)})}_isEnabled(){return this.getOptions().enabled!==!1&&this._transport!==void 0}_prepareEvent(t,r,n,s=ki()){const a=this.getOptions(),i=Object.keys(this._integrations);return!r.integrations&&i.length>0&&(r.integrations=i),this.emit("preprocessEvent",t,r),Ei(a,t,r,n,this,s).then(o=>{if(o===null)return o;const p={...s.getPropagationContext(),...n?n.getPropagationContext():void 0};if(!(o.contexts&&o.contexts.trace)&&p){const{traceId:u,spanId:h,parentSpanId:m,dsc:y}=p;o.contexts={trace:{trace_id:u,span_id:h,parent_span_id:m},...o.contexts};const w=y||Ii(u,this,n);o.sdkProcessingMetadata={dynamicSamplingContext:w,...o.sdkProcessingMetadata}}return o})}_captureEvent(t,r={},n){return this._processEvent(t,r,n).then(s=>s.event_id,s=>{if(ne){const a=s;a.logLevel==="log"?U.log(a.message):U.warn(a)}})}_processEvent(t,r,n){const s=this.getOptions(),{sampleRate:a}=s,i=La(t),o=Oa(t),p=t.type||"error",u=`before send for type \`${p}\``;if(o&&typeof a=="number"&&Math.random()>a)return this.recordDroppedEvent("sample_rate","error",t),qr(new Ue(`Discarding event because it's not included in the random sample (sampling rate = ${a})`,"log"));const h=p==="replay_event"?"replay":p,m=(t.sdkProcessingMetadata||{}).capturedSpanIsolationScope;return this._prepareEvent(t,r,n,m).then(y=>{if(y===null)throw this.recordDroppedEvent("event_processor",h,t),new Ue("An event processor returned `null`, will not send event.","log");if(r.data&&r.data.__sentry__===!0)return y;const w=iu(s,y,r);return ou(w,u)}).then(y=>{if(y===null){if(this.recordDroppedEvent("before_send",h,t),i){const v=1+(t.spans||[]).length;this.recordDroppedEvent("before_send","span",v)}throw new Ue(`${u} returned \`null\`, will not send event.`,"log")}const w=n&&n.getSession();if(!i&&w&&this._updateSessionFromEvent(w,y),i){const v=y.sdkProcessingMetadata&&y.sdkProcessingMetadata.spanCountBeforeProcessing||0,S=y.spans?y.spans.length:0,D=v-S;D>0&&this.recordDroppedEvent("before_send","span",D)}const b=y.transaction_info;if(i&&b&&y.transaction!==t.transaction){const v="custom";y.transaction_info={...b,source:v}}return this.sendEvent(y,r),y}).then(null,y=>{throw y instanceof Ue?y:(this.captureException(y,{data:{__sentry__:!0},originalException:y}),new Ue(`Event processing pipeline threw an error, original event will not be sent. Details have been sent as a new event.
Reason: ${y}`))})}_process(t){this._numProcessing++,t.then(r=>(this._numProcessing--,r),r=>(this._numProcessing--,r))}_sendEnvelope(t){if(this.emit("beforeEnvelope",t),this._isEnabled()&&this._transport)return this._transport.send(t).then(null,r=>{ne&&U.error("Error while sending event:",r)});ne&&U.error("Transport disabled")}_clearOutcomes(){const t=this._outcomes;return this._outcomes={},Object.keys(t).map(r=>{const[n,s]=r.split(":");return{reason:n,category:s,quantity:t[r]}})}}function ou(e,t){const r=`${t} must return \`null\` or a valid event.`;if(Di(e))return e.then(n=>{if(!Gr(n)&&n!==null)throw new Ue(r);return n},n=>{throw new Ue(`${t} rejected with ${n}`)});if(!Gr(e)&&e!==null)throw new Ue(r);return e}function iu(e,t,r){const{beforeSend:n,beforeSendTransaction:s}=e;if(Oa(t)&&n)return n(t,r);if(La(t)&&s){if(t.spans){const a=t.spans.length;t.sdkProcessingMetadata={...t.sdkProcessingMetadata,spanCountBeforeProcessing:a}}return s(t,r)}return t}function Oa(e){return e.type===void 0}function La(e){return e.type==="transaction"}function cu(e,t){t.debug===!0&&(ne?U.enable():hs(()=>{console.warn("[Sentry] Cannot initialize SDK with `debug` option using a non-debug bundle.")})),Ci().update(t.initialScope);const r=new e(t);lu(r),du(r)}function lu(e){const t=_s().getStackTop();t.client=e,t.scope.setClient(e)}function du(e){e.init?e.init():e.setupIntegrations&&e.setupIntegrations()}const uu=30;function Pa(e,t,r=Ad(e.bufferSize||uu)){let n={};const s=i=>r.drain(i);function a(i){const o=[];if(Ea(i,(m,y)=>{const w=Ia(y);if(qd(n,w)){const b=xa(m,y);e.recordDroppedEvent("ratelimit_backoff",w,b)}else o.push(m)}),o.length===0)return gt();const p=bt(i[0],o),u=m=>{Ea(p,(y,w)=>{const b=xa(y,w);e.recordDroppedEvent(m,Ia(w),b)})},h=()=>t({body:Pd(p,e.textEncoder)}).then(m=>(m.statusCode!==void 0&&(m.statusCode<200||m.statusCode>=300)&&ne&&U.warn(`Sentry responded with status code ${m.statusCode} to sent event.`),n=Bd(n,m),m),m=>{throw u("network_error"),m});return r.add(h).then(m=>m,m=>{if(m instanceof Ue)return ne&&U.error("Skipped sending event because buffer is full."),u("queue_overflow"),gt();throw m})}return a.__sentry__baseTransport__=!0,{send:a,flush:s}}function xa(e,t){if(!(t!=="event"&&t!=="transaction"))return Array.isArray(e)?e[1]:void 0}function pu(e,t,r=[t],n="npm"){const s=e._metadata||{};s.sdk||(s.sdk={name:`sentry.javascript.${t}`,packages:r.map(a=>({name:`${n}:@sentry/${a}`,version:Ss})),version:Ss}),e._metadata=s}const gu=[/^Script error\.?$/,/^Javascript error: Script error\.? on line 0$/,/^ResizeObserver loop completed with undelivered notifications.$/,/^Cannot redefine property: googletag$/],hu=[/^.*\/healthcheck$/,/^.*\/healthy$/,/^.*\/live$/,/^.*\/ready$/,/^.*\/heartbeat$/,/^.*\/health$/,/^.*\/healthz$/],Ma="InboundFilters",mu=(e={})=>({name:Ma,setupOnce(){},processEvent(t,r,n){const s=n.getOptions(),a=fu(e,s);return yu(t,a)?null:t}}),Na=mu;Ze(Ma,Na);function fu(e={},t={}){return{allowUrls:[...e.allowUrls||[],...t.allowUrls||[]],denyUrls:[...e.denyUrls||[],...t.denyUrls||[]],ignoreErrors:[...e.ignoreErrors||[],...t.ignoreErrors||[],...e.disableErrorDefaults?[]:gu],ignoreTransactions:[...e.ignoreTransactions||[],...t.ignoreTransactions||[],...e.disableTransactionDefaults?[]:hu],ignoreInternal:e.ignoreInternal!==void 0?e.ignoreInternal:!0}}function yu(e,t){return t.ignoreInternal&&Tu(e)?(ne&&U.warn(`Event dropped due to being internal Sentry Error.
Event: ${Xe(e)}`),!0):_u(e,t.ignoreErrors)?(ne&&U.warn(`Event dropped due to being matched by \`ignoreErrors\` option.
Event: ${Xe(e)}`),!0):wu(e,t.ignoreTransactions)?(ne&&U.warn(`Event dropped due to being matched by \`ignoreTransactions\` option.
Event: ${Xe(e)}`),!0):vu(e,t.denyUrls)?(ne&&U.warn(`Event dropped due to being matched by \`denyUrls\` option.
Event: ${Xe(e)}.
Url: ${wr(e)}`),!0):bu(e,t.allowUrls)?!1:(ne&&U.warn(`Event dropped due to not being matched by \`allowUrls\` option.
Event: ${Xe(e)}.
Url: ${wr(e)}`),!0)}function _u(e,t){return e.type||!t||!t.length?!1:Su(e).some(r=>sr(r,t))}function wu(e,t){if(e.type!=="transaction"||!t||!t.length)return!1;const r=e.transaction;return r?sr(r,t):!1}function vu(e,t){if(!t||!t.length)return!1;const r=wr(e);return r?sr(r,t):!1}function bu(e,t){if(!t||!t.length)return!0;const r=wr(e);return r?sr(r,t):!0}function Su(e){const t=[];e.message&&t.push(e.message);let r;try{r=e.exception.values[e.exception.values.length-1]}catch{}return r&&r.value&&(t.push(r.value),r.type&&t.push(`${r.type}: ${r.value}`)),ne&&t.length===0&&U.error(`Could not extract message for event ${Xe(e)}`),t}function Tu(e){try{return e.exception.values[0].type==="SentryError"}catch{}return!1}function Eu(e=[]){for(let t=e.length-1;t>=0;t--){const r=e[t];if(r&&r.filename!=="<anonymous>"&&r.filename!=="[native code]")return r.filename||null}return null}function wr(e){try{let t;try{t=e.exception.values[0].stacktrace.frames}catch{}return t?Eu(t):null}catch{return ne&&U.error(`Cannot extract url for event ${Xe(e)}`),null}}let Fa;const Ua="FunctionToString",$a=new WeakMap,Iu=()=>({name:Ua,setupOnce(){Fa=Function.prototype.toString;try{Function.prototype.toString=function(...e){const t=Vr(this),r=$a.has(Pe())&&t!==void 0?t:this;return Fa.apply(r,e)}}catch{}},setup(e){$a.set(e,!0)}}),ja=Iu;Ze(Ua,ja);const V=me;let Cn=0;function Wa(){return Cn>0}function ku(){Cn++,setTimeout(()=>{Cn--})}function St(e,t={},r){if(typeof e!="function")return e;try{const s=e.__sentry_wrapped__;if(s)return typeof s=="function"?s:e;if(Vr(e))return e}catch{return e}const n=function(){const s=Array.prototype.slice.call(arguments);try{r&&typeof r=="function"&&r.apply(this,arguments);const a=s.map(i=>St(i,t));return e.apply(this,a)}catch(a){throw ku(),Ri(i=>{i.addEventProcessor(o=>(t.mechanism&&(Hr(o,void 0,void 0),ar(o,t.mechanism)),o.extra={...o.extra,arguments:s},o)),W(a)}),a}};try{for(const s in e)Object.prototype.hasOwnProperty.call(e,s)&&(n[s]=e[s])}catch{}Ai(n,e),Wr(e,"__sentry_wrapped__",n);try{Object.getOwnPropertyDescriptor(n,"name").configurable&&Object.defineProperty(n,"name",{get(){return e.name}})}catch{}return n}const Ge=typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__;function qa(e,t){const r=Rn(e,t),n={type:t&&t.name,value:Ru(t)};return r.length&&(n.stacktrace={frames:r}),n.type===void 0&&n.value===""&&(n.value="Unrecoverable error caught"),n}function Du(e,t,r,n){const s=Pe(),a=s&&s.getOptions().normalizeDepth,i={exception:{values:[{type:Yr(t)?t.constructor.name:n?"UnhandledRejection":"Error",value:Pu(t,{isUnhandledRejection:n})}]},extra:{__serialized__:Pi(t,a)}};if(r){const o=Rn(e,r);o.length&&(i.exception.values[0].stacktrace={frames:o})}return i}function An(e,t){return{exception:{values:[qa(e,t)]}}}function Rn(e,t){const r=t.stacktrace||t.stack||"",n=Au(t);try{return e(r,n)}catch{}return[]}const Cu=/Minified React error #\d+;/i;function Au(e){if(e){if(typeof e.framesToPop=="number")return e.framesToPop;if(Cu.test(e.message))return 1}return 0}function Ru(e){const t=e&&e.message;return t?t.error&&typeof t.error.message=="string"?t.error.message:t:"No error message"}function Ou(e,t,r,n){const s=r&&r.syntheticException||void 0,a=On(e,t,s,n);return ar(a),a.level="error",r&&r.event_id&&(a.event_id=r.event_id),gt(a)}function Lu(e,t,r="info",n,s){const a=n&&n.syntheticException||void 0,i=Ln(e,t,a,s);return i.level=r,n&&n.event_id&&(i.event_id=n.event_id),gt(i)}function On(e,t,r,n,s){let a;if(Kr(t)&&t.error)return An(e,t.error);if(Ts(t)||Oi(t)){const i=t;if("stack"in t)a=An(e,t);else{const o=i.name||(Ts(i)?"DOMError":"DOMException"),p=i.message?`${o}: ${i.message}`:o;a=Ln(e,p,r,n),Hr(a,p)}return"code"in i&&(a.tags={...a.tags,"DOMException.code":`${i.code}`}),a}return Li(t)?An(e,t):Gr(t)||Yr(t)?(a=Du(e,t,r,s),ar(a,{synthetic:!0}),a):(a=Ln(e,t,r,n),Hr(a,`${t}`,void 0),ar(a,{synthetic:!0}),a)}function Ln(e,t,r,n){const s={};if(n&&r){const a=Rn(e,r);a.length&&(s.exception={values:[{value:t,stacktrace:{frames:a}}]})}if(bs(t)){const{__sentry_template_string__:a,__sentry_template_values__:i}=t;return s.logentry={message:a,params:i},s}return s.message=t,s}function Pu(e,{isUnhandledRejection:t}){const r=xi(e),n=t?"promise rejection":"exception";return Kr(e)?`Event \`ErrorEvent\` captured as ${n} with message \`${e.message}\``:Yr(e)?`Event \`${xu(e)}\` (type=${e.type}) captured as ${n}`:`Object captured as ${n} with keys: ${r}`}function xu(e){try{const t=Object.getPrototypeOf(e);return t?t.constructor.name:void 0}catch{}}function Mu(e,{metadata:t,tunnel:r,dsn:n}){const s={event_id:e.event_id,sent_at:new Date().toISOString(),...t&&t.sdk&&{sdk:{name:t.sdk.name,version:t.sdk.version}},...!!r&&!!n&&{dsn:Bt(n)}},a=Nu(e);return bt(s,[a])}function Nu(e){return[{type:"user_report"},e]}class Fu extends au{constructor(t){const r=V.SENTRY_SDK_SOURCE||Cd();pu(t,"browser",["browser"],r),super(t),t.sendClientReports&&V.document&&V.document.addEventListener("visibilitychange",()=>{V.document.visibilityState==="hidden"&&this._flushOutcomes()})}eventFromException(t,r){return Ou(this._options.stackParser,t,r,this._options.attachStacktrace)}eventFromMessage(t,r="info",n){return Lu(this._options.stackParser,t,r,n,this._options.attachStacktrace)}captureUserFeedback(t){if(!this._isEnabled()){Ge&&U.warn("SDK not enabled, will not capture user feedback.");return}const r=Mu(t,{metadata:this.getSdkMetadata(),dsn:this.getDsn(),tunnel:this.getOptions().tunnel});this._sendEnvelope(r)}_prepareEvent(t,r,n){return t.platform=t.platform||"javascript",super._prepareEvent(t,r,n)}_flushOutcomes(){const t=this._clearOutcomes();if(t.length===0){Ge&&U.log("No outcomes to send");return}if(!this._dsn){Ge&&U.log("No dsn provided, will not send outcomes");return}Ge&&U.log("Sending outcomes:",t);const r=Ud(t,this._options.tunnel&&Bt(this._dsn));this._sendEnvelope(r)}}let Vt;function Uu(){if(Vt)return Vt;if(En(V.fetch))return Vt=V.fetch.bind(V);const e=V.document;let t=V.fetch;if(e&&typeof e.createElement=="function")try{const r=e.createElement("iframe");r.hidden=!0,e.head.appendChild(r);const n=r.contentWindow;n&&n.fetch&&(t=n.fetch),e.head.removeChild(r)}catch(r){Ge&&U.warn("Could not create sandbox iframe for pure fetch check, bailing to window.fetch: ",r)}return Vt=t.bind(V)}function $u(){Vt=void 0}function ju(e,t=Uu()){let r=0,n=0;function s(a){const i=a.body.length;r+=i,n++;const o={body:a.body,method:"POST",referrerPolicy:"origin",headers:e.headers,keepalive:r<=6e4&&n<15,...e.fetchOptions};try{return t(e.url,o).then(p=>(r-=i,n--,{statusCode:p.status,headers:{"x-sentry-rate-limits":p.headers.get("X-Sentry-Rate-Limits"),"retry-after":p.headers.get("Retry-After")}}))}catch(p){return $u(),r-=i,n--,qr(p)}}return Pa(e,s)}const Wu=4;function qu(e){function t(r){return new Br((n,s)=>{const a=new XMLHttpRequest;a.onerror=s,a.onreadystatechange=()=>{a.readyState===Wu&&n({statusCode:a.status,headers:{"x-sentry-rate-limits":a.getResponseHeader("X-Sentry-Rate-Limits"),"retry-after":a.getResponseHeader("Retry-After")}})},a.open("POST",e.url);for(const i in e.headers)Object.prototype.hasOwnProperty.call(e.headers,i)&&a.setRequestHeader(i,e.headers[i]);a.send(r.body)})}return Pa(e,t)}const vr="?",Bu=30,zu=40,Gu=50;function Pn(e,t,r,n){const s={filename:e,function:t,in_app:!0};return r!==void 0&&(s.lineno=r),n!==void 0&&(s.colno=n),s}const Vu=/^\s*at (?:(.+?\)(?: \[.+\])?|.*?) ?\((?:address at )?)?(?:async )?((?:<anonymous>|[-a-z]+:|.*bundle|\/)?.*?)(?::(\d+))?(?::(\d+))?\)?\s*$/i,Hu=/\((\S*)(?::(\d+))(?::(\d+))\)/,Ku=e=>{const t=Vu.exec(e);if(t){if(t[2]&&t[2].indexOf("eval")===0){const s=Hu.exec(t[2]);s&&(t[2]=s[1],t[3]=s[2],t[4]=s[3])}const[r,n]=Ba(t[1]||vr,t[2]);return Pn(n,r,t[3]?+t[3]:void 0,t[4]?+t[4]:void 0)}},Yu=[Bu,Ku],Xu=/^\s*(.*?)(?:\((.*?)\))?(?:^|@)?((?:[-a-z]+)?:\/.*?|\[native code\]|[^@]*(?:bundle|\d+\.js)|\/[\w\-. /=]+)(?::(\d+))?(?::(\d+))?\s*$/i,Ju=/(\S+) line (\d+)(?: > eval line \d+)* > eval/i,Qu=e=>{const t=Xu.exec(e);if(t){if(t[3]&&t[3].indexOf(" > eval")>-1){const s=Ju.exec(t[3]);s&&(t[1]=t[1]||"eval",t[3]=s[1],t[4]=s[2],t[5]="")}let r=t[3],n=t[1]||vr;return[n,r]=Ba(n,r),Pn(r,n,t[4]?+t[4]:void 0,t[5]?+t[5]:void 0)}},Zu=[Gu,Qu],ep=/^\s*at (?:((?:\[object object\])?.+) )?\(?((?:[-a-z]+):.*?):(\d+)(?::(\d+))?\)?\s*$/i,tp=e=>{const t=ep.exec(e);return t?Pn(t[2],t[1]||vr,+t[3],t[4]?+t[4]:void 0):void 0},rp=[zu,tp],np=[Yu,Zu,rp],sp=Mi(...np),Ba=(e,t)=>{const r=e.indexOf("safari-extension")!==-1,n=e.indexOf("safari-web-extension")!==-1;return r||n?[e.indexOf("@")!==-1?e.split("@")[0]:vr,r?`safari-extension:${t}`:`safari-web-extension:${t}`]:[e,t]},br=1024,za="Breadcrumbs",ap=(e={})=>{const t={console:!0,dom:!0,fetch:!0,history:!0,sentry:!0,xhr:!0,...e};return{name:za,setupOnce(){},setup(r){t.console&&od(cp(r)),t.dom&&ld(ip(r,t.dom)),t.xhr&&Id(lp(r)),t.fetch&&md(dp(r)),t.history&&Ta(up(r)),t.sentry&&r.on&&r.on("beforeSendEvent",op(r))}}},Ga=ap;Ze(za,Ga);function op(e){return function(t){Pe()===e&&X({category:`sentry.${t.type==="transaction"?"transaction":"event"}`,event_id:t.event_id,level:t.level,message:Xe(t)},{event:t})}}function ip(e,t){return function(r){if(Pe()!==e)return;let n,s,a=typeof t=="object"?t.serializeAttribute:void 0,i=typeof t=="object"&&typeof t.maxStringLength=="number"?t.maxStringLength:void 0;i&&i>br&&(Ge&&U.warn(`\`dom.maxStringLength\` cannot exceed ${br}, but a value of ${i} was configured. Sentry will use ${br} instead.`),i=br),typeof a=="string"&&(a=[a]);try{const p=r.event,u=pp(p)?p.target:p;n=Ni(u,{keyAttrs:a,maxStringLength:i}),s=Fi(u)}catch{n="<unknown>"}if(n.length===0)return;const o={category:`ui.${r.name}`,message:n};s&&(o.data={"ui.component_name":s}),X(o,{event:r.event,name:r.name,global:r.global})}}function cp(e){return function(t){if(Pe()!==e)return;const r={category:"console",data:{arguments:t.args,logger:"console"},level:Od(t.level),message:Es(t.args," ")};if(t.level==="assert")if(t.args[0]===!1)r.message=`Assertion failed: ${Es(t.args.slice(1)," ")||"console.assert"}`,r.data.arguments=t.args.slice(1);else return;X(r,{input:t.args,level:t.level})}}function lp(e){return function(t){if(Pe()!==e)return;const{startTimestamp:r,endTimestamp:n}=t,s=t.xhr[Gt];if(!r||!n||!s)return;const{method:a,url:i,status_code:o,body:p}=s,u={method:a,url:i,status_code:o},h={xhr:t.xhr,input:p,startTimestamp:r,endTimestamp:n};X({category:"xhr",data:u,type:"http"},h)}}function dp(e){return function(t){if(Pe()!==e)return;const{startTimestamp:r,endTimestamp:n}=t;if(n&&!(t.fetchData.url.match(/sentry_key/)&&t.fetchData.method==="POST"))if(t.error){const s=t.fetchData,a={data:t.error,input:t.args,startTimestamp:r,endTimestamp:n};X({category:"fetch",data:s,level:"error",type:"http"},a)}else{const s=t.response,a={...t.fetchData,status_code:s&&s.status},i={input:t.args,response:s,startTimestamp:r,endTimestamp:n};X({category:"fetch",data:a,type:"http"},i)}}}function up(e){return function(t){if(Pe()!==e)return;let r=t.from,n=t.to;const s=kn(V.location.href);let a=r?kn(r):void 0;const i=kn(n);(!a||!a.path)&&(a=s),s.protocol===i.protocol&&s.host===i.host&&(n=i.relative),s.protocol===a.protocol&&s.host===a.host&&(r=a.relative),X({category:"navigation",data:{from:r,to:n}})}}function pp(e){return!!e&&!!e.target}const Va="Dedupe",gp=()=>{let e;return{name:Va,setupOnce(){},processEvent(t){if(t.type)return t;try{if(hp(t,e))return Ge&&U.warn("Event dropped due to being a duplicate of previously captured event."),null}catch{}return e=t}}},Ha=gp;Ze(Va,Ha);function hp(e,t){return t?!!(mp(e,t)||fp(e,t)):!1}function mp(e,t){const r=e.message,n=t.message;return!(!r&&!n||r&&!n||!r&&n||r!==n||!Ya(e,t)||!Ka(e,t))}function fp(e,t){const r=Xa(t),n=Xa(e);return!(!r||!n||r.type!==n.type||r.value!==n.value||!Ya(e,t)||!Ka(e,t))}function Ka(e,t){let r=Ja(e),n=Ja(t);if(!r&&!n)return!0;if(r&&!n||!r&&n||(r=r,n=n,n.length!==r.length))return!1;for(let s=0;s<n.length;s++){const a=n[s],i=r[s];if(a.filename!==i.filename||a.lineno!==i.lineno||a.colno!==i.colno||a.function!==i.function)return!1}return!0}function Ya(e,t){let r=e.fingerprint,n=t.fingerprint;if(!r&&!n)return!0;if(r&&!n||!r&&n)return!1;r=r,n=n;try{return r.join("")===n.join("")}catch{return!1}}function Xa(e){return e.exception&&e.exception.values&&e.exception.values[0]}function Ja(e){const t=e.exception;if(t)try{return t.values[0].stacktrace.frames}catch{return}}const Qa="GlobalHandlers",yp=(e={})=>{const t={onerror:!0,onunhandledrejection:!0,...e};return{name:Qa,setupOnce(){Error.stackTraceLimit=50},setup(r){t.onerror&&(_p(r),to("onerror")),t.onunhandledrejection&&(wp(r),to("onunhandledrejection"))}}},Za=yp;Ze(Qa,Za);function _p(e){_d(t=>{const{stackParser:r,attachStacktrace:n}=ro();if(Pe()!==e||Wa())return;const{msg:s,url:a,line:i,column:o,error:p}=t,u=p===void 0&&pt(s)?Sp(s,a,i,o):eo(On(r,p||s,void 0,n,!1),a,i,o);u.level="error",Is(u,{originalException:p,mechanism:{handled:!1,type:"onerror"}})})}function wp(e){vd(t=>{const{stackParser:r,attachStacktrace:n}=ro();if(Pe()!==e||Wa())return;const s=vp(t),a=zr(s)?bp(s):On(r,s,void 0,n,!0);a.level="error",Is(a,{originalException:s,mechanism:{handled:!1,type:"onunhandledrejection"}})})}function vp(e){if(zr(e))return e;const t=e;try{if("reason"in t)return t.reason;if("detail"in t&&"reason"in t.detail)return t.detail.reason}catch{}return e}function bp(e){return{exception:{values:[{type:"UnhandledRejection",value:`Non-Error promise rejection captured with value: ${String(e)}`}]}}}function Sp(e,t,r,n){const s=/^(?:[Uu]ncaught (?:exception: )?)?(?:((?:Eval|Internal|Range|Reference|Syntax|Type|URI|)Error): )?(.*)$/i;let a=Kr(e)?e.message:e,i="Error";const o=a.match(s);return o&&(i=o[1],a=o[2]),eo({exception:{values:[{type:i,value:a}]}},t,r,n)}function eo(e,t,r,n){const s=e.exception=e.exception||{},a=s.values=s.values||[],i=a[0]=a[0]||{},o=i.stacktrace=i.stacktrace||{},p=o.frames=o.frames||[],u=isNaN(parseInt(n,10))?void 0:n,h=isNaN(parseInt(r,10))?void 0:r,m=pt(t)&&t.length>0?t:Ui();return p.length===0&&p.push({colno:u,filename:m,function:"?",in_app:!0,lineno:h}),e}function to(e){Ge&&U.log(`Global Handler attached: ${e}`)}function ro(){const e=Pe();return e&&e.getOptions()||{stackParser:()=>[],attachStacktrace:!1}}const no="HttpContext",Tp=()=>({name:no,setupOnce(){},preprocessEvent(e){if(!V.navigator&&!V.location&&!V.document)return;const t=e.request&&e.request.url||V.location&&V.location.href,{referrer:r}=V.document||{},{userAgent:n}=V.navigator||{},s={...e.request&&e.request.headers,...r&&{Referer:r},...n&&{"User-Agent":n}},a={...e.request,...t&&{url:t},headers:s};e.request=a}}),so=Tp;Ze(no,so);const Ep="cause",Ip=5,ao="LinkedErrors",kp=(e={})=>{const t=e.limit||Ip,r=e.key||Ep;return{name:ao,setupOnce(){},preprocessEvent(n,s,a){const i=a.getOptions();Zl(qa,i.stackParser,i.maxValueLength,r,t,n,s)}}},oo=kp;Ze(ao,oo);const Dp=["EventTarget","Window","Node","ApplicationCache","AudioTrackList","BroadcastChannel","ChannelMergerNode","CryptoOperation","EventSource","FileReader","HTMLUnknownElement","IDBDatabase","IDBRequest","IDBTransaction","KeyOperation","MediaController","MessagePort","ModalWindow","Notification","SVGElementInstance","Screen","SharedWorker","TextTrack","TextTrackCue","TextTrackList","WebSocket","WebSocketWorker","Worker","XMLHttpRequest","XMLHttpRequestEventTarget","XMLHttpRequestUpload"],io="TryCatch",Cp=(e={})=>{const t={XMLHttpRequest:!0,eventTarget:!0,requestAnimationFrame:!0,setInterval:!0,setTimeout:!0,...e};return{name:io,setupOnce(){t.setTimeout&&ge(V,"setTimeout",lo),t.setInterval&&ge(V,"setInterval",lo),t.requestAnimationFrame&&ge(V,"requestAnimationFrame",Ap),t.XMLHttpRequest&&"XMLHttpRequest"in V&&ge(XMLHttpRequest.prototype,"send",Rp);const r=t.eventTarget;r&&(Array.isArray(r)?r:Dp).forEach(Op)}}},co=Cp;Ze(io,co);function lo(e){return function(...t){const r=t[0];return t[0]=St(r,{mechanism:{data:{function:at(e)},handled:!1,type:"instrument"}}),e.apply(this,t)}}function Ap(e){return function(t){return e.apply(this,[St(t,{mechanism:{data:{function:"requestAnimationFrame",handler:at(e)},handled:!1,type:"instrument"}})])}}function Rp(e){return function(...t){const r=this;return["onload","onerror","onprogress","onreadystatechange"].forEach(n=>{n in r&&typeof r[n]=="function"&&ge(r,n,function(s){const a={mechanism:{data:{function:n,handler:at(s)},handled:!1,type:"instrument"}},i=Vr(s);return i&&(a.mechanism.data.handler=at(i)),St(s,a)})}),e.apply(this,t)}}function Op(e){const t=V,r=t[e]&&t[e].prototype;!r||!r.hasOwnProperty||!r.hasOwnProperty("addEventListener")||(ge(r,"addEventListener",function(n){return function(s,a,i){try{typeof a.handleEvent=="function"&&(a.handleEvent=St(a.handleEvent,{mechanism:{data:{function:"handleEvent",handler:at(a),target:e},handled:!1,type:"instrument"}}))}catch{}return n.apply(this,[s,St(a,{mechanism:{data:{function:"addEventListener",handler:at(a),target:e},handled:!1,type:"instrument"}}),i])}}),ge(r,"removeEventListener",function(n){return function(s,a,i){const o=a;try{const p=o&&o.__sentry_wrapped__;p&&n.call(this,s,p,i)}catch{}return n.call(this,s,o,i)}}))}const Lp=[Na(),ja(),co(),Ga(),Za(),oo(),Ha(),so()];function Pp(e){return[...Lp]}function xp(e={}){e.defaultIntegrations===void 0&&(e.defaultIntegrations=Pp()),e.release===void 0&&(typeof __SENTRY_RELEASE__=="string"&&(e.release=__SENTRY_RELEASE__),V.SENTRY_RELEASE&&V.SENTRY_RELEASE.id&&(e.release=V.SENTRY_RELEASE.id)),e.autoSessionTracking===void 0&&(e.autoSessionTracking=!0),e.sendClientReports===void 0&&(e.sendClientReports=!0);const t={...e,stackParser:$i(e.stackParser||sp),integrations:Zd(e),transport:e.transport||(ba()?ju:qu)};cu(Fu,t),e.autoSessionTracking&&Mp()}function Mp(){if(typeof V.document>"u"){Ge&&U.warn("Session tracking in non-browser environment with @sentry/browser is not supported.");return}ks({ignoreDuration:!0}),Ds(),Ta(({from:e,to:t})=>{e!==void 0&&e!==t&&(ks({ignoreDuration:!0}),Ds())})}const Np=Q("preFlightChecks/setNetworkError"),xn=Q("preFlightChecks/setS3ConnectionError"),Mn=Q("preFlightChecks/setAssemblyAIConnectionError"),uo=Q("preFlightChecks/setBackendConnectionError"),Ht=Q("preFlightChecks/setIsRecordingStartedFromBrowser"),Fp=async({tabId:e,windowId:t})=>{const r=await chrome.tabs.get(e),n=await chrome.windows.get(t),{networkError:s,s3ConnectionError:a,backendConnectionError:i,isRecordingStartedFromBrowser:o}=Pt(d.getState()),p=(await chrome.tabs.query({})).length;d.dispatch(na(p));const{lastUsableContentWindowId:u}=fe(d.getState()),h=n.type==="normal"||n.type==="popup";n.focused&&h&&u!==t&&n.id&&d.dispatch(Cs(n.id)),r.id&&n.focused&&(d.dispatch(As(r.id)),o&&(s||a||i)&&(d.dispatch(Je(!0)),d.dispatch(Ht(!1)))),le(r,{messageType:"browserContextNeeded",browserContext:{tab:r,window:n}})},Nn=async()=>{const{lastUsableContentWindowId:e}=fe(d.getState()),{currentFocusedActiveTabId:t}=fe(d.getState()),r=await chrome.tabs.query({active:!0}),n=(await chrome.tabs.query({})).length;d.dispatch(na(n)),r.forEach(s=>{chrome.windows.get(s.windowId).then(a=>{s.id!==void 0&&(t===s.id&&e===a.id||(a.focused&&(a.type==="normal"||a.type==="popup")&&a.id&&d.dispatch(Cs(a.id)),a.focused&&s.active&&d.dispatch(As(s.id)),le(s,{messageType:"browserContextChanged",tab:s,window:a})))})})};chrome.tabs.onActivated.addListener(Fp),chrome.windows.onCreated.addListener(Nn),chrome.windows.onFocusChanged.addListener(Nn),chrome.runtime.onInstalled.addListener(Nn);const Up={}.NODE_ENV!=="production",po={}.NODE_ENV==="production",$p={}.VITE_E2E==="true";xp({debug:Up,dsn:"https://7f832b1e318847f49f65d4d716db714a@o385127.ingest.sentry.io/6071844",environment:po?"production":"development",enabled:po&&!$p,includeLocalVariables:!0,ignoreErrors:["Could not establish connection. Receiving end does not exist.","The message port closed before a response was received.","No host permissions for cookies at url","ResizeObserver loop limit exceeded","No tab with id"],beforeSend:function(e,t){const r=t.originalException;return r instanceof Wi&&(e.fingerprint=["extension-api-screenshot-error"]),r instanceof qi&&(e.fingerprint=["backup-screenshot-error"]),e}}),ji("version",chrome.runtime.getManifest().version.toString());const jp=e=>{try{return new URL(e),!0}catch{return!1}},Wp=(e,t)=>{if(!(t!==null&&t!==""&&t!==void 0&&jp(t)))return!1;const{baseDomain:r,pathSegments:n}=go(e),{baseDomain:s,pathSegments:a}=go(t),i=T=>T.replace(/^[a-zA-Z][a-zA-Z0-9+.-]*:\/\//,""),o=T=>i(T).replace(/:\d+$/,"").toLowerCase(),p=o(r),u=o(s);if(p!==u)return!1;const h=T=>T.split("#")[0].split("?")[0],m=n.map(h).filter(T=>T!=="").length,y=a.map(h).filter(T=>T!=="").length;if(m!==y)return!1;const w=n.map(h).filter(T=>T!==""),b=a.map(h).filter(T=>T!=="");for(let T=0;T<w.length;T+=1){const I=w[T],C=b[T];if(!(C===I||C==="*"))return!1}const v=T=>{const I=T.indexOf("#"),C=T.indexOf("?");return C!==-1&&(I===-1||C<I)?T.slice(C,I===-1?void 0:I):""},S=v(e),D=v(t);if(S!==D)return!1;const E=e.includes("#"),A=t.includes("#");return!(!E&&A)},go=e=>{const t=e.match(/^[a-zA-Z][a-zA-Z0-9+.-]*:\/\//);if(t){const a=e.slice(t[0].length).split("/").filter(p=>p!==""),i=t[0]+a[0],o=a.slice(1);return{baseDomain:i,pathSegments:o}}const r=e.split("/").filter(a=>a!==""),n=r[0]||"",s=r.slice(1);return{baseDomain:n,pathSegments:s}};let Ve=null,Tt={isOptimizeConfigured:!1,isDWActive:!1,isUrlStreamingActive:!1},Et=0,Fn=!1;const qp=30,ho=1,Bp=3,Un="dw-preference-sync",$n="dwPreferenceServiceState";function zp(e){if(!e)return{isOptimizeConfigured:Et>0,isDWActive:!1,isUrlStreamingActive:!1};const t=e.discovery_mode??0,r=Number(e.consent_status)===20;return{isOptimizeConfigured:!0,isDWActive:r&&(t===20||t===30),isUrlStreamingActive:r&&(t===10||t===30)}}function Gp(e,t){return e.isOptimizeConfigured===t.isOptimizeConfigured&&e.isDWActive===t.isDWActive&&e.isUrlStreamingActive===t.isUrlStreamingActive}function Vp(){const e=Math.random()*(Bp-ho)+ho;return qp+e}async function mo(){try{await chrome.alarms.clear(Un)}catch{}try{const e=Vp();chrome.alarms.create(Un,{delayInMinutes:e})}catch{}}let fo=!1;async function Hp(){var e;try{const t=(e=await chrome.storage.session.get($n))==null?void 0:e[$n];t&&typeof t=="object"&&(Ve=t.preference??null,Tt=t.derivedState??Tt,Et=typeof t.lastSyncedAt=="number"?t.lastSyncedAt:0)}catch{}}async function Kp(){try{const e={preference:Ve,derivedState:Tt,lastSyncedAt:Et};await chrome.storage.session.set({[$n]:e})}catch{}}async function Yp(e){if(await Promise.all([fn([]),yn([])]),!Array.isArray(e))return;const t=[],r=[];for(const n of e){if(!n||typeof n!="object")continue;const s=n;if(s.app_tag&&typeof s.app_tag=="object"){const i=s.app_tag;if(i&&typeof i.domain=="string"&&i.domain){r.push(i);continue}}const a=s.domain_fallback;typeof a=="string"&&a.trim().length>0&&t.push(a)}await Promise.all([fn(t),yn(r)])}function yo(e){if(!Array.isArray(e))return"none";const t=[],r=[];for(const n of e){if(!n||typeof n!="object")continue;const s=n,a=s==null?void 0:s.app_tag;if(a&&typeof a=="object"){const o=typeof a.id=="string"?a.id:void 0,p=typeof a.domain=="string"?a.domain.toLowerCase():"",u=typeof a.root_domain_url=="string"?a.root_domain_url.toLowerCase():"",h=Array.isArray(a.multi_root_domains_urls)?a.multi_root_domains_urls.filter(m=>typeof m=="string").map(m=>m.toLowerCase()).sort().join(";"):"";t.push(`${o??""}|${p}|${u}|${h}`)}const i=s==null?void 0:s.domain_fallback;typeof i=="string"&&i.trim()&&r.push(i.trim().toLowerCase())}return t.sort(),r.sort(),`t:${t.join(",")}|d:${r.join(",")}`}async function jn(e){var t;if(!Fn){Fn=!0;try{const r=(t=await ot())==null?void 0:t.token;if(!r)return;const n=`${K.BACKEND_BASE_URL}/discover_workflows/preferences/me/`,s=await fetch(n,{method:"GET",headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}});if(s.status<200||s.status>=300){Bi("DWPreferenceSync.Non2xx",{level:"warning",extra:{status:s.status,reason:e}});return}const a=await s.json();if(!a||typeof a!="object")return;const i=zp(a),o=yo(Ve==null?void 0:Ve.allowed_items),p=yo(a==null?void 0:a.allowed_items),u=!Ve||!Gp(i,Tt)||a.data_destination_org_id!==Ve.data_destination_org_id||p!==o;if(Ve=a,Tt=i,Et=Date.now(),p!==o)try{await Yp(a==null?void 0:a.allowed_items)}catch(h){W(h,{tags:{component:"discover_workflows"},extra:{context:"Failed to apply server allowlist"}})}if(await Kp(),u)try{chrome.runtime.sendMessage({messageType:"optionsChanged"})}catch{}}catch(r){W(r,{tags:{component:"discover_workflows"},extra:{context:"Failed to sync DW preferences"}})}finally{Fn=!1,await mo()}}}function Xp(){if(!fo)try{chrome.alarms.onAlarm.addListener(e=>{(e==null?void 0:e.name)===Un&&jn("scheduled")}),fo=!0}catch{}}function Jp(){Hp().then(()=>{try{chrome.runtime.sendMessage({messageType:"optionsChanged"})}catch{}}),Xp(),mo(),jn("startup")}function Qp(e="manual"){jn(e)}function we(){return{...Tt,lastSyncedAt:Et}}function Zp(){return{preference:Ve,lastSyncedAt:Et}}const Sr=(e,t)=>{let r=e.getState();const n=()=>{const a=e.getState();a!==r&&(t(r,a),r=a)},s=e.subscribe(n);return n(),s},_o=e=>{le(e,{messageType:"replaceStore",store:d.getState()})},eg=()=>{chrome.runtime.sendMessage({messageType:"replaceStore",store:d.getState()})},tg=()=>{chrome.tabs.query({active:!0}).then(e=>{e.forEach(t=>{_o(t)})}),eg()},rg=async()=>{Sr(d,tg),chrome.tabs.onActivated.addListener(e=>_o(e))};rg();const ye=128,Ae=128,ng=new OffscreenCanvas(ye,Ae),$e={iconContext:ng.getContext("2d",{willReadFrequently:!0}),recordingInterval:null,loadingInterval:null,startingTime:new Date,redOn:!0},sg=ye/6,ag=ye/2-2,og="#3730a3",ig="#f87171",cg="#1f2937",lg="#9ca3af",Kt=2500,dg=60,ug=e=>{const t=ye/2-1,r=Ae-2,n=e.createLinearGradient(0,0,0,ye);n.addColorStop(0,"#3730a3"),n.addColorStop(1,"#4f46e5");const s=e.createLinearGradient(0,0,0,ye);s.addColorStop(0,"#818cf8"),s.addColorStop(1,"#4f46e5");const a=2;e.lineWidth=16,e.save(),e.translate(ye/2,Ae/2),e.rotate(Math.PI*2*(new Date().getTime()%Kt/Kt)),e.translate(-ye/2+4,-Ae/2+4),e.beginPath(),e.rect(-a,-a,t+a,r+a*2),e.clip(),e.strokeStyle=n,e.beginPath(),e.arc(t-6,t-6,t-6,0,Math.PI*2,!1),e.stroke(),e.restore(),e.save(),e.translate(ye/2,Ae/2),e.rotate(Math.PI*2*(new Date().getTime()%Kt/Kt)),e.translate(-ye/2+4,-Ae/2+4),e.beginPath(),e.rect(t,-a,t+a,r+a*2),e.clip(),e.strokeStyle=s,e.beginPath(),e.arc(t-6,t-6,t-6,0,Math.PI*2,!1),e.stroke(),e.restore()},pg=(e,t)=>{e.beginPath(),e.arc(ye/2,Ae/2,ag,0,2*Math.PI,!1),e.fillStyle=t,e.strokeStyle=t,e.fill(),e.lineWidth=2,e.stroke()},wo=(e,t,r,n,s=sg)=>(e.save(),e.fillStyle=r,e.strokeStyle=r,pg(e,t),e.beginPath(),e.arc(ye/2,Ae/2,s,0,2*Math.PI,!1),e.fillStyle=n?r:t,e.strokeStyle=n?r:t,e.fill(),e.lineWidth=2,e.stroke(),e.restore(),e.getImageData(0,0,ye,Ae)),gg=e=>(e.save(),e.clearRect(0,0,ye,Ae),ug(e),e.restore(),e.getImageData(0,0,ye,Ae)),hg=()=>{$e.recordingInterval=setInterval(()=>{const e=new Date().getTime()%1500;chrome.action.setIcon({imageData:wo($e.iconContext,og,ig,e<=1e3)})},500)},mg=()=>{$e.loadingInterval=setInterval(()=>{chrome.action.setIcon({imageData:gg($e.iconContext)})},Kt/dg)},fg=()=>{chrome.action.setIcon({imageData:wo($e.iconContext,cg,lg,!0)})},yg=async e=>{try{const t=[16,48,128],r={};for(const n of t){const s=e[n],a=await(await fetch(s)).blob(),i=await createImageBitmap(a),o=new OffscreenCanvas(n,n).getContext("2d");o.drawImage(i,0,0,n,n);const p=o.getImageData(0,0,n,n),u=p.data;for(let h=0;h<u.length;h+=4){const m=.299*u[h]+.587*u[h+1]+.114*u[h+2];u[h]=m,u[h+1]=m,u[h+2]=m}o.putImageData(p,0,0),r[n]=o.getImageData(0,0,n,n),i.close()}return r}catch(t){throw t}},vo=(e=!0)=>{const t="production";chrome.management.getSelf(async r=>{const n=["development","sideload"];let s={};if(n.includes(r.installType)?s={16:chrome.runtime.getURL("logo-16-preview.png"),48:chrome.runtime.getURL("logo-48-preview.png"),128:chrome.runtime.getURL("logo-128-preview.png")}:s={16:chrome.runtime.getURL(`public/logo-16-${t}.png`),48:chrome.runtime.getURL(`public/logo-48-${t}.png`),128:chrome.runtime.getURL(`public/logo-128-${t}.png`)},e)chrome.action.setIcon({path:s});else{const a=await yg(s);chrome.action.setIcon({imageData:a})}})},_g=()=>{clearInterval($e.loadingInterval),clearInterval($e.recordingInterval),$e.loadingInterval=null,$e.recordingInterval=null},bo=(e,t=!0)=>{if(_g(),$e.iconContext.clearRect(0,0,ye,Ae),!xt(d.getState()))switch(e){case de.RECORDING:case de.STARTING_RECORDING:hg();break;case de.PAUSED_RECORDING:fg();break;case de.ENDING_RECORDING:mg();break;case de.IDLE:default:vo(t);break}},wg=(e,t)=>{const r=fe(e).status,n=fe(t).status,s=!!Xr(t);r!==n&&bo(n,s)},vg=(e,t)=>{const r=Xr(e),n=Xr(t),s=fe(t).status,a=!!r,i=!!n;(a!==i||!a&&!i&&s===de.IDLE)&&bo(s,i)};Sr(d,wg),Sr(d,vg);const bg=Q("globalVariables/setLastSentNotification"),So=Q("globalVariables/setDomains"),Sg=Q("globalVariables/setLastFetched"),To=Q("globalVariables/setCurrentRecommendedScribeCount"),Tg=Q("globalVariables/setDefaultName"),Eg=Q("globalVariables/setOs"),Ig=Q("globalVariables/updateLinkMap"),kg=Q("globalVariables/setIpAddress"),Dg=Q("globalVariables/setBenchmark"),Cg=Q("permissions/setMissingPermissions"),It=Q("pins/setPinDropping"),et=Q("pins/setPins"),Eo=Q("pins/setViewedPins"),Io=Q("pins/setHoveredPinId"),Tr=Q("pins/setPinDocument"),Ag=Q("pins/setPinShiftClickThrough"),Er=Q("pins/setPinsLoading"),Rg=Q("pins/setHiddenPinsUrlList"),Ir="https://api.assemblyai.com";async function ko(e,t={}){try{const r=await fetch(e,{cache:"no-cache",headers:t});if(r.ok)return P("server_reachable",{url:e}),r;throw P("server_unreachable",{url:e,status:r.status}),new Error(`Server is not reachable. Status: ${r.status}`)}catch(r){throw console.error("Error:",r),P("server_error",{url:e,error:r.message}),r}}async function Og(){return ko("https://scribe-api.scribehow.com/health_check/",{"X-Product":"extension","X-Product-Version":zi.version}).then(()=>{d.dispatch(uo(!1))}).catch(e=>{throw d.dispatch(uo(!0)),e})}async function Lg(){try{const e=await fetch(Ir,{cache:"no-cache"});if(e.status===404||e.status<400)return P("server_reachable",{url:Ir}),d.dispatch(Mn(!1)),!0;throw P("assemblyai_unreachable",{url:Ir,status:e.status}),d.dispatch(Mn(!0)),new Error(`AssemblyAI returned unexpected status: ${e.status}`)}catch(e){throw d.dispatch(Mn(!0)),console.error("AssemblyAI connection error:",e),P("assemblyai_unreachable",{url:Ir,error:e.message}),e}}async function Pg(){try{await ko("https://colony-recorder.s3-accelerate.amazonaws.com/connection-check.txt")}catch(t){throw d.dispatch(xn(!0)),t}const e="https://colony-labs-public.s3.us-east-2.amazonaws.com/test.json";try{const t=await fetch(e,{method:"HEAD"});if(!t.ok)throw new Error(`S3 bucket returned unexpected status: ${t.status}`);d.dispatch(xn(!1)),P("s3_put_reachable",{url:e})}catch(t){throw console.error("Error:",t),W(t),P("s3_put_unreachable",{url:e,error:t.message}),d.dispatch(xn(!0)),t}}async function kt(){return d.dispatch(Np(!1)),Promise.all([Og(),Pg(),Lg()]).then(()=>!0).catch(e=>(P("no_internet_connection"),!1))}class Do{constructor(t){Ye(this,"delay");Ye(this,"timeout",null);Ye(this,"queue",[]);this.delay=t}invoke(t){this.queue.push(t),this.timeout===null?(this.callLatest(),this.timeout=setTimeout(()=>{this.callLatest(),this.timeout=null},this.delay)):this.queue.push(t)}callLatest(){var t;(t=this.queue.pop())==null||t(),this.queue=[]}}const Wn="cortexDailySession";function xg(e=new Date){const t=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),n=String(e.getDate()).padStart(2,"0");return`${t}-${r}-${n}`}async function Mg(){var e;try{const t=(e=await chrome.storage.local.get(Wn))==null?void 0:e[Wn];if(t&&typeof t=="object"){const r=t;if(typeof r.id=="string"&&typeof r.date=="string")return{id:r.id,date:r.date}}}catch{}return null}async function Ng(e){try{await chrome.storage.local.set({[Wn]:e})}catch{}}async function Fg(){const e=xg(),t=await Mg();if(t&&t.date===e&&t.id)return t.id;const r=ze();return await Ng({id:r,date:e}),r}function Ug(){return ze()}async function $g(){const e=await Fg(),t=Ug();return{"X-Session-ID":e,"X-Request-ID":t}}const q="X-Session-ID",B="X-Request-ID",jg="ExtensionPreferences",Wg=1,Dt="settings";let kr=null;function Co(){return kr?Promise.resolve(kr):new Promise((e,t)=>{const r=indexedDB.open(jg,Wg);r.onupgradeneeded=()=>{const n=r.result;n.objectStoreNames.contains(Dt)||n.createObjectStore(Dt,{keyPath:"key"})},r.onsuccess=()=>{kr=r.result,e(kr)},r.onerror=()=>t(r.error)})}const Ao="dwActionLoggingEnabled";async function Ro(){const e=await Co();return new Promise(t=>{const r=e.transaction(Dt,"readonly").objectStore(Dt).get(Ao);r.onsuccess=()=>{var s;const n=(s=r.result)==null?void 0:s.value;t(!!n)},r.onerror=()=>t(!1)})}async function qg(e){const t=await Co();return new Promise((r,n)=>{const s=t.transaction(Dt,"readwrite").objectStore(Dt).put({key:Ao,value:!!e});s.onsuccess=()=>r(),s.onerror=()=>n(s.error)})}var qn={exports:{}};(function(e,t){(function(r,n){n(t)})(gr,function(r){var n={getItemSync:function(l){try{return localStorage.getItem(l)||null}catch{return null}},getItem:function(l,g){var c=this;return new Promise(function(f,_){try{var k=c.getItemSync(l);g==null||g(null,k),f(k)}catch(R){g&&g(R,null),_(R)}})},setItem:function(l,g,c){return new Promise(function(f,_){try{localStorage.setItem(l,g),c&&c(null,g),f(g)}catch(k){c&&c(k,null),_(k)}})}},s=function(){return s=Object.assign||function(l){for(var g,c=1,f=arguments.length;c<f;c++)for(var _ in g=arguments[c])Object.prototype.hasOwnProperty.call(g,_)&&(l[_]=g[_]);return l},s.apply(this,arguments)};function a(l,g,c){if(c||arguments.length===2)for(var f,_=0,k=g.length;_<k;_++)!f&&_ in g||(f||(f=Array.prototype.slice.call(g,0,_)),f[_]=g[_]);return l.concat(f||Array.prototype.slice.call(g))}var i,o,p=function l(g,c){if(g===c)return!0;if(g&&c&&typeof g=="object"&&typeof c=="object"){if(g.constructor!==c.constructor)return!1;var f,_,k;if(Array.isArray(g)){if((f=g.length)!=c.length)return!1;for(_=f;_--!=0;)if(!l(g[_],c[_]))return!1;return!0}if(g.constructor===RegExp)return g.source===c.source&&g.flags===c.flags;if(g.valueOf!==Object.prototype.valueOf)return g.valueOf()===c.valueOf();if(g.toString!==Object.prototype.toString)return g.toString()===c.toString();if((f=(k=Object.keys(g)).length)!==Object.keys(c).length)return!1;for(_=f;_--!=0;)if(!Object.prototype.hasOwnProperty.call(c,k[_]))return!1;for(_=f;_--!=0;){var R=k[_];if(!l(g[R],c[R]))return!1}return!0}return g!=g&&c!=c};(function(l){l.NONE="NONE",l.DEFAULT_FLAGS="DEFAULT_FLAGS",l.CACHE="CACHE",l.SERVER="SERVER"})(i||(i={}));var u,h=null,m="BULLET_TRAIN_DB",y="BULLET_TRAIN_EVENT",w="https://edge.api.flagsmith.com/api/v1/",b=function(l){return"Attempted to "+l+" a user before calling flagsmith.init. Call flagsmith.init first, if you wish to prevent it sending a request for flags, call init with preventFetch:true."},v="flagsmith_value_",S="flagsmith_enabled_",D="flagsmith_trait_",E=function(){function l(g){var c=this;this._trigger=null,this._triggerLoadingState=null,this.timestamp=null,this.isLoading=!1,this.eventSource=null,this.getJSON=function(f,_,k){var R=c,L=R.environmentID,$=R.headers,oe={method:_||"GET",body:k,cache:"no-cache",headers:{"x-environment-key":"".concat(L)}};_&&_!=="GET"&&(oe.headers["Content-Type"]="application/json; charset=utf-8"),$&&Object.assign(oe.headers,$),o||console.error("Flagsmith: fetch is undefined, please specify a fetch implementation into flagsmith.init to support SSR.");var ce="".concat(c.identity);return o(f,oe).then(function(M){var ue,_e="".concat(c.identity);if(ce===_e){var Te=(ue=M.headers)===null||ue===void 0?void 0:ue.get("x-flagsmith-document-updated-at");if(Te)try{var Oe=parseFloat(Te);if(isNaN(Oe))throw"Failed to parse x-flagsmith-document-updated-at";c.timestamp=Oe}catch(Ee){c.log(Ee,"Failed to parse x-flagsmith-document-updated-at",Te)}return c.log("Fetch response: "+M.status+" "+(_||"GET")+0+f),M.text().then(function(Ee){var Me=Ee;try{Me=JSON.parse(Ee)}catch{}return M.status&&M.status>=200&&M.status<300?Me:Promise.reject(Me)})}c.log("Received response with identity miss-match, ignoring response. Requested: ".concat(ce,", Current: ").concat(_e))}).catch(function(M){throw console.error("Flagsmith: Fetch error: "+M),new Error("Flagsmith: Fetch error:"+M)})},this._onChange=function(f,_,k){c.setLoadingState(k),c.onChange&&c.onChange(f,_,c.loadingState),c._trigger&&(c.log("trigger called"),c._trigger())},this.getFlags=function(f,_){var k=c;k.onChange;var R=k.onError,L=k.identity,$=k.api,oe=!1;c.log("Get Flags"),c.isLoading=!0,c.loadingState.isFetching||c.setLoadingState(s(s({},c.loadingState),{isFetching:!0}));var ce=function(M){var ue=M.flags,_e=M.traits;c.isLoading=!1,L&&(c.withTraits=null);var Te={},Oe={};_e=_e||[],(ue=ue||[]).forEach(function(z){Te[z.feature.name.toLowerCase().replace(/ /g,"_")]={id:z.feature.id,enabled:z.enabled,value:z.feature_state_value}}),_e.forEach(function(z){Oe[z.trait_key.toLowerCase().replace(/ /g,"_")]=z.trait_value}),c.oldFlags=s({},c.flags);var Ee=p(c.flags,Te),Me=p(c.traits,Oe);if(c.flags=Te,c.traits=Oe,c.updateStorage(),c.datadogRum)try{if(c.datadogRum.trackTraits){var He={};Object.keys(c.traits).map(function(z){He[D+z]=c.getTrait(z)});var F=s(s(s({},c.datadogRum.client.getUser()),{id:c.datadogRum.client.getUser().id||c.identity}),He);c.log("Setting Datadog user",F),c.datadogRum.client.setUser(F)}}catch(z){console.error(z)}if(c.dtrum)try{var ie={javaDouble:{},date:{},shortString:{},javaLongOrObject:{}};Object.keys(c.flags).map(function(z){I(ie,v+z,c.getValue(z,{},!0)),I(ie,S+z,c.hasFeature(z,!0))}),Object.keys(c.traits).map(function(z){I(ie,D+z,c.getTrait(z))}),c.log("Sending javaLongOrObject traits to dynatrace",ie.javaLongOrObject),c.log("Sending date traits to dynatrace",ie.date),c.log("Sending shortString traits to dynatrace",ie.shortString),c.log("Sending javaDouble to dynatrace",ie.javaDouble),c.dtrum.sendSessionProperties(ie.javaLongOrObject,ie.date,ie.shortString,ie.javaDouble)}catch(z){console.error(z)}c._onChange(c.oldFlags,{isFromServer:!0,flagsChanged:!Ee,traitsChanged:!Me},c._loadedState(null,i.SERVER))};return L?Promise.all([c.withTraits?c.getJSON($+"identities/","POST",JSON.stringify({identifier:L,traits:Object.keys(c.withTraits).map(function(M){return{trait_key:M,trait_value:c.withTraits[M]}}).filter(function(M){return M.trait_value!==void 0||(c.log("Warning - attempted to set an undefined trait value for key",M.trait_key),!1)})})):c.getJSON($+"identities/?identifier="+encodeURIComponent(L))]).then(function(M){c.withTraits=null,ce(M[0]),f&&!oe&&(oe=!0,f())}).catch(function(M){var ue=M.message;R&&R(new Error(ue))}):Promise.all([c.getJSON($+"flags/")]).then(function(M){ce({flags:M[0],traits:void 0}),f&&!oe&&(oe=!0,f())}).catch(function(M){_&&!oe&&(oe=!0,_(M)),R&&R(M)})},this.analyticsFlags=function(){var f=c.api;if(c.evaluationEvent&&c.evaluationEvent[c.environmentID])return c.evaluationEvent&&Object.getOwnPropertyNames(c.evaluationEvent).length!==0&&Object.getOwnPropertyNames(c.evaluationEvent[c.environmentID]).length!==0?c.getJSON(f+"analytics/flags/","POST",JSON.stringify(c.evaluationEvent[c.environmentID])).then(function(_){var k=c.getState();c.evaluationEvent||(c.evaluationEvent={}),c.evaluationEvent[c.environmentID]={},c.setState(s(s({},k),{evaluationEvent:c.evaluationEvent})),c.updateEventStorage()}).catch(function(_){c.log("Exception fetching evaluationEvent",_)}):void 0},this.datadogRum=null,this.loadingState={isLoading:!0,isFetching:!0,error:null,source:i.NONE},this.canUseStorage=!1,this.analyticsInterval=null,this.api=null,this.cacheFlags=!1,this.ts=null,this.enableAnalytics=!1,this.enableLogs=!1,this.environmentID="",this.evaluationEvent=null,this.flags=null,this.getFlagInterval=null,this.headers=null,this.initialised=!1,this.oldFlags=null,this.onChange=null,this.onError=null,this.identity=null,this.ticks=null,this.timer=null,this.traits=null,this.dtrum=null,this.withTraits=null,this.cacheOptions={ttl:0,skipAPI:!1},this.evaluateFlag=function(f,_){if(c.datadogRum&&(c.datadogRum.client.addFeatureFlagEvaluation?_==="VALUE"?c.datadogRum.client.addFeatureFlagEvaluation(v+f,c.getValue(f,{},!0)):c.datadogRum.client.addFeatureFlagEvaluation(S+f,c.hasFeature(f,!0)):console.error("Flagsmith: Your datadog RUM client does not support the function addFeatureFlagEvaluation, please update it.")),c.enableAnalytics){if(!c.evaluationEvent)return;c.evaluationEvent[c.environmentID]||(c.evaluationEvent[c.environmentID]={}),c.evaluationEvent[c.environmentID][f]===void 0&&(c.evaluationEvent[c.environmentID][f]=0),c.evaluationEvent[c.environmentID][f]+=1}c.updateEventStorage()},this.getValue=function(f,_,k){var R=c.flags&&c.flags[f.toLowerCase().replace(/ /g,"_")],L=null;if(R&&(L=R.value),k||c.evaluateFlag(f,"VALUE"),L===null&&(_==null?void 0:_.fallback)!==void 0)return _.fallback;if(_!=null&&_.json)try{return L===null?(c.log("Tried to parse null flag as JSON: "+f),null):JSON.parse(L)}catch{return _.fallback}return L},this.getTrait=function(f){return c.traits&&c.traits[f.toLowerCase().replace(/ /g,"_")]},this.getAllTraits=function(){return c.traits},this.setTrait=function(f,_){if(c.api){var k={};return k[f]=_,c.setTraits(k)}console.error(b("setTrait"))},this.setTraits=function(f){if(c.api){if(f&&typeof f=="object"||console.error("Expected object for flagsmith.setTraits"),c.withTraits=s(s({},c.withTraits||{}),f),c.identity)return c.initialised?c.getFlags():void 0;c.log("Set traits prior to identifying",c.withTraits)}else console.error(b("setTraits"))},this.hasFeature=function(f,_){var k=c.flags&&c.flags[f.toLowerCase().replace(/ /g,"_")],R=!1;return k&&k.enabled&&(R=!0),_||c.evaluateFlag(f,"ENABLED"),R},o=g.fetch?g.fetch:typeof fetch<"u"?fetch:gr===null||gr===void 0?void 0:gr.fetch,this.canUseStorage=typeof window<"u"||!!g.browserlessStorage,this.log("Constructing flagsmith instance "+g),g.eventSource&&(u=g.eventSource),g.AsyncStorage&&(h=g.AsyncStorage)}return l.prototype.init=function(g){var c=this,f=g.environmentID,_=g.api,k=_===void 0?w:_,R=g.headers,L=g.onChange,$=g.cacheFlags,oe=g.datadogRum,ce=g.onError,M=g.defaultFlags,ue=g.fetch,_e=g.preventFetch,Te=g.enableLogs,Oe=g.enableDynatrace,Ee=g.enableAnalytics,Me=g.realtime,He=g.eventSourceUrl,F=He===void 0?"https://realtime.flagsmith.com/":He,ie=g.AsyncStorage,z=g.identity,x=g.traits,We=g.state,Ke=g.cacheOptions,qe=g.angularHttpClient,rr=g._trigger,Nr=g._triggerLoadingState;return new Promise(function(Ie,nr){var Fr,Ur;c.environmentID=f,c.api=k,c.headers=R,c.getFlagInterval=null,c.analyticsInterval=null,c.onChange=L;var ls="Wrong Flagsmith Configuration: preventFetch is true and no defaulFlags provided";if(c._trigger=rr||c._trigger,c._triggerLoadingState=Nr||c._triggerLoadingState,c.onError=function(pe){c.setLoadingState(s(s({},c.loadingState),{isFetching:!1,isLoading:!1,error:pe})),ce&&(pe instanceof Error?ce(pe):ce(new Error(pe)))},c.identity=z,c.withTraits=x,c.enableLogs=Te||!1,c.cacheOptions=Ke?{skipAPI:!!Ke.skipAPI,ttl:Ke.ttl||0}:c.cacheOptions,!c.cacheOptions.ttl&&c.cacheOptions.skipAPI&&console.warn("Flagsmith: you have set a cache ttl of 0 and are skipping API calls, this means the API will not be hit unless you clear local storage."),ue&&(o=ue),c.enableAnalytics=Ee||!1,c.flags=Object.assign({},M)||{},c.traits=Object.assign({},x)||{},c.initialised=!0,c.ticks=1e4,Object.keys(c.flags).length&&(c.loadingState=s(s({},c.loadingState),{isLoading:!1,source:i.DEFAULT_FLAGS})),Me&&typeof window<"u"){var ds=F+"sse/environments/"+f+"/stream";u?c.eventSource||(c.log("Creating event source with url "+ds),c.eventSource=new u(ds),c.eventSource.addEventListener("environment_updated",function(pe){var ve;try{ve=JSON.parse(pe.data).updated_at}catch(Le){c.log("Could not parse sse event",Le)}ve?!c.timestamp||ve>c.timestamp?c.isLoading?c.log("updated_at is new, but flags are loading",pe.data,c.timestamp):(c.log("updated_at is new, fetching flags",pe.data,c.timestamp),c.getFlags()):c.log("updated_at is outdated, skipping get flags",pe.data,c.timestamp):c.log("No updated_at received, fetching flags",pe)})):c.log("Error, EventSource is undefined")}if(c.log("Initialising with properties",{environmentID:f,api:k,headers:R,onChange:L,cacheFlags:$,onError:ce,defaultFlags:M,preventFetch:_e,enableLogs:Te,enableAnalytics:Ee,AsyncStorage:h,identity:z,traits:x,_trigger:rr,state:We,angularHttpClient:qe},c),c.timer=c.enableLogs?new Date().valueOf():null,ie&&(h=ie),c.cacheFlags=h!==void 0&&!!$,c.setState(We),!f)throw nr("Please specify a environment id"),"Please specify a environment id";if(oe&&(c.datadogRum=oe),Oe&&(typeof dtrum>"u"?console.error("You have attempted to enable dynatrace but dtrum is undefined, please check you have the Dynatrace RUM JavaScript API installed."):c.dtrum=dtrum),qe&&(o=function(pe,ve){var Le=ve.headers,Lt=ve.method,be=ve.body;return new Promise(function(nt){switch(Lt){case"GET":return qe.get(pe,{headers:Le}).subscribe(function(st){nt({ok:!0,text:function(){return Promise.resolve(st)}})});case"POST":case"PUT":return qe.post(pe,be,{headers:Le}).subscribe(function(st){nt({ok:!0,text:function(){return Promise.resolve(st)}})})}})}),h&&c.canUseStorage&&h.getItem(y).then(function(pe){if(pe)try{c.evaluationEvent=JSON.parse(pe)}catch{c.evaluationEvent={}}else c.evaluationEvent={};return c.analyticsInterval=setInterval(c.analyticsFlags,c.ticks),!0}),c.enableAnalytics&&(c.analyticsInterval&&clearInterval(c.analyticsInterval),h&&c.canUseStorage&&h.getItem(y,function(pe,ve){if(ve){var Le=JSON.parse(ve);Le[c.environmentID]&&(We=c.getState(),c.log("Retrieved events from cache",ve),c.setState(s(s({},We),{evaluationEvent:Le[c.environmentID]})))}return!0})),$){if(h&&c.canUseStorage){var us=function(pe,ve){var Le,Lt;if(ve)try{var be=JSON.parse(ve),nt=!1;if(be&&be.api===c.api&&be.environmentID===c.environmentID){var st=!0;c.identity&&be.identity!==c.identity&&(c.log("Ignoring cache,  identity has changed from "+be.identity+" to "+c.identity),st=!1),c.cacheOptions.ttl&&(!be.ts||new Date().valueOf()-be.ts>c.cacheOptions.ttl)&&be.ts&&(c.log("Ignoring cache, timestamp is too old ts:"+be.ts+" ttl: "+c.cacheOptions.ttl+" time elapsed since cache: "+(new Date().valueOf()-be.ts)+"ms"),st=!1),st&&(nt=!0,c.setState(be),c.log("Retrieved flags from cache",be))}if(nt){var gs=!(_e||c.cacheOptions.skipAPI&&nt);c._onChange(null,{isFromServer:!1,flagsChanged:!0,traitsChanged:!!c.traits&&!!Object.keys(c.traits).length},c._loadedState(null,i.CACHE,gs)),c.oldFlags=c.flags,Ie(!0),c.cacheOptions.skipAPI&&nt&&c.log("Skipping API, using cache"),gs&&c.getFlags()}else _e?Ie(!0):c.getFlags(Ie,nr)}catch(gi){c.log("Exception fetching cached logs",gi)}else _e?(M?c._onChange(null,{isFromServer:!1,flagsChanged:!0,traitsChanged:!!c.traits&&!!Object.keys(c.traits).length},c._loadedState(null,i.DEFAULT_FLAGS)):c.flags?(Le=c._onChange)===null||Le===void 0||Le.call(c,null,{isFromServer:!1,flagsChanged:!0,traitsChanged:!!c.traits&&!!Object.keys(c.traits).length},c._loadedState(null,i.DEFAULT_FLAGS)):(Lt=c.onError)===null||Lt===void 0||Lt.call(c,new Error(ls)),Ie(!0)):c.getFlags(Ie,nr);return!0};if(h.getItemSync)try{us(0,h.getItemSync(m))}catch{}else h.getItem(m,us)}}else if(_e){if(M)(Fr=c._onChange)===null||Fr===void 0||Fr.call(c,null,{isFromServer:!1,flagsChanged:!0,traitsChanged:!!c.traits&&!!Object.keys(c.traits).length},c._loadedState(null,i.DEFAULT_FLAGS));else if(c.flags){var ps=null;Object.keys(c.flags).length===0&&(ps=ls),(Ur=c._onChange)===null||Ur===void 0||Ur.call(c,null,{isFromServer:!1,flagsChanged:!0,traitsChanged:!!c.traits&&!!Object.keys(c.traits).length},c._loadedState(ps,i.DEFAULT_FLAGS))}Ie(!0)}else c.getFlags(Ie,nr)}).catch(function(Ie){c.log("Error during initialisation ",Ie),ce&&ce(Ie)})},l.prototype._loadedState=function(g,c,f){return g===void 0&&(g=null),f===void 0&&(f=!1),{error:g,isFetching:f,isLoading:!1,source:c}},l.prototype.getAllFlags=function(){return this.flags},l.prototype.identify=function(g,c){return this.identity=g,this.log("Identify: "+this.identity),c&&(this.withTraits=s(s({},this.withTraits||{}),c)),this.initialised?this.getFlags():Promise.resolve()},l.prototype.getState=function(){return{api:this.api,environmentID:this.environmentID,flags:this.flags,identity:this.identity,ts:this.ts,traits:this.traits,evaluationEvent:this.evaluationEvent}},l.prototype.setState=function(g){g&&(this.initialised=!0,this.api=g.api||this.api||w,this.environmentID=g.environmentID||this.environmentID,this.flags=g.flags||this.flags,this.identity=g.identity||this.identity,this.traits=g.traits||this.traits,this.withTraits=s(s({},this.withTraits||{}),this.traits),this.evaluationEvent=g.evaluationEvent||this.evaluationEvent,this.log("setState called",this))},l.prototype.log=function(){for(var g=[],c=0;c<arguments.length;c++)g[c]=arguments[c];this.enableLogs&&console.log.apply(this,a(["FLAGSMITH:",new Date().valueOf()-(this.timer||0),"ms"],g,!0))},l.prototype.updateStorage=function(){if(this.cacheFlags){this.ts=new Date().valueOf();var g=JSON.stringify(this.getState());this.log("Setting storage",g),h.setItem(m,g)}},l.prototype.updateEventStorage=function(){if(this.enableAnalytics){var g=JSON.stringify(this.getState().evaluationEvent);h.setItem(y,g)}},l.prototype.setLoadingState=function(g){var c;p(g,this.loadingState)||(this.loadingState=s({},g),this.log("Loading state changed",g),(c=this._triggerLoadingState)===null||c===void 0||c.call(this))},l.prototype.logout=function(){return this.identity=null,this.traits={},this.initialised?this.getFlags():Promise.resolve()},l.prototype.startListening=function(g){g===void 0&&(g=1e3),this.getFlagInterval&&clearInterval(this.getFlagInterval),this.getFlagInterval=setInterval(this.getFlags,g)},l.prototype.stopListening=function(){this.getFlagInterval&&(clearInterval(this.getFlagInterval),this.getFlagInterval=null)},l.prototype.getSegments=function(){},l}();function A(l){var g=l.fetch,c=l.AsyncStorage,f=l.eventSource;return new E({fetch:g,AsyncStorage:c,eventSource:f})}var T,I=function(l,g,c){var f="shortString",_=!0;typeof c=="number"&&(f="javaDouble",_=!1),l[f]=l[f]||{},l[f][g]=_?c+"":c},C=(T=function(l,g){return T=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(c,f){c.__proto__=f}||function(c,f){for(var _ in f)Object.prototype.hasOwnProperty.call(f,_)&&(c[_]=f[_])},T(l,g)},function(l,g){if(typeof g!="function"&&g!==null)throw new TypeError("Class extends value "+String(g)+" is not a constructor or null");function c(){this.constructor=l}T(l,g),l.prototype=g===null?Object.create(g):(c.prototype=g.prototype,new c)}),N=function(l){var g=typeof Symbol=="function"&&Symbol.iterator,c=g&&l[g],f=0;if(c)return c.call(l);if(l&&typeof l.length=="number")return{next:function(){return l&&f>=l.length&&(l=void 0),{value:l&&l[f++],done:!l}}};throw new TypeError(g?"Object is not iterable.":"Symbol.iterator is not defined.")},O=function(l,g){var c=typeof Symbol=="function"&&l[Symbol.iterator];if(!c)return l;var f,_,k=c.call(l),R=[];try{for(;(g===void 0||g-- >0)&&!(f=k.next()).done;)R.push(f.value)}catch(L){_={error:L}}finally{try{f&&!f.done&&(c=k.return)&&c.call(k)}finally{if(_)throw _.error}}return R},H=function(l,g,c){if(c||arguments.length===2)for(var f,_=0,k=g.length;_<k;_++)!f&&_ in g||(f||(f=Array.prototype.slice.call(g,0,_)),f[_]=g[_]);return l.concat(f||Array.prototype.slice.call(g))},te=function(l){function g(){return l.call(this,`EventSource not available.
Consider loading an EventSource polyfill and making it available globally as EventSource, or passing one in as eventSourceClass to the ReconnectingEventSource constructor.`)||this}return C(g,l),g}(Error),ae=function(){function l(g,c){var f=this;if(this.CONNECTING=0,this.OPEN=1,this.CLOSED=2,this._configuration=c!=null?Object.assign({},c):void 0,this.withCredentials=!1,this._eventSource=null,this._lastEventId=null,this._timer=null,this._listeners={open:[],error:[],message:[]},this.url=g.toString(),this.readyState=this.CONNECTING,this.max_retry_time=3e3,this.eventSourceClass=globalThis.FlagsmithEventSource,this._configuration!=null&&(this._configuration.lastEventId&&(this._lastEventId=this._configuration.lastEventId,delete this._configuration.lastEventId),this._configuration.max_retry_time&&(this.max_retry_time=this._configuration.max_retry_time,delete this._configuration.max_retry_time),this._configuration.eventSourceClass&&(this.eventSourceClass=this._configuration.eventSourceClass,delete this._configuration.eventSourceClass)),this.eventSourceClass==null||typeof this.eventSourceClass!="function")throw new te;this._onevent_wrapped=function(_){f._onevent(_)},this._start()}return l.prototype.dispatchEvent=function(g){throw new Error("Method not implemented.")},l.prototype._start=function(){var g,c,f=this,_=this.url;this._lastEventId&&(_.indexOf("?")===-1?_+="?":_+="&",_+="lastEventId="+encodeURIComponent(this._lastEventId)),this._eventSource=new this.eventSourceClass(_,this._configuration),this._eventSource.onopen=function($){f._onopen($)},this._eventSource.onerror=function($){f._onerror($)},this._eventSource.onmessage=function($){f.onmessage($)};try{for(var k=N(Object.keys(this._listeners)),R=k.next();!R.done;R=k.next()){var L=R.value;this._eventSource.addEventListener(L,this._onevent_wrapped)}}catch($){g={error:$}}finally{try{R&&!R.done&&(c=k.return)&&c.call(k)}finally{if(g)throw g.error}}},l.prototype._onopen=function(g){this.readyState===0&&(this.readyState=1,this.onopen(g))},l.prototype._onerror=function(g){var c=this;if(this.readyState===1&&(this.readyState=0,this.onerror(g)),this._eventSource){this._eventSource.close(),this._eventSource=null;var f=Math.round(this.max_retry_time*Math.random());this._timer=setTimeout(function(){return c._start()},f)}},l.prototype._onevent=function(g){var c,f;g&&g.lastEventId&&(this._lastEventId=g.lastEventId);var _=this._listeners[g.type];if(_!=null)try{for(var k=N(H([],O(_),!1)),R=k.next();!R.done;R=k.next())R.value.call(this,g)}catch(L){c={error:L}}finally{try{R&&!R.done&&(f=k.return)&&f.call(k)}finally{if(c)throw c.error}}g.type==="message"&&this.onmessage(g)},l.prototype.onopen=function(g){},l.prototype.onerror=function(g){},l.prototype.onmessage=function(g){},l.prototype.close=function(){this._timer&&(clearTimeout(this._timer),this._timer=null),this._eventSource&&(this._eventSource.close(),this._eventSource=null),this.readyState=2},l.prototype.addEventListener=function(g,c,f){this._listeners[g]==null&&(this._listeners[g]=[],this._eventSource!=null&&this._eventSource.addEventListener(g,this._onevent_wrapped));var _=this._listeners[g];_.includes(c)||(this._listeners[g]=H(H([],O(_),!1),[c],!1))},l.prototype.removeEventListener=function(g,c,f){var _=this._listeners[g];this._listeners[g]=_.filter(function(k){return k!==c})},l}();globalThis.FlagsmithEventSource=typeof EventSource<"u"?EventSource:null;var he=function(l,g){return g=g||{},new Promise(function(c,f){var _=new XMLHttpRequest,k=[],R=[],L={},$=function(){return{ok:(_.status/100|0)==2,statusText:_.statusText,status:_.status,url:_.responseURL,text:function(){return Promise.resolve(_.responseText)},json:function(){return Promise.resolve(_.responseText).then(JSON.parse)},blob:function(){return Promise.resolve(new Blob([_.response]))},clone:$,headers:{keys:function(){return k},entries:function(){return R},get:function(ce){return L[ce.toLowerCase()]},has:function(ce){return ce.toLowerCase()in L}}}};for(var oe in _.open(g.method||"get",l,!0),_.onload=function(){_.getAllResponseHeaders().replace(/^(.*?):[^\S\n]*([\s\S]*?)$/gm,function(ce,M,ue){k.push(M=M.toLowerCase()),R.push([M,ue]),L[M]=L[M]?L[M]+","+ue:ue}),c($())},_.onerror=f,_.withCredentials=g.credentials=="include",g.headers)_.setRequestHeader(oe,g.headers[oe]);_.send(g.body||null)})},re=A({AsyncStorage:n,fetch:he,eventSource:ae});typeof window<"u"&&(window.flagsmith=re),r.createFlagsmithInstance=function(){return A({AsyncStorage:n,fetch:he,eventSource:ae})},r.default=re,Object.defineProperty(r,"__esModule",{value:!0})})})(qn,qn.exports);var Bg=qn.exports;const Bn=Dl(Bg),zg=e=>e.replace(/_./g,t=>t[1].toUpperCase()).replace(/-./g,t=>t[1].toUpperCase()),Gg=e=>{const t={...e};return Object.entries(t).forEach(([r,n])=>{const s=zg(r);delete t[r],t[s]=n}),t},Vg=e=>{const t={};return Object.entries(e).forEach(([r,n])=>{if(n.enabled){const s=n.value!==void 0&&n.value!==null&&n.value!=="";t[r]=s?n.value:!0}}),t},Hg=async e=>(e==null?void 0:e.email)||await Hi(Ki,ze()),Kg=e=>{var s,a,i,o,p,u,h,m,y;const t=e!=null&&e.date_joined?new Date(e.date_joined).valueOf():void 0,r=(a=(s=e==null?void 0:e.active_organization)==null?void 0:s.super_organization)==null?void 0:a.created,n=r?new Date(r).valueOf():t;return e?{super_organization_id:(o=(i=e.active_organization)==null?void 0:i.super_organization)==null?void 0:o.id,organization_id:(p=e.active_organization)==null?void 0:p.id,email_address:e.email,first_name:e.first_name,last_name:e.last_name,date_joined:e.date_joined,date_joined_timestamp:t,super_organization_created_date:r,super_organization_created_date_timestamp:n,plan_name:(m=(h=(u=e.active_organization)==null?void 0:u.super_organization)==null?void 0:h.plan)==null?void 0:m.name,signup_method:e.signup_method,browser:Rs(),extension_version:chrome.runtime.getManifest().version,signup_source:e.signup_source,sps_enabled:!!((y=e.active_organization)!=null&&y.smart_privacy_screen_enabled)}:null},Yg=async e=>{const t=await Hg(e),r=Kg(e);t!==null&&Bn.identify(t,r).then(()=>Bn.getAllFlags()).then(n=>{const s=Vg(Gg(n));d.dispatch(Gi(s))})},Xg=async()=>{Bn.init({environmentID:Vi,fetch,preventFetch:!0})};Xg().catch(e=>{console.error(e)});const Dr=async()=>{const e=await Cl();d.dispatch(Yi(e));const t=await da("recordingControlsPosition");d.dispatch(Xi(t))},Jg=async(e,t)=>{await _n(e,t),Dr()},Oo="/assets/index.tsx-loader.js",Lo="/assets/index.js-loader.js",Qg=async e=>{!e.id||!(e!=null&&e.url)||ke(e.url)||await chrome.scripting.executeScript({target:{tabId:e.id,allFrames:!0},files:[Oo,Lo]})},zn=async({tabId:e})=>{const t=await chrome.tabs.get(e);try{le(t,{messageType:"pingContentScript"},r=>{r||Qg(t)})}catch(r){P("error_in_refreshContentScriptIfStale",{error:r})}},Zg=async()=>{(await chrome.tabs.query({active:!0})).forEach(e=>{e.id!==void 0&&zn({tabId:e.id})})};chrome.tabs.onActivated.addListener(zn),chrome.windows.onFocusChanged.addListener(Zg);function Po(e=null){chrome.tabs.query({active:!0,currentWindow:!0},function(t){t&&t[0]&&t[0].id&&chrome.tabs.sendMessage(t[0].id,{messageType:"getCurrentDom",sessionId:e})})}function eh({dom:e,url:t,sessionId:r}){chrome.runtime.sendMessage({messageType:"send-dom-to-sidepanel",data:{dom:e,url:t,sessionId:r}})}const th=(e,t,r,n)=>{var s,a;if(e.messageType===wn.ON_MEDIA_PERMISSIONS_TAB_INITALIZED&&Ji(t.tab,e.microphonePermission),e.messageType===wn.MEDIA_PERMISSION_CHANGED&&e.microphonePermission===Qi.GRANTED){const i=(a=(s=Z(n.getState()))==null?void 0:s.recordedTabs)==null?void 0:a[0];i&&chrome.tabs.update(i,{active:!0})}},rh=async()=>{try{const{data:e}=await j.get("/transcript_token/");return e.token}catch(e){throw W({title:"Failed to fetch AssemblyAI auth token",error:e.message}),new Error("Failed to fetch AssemblyAI auth token",e.message)}},xo=(e,t)=>{var s,a;const r=((s=e.words[0])==null?void 0:s.start)||0,n=((a=e.words[e.words.length-1])==null?void 0:a.end)||0;return{...e,audio_start_timestamp:r+t,audio_end_timestamp:n+t,relative_audio_start:t}},nh=async(e,t)=>{var r,n;switch(e){case Qe.GET_AUTH_TOKEN:try{return{token:await rh()}}catch(s){throw console.error("Failed to fetch auth token:",s),d.dispatch(ht(!1)),s}case Qe.TRANSCRIPT:{const s=d.getState(),{isTranscribing:a,lastPauseTimestamp:i,pauseRanges:o}=Z(s),p=it(s);if((r=t.transcript)!=null&&r.words.length&&(a||p)){const u=t.startTimestamp||Date.now().valueOf();let h=0;o&&o.length>0&&(h=o.reduce((w,b)=>b.unpauseTimestamp?w+(b.unpauseTimestamp-b.pauseTimestamp):w,0));const m={...t.transcript,words:t.transcript.words.map(w=>({...w,start:w.start+h,end:w.end+h}))},y=xo(m,u);d.dispatch(or(y))}else if((n=t.transcript)!=null&&n.words.length&&!a&&!p&&i){const u=t.startTimestamp||Date.now().valueOf();let h=0;o&&o.length>0&&(h=o.reduce((w,b)=>b.unpauseTimestamp?w+(b.unpauseTimestamp-b.pauseTimestamp):w,0));const m={...t.transcript,words:t.transcript.words.map(w=>({...w,start:w.start+h,end:w.end+h}))},y=xo(m,u);d.dispatch(or(y))}break}case Qe.ERROR:W({title:t.title,error:t.error}),d.dispatch(ht(!1));break;case Qe.ON_READY:d.dispatch(ht(!0));break}},sh=async()=>{try{const{data:e}=await j.get("/transcript_token_v3/");return e.token}catch(e){throw W({title:"Failed to fetch AssemblyAI V3 auth token",error:e.message}),new Error("Failed to fetch AssemblyAI V3 auth token",e.message)}},Mo=(e,t)=>{var s,a;const r=((s=e.words[0])==null?void 0:s.start)??0,n=((a=e.words[e.words.length-1])==null?void 0:a.end)??0;return{message_type:e.turn_is_formatted?"FinalTranscript":"PartialTranscript",confidence:e.confidence||0,text:e.transcript,words:e.words,created:new Date().toISOString(),audio_start_timestamp:r+t,audio_end_timestamp:n+t,relative_audio_start:t}},ah=async(e,t)=>{var r,n;switch(e){case Qe.GET_AUTH_TOKEN:try{return{token:await sh()}}catch(s){throw console.error("V3: Failed to fetch auth token:",s),d.dispatch(ht(!1)),s}case Qe.TRANSCRIPT:{const s=d.getState(),{isTranscribing:a,lastPauseTimestamp:i,pauseRanges:o}=Z(s),p=it(s);if((r=t.transcript)!=null&&r.words.length&&(a||p)){const u=t.startTimestamp||Date.now().valueOf();let h=t.transcript.words;if(o&&o.length>0&&(h=t.transcript.words.filter(w=>{const b=w.start+u;return!o.some(v=>v.unpauseTimestamp?b>=v.pauseTimestamp&&b<v.unpauseTimestamp:b>=v.pauseTimestamp)}),h.length===0))break;const m={...t.transcript,words:h},y=Mo(m,u);d.dispatch(or(y))}else if((n=t.transcript)!=null&&n.words.length&&!a&&!p&&i){const u=t.startTimestamp||Date.now().valueOf();let h=t.transcript.words;if(o&&o.length>0&&(h=t.transcript.words.filter(w=>{const b=w.start+u;return!o.some(v=>v.unpauseTimestamp?b>=v.pauseTimestamp&&b<v.unpauseTimestamp:b>=v.pauseTimestamp)}),h.length===0))break;const m={...t.transcript,words:h},y=Mo(m,u);d.dispatch(or(y))}break}case Qe.ERROR:W({title:t.title,error:t.error}),d.dispatch(ht(!1));break;case Qe.ON_READY:d.dispatch(ht(!0));break}},oh=e=>e.domSettlement||{captures:{}},Cr=Mt(oh,e=>e.captures);Mt(Cr,e=>{const t=Date.now(),r=[];return Object.entries(e).forEach(([n,s])=>{s.ttl&&s.ttl<t&&r.push(n)}),r}),Mt(Cr,e=>{const t={};return Object.entries(e).forEach(([r,n])=>{n.scribeId||(t[r]=n)}),t}),Mt(Cr,e=>Object.keys(e).length),Mt(Cr,e=>{const t={};return Object.entries(e).forEach(([r,n])=>{n.scribeId&&!n.ttl&&(t[r]=n)}),t});class ih{constructor(t){Ye(this,"isEnabled");Ye(this,"lastDomainByTab");Ye(this,"capturedDomains");Ye(this,"config");this.config=t,this.isEnabled=!0,this.lastDomainByTab=new Map,this.capturedDomains=new Set}async handleStageCapture(t,r,n){if(this.isEnabled&&!(r!=="networkIdle"&&r!=="fullySettled"))try{const s=await this.getTab(t);if(!s||!s.url||!this.shouldMonitorUrl(s.url))return;const a=this.getDomainFromUrl(s.url);if(!a)return;const i=`${t}-${a}-${r}`;if(this.capturedDomains.has(i))return;const o=await ir();if(!o||!o.base64Image)return;const p=await mt.saveScreenshot(o.base64Image,t,a,s.url,r);d.dispatch(Zi({tabId:t,domain:a,screenshotId:p})),this.capturedDomains.add(i),this.lastDomainByTab.set(t,a)}catch(s){console.error("[DOM Settlement] Failed to capture screenshot:",s)}}async handleDomainChange(t,r){var a,i;if(!this.isEnabled)return;const n=this.getDomainFromUrl(r),s=this.lastDomainByTab.get(t);if(s&&n&&s!==n){const o=d.getState(),p=`${t}-${s}`,u=(i=(a=o.domSettlement)==null?void 0:a.captures)==null?void 0:i[p];u!=null&&u.screenshotId&&await mt.deleteScreenshot(u.screenshotId),d.dispatch(ec({tabId:t,domain:s})),this.lastDomainByTab.set(t,n);const h=[];this.capturedDomains.forEach(m=>{m.startsWith(`${t}-`)&&h.push(m)}),h.forEach(m=>this.capturedDomains.delete(m))}}associateCapturesWithScribe(t,r){var n;try{const s=((n=d.getState().domSettlement)==null?void 0:n.captures)||{};Object.entries(s).forEach(([a,i])=>{if(a.startsWith(`${t}-`)){const{domain:o}=i;d.dispatch(tc({tabId:t,domain:o,scribeId:r}))}})}catch(s){console.error("[DOM Settlement] Error associating captures:",s)}}async getCapturesForScribe(t){var a;const r=((a=d.getState().domSettlement)==null?void 0:a.captures)||{},n=[],s=Object.entries(r).filter(([i,o])=>o.scribeId===t&&o.screenshotId);for(const[i,o]of s){const p=await mt.getScreenshotWithMetadata(o.screenshotId);p&&n.push({tabId:o.tabId,domain:o.domain,screenshot:p.base64Data,captureTime:o.captureTime,stage:p.stage,url:p.href,s3DownloadUrl:p.s3DownloadUrl,s3InternalUrl:p.s3InternalUrl})}return n}async clearScribeCaptures(t){var s;const r=((s=d.getState().domSettlement)==null?void 0:s.captures)||{},n=[];Object.entries(r).forEach(([a,i])=>{i.scribeId===t&&i.screenshotId&&n.push(i.screenshotId)}),n.length>0&&await mt.deleteScreenshots(n),d.dispatch(rc(t))}async uploadInitialScreenshotToS3(t,r){var n,s;try{const a=d.getState(),i=this.lastDomainByTab.get(t);if(!i)return null;const o=`${t}-${i}`,p=(s=(n=a.domSettlement)==null?void 0:n.captures)==null?void 0:s[o];if(!(p!=null&&p.screenshotId)||p.scribeId!==r)return null;const u=await mt.getScreenshot(p.screenshotId);if(!u)return null;const h=await j.post("/signed_urls/",{name:"dom_settlement_screenshot",file_type:"jpeg"}),{internal_url:m,upload_url:y,download_url:w}=h.data;let b=u;b.includes(",")&&(b=b.split(",")[1]);const v=atob(b),S=new Uint8Array(v.length);for(let E=0;E<v.length;E++)S[E]=v.charCodeAt(E);const D=new Blob([S],{type:"image/jpeg"});return await nc(y,D,"image/jpeg",{timeout:6e4}),await mt.updateS3Urls(p.screenshotId,m,w,y),{internalUrl:m,downloadUrl:w}}catch(a){return console.error("[DOM Settlement] Failed to upload screenshot to S3:",a),W(a),null}}setEnabled(t){this.isEnabled=t}getDomainFromUrl(t){try{return new URL(t).hostname}catch{return null}}shouldMonitorUrl(t){return!(t.startsWith("chrome://")||t.startsWith("chrome-extension://")||t.startsWith("about:")||t.startsWith("file://"))}async getTab(t){return new Promise(r=>{chrome.tabs.get(t,n=>{chrome.runtime.lastError?r(null):r(n)})})}downloadScreenshot(t,r){let n=t;n.startsWith("data:")||(n=`data:image/png;base64,${t}`),chrome.downloads.download({url:n,filename:r,saveAs:!1},s=>{chrome.runtime.lastError&&console.error(`[DOM Settlement] Failed to download screenshot: ${chrome.runtime.lastError.message}`)})}downloadJson(t,r){const n=JSON.stringify(t,null,2),s=new TextEncoder().encode(n),a=`data:application/json;base64,${btoa(String.fromCharCode(...s))}`;chrome.downloads.download({url:a,filename:r,saveAs:!1},i=>{chrome.runtime.lastError&&console.error(`[DOM Settlement] Failed to download JSON: ${chrome.runtime.lastError.message}`)})}}const ch=()=>{let e=Jr();return e||(e=new ih({}),oc(e),setInterval(()=>{d.dispatch(sc())},30*1e3)),e},lh=()=>{chrome.tabs.onRemoved.addListener(e=>{d.dispatch(ac(e))}),chrome.tabs.onUpdated.addListener((e,t,r)=>{if(t.url&&r.url){const n=Jr();n&&n.handleDomainChange(e,r.url)}})};function dh(e){if(!Array.isArray(e)||e.length===0)return Array.isArray(e)?e:[];const t=new Map,r=[];for(const a of e){const i=a==null?void 0:a.stack_id;i&&typeof i=="string"&&i.length>0&&(t.has(i)||(t.set(i,[]),r.push(i)),t.get(i).push(a))}if(r.length===0)return e;const n=new Set,s=[];for(const a of e){const i=a==null?void 0:a.stack_id;if(!i){s.push(a);continue}if(n.has(i))continue;const o=t.get(i)||[];n.add(i);let p;for(const m of o)typeof(m==null?void 0:m.stack_short_description)=="string"&&m.stack_short_description.trim()?p=m.stack_short_description.trim():typeof(m==null?void 0:m.stack_description)=="string"&&m.stack_description.trim()&&(p=m.stack_description.trim());const u=o[0]||{},h={id:`stack_${i}`,kind:"stack",type:"stack",url:(u==null?void 0:u.url)||"",timestamp:(u==null?void 0:u.timestamp)||void 0,description:p||void 0,actions:o.map(m=>({...m}))};s.push(h)}return s}function uh(e){if(!e||!Array.isArray(e.scribes))return e;const t=e.scribes.map(r=>{const n=dh(Array.isArray(r==null?void 0:r.actions)?r.actions:[]);return{...r,actions:n}});return{...e,scribes:t}}function ph(){const e=new Date,t=(e.getDay()+6)%7,r=new Date(e);return r.setHours(0,0,0,0),r.setDate(e.getDate()-t),{mondayMidnightMs:r.getTime()}}function gh(e){if(!e||typeof e!="string")return null;const t=e.match(/^(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2})(\.(\d+))?Z$/);if(t){const n=t[1],s=(t[3]||"").slice(0,3),a=s?`${n}.${s}Z`:`${n}Z`,i=new Date(a).getTime();return Number.isFinite(i)?i:null}const r=new Date(e).getTime();return Number.isFinite(r)?r:null}function Gn(e){const t=gh(e);if(t==null)return!1;const{mondayMidnightMs:r}=ph();return t>=r}async function Ar(e){var t,r,n,s,a;try{if(!we().isDWActive)return{ok:!0,stored:!1,reason:"disabled"}}catch{return{ok:!0,stored:!1,reason:"state_unavailable"}}try{const i=`${K.BACKEND_BASE_URL}/discover_workflows/sessions/latest`,o=await ot(),p={...o!=null&&o.token?{Authorization:`Bearer ${o.token}`}:{}},u=await fetch(i,{headers:p});if(u.status===404){let w=!1,b=!1;try{if(e){const S=((t=await qt(e))==null?void 0:t.payload)??{};w=(Array.isArray(S==null?void 0:S.scribes)?S.scribes:[]).length===0;const D=((r=S==null?void 0:S.metadata)==null?void 0:r.job_start_time)||void 0;b=typeof D=="string"&&Gn(D)}}catch{}if(w&&!b){try{X({message:"dw_latest_results_404_considered_stale",category:"discover_workflows",level:"info",data:{org_scope:e||null}});const S=u.headers.get(q)||u.headers.get(q.toLowerCase()),D=u.headers.get(B)||u.headers.get(B.toLowerCase());J("DW.API.Latest.404Stale",{status:u.status,sessionId:S,requestId:D,org_scope:e||null})}catch{}return{ok:!0,stored:!1,cleared:!1,reason:"stale"}}let v=0;try{e&&(v=await ga(e)),X({message:"dw_latest_results_cleared_due_to_404",category:"discover_workflows",level:"info",data:{org_scope:e||null}});try{const S=u.headers.get(q)||u.headers.get(q.toLowerCase()),D=u.headers.get(B)||u.headers.get(B.toLowerCase());J("DW.API.Latest.404Cleared",{status:u.status,sessionId:S,requestId:D,org_scope:e||null})}catch{}}catch{}return{ok:!0,stored:!1,cleared:v>0,reason:"empty_fresh"}}const h=await u.json();if(!h||!h.metadata)return X({message:"dw_latest_results_empty_response",category:"discover_workflows",level:"warning"}),{ok:!1,stored:!1,reason:"empty_response"};const{metadata:m}=h;if(!Gn(m.job_start_time)){let w=0;try{e&&(w=await ga(e))}catch{}X({message:"dw_latest_results_stale_cleared",category:"discover_workflows",level:"info",data:{job_start_time:m.job_start_time,org_scope:e||null}});try{const b=u.headers.get(q)||u.headers.get(q.toLowerCase()),v=u.headers.get(B)||u.headers.get(B.toLowerCase());J("DW.API.Latest.StaleCleared",{status:u.status,sessionId:b,requestId:v,job_start_time:m.job_start_time,org_scope:e||null})}catch{}return{ok:!0,stored:!1,cleared:w>0,reason:"stale"}}if(!Array.isArray(h==null?void 0:h.scribes)||((h==null?void 0:h.scribes)||[]).length===0){let w=!1,b=!1;try{if(e){const v=((n=await qt(e))==null?void 0:n.payload)??{};w=(Array.isArray(v==null?void 0:v.scribes)?v.scribes:[]).length===0;const S=((s=v==null?void 0:v.metadata)==null?void 0:s.job_start_time)||void 0;b=typeof S=="string"&&Gn(S)}}catch{}if(w&&!b){X({message:"dw_latest_results_empty_considered_stale",category:"discover_workflows",level:"info",data:{org_scope:e||null}});try{const v=u.headers.get(q)||u.headers.get(q.toLowerCase()),S=u.headers.get(B)||u.headers.get(B.toLowerCase());J("DW.API.Latest.EmptyConsideredStale",{status:u.status,sessionId:v,requestId:S,org_scope:e||null})}catch{}return{ok:!0,stored:!1,cleared:!1,reason:"stale"}}}const y=uh(h);await Nl(m.super_org_id,m.org_id,m.job_id,y),X({message:"dw_latest_results_stored",category:"discover_workflows",level:"info",data:{super_org_id:m.super_org_id,org_id:m.org_id,job_id:m.job_id}});try{const w=u.headers.get(q)||u.headers.get(q.toLowerCase()),b=u.headers.get(B)||u.headers.get(B.toLowerCase());J("DW.API.Latest.Success",{status:u.status,sessionId:w,requestId:b,super_org_id:m.super_org_id,org_id:m.org_id,job_id:m.job_id})}catch{}return{ok:!0,stored:!0}}catch(i){const o=((a=i==null?void 0:i.response)==null?void 0:a.status)??void 0;W(i,{tags:{component:"discover_workflows"},extra:{context:"Failed to fetch DW latest results",status:o}});try{J("DW.API.Latest.Failure",{status:o,sessionId:void 0,requestId:void 0,error:(i==null?void 0:i.message)||"network_error"})}catch{}return{ok:!1,stored:!1,reason:String(o||"network_error")}}}const Ct=(()=>({BASE_URL:"/",MODE:"production",DEV:!1,PROD:!0,SSR:!1}).VITE_CORTEX_BASE_URL?{}.VITE_CORTEX_BASE_URL:"https://cortex.scribehow.com")(),At=ic({baseURL:Ct,getAuthToken:async()=>ot(),setAuthToken:async e=>{await cc(e)}});At.interceptors.request.use(async e=>{try{const t=await $g();return{...e,headers:{...e.headers||{},...t}}}catch{}return e});const Vn="dw-weekly-check",tt="dw-retry-check",No=4*60,hh=7*24*60;let Re=null,ut,rt;function Yt(e){if(!e||typeof e!="string")return null;const t=e.match(/^(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2})(\.(\d+))?Z$/);if(t){const n=t[1],s=(t[3]||"").slice(0,3),a=s?`${n}.${s}Z`:`${n}Z`,i=new Date(a).getTime();return Number.isFinite(i)?i:null}const r=new Date(e).getTime();return Number.isFinite(r)?r:null}function Xt(){try{return!!we().isDWActive}catch{return!1}}function Hn(){try{const e=Se(d.getState());return!!((e==null?void 0:e.lrrManualRefreshEnabled)??(e==null?void 0:e.lrr_manual_refresh_enabled))}catch{return!1}}function mh(){const e=new Date,t=(e.getDay()+6)%7,r=new Date(e);return r.setDate(e.getDate()-t),r.setHours(8,0,0,0),e.getTime()<r.getTime()?r.getTime():new Date(r.getTime()+7*24*60*60*1e3).getTime()}function fh(){const e=new Date,t=(e.getDay()+6)%7,r=new Date(e);return r.setDate(e.getDate()-t),r.setHours(8,0,0,0),r.getTime()}async function yh(){try{const e=mh();chrome.alarms.create(Vn,{when:e,periodInMinutes:hh}),J("DW.Scheduler.WeeklyRun.Scheduled",{when:e})}catch{}}async function _h(){try{await chrome.alarms.clear(Vn),await chrome.alarms.clear(tt),J("DW.Scheduler.Alarms.Cleared",{})}catch{}}async function wh(e){try{chrome.alarms.create(tt,{delayInMinutes:No}),J("DW.Scheduler.Retry.Scheduled",{delayMinutes:No,reason:e||void 0})}catch{}}async function Fo(){var i,o,p,u,h;if(!Xt())return;let e=null;try{const m=d.getState(),y=Ne(m),w=(p=(o=(i=y==null?void 0:y.userData)==null?void 0:i.active_organization)==null?void 0:o.super_organization)==null?void 0:p.id,b=(h=(u=y==null?void 0:y.userData)==null?void 0:u.active_organization)==null?void 0:h.id;w&&b&&(e=`${w}|${b}`)}catch{}const{ok:t,stored:r,cleared:n,reason:s}=await Ar(e||""),a=!t||s==="stale";if(t&&(r||n)){J("DW.Scheduler.WeeklyRun.Triggered",{org_scope:e||null});try{chrome.runtime.sendMessage({messageType:"dwLatestResultsUpdated"})}catch{}if(!a)try{await chrome.alarms.clear(tt)}catch{}}a&&await wh(s)}async function Uo(){var r,n,s,a,i,o,p,u;if(!Xt()){await _h();return}await yh();const e=Date.now(),t=fh();if(e>=t){try{const h=d.getState(),m=Ne(h),y=(s=(n=(r=m==null?void 0:m.userData)==null?void 0:r.active_organization)==null?void 0:n.super_organization)==null?void 0:s.id,w=(i=(a=m==null?void 0:m.userData)==null?void 0:a.active_organization)==null?void 0:i.id,b=y&&w?`${y}|${w}`:null;if(b){const v=(u=(p=(o=await qt(b))==null?void 0:o.payload)==null?void 0:p.metadata)==null?void 0:u.job_start_time;if((()=>{if(!v)return!1;const S=Yt(v);if(S==null)return!1;const D=S,E=(()=>{const A=new Date,T=(A.getDay()+6)%7,I=new Date(A);return I.setHours(0,0,0,0),I.setDate(A.getDate()-T),I.getTime()})();return Number.isFinite(D)&&D>=E})()){try{await chrome.alarms.clear(tt)}catch{}J("DW.Scheduler.StartupRecovery.SkippedFetchDueToFreshData",{orgScope:b});return}}}catch{}J("DW.Scheduler.StartupRecovery.FetchTriggered",{}),Fo()}}try{chrome.alarms.onAlarm.addListener(e=>{((e==null?void 0:e.name)===Vn||(e==null?void 0:e.name)===tt)&&Fo()})}catch{}async function vh(){var e,t,r,n,s,a,i,o,p,u,h,m,y,w,b,v,S,D,E,A,T;if(!(!Xt()||!Hn())){try{chrome.runtime.sendMessage({messageType:"dwManualRunStarted"})}catch{}J("DW.Scheduler.ManualRun.Started",{});try{const I=`${Ct}/api/v1/discoverworkflows/run`,C=await At.post(I,{}),{status:N}=C;if(N<200||N>=300)throw new Error(`Unexpected status ${N}`);try{const O=((e=C.headers)==null?void 0:e[q.toLowerCase()])||((t=C.config)==null?void 0:t.headers)&&(C.config.headers[q]||C.config.headers[q.toLowerCase()])||null,H=((r=C.headers)==null?void 0:r[B.toLowerCase()])||((n=C.config)==null?void 0:n.headers)&&(C.config.headers[B]||C.config.headers[B.toLowerCase()])||null;J("DW.API.Run.Success",{status:N,sessionId:O,requestId:H})}catch{}try{chrome.runtime.sendMessage({messageType:"dwManualRunCompleted",ok:!0})}catch{}}catch(I){W(I,{tags:{component:"discover_workflows"},extra:{context:"Failed to POST DW run"}});try{const C=((a=(s=I==null?void 0:I.response)==null?void 0:s.headers)==null?void 0:a[q.toLowerCase()])||((p=(o=(i=I==null?void 0:I.response)==null?void 0:i.config)==null?void 0:o.headers)==null?void 0:p[q])||((m=(h=(u=I==null?void 0:I.response)==null?void 0:u.config)==null?void 0:h.headers)==null?void 0:m[q.toLowerCase()]),N=((w=(y=I==null?void 0:I.response)==null?void 0:y.headers)==null?void 0:w[B.toLowerCase()])||((S=(v=(b=I==null?void 0:I.response)==null?void 0:b.config)==null?void 0:v.headers)==null?void 0:S[B])||((A=(E=(D=I==null?void 0:I.response)==null?void 0:D.config)==null?void 0:E.headers)==null?void 0:A[B.toLowerCase()]);J("DW.API.Run.Failure",{status:(T=I==null?void 0:I.response)==null?void 0:T.status,sessionId:C,requestId:N,error:(I==null?void 0:I.message)||"network_error"})}catch{}try{chrome.runtime.sendMessage({messageType:"dwManualRunCompleted",ok:!1,error:"run_failed"})}catch{}}}}async function bh(){var e,t,r,n,s,a,i,o,p,u,h;if(!(!Xt()||!Hn()))try{let m=null;try{const te=d.getState(),ae=Ne(te),he=(r=(t=(e=ae==null?void 0:ae.userData)==null?void 0:e.active_organization)==null?void 0:t.super_organization)==null?void 0:r.id,re=(s=(n=ae==null?void 0:ae.userData)==null?void 0:n.active_organization)==null?void 0:s.id;he&&re&&(m=`${he}|${re}`)}catch{}const y=m?await qt(m):null,w=(i=(a=y==null?void 0:y.payload)==null?void 0:a.metadata)==null?void 0:i.job_id,b=(p=(o=y==null?void 0:y.payload)==null?void 0:o.metadata)==null?void 0:p.job_start_time,v=Yt(b||void 0)||void 0,S=`${K.BACKEND_BASE_URL}/discover_workflows/sessions/latest`,D=await ot(),E={...D!=null&&D.token?{Authorization:`Bearer ${D.token}`}:{}},A=await(await fetch(S,{headers:E})).json(),T=(u=A==null?void 0:A.metadata)==null?void 0:u.job_id,I=(h=A==null?void 0:A.metadata)==null?void 0:h.job_start_time,C=Yt(I||void 0),N=C??void 0,O=!!(w&&T&&T!==w),H=(()=>typeof N=="number"&&Number.isFinite(N)?typeof v=="number"&&Number.isFinite(v)?N>v:!0:!1)();if(O||H){const{ok:te,stored:ae,cleared:he}=await Ar(m||"");if(te&&(ae||he)){try{chrome.runtime.sendMessage({messageType:"dwLatestResultsUpdated"})}catch{}try{await chrome.alarms.clear(tt)}catch{}}return{ok:te,stored:ae}}return{ok:!0,stored:!1}}catch{return{ok:!1,stored:!1}}}async function Sh(){var e,t,r,n,s,a,i;if(!(!Xt()||!Hn())&&Re==null){try{const o=`${K.BACKEND_BASE_URL}/discover_workflows/sessions/latest`,p=await ot(),u={...p!=null&&p.token?{Authorization:`Bearer ${p.token}`}:{}},h=await(await fetch(o,{headers:u})).json();ut=(e=h==null?void 0:h.metadata)==null?void 0:e.job_id;const m=(t=h==null?void 0:h.metadata)==null?void 0:t.job_start_time;rt=Yt(m||void 0)??void 0;let w=null;try{const v=d.getState(),S=Ne(v),D=(s=(n=(r=S==null?void 0:S.userData)==null?void 0:r.active_organization)==null?void 0:n.super_organization)==null?void 0:s.id,E=(i=(a=S==null?void 0:S.userData)==null?void 0:a.active_organization)==null?void 0:i.id;D&&E&&(w=`${D}|${E}`)}catch{}const b=w?await qt(w):null;if(!(b&&(b!=null&&b.payload))){const{ok:v,stored:S,cleared:D}=await Ar("");if(v&&S){try{chrome.runtime.sendMessage({messageType:"dwLatestResultsUpdated"})}catch{}try{await chrome.alarms.clear(tt)}catch{}Re!=null&&(clearInterval(Re),Re=null),ut=void 0,rt=void 0;try{chrome.runtime.sendMessage({messageType:"dwAutopollFoundNewResults"})}catch{}try{chrome.runtime.sendMessage({messageType:"dwAutopollStopped"})}catch{}return}}}catch{ut=void 0,rt=void 0}try{chrome.runtime.sendMessage({messageType:"dwAutopollStarted"})}catch{}Re=setInterval(async()=>{var o,p;try{const u=`${K.BACKEND_BASE_URL}/discover_workflows/sessions/latest`,h=await ot(),m={...h!=null&&h.token?{Authorization:`Bearer ${h.token}`}:{}},y=await(await fetch(u,{headers:m})).json(),w=(o=y==null?void 0:y.metadata)==null?void 0:o.job_id,b=(p=y==null?void 0:y.metadata)==null?void 0:p.job_start_time,v=Yt(b||void 0),S=v??void 0,D=!!(ut&&w&&w!==ut),E=(()=>typeof S=="number"&&Number.isFinite(S)?typeof rt=="number"&&Number.isFinite(rt)?S>rt:!0:!1)();if(D||E){const{ok:A,stored:T,cleared:I}=await Ar("");if(A&&(T||I)){try{chrome.runtime.sendMessage({messageType:"dwLatestResultsUpdated"})}catch{}try{await chrome.alarms.clear(tt)}catch{}}Re!=null&&(clearInterval(Re),Re=null),ut=void 0,rt=void 0;try{chrome.runtime.sendMessage({messageType:"dwAutopollFoundNewResults"})}catch{}try{chrome.runtime.sendMessage({messageType:"dwAutopollStopped"})}catch{}}}catch{}},5e3)}}async function Th(){Re!=null&&(clearInterval(Re),Re=null),ut=void 0,rt=void 0;try{chrome.runtime.sendMessage({messageType:"dwAutopollStopped"})}catch{}}function $o(){return{running:Re!=null}}const Eh="DWStreamingQueueDB",Ih=1,je="actions",Jt=()=>new Promise((e,t)=>{const r=indexedDB.open(Eh,Ih);r.onupgradeneeded=n=>{const s=n.target.result;s.objectStoreNames.contains(je)||s.createObjectStore(je,{keyPath:"action_id"})},r.onsuccess=n=>e(n.target.result),r.onerror=()=>t(r.error)});async function jo(e,t){const r=await Jt(),n=r.transaction([je],"readwrite"),s=n.objectStore(je);await new Promise((a,i)=>{const o=s.put({action_id:e,payload:t});o.onsuccess=()=>a(),o.onerror=()=>i(o.error||new Error("enqueueAction request error")),n.oncomplete=()=>r.close(),n.onerror=()=>i(n.error||new Error("enqueueAction transaction error"))});try{await Ro()&&await Wl(e,t)}catch{}}async function Wo(e){const t=await Jt(),r=t.transaction([je],"readonly"),n=r.objectStore(je),s=[];return await new Promise((a,i)=>{const o=n.openCursor();o.onsuccess=()=>{const p=o.result;if(!p){a();return}if(s.push(p.value),s.length>=e){a();return}p.continue()},o.onerror=()=>i(o.error)}),await new Promise(a=>{r.oncomplete=()=>{t.close(),a()}}),s}async function kh(e){if(!e.length)return;const t=await Jt(),r=t.transaction([je],"readwrite"),n=r.objectStore(je);await Promise.all(e.map(s=>new Promise((a,i)=>{const o=n.delete(s);o.onsuccess=()=>a(),o.onerror=()=>i(o.error)}))),await new Promise(s=>{r.oncomplete=()=>{t.close(),s()}})}async function Dh(){const e=await Jt(),t=e.transaction([je],"readwrite"),r=t.objectStore(je);let n=0;return await new Promise((s,a)=>{const i=r.openCursor();i.onsuccess=()=>{const o=i.result;if(!o){s();return}const p=o.delete();p.onsuccess=()=>{n+=1,o.continue()},p.onerror=()=>a(p.error)},i.onerror=()=>a(i.error)}),await new Promise(s=>{t.oncomplete=()=>{e.close(),s()}}),n}const Ch=e=>new Promise((t,r)=>{if(!e){t(null);return}const n=new FileReader;n.onloadend=()=>t(n.result),n.onerror=r,n.readAsDataURL(e)}),Ah=10;let Kn=!1;const Rh=1e3,qo=!1;async function Oh(){try{return!!we().isDWActive}catch(e){return W(e,{tags:{component:"long_running_recorder_streaming"},extra:{message:"Error checking if streaming should be enabled"}}),!1}}function Lh(e){try{const t=e.match(/^data:(.*?);base64,(.*)$/);if(!t)return null;const r=t[1]||"image/jpeg",n=t[2],s=atob(n),a=s.length,i=new Uint8Array(a);for(let o=0;o<a;o+=1)i[o]=s.charCodeAt(o);return new Blob([i],{type:r})}catch{return null}}async function Ph(e,t={}){var r,n;try{if(!e)return{blob:null,imageWidth:null,imageHeight:null,relativeActionX:null,relativeActionY:null};let s=null;if(typeof e=="string"?s=Lh(e):e instanceof Blob&&(s=e),!s)return{blob:null,imageWidth:null,imageHeight:null,relativeActionX:null,relativeActionY:null};const a=await createImageBitmap(s),i=typeof t.devicePixelRatio=="number"&&t.devicePixelRatio>1?t.devicePixelRatio:1,o=Math.round(a.width/i),p=Math.round(a.height/i),u=new OffscreenCanvas(o,p),h=u.getContext("2d");if(!h)return{blob:s,imageWidth:null,imageHeight:null,relativeActionX:null,relativeActionY:null};h.drawImage(a,0,0,o,p);const m=2048,y=768,w=!!t.position&&typeof((r=t.position)==null?void 0:r.x)=="number"&&typeof((n=t.position)==null?void 0:n.y)=="number";let b,v=null,S=null;if(w){const D=t.position,E=(D.x||0)/i,A=(D.y||0)/i,T=o>=p,I=Math.min(y,Math.min(o,p)),C=Math.min(m,Math.max(o,p)),N=Math.min(T?C:I,o),O=Math.min(T?I:C,p);let H=Math.max(0,Math.floor(E-N/2)),te=Math.max(0,Math.floor(A-O/2));H+N>o&&(H=o-N),te+O>p&&(te=p-O),b=new OffscreenCanvas(N,O);const ae=b.getContext("2d");if(!ae)return{blob:s,imageWidth:null,imageHeight:null,relativeActionX:null,relativeActionY:null};ae.drawImage(u,H,te,N,O,0,0,N,O);const he=Math.min(N,O);if(he>y){const re=y/he,l=Math.round(N*re),g=Math.round(O*re),c=new OffscreenCanvas(l,g),f=c.getContext("2d");if(!f)return{blob:s,imageWidth:null,imageHeight:null,relativeActionX:null,relativeActionY:null};f.drawImage(b,0,0,l,g),b=c,v=(E-H)*re,S=(A-te)*re}else v=E-H,S=A-te}else{let D=o,E=p;const A=Math.max(D,E);if(A>m){const C=m/A;D=Math.round(D*C),E=Math.round(E*C)}const T=Math.min(D,E);if(T>y){const C=y/T;D=Math.round(D*C),E=Math.round(E*C)}b=new OffscreenCanvas(D,E);const I=b.getContext("2d");if(!I)return{blob:s,imageWidth:null,imageHeight:null,relativeActionX:null,relativeActionY:null};if(I.drawImage(u,0,0,D,E),w){const C=t.position,N=(C.x||0)/i,O=(C.y||0)/i,H=D/o;v=N*H,S=O*H}}try{const D=await b.convertToBlob({type:"image/jpeg",quality:.8});return qo&&v!=null&&S!=null,{blob:D,imageWidth:b.width,imageHeight:b.height,relativeActionX:v,relativeActionY:S}}catch{const D=await b.convertToBlob();return qo&&v!=null&&S!=null,{blob:D,imageWidth:b.width,imageHeight:b.height,relativeActionX:v,relativeActionY:S}}}catch{return{blob:null,imageWidth:null,imageHeight:null,relativeActionX:null,relativeActionY:null}}}function xh(e){let t="click";switch(e.kind){case"mouse_click_action":case"mouse_start_drag_action":case"mouse_end_drag_action":case"mouse_cancel_drag_action":t="click";break;case"keyboard_action":case"keyboard_sequence_action":case"keyboard_combination_action":t="type";break;case"scroll_action":t="scroll";break;default:t="click"}let r;const n=(e.target_tag||"").toLowerCase();return["input","button","select","textarea","a"].includes(n)&&(r=n==="a"?"link":n),{mappedType:t,mappedKind:r}}async function Mh(e){var n;if(!e)return{base64:"",imageFormat:"jpeg"};if(typeof e=="string"){const s=e.match(/^data:image\/(.*?);base64,(.*)$/);return s?{imageFormat:s[1]||"jpeg",base64:s[2]}:{base64:"",imageFormat:"jpeg"}}const t=await Ch(e);if(!t)return{base64:"",imageFormat:"jpeg"};const r=t.match(/^data:image\/(.*?);base64,(.*)$/);return r?{imageFormat:r[1]||"jpeg",base64:r[2]}:{imageFormat:((n=e.type)==null?void 0:n.split("/")[1])||"webp",base64:t}}function Nh(e){if(!e||typeof e!="object")return e;const t={};for(const r of Object.keys(e))e[r]!==void 0&&(t[r]=e[r]);return t}const Fh=e=>["enter","return","tab","escape"].includes(e.toLowerCase()),Uh={space:" ",period:".",dot:".",comma:",",minus:"-",dash:"-",plus:"+",equals:"=",semicolon:";",colon:":",quote:"'",doublequote:'"',backslash:"\\",forwardslash:"/",slash:"/",underscore:"_",leftbracket:"[",rightbracket:"]",leftparen:"(",rightparen:")",leftbrace:"{",rightbrace:"}",lessthan:"<",greaterthan:">",questionmark:"?",exclamation:"!",at:"@",hash:"#",dollar:"$",percent:"%",caret:"^",ampersand:"&",asterisk:"*",tilde:"~",backtick:"`",pipe:"|"},Rr=(e,t=!1)=>!e||e.length===0?"":t||e.some(r=>Fh(r))?`Press ${e.join(" + ")}`:`Type "${e.map(r=>{const n=r.toLowerCase();return Uh[n]||r}).join("")}"`;function $h(e){let t=typeof e.description=="string"?e.description:"";if(t=t.trim().slice(0,Rh),t)return t;if((e==null?void 0:e.kind)==="keyboard_combination_action"&&(e!=null&&e.keys))return Rr(e.keys,!0);if((e==null?void 0:e.kind)==="keyboard_sequence_action"&&(e!=null&&e.keys))return Rr(e.keys,!1);if((e==null?void 0:e.kind)==="keyboard_action"&&(e!=null&&e.key)&&(e!=null&&e.modifiers)){const{modifiers:n}=e,s=Object.values(n).filter(a=>a).length;if(s>1||s>0&&!n.shiftKey){const a=[];return n.metaKey&&a.push("cmd"),n.ctrlKey&&a.push("ctrl"),n.altKey&&a.push("alt"),n.shiftKey&&a.push("shift"),a.push(e.key),Rr(a,!0)}return Rr([e.key],!1)}const{mappedType:r}=xh(e);return r==="type"?"Type text":r==="scroll"?"Scroll page":"Click element"}async function jh(){var e,t,r,n,s,a,i,o,p,u,h,m,y,w,b,v,S,D,E,A,T,I,C,N,O,H,te,ae,he;if(await Oh()&&(()=>{try{return!!we().isDWActive}catch{return!1}})()){if(Kn)return;Kn=!0;try{for(;;){const re=await Wo(Ah);if(!re.length)break;const l=(()=>{var f;try{return((f=Zp().preference)==null?void 0:f.data_destination_org_id)||void 0}catch{return}})(),g={metadata:{action_count:re.length,...l?{data_destination_org_id:l}:{}},actions:re.map(f=>f.payload)};X({message:"dw_streaming_actions_to_cortex",category:"long_running_recorder_streaming",level:"info",data:{actionCount:re.length}});let c=0;try{const f=await At.post(`${Ct}/api/v1/long_recorder/actions/stream_data`,g),_=((e=f==null?void 0:f.data)==null?void 0:e.results)||[],k=_.filter(L=>L==null?void 0:L.success).map(L=>L.action_id);if(k.length){await kh(k);try{await ql(k,Date.now())}catch{}}c=k.length;const R=re.length-c;X({message:"dw_streaming_actions_completed",category:"long_running_recorder_streaming",level:"info",data:{actionCount:re.length,successCount:c,failureCount:R}});try{const L=((t=f==null?void 0:f.headers)==null?void 0:t[q.toLowerCase()])||((n=(r=f==null?void 0:f.config)==null?void 0:r.headers)==null?void 0:n[q])||((a=(s=f==null?void 0:f.config)==null?void 0:s.headers)==null?void 0:a[q.toLowerCase()]),$=((i=f==null?void 0:f.headers)==null?void 0:i[B.toLowerCase()])||((p=(o=f==null?void 0:f.config)==null?void 0:o.headers)==null?void 0:p[B])||((h=(u=f==null?void 0:f.config)==null?void 0:u.headers)==null?void 0:h[B.toLowerCase()]);J("DW.Streaming.BatchSuccess",{actionCount:re.length,successCount:c,failureCount:R,sessionId:L,requestId:$})}catch{}if(R>0){const L=_.filter($=>!($!=null&&$.success));X({message:"dw_streaming_individual_failures",category:"long_running_recorder_streaming",level:"warning",data:{failures:L}});try{const $=((m=f==null?void 0:f.headers)==null?void 0:m[q.toLowerCase()])||((w=(y=f==null?void 0:f.config)==null?void 0:y.headers)==null?void 0:w[q])||((v=(b=f==null?void 0:f.config)==null?void 0:b.headers)==null?void 0:v[q.toLowerCase()]),oe=((S=f==null?void 0:f.headers)==null?void 0:S[B.toLowerCase()])||((E=(D=f==null?void 0:f.config)==null?void 0:D.headers)==null?void 0:E[B])||((T=(A=f==null?void 0:f.config)==null?void 0:A.headers)==null?void 0:T[B.toLowerCase()]);J("DW.Streaming.BatchPartialFailure",{actionCount:re.length,failures:L,sessionId:$,requestId:oe})}catch{}}}catch(f){W(f,{tags:{component:"dw_streaming_queue"},extra:{message:"[DW] Error streaming actions from DW queue"}});try{const _=((C=(I=f==null?void 0:f.response)==null?void 0:I.headers)==null?void 0:C[q.toLowerCase()])||((O=(N=f==null?void 0:f.response)==null?void 0:N.config)==null?void 0:O.headers)&&(f.response.config.headers[q]||f.response.config.headers[q.toLowerCase()]),k=((te=(H=f==null?void 0:f.response)==null?void 0:H.headers)==null?void 0:te[B.toLowerCase()])||((he=(ae=f==null?void 0:f.response)==null?void 0:ae.config)==null?void 0:he.headers)&&(f.response.config.headers[B]||f.response.config.headers[B.toLowerCase()]);J("DW.Streaming.BatchFailure",{error:(f==null?void 0:f.message)||"network_error",sessionId:_,requestId:k})}catch{}break}if(c===0)break}}finally{Kn=!1}}}let Bo=null;const zo=/^(chrome-extension:\/\/[^/]+\/|chrome:\/\/|extension:\/\/|edge:\/\/|opera:\/\/settings|arc:\/\/extensions\/|[^:]+:\/\/extensions\/).*/,Yn=async(e,t,r="click",n)=>{var o,p,u,h,m,y,w,b,v,S,D,E,A;let s,a,i=null;try{t?s=t:s=await ir(),a=(()=>{const{base64Image:T,...I}=s;return I})(),i=(s==null?void 0:s.base64Image)??null,r==="click"&&(Bo=i)}catch(T){const I=await Zr(),C={timestamp:e.timestamp,scribeId:I.scribeId,privacyScreen:I.privacyScreen};(o=T==null?void 0:T.message)!=null&&o.includes("This request exceeds the MAX_CAPTURE_VISIBLE_TAB_CALLS_PER_SECOND quota.")?(i=Bo,P("fallback_screenshot_taken")):(G("screenshot_upload_failed",{errorMessage:T==null?void 0:T.message}),P("screenshot_upload_failed",{reason:"chrome_failed_screenshot_capture",errorName:(p=T==null?void 0:T.metadata)==null?void 0:p.errorName,errorMessage:T==null?void 0:T.message,errorStack:T==null?void 0:T.stack,screenshot_data:C,actionUrl:e.url,fallbackMethodCaptureUrl:(u=T==null?void 0:T.metadata)==null?void 0:u.fallbackMethodCaptureUrl,x:(h=e==null?void 0:e.position)==null?void 0:h.x,y:(m=e==null?void 0:e.position)==null?void 0:m.y,selector:e==null?void 0:e.target_selector,screenshotAttemptId:(s==null?void 0:s.attemptId)??((y=T==null?void 0:T.metadata)==null?void 0:y.screenshotAttemptId)??null,captureDuration:((w=T==null?void 0:T.metadata)==null?void 0:w.captureDuration)||null,failDuration:((b=T==null?void 0:T.metadata)==null?void 0:b.failDuration)||null,wasEarlyScreenshot:(s==null?void 0:s.wasEarlyScreenshot)??!1,wasFallback:(s==null?void 0:s.wasFallback)??((v=T==null?void 0:T.metadata)==null?void 0:v.wasFallback)??null,didNotAttemptFallback:(S=T==null?void 0:T.metadata)==null?void 0:S.didNotAttemptFallback,was_in_iframe:(e==null?void 0:e.was_in_iframe)??null}),d.dispatch(Ps({tempId:e.tempId,partialAction:{failed_ss:!0,screenshot_upload_status:ee.UPLOAD_STATUS.ERROR}})))}if(i){const T=i==null?void 0:i.split(",")[1],{scribeId:I,privacyScreen:C}=await Zr(),{domUpload:N}=n||Se(d.getState());if(r==="click"&&e.domString&&N){const O=((A=(E=(D=d.getState())==null?void 0:D.auth)==null?void 0:E.userData)==null?void 0:A.email)||null;Xl(j,I,e.tempId,e.domString,e.timestamp,0,null,C,O).catch(H=>{const te={scribeId:I,timestamp:e.timestamp};P("dom_upload_queued_for_retry",{dom_data:te,error:H.message})})}Ls(I,C,e.tempId,T,e.timestamp,0,a).catch(O=>{const H={...O},te={scribeId:I,timestamp:e.timestamp,privacyScreen:C};P("screenshot_upload_queued_for_retry",{screenshot_data:te,error:O.message}),G("screenshot_upload_queued_for_retry",H)})}},Go=(e,t,r)=>{var m;const n=["domString","key","target_element"],s=lc.omit({...e.action},n),a=Z(d.getState());P("action_captured",{action:s});const i=d.getState(),{status:o}=fe(i),p=Se(i);if(o===de.PAUSED_RECORDING||o===de.ENDING_RECORDING||o===de.IDLE){r();return}const u={...e.action,favIconUrl:t.tab&&t.tab.favIconUrl,tabId:t.tab&&t.tab.id,tempId:ze()},{domString:h}=u;if(delete u.domString,a.actionsQueue.length===0&&u.url&&!((m=Qr(i))!=null&&m.scribeId)&&(zo.test(u.url)||Os(u)),u.kind===ee.MOUSE_ACTIONS.START_DRAG)Be(u);else if(u.kind===ee.MOUSE_ACTIONS.END_DRAG)Be({...u,screenshot_url:null,dom_url:null,screenshot_upload_status:ee.UPLOAD_STATUS.WAITING}),(async()=>{const y=await ir(),w=(()=>{const{base64Image:v,...S}=y;return S})(),b=(y==null?void 0:y.base64Image)??null;if(b){const v=b==null?void 0:b.split(",")[1],{scribeId:S,privacyScreen:D}=await Zr();Ls(S,D,u.tempId,v,u.timestamp,0,w).catch(E=>{const A={...E},T={scribeId:S,timestamp:u.timestamp,privacyScreen:D};P("screenshot_upload_queued_for_retry",{screenshot_data:T,error:E.message}),G("screenshot_upload_queued_for_retry",A)})}})();else if(u.kind===ee.MOUSE_ACTIONS.CANCEL_DRAG)Be(u);else if(u.kind===ee.MOUSE_ACTIONS.CLICK)Be({...u,screenshot_url:null,dom_url:null,screenshot_upload_status:ee.UPLOAD_STATUS.WAITING}),(async()=>{let y;if(u!=null&&u.earlyScreenshotTimestamp){const w=`early-screenshot-${u.earlyScreenshotTimestamp}`,b=await new Promise(async v=>{let S=0;for(;S<5;){const D=(await chrome.storage.session.get(w))[w];if(D){chrome.storage.session.remove(w),v(D);break}S++,await new Promise(E=>{setTimeout(E,200)})}});b&&(y={base64Image:b,attemptId:Math.random().toString(),successDuration:0,wasEarlyScreenshot:!0,wasFallback:!1,didNotAttemptFallback:!0})}u.domString=h,await Yn(u,y,"click",p)})();else if(u.kind===ee.KEYBOARD_ACTIONS.PRESS){const{modifiers:y={}}=u,{shiftKey:w=!1,altKey:b=!1,ctrlKey:v=!1,metaKey:S=!1}=y,D=[w,b,v,S].filter(Boolean).length;(D>1||D>0&&!w)&&p.screenshotWithKeyboardCombo===!0?(Be({...u,screenshot_url:null,dom_url:null,screenshot_upload_status:ee.UPLOAD_STATUS.WAITING}),(async()=>await Yn(u,null,"keyboard_combo",p))()):Be(u)}else if(u.kind===ee.INPUT_BLUR){const y=a.actionsQueue[a.actionsQueue.length-1];if(y&&y.kind!==ee.KEYBOARD_ACTIONS.PRESS)return;Be({...u,screenshot_url:null,dom_url:null,screenshot_upload_status:ee.UPLOAD_STATUS.WAITING}),(async()=>await Yn(u,null,"click",p))()}else Be(u)},Wh=(e,t,r)=>{const n=d.getState(),s=Z(n),a=Qr(n),i=it(n),o=p=>{const u=it(p);return en(Z(p).actionsQueue,Fe(p).os,xs(p),!!u)};return((p,u)=>{if(u)return!1;switch(p){case tn.AUDIO_ONLY:return i&&s.actionsQueue.length===0;case tn.ALWAYS:return s.actionsQueue.length===0;case tn.NEVER:return!1;default:return!1}})(e.setFirstAction,!!(a!=null&&a.scribeId))?(Y().then(p=>{p&&!zo.test((p==null?void 0:p.url)||"")&&Os({url:p.url??"",tabId:p.id??0}),r({actions:o(d.getState()),deletedActionIds:Z(d.getState()).deletedActionIds||[]})}),!0):(r({actions:o(d.getState()),deletedActionIds:Z(d.getState()).deletedActionIds||[]}),!1)},qh=e=>Jl(_l,e),Bh=e=>Ql(wl,e);function Vo(e,t){const{extensionSidepanel2024q1:r}=Se(d.getState()),n=dc()||0;if(r||n>128){const s={url:e.startingUrl||"",id:e.scribe.id,name:e.scribe.name,location:e.location,actionIndex:e.scribe.actionIndex||""};d.dispatch(uc(s)),e.isOnPages?(chrome.action.setPopup({popup:"src/scripts/confirm-guide-me/index.html"}),chrome.action.openPopup(),chrome.action.setPopup({popup:""})):chrome.windows.getLastFocused({populate:!1},a=>{a.id&&(e.targetWindowId=a.id,ua(e,j))})}else Rl(e,j)}const zh=15e3,Gh=async e=>new Promise(t=>{const r=`${K.BACKEND_BASE_URL}/workos_sso/auth?domain=${encodeURIComponent(e)}`;chrome.windows.create({url:r,state:"minimized"},n=>{if(!n||!n.id){t({success:!1,reason:"Failed to create auth window"});return}let s=!1;const a=(i,o,p)=>{var u;p.windowId===n.id&&(s||(u=o.url)!=null&&u.includes("api/workos_sso/auth-complete")&&(s=!0,chrome.tabs.onUpdated.removeListener(a),n.id&&chrome.windows.remove(n.id,()=>{t({success:!0,reason:"completed"})})))};chrome.tabs.onUpdated.addListener(a),setTimeout(()=>{s||(s=!0,chrome.tabs.onUpdated.removeListener(a),n.id?chrome.windows.remove(n.id,()=>{t({success:!1,reason:"timeout"})}):t({success:!1,reason:"Missing window id"}))},zh)})}),Xn=async()=>{try{const e=await chrome.storage.managed.get(),t=Object.fromEntries(Object.entries(e).map(([a,i])=>[a.toLowerCase(),i])),r=t.silentloginenabled==="true"||t.silentloginenabled===!0||!1,n=typeof t.domain=="string"?String(t.domain||""):"",s=t.autologinonstartup==="true"||t.autologinonstartup===!0||!1;return n?{autoLoginOnStartup:s,domain:n,silentLoginEnabled:r,success:!0}:(G("silent_auth_failed",{reason:"no_domain_in_managed_config"}),{autoLoginOnStartup:s,domain:n,silentLoginEnabled:r,success:!1})}catch(e){return G("silent_auth_failed",{error:e.message,reason:"managed_config_error"}),{success:!1}}},Jn="ScribeSilentAuthRetryAlarm",Vh=async e=>{if(e.name===Jn){try{await chrome.alarms.clear(Jn)}catch(t){G("silent_auth_retry_alarm_clear_failed",{error:t.message})}await Qn("retry")}},Hh=e=>{const t=new Date,r=new Date;return r.setHours(e,0,0,0),r.getTime()<=t.getTime()&&r.setDate(r.getDate()+1),r.getTime()-t.getTime()},Ho=async(e,t)=>{const r=Hh(14),n=r/1e3/60;await chrome.alarms.create(Jn,{delayInMinutes:n,periodInMinutes:24*60}),G("silent_auth_retry_scheduled",{domain:e,scheduledFor:new Date(Date.now()+r).toISOString(),reason:t})},Qn=async e=>{try{const{silentLoginEnabled:t,domain:r,success:n}=await Xn(),s=d.getState().auth.userData;if(!t||s)return;if(!n){await Ho(r||"unknown","managed_config_failure");return}if(t&&r){const a=await Gh(r),{success:i,reason:o}=a;i?G("silent_auth_success",{domain:r,reason:o,initializedFrom:e}):(G("silent_auth_failed",{domain:r,reason:o}),await Ho(r,o))}else G("silent_auth_failed",{domain:r||"unknown",reason:"unknown"})}catch(t){G("silent_auth_failed",{reason:"exception",error:t.message})}},Ko=50,Kh=3,Yh=[1e3,2e3,5e3];let Qt=[],Zn=null;const Xh=5e3;async function Yo(e,t=0){var r;try{const n={metadata:{url_count:e.length,batch_timestamp:Date.now()},urls:e.map(a=>({url:a.url,timestamp:new Date(a.timestamp).toISOString(),user_id:a.user_id,active_org_id:a.active_org_id,super_org_id:a.super_org_id,app_tag_uuid:a.app_tag_uuid}))},s=await At.post(`${Ct}/api/v1/long_recorder/actions/stream_url`,n);return X({message:"url_streaming_success",category:"url_streaming",level:"info",data:{urlCount:e.length,retryCount:t}}),s}catch(n){if((!n.response||((r=n.response)==null?void 0:r.status)>=500)&&t<Kh){const s=Yh[t];return X({message:"url_streaming_retry_attempt",category:"url_streaming",level:"warning",data:{retryCount:t+1,delay:s,error:n.message,urlCount:e.length}}),await new Promise(a=>setTimeout(a,s)),Yo(e,t+1)}throw W(n,{tags:{component:"url_streaming"},extra:{message:"Failed to stream URLs after all retries",urlCount:e.length,retryCount:t}}),n}}async function Jh(e){try{const t=await j.post("/app_tag/batch_search/",{urls:e}),r=new Map;if(t.data&&Array.isArray(t.data))for(const n of t.data)n&&typeof n.url=="string"&&r.set(n.url,n.id??null);return r}catch(t){return W(t,{tags:{component:"url_streaming"},extra:{message:"Failed to fetch app tag UUIDs for batch",urlCount:e.length,sampleUrls:e.slice(0,5)}}),new Map}}async function Qh(){if(Qt.length===0)return;const e=[];for(let t=0;t<Qt.length;t+=Ko)e.push(Qt.slice(t,t+Ko));Qt=[];for(const t of e)try{const r=[...new Set(t.map(a=>a.url))],n=await Jh(r),s=t.map(a=>{const i=n.get(a.url);return{...a,app_tag_uuid:i??void 0}});await Yo(s)}catch(r){W(r,{tags:{component:"url_streaming"},extra:{message:"Failed to process and stream batch",batchSize:t.length,sampleUrls:t.slice(0,3).map(n=>n.url)}})}}function Zh(){Zn&&clearTimeout(Zn),Zn=setTimeout(()=>{Qh().catch(e=>{W(e,{tags:{component:"url_streaming"},extra:{message:"Top-level batch processing failure"}})})},Xh)}function em(e){if(!e.url||!e.timestamp){console.warn("[URL Streaming] Missing required fields, skipping:",e);return}Qt.push(e),e.url,Zh()}var tm=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};tm.SENTRY_RELEASE={id:"1305c76edd7b4291b80d5f57cd104316065124a5"};try{Jp()}catch{}let Xo=0;const rm=()=>{const e=performance.now();let t=0;for(let n=1;n<6e6;n++)t+=Math.sqrt(n)*Math.sin(n%360)*Math.cos(Math.random()*n)/(Math.log(n+1)+1);const r=performance.now();return globalThis.cpuResult=t,Math.floor(r-e)},es=async()=>{var r,n,s;nn(),await chrome.storage.local.remove("persist:localStorage"),d.dispatch({type:"PURGE_REDUX"});const e=await Sc();d.dispatch(kg(e)),await Dr(),ym();try{try{indexedDB.deleteDatabase("LongRunningRecorderDB")}catch{}try{indexedDB.deleteDatabase("SuggestedScribesDB")}catch{}try{indexedDB.deleteDatabase("RejectedLongSummariesDB")}catch{}if((r=we())!=null&&r.isDWActive){const[a]=await Promise.all([Vl(),Jt(),Fl()]);a&&a.close();try{await Promise.all([Hl(),Ul()])}catch{}}}catch{}chrome.runtime.getPlatformInfo(a=>{a&&d.dispatch(Eg(a.os))});const t=rm();d.dispatch(Dg({bench:t,cores:(navigator==null?void 0:navigator.hardwareConcurrency)??null,rtt:((n=navigator==null?void 0:navigator.connection)==null?void 0:n.rtt)??null,downlink:((s=navigator==null?void 0:navigator.connection)==null?void 0:s.downlink)??null})),(await Al()).isSupported||(_n("recordingControlsPreference","floating-button"),chrome.runtime.sendMessage({messageType:"optionsChanged"})),Promise.all([sa(),aa()]).then(([a,i])=>{Array.isArray(a)||fn([]),Array.isArray(i)||yn([])})};chrome.runtime.onStartup.addListener(async()=>{await es(),Rt({callSource:"onStartup listener"}).then(t=>{t&&oi()});const{autoLoginOnStartup:e}=await Xn();e&&Qn("startup"),kt(),await Ms.flush();try{Uo()}catch{}chrome.runtime.reload()}),chrome.runtime.onInstalled.addListener(async e=>{if(vo(),e.reason===chrome.runtime.OnInstalledReason.INSTALL){es(),G("installed_extension"),P("extension_installed");const{silentLoginEnabled:t}=await Xn();t&&Qn("install"),chrome.runtime.setUninstallURL(pc)}else e.reason===chrome.runtime.OnInstalledReason.UPDATE&&es();Rt({callSource:"onInstalled listener"}).then(t=>{t&&oi(),e.reason===chrome.runtime.OnInstalledReason.INSTALL&&am(t)});try{Uo()}catch{}}),chrome.alarms.onAlarm.addListener(async e=>{Vh(e)});const ts=async()=>{const{permissions:e,origins:t}=await chrome.permissions.getAll(),r=t.includes("<all_urls>");return r||P("permissions_missing",{origins:t,permissions:e}),d.dispatch(Cg(!r)),r},nm=e=>{chrome.action.getUserSettings().then(t=>{(e==null?void 0:e.extension_currently_pinned)!==t.isOnToolbar&&(j.patch("/users/growth_state/",{extension_currently_pinned:t.isOnToolbar}),G(t.isOnToolbar?"extension_pinned":"extension_unpinned"))})},Rt=async e=>{var t,r;try{await gc();const[n,s,a]=await Promise.all([j.get("/users/"),j.get("/users/growth_state/"),j.get("/users/user_settings/")]);let i=n==null?void 0:n.data;try{const o=[i==null?void 0:i.active_organization,...(i==null?void 0:i.organizations)||[]].filter(Boolean),p=[...new Set(o.map(m=>{var y;return(y=m==null?void 0:m.super_organization)==null?void 0:y.id}).filter(Boolean))],u=(await Promise.all(p.map(m=>j.get(`/super_organization_admin/${m}/`).then(y=>{var w;return{id:m,role:(w=y==null?void 0:y.data)==null?void 0:w.role}}).catch(y=>(W(y,{extra:{title:"Error fetching super organization role"}}),null))))).filter(m=>m&&m.role).reduce((m,{id:y,role:w})=>({...m,[y]:w}),{}),h=m=>{var w;if(!((w=m==null?void 0:m.super_organization)!=null&&w.id))return m;const y=u[m.super_organization.id];return y?{...m,super_organization:{...m.super_organization,role:y}}:m};i={...i,active_organization:h(i.active_organization),organizations:((t=i.organizations)==null?void 0:t.map(h))||[]}}catch(o){W(o,{extra:{title:"Error enriching user data with roles"}})}if(n&&n.status===200){Yg(i),d.dispatch(Nt(i));try{Qp("post-login")}catch{}return d.dispatch(hc(a==null?void 0:a.data)),i&&(P("user_logged_in",{email:i.email,options:e}),mc({email:i.email}),fc(i,s==null?void 0:s.data),(r=s==null?void 0:s.data)!=null&&r.installed_extension?d.dispatch(ft(s==null?void 0:s.data)):(j.patch("/users/growth_state/",{installed_extension:!0}),d.dispatch(ft({...s==null?void 0:s.data,installed_extension:!0}))),d.dispatch(yc({api:j})),nm(s==null?void 0:s.data),ch()),i}return d.dispatch(Nt(null)),null}catch(n){if(await kt())return d.dispatch(Nt(null)),null;W({title:"Error fetching user",err:n}),console.error("Error fetching user",n)}return null},sm=async()=>{var r,n,s;let e=!1;const t=Rs();if(![Tc.Opera].includes(t))try{await new Promise(i=>setTimeout(i,200));const a=(r=await chrome.storage.managed.get())==null?void 0:r.SuppressWelcomeTab;a===!0||a===1||a==="1"||a==="true"?(e=!0,P("suppress_welcome_tab_active",{matchedValue:a,matchedType:typeof a})):a!==void 0&&P("suppress_welcome_tab_unexpected_value",{unexpectedValue:a,unexpectedType:typeof a})}catch(a){P("suppress_welcome_tab_error",{error:a.message||a,errorType:a.name,errorStack:a.stack}),W({title:"Error checking managed storage for SuppressWelcomeTab",error:a})}if(!e)try{const a=await chrome.tabs.query({index:0,lastFocusedWindow:!0});if(a.length>0){const i=a[0];((n=i.url)!=null&&n.includes("altamed.org")||(s=i.url)!=null&&s.includes("login.microsoftonline.com"))&&(e=!0,P("suppress_welcome_tab_altamed_domain_detected"))}}catch(a){P("altamed_domain_check_error",{error:a.message||a,errorType:a.name,errorStack:a.stack})}return e},am=async e=>{if(!_c){if(await sm()){P("suppress_welcome_tab_managed_policy_set");return}e?chrome.tabs.query({currentWindow:!0}).then(t=>{t=t.filter(r=>r.url.includes(rn())),t.length>0?chrome.tabs.update(t[0].id,{highlighted:!0,url:Ns()}):chrome.tabs.create({url:Ns()})}):chrome.tabs.create({url:wc()})}},Jo=(e,t,r)=>{var p;d.dispatch(cn());const{networkError:n,s3ConnectionError:s,backendConnectionError:a,networkOrServerError:i}=Pt(d.getState());e.targetTaskId&&d.dispatch(on(e.targetTaskId));const o=u=>{P("browser_start_recording",{request:e}),d.dispatch(ln(e.source)),Zt(u,void 0,e.entryPoint),r({isRecording:!0})};if(!De(d.getState())){if(e.startRecordingFromNewTab||e.startRecordingFromUrl){const u=e.startRecordingFromUrl&&e.url?e.url:Zs;chrome.tabs.create({url:u}).then(h=>{if(n||s||a){d.dispatch(Ht(!0)),d.dispatch(Je(!0)),P("create_new_tab_error",{networkOrServerError:i});return}h.status==="complete"?o(h):Om(h,o)})}else e.targetTabId&&chrome.tabs.query({}).then(u=>{u=u.filter(h=>h.id===e.targetTabId),chrome.extension.isAllowedFileSchemeAccess().then(h=>{if(u.length>0&&!ke(u[0].url,h)){if(chrome.tabs.update(u[0].id,{active:!0}),chrome.windows.update(u[0].windowId,{focused:!0}),n||s||a){P("browser_initiated_recording_failed",{networkOrServerError:i}),d.dispatch(Ht(!0));return}o(u[0])}else r({isRecording:!1,isAllowedFileSchemeAccess:h})})});if(_t()){const u=e.targetTabId||((p=t==null?void 0:t.tab)==null?void 0:p.id);e.targetWindowId?Ft(e.targetWindowId,se.Recorder,{frontendUrl:K.FRONTEND_URL}):u?Ce(u,se.Recorder,{frontendUrl:K.FRONTEND_URL}):P("side_panel_not_opened",{reason:"No target tab nor window ID provided",request:e,sender:t,function:"browserStartRecording"})}return chrome.action.setPopup({popup:""}),!0}},rs=(e,t,r,n=!1)=>{var u;const{networkError:s,s3ConnectionError:a,backendConnectionError:i,networkOrServerError:o}=Pt(d.getState()),p=h=>{P("edit_recording_for",{request:e}),G("edited_file_add_recording",{platform:Qs(),capture_type:"extension",file_id:e.scribeId});const m=n?"recapture":void 0;Zt(h,e.scribeId,m),r({status:"success"})};if(!De(d.getState())){if(Y().then(h=>{d.dispatch(il(h==null?void 0:h.id))}),!e.startRecordingFromNewTab&&e.targetTabId)_t()&&!n&&Ce(e.targetTabId||((u=t.tab)==null?void 0:u.id),se.Recorder,{frontendUrl:K.FRONTEND_URL}),chrome.tabs.query({}).then(h=>{h=h.filter(m=>m.id===e.targetTabId),chrome.extension.isAllowedFileSchemeAccess().then(m=>{if(h.length>0&&!ke(h[0].url,m)){if(chrome.tabs.update(h[0].id,{active:!0}),chrome.windows.update(h[0].windowId,{focused:!0}),s||a||i){P("browser_initiated_recording_failed",{networkOrServerError:o}),d.dispatch(Ht(!0));return}p(h[0])}else r({isRecording:!1,isAllowedFileSchemeAccess:m})})});else{e.targetWindowId&&_t()&&!n&&Ft(e.targetWindowId,se.Recorder,{frontendUrl:K.FRONTEND_URL});const h=Zs;chrome.tabs.create({url:h}).then(m=>{if(s||a||i){d.dispatch(Ht(!0)),d.dispatch(Je(!0)),P("create_new_tab_error",{networkOrServerError:o});return}p(m)})}return!0}r({status:"error",details:"Already recording."})},ns=e=>{e.scribeId&&d.dispatch(an(e)),e.entryPoint&&d.dispatch(zs(e.entryPoint)),e.taskId?d.dispatch(on(e.taskId)):d.dispatch(on("")),d.dispatch(xc(!!e.isScribeEditMode)),chrome.action.setPopup({popup:"src/scripts/tab-selector/index.html"}),chrome.action.openPopup(),chrome.action.setPopup({popup:""})};async function Qo(e){d.dispatch(cl(e))}const om=(e,t,r)=>{var s,a,i;if(e.messageType==="selectMicrophone"&&e.microphoneId&&(Qo(e.microphoneId),r({status:"success"})),e.messageType==="getAuthToken")return ot().then(o=>{r(o)}).catch(o=>{console.error("[Auth] Error getting auth token:",o),r({error:o.message||"Failed to get auth token"})}),!0;if((e==null?void 0:e.messageType)==="startCopilot"){d.dispatch(cr(!0));const o={};e!=null&&e.copilotPrompt&&(o.copilotPrompt=e.copilotPrompt),e!=null&&e.copilotSuggestionsTitle&&(o.copilotSuggestionsTitle=e.copilotSuggestionsTitle),e!=null&&e.copilotSuggestionsSubtitle&&(o.copilotSuggestionsSubtitle=e.copilotSuggestionsSubtitle),e!=null&&e.copilotSuggestedPrompts&&(o.copilotSuggestedPrompts=e.copilotSuggestedPrompts),e!=null&&e.copilotSearch&&(o.copilotSearch=e.copilotSearch),Ce((s=t.tab)==null?void 0:s.id,se.Copilot,{queryParams:o})}if(e.messageType==="submitCopilotPrompt"&&(Po(e.sessionId),d.dispatch(cn),!De(d.getState())))return Y().then(o=>{d.dispatch(ln(e.source)),chrome.extension.isAllowedFileSchemeAccess().then(p=>{o&&!ke(o.url,p)?(Zt(o,null,ur.EXTENSION),r({isRecording:!0})):r({isRecording:!1,isAllowedFileSchemeAccess:p})})}),!0;if(e.messageType==="getDomForCopilot"&&Po(),e.messageType==="toggleDropdownExtension"){const o=ll(d.getState());d.dispatch(Je(!o));return}if(e.messageType==="updateGrowthState"){const{updates:o}=e,p={...d.getState().auth.userGrowthState,...o};return j.patch("/users/growth_state/",o).then(()=>{d.dispatch(ft(p))}).catch(u=>{d.dispatch(ft(p)),W(u,{tags:{component:"pins"},extra:{title:"Error updating growth state",error:u==null?void 0:u.message}})}),!0}if(e.messageType==="currentVisibleAction"&&(Wt(!0),ia().then(o=>{var p;(o==null?void 0:o.id)!==((p=e==null?void 0:e.action)==null?void 0:p.id)&&ca(e.action)})),e.messageType==="guideMeStepForward"){Y().then(o=>{chrome.tabs.sendMessage(o.id,{messageType:"guideMeStepForward"})});return}if(e.messageType==="showGuideMeLoading"){Y().then(o=>{chrome.tabs.sendMessage(o.id,{messageType:"showGuideMeLoading"})});return}if(e.messageType==="hideGuideMeLoading"){Y().then(o=>{chrome.tabs.sendMessage(o.id,{messageType:"hideGuideMeLoading"})});return}if(e.messageType==="setIsAutopilot"){Y().then(o=>{chrome.tabs.sendMessage(o.id,{messageType:"setIsAutopilot",isAutopilot:e.isAutopilot})});return}if(e.messageType==="navigateActiveTabToActionUrl"){const o=(a=e==null?void 0:e.action)==null?void 0:a.url;o&&chrome.tabs.query({active:!0,lastFocusedWindow:!0},p=>{try{chrome.tabs.update(p[0].id,{url:o})}catch(u){console.error("Error updating tab with url",u)}})}if(e.messageType==="checkForLocalStorageScribes")return nn().then(({localScribeDetected:o,scribeId:p})=>{r({localScribeDetected:o,scribeId:p})}),!0;if(e.messageType==="discardLocalStorageScribes"&&(yt(),r({message:"discarded"})),e.messageType==="getGuideMeSessionId")return Tl().then(o=>{r({sessionId:o})}),!0;e.messageType==="setIsGuiding"&&(Wt(e.isGuiding),e.isGuiding===!1&&pr()),e.messageType==="removeLiveOverlay"&&pr(),e.messageType==="launchRecommendedScribes"&&pa(e.url);const n=De(d.getState());if(e.messageType&&e.messageType!=="editRecordingFor")if(e.messageType==="browserStartRecording")Jo(e,t,r);else if(e.messageType==="browserStopRecording")chrome.tabs.create({url:`${K.FRONTEND_URL}/billing`}),Or();else if(e.messageType==="browserDeleteRecording")Or(e.isCopilot);else if(e.messageType==="browserCompleteCapture")P("browser_complete_capture",{request:e,isRecording:n,recordingControls:(i=ct(d.getState()))==null?void 0:i.recordingControlsPreference}),n&&Ut({isCopilot:e.isCopilot,copilotPrompt:e.copilotPrompt,isLocalScribe:e.isLocalScribe,isLocalImageRetry:e.isLocalImageRetry,deletedActionIds:e.deletedActionIds});else if(e.messageType==="browserPauseCapture")n&&ci();else if(e.messageType==="browserBlurCapture")chrome.tabs.query({active:!0,currentWindow:!0}).then(o=>{chrome.tabs.sendMessage(o[0].id,{messageType:"toggleBlurControls"})});else if(e.messageType==="setIsTranscribing")d.dispatch(gn(e.isTranscribing)),e.isTranscribing&&hn();else if(e.messageType==="action"){Go(e,t,r);return}else e.messageType==="updateSidepanelContentUrl"&&Y().then(o=>{var h,m,y,w;const p=(m=(h=e.url)==null?void 0:h.match(/\?url=(.*)/))==null?void 0:m[1],u=(o==null?void 0:o.url)||p;if(dl(e==null?void 0:e.url),u&&(e==null?void 0:e.url.includes(se.Assistant))&&!e.copilotEntry){const b=((w=(y=e.url)==null?void 0:y.split("?"))==null?void 0:w[1])||"",v=new URLSearchParams(b);v.delete("url"),Ce(o==null?void 0:o.id,se.Assistant,{queryParams:{url:u,...Object.fromEntries(v)},frontendUrl:K.FRONTEND_URL})}});if(e.messageType==="openPopup"&&ns(e),e.messageType==="recaptureStep"&&Y().then(o=>{if(o){const p={...e,isStepRecapture:!0,targetTabId:o.id,targetWindowId:o==null?void 0:o.windowId,stepRecaptureDescription:e.description};d.dispatch(an(p)),rs(p,t,r,!0)}}),e.messageType==="openScribeViewer"&&Vo(e),e.messageType==="cleanupDomFromCopilot"&&chrome.tabs.query({},o=>{o.forEach(p=>{chrome.scripting.executeScript({target:{tabId:p.id},func:()=>{var u;(u=document==null?void 0:document.querySelectorAll("[_i_d]"))==null||u.forEach(h=>h==null?void 0:h.removeAttribute("_i_d"))}})})}),e.messageType==="openSidePanel"&&Ce(t.tab.id,e.route,{frontendUrl:K.FRONTEND_URL}),e.messageType==="setSidePanelRoute"){xt(d.getState())&&d.dispatch(cr(!1)),e.entryPoint&&e.entryPoint===ur.VIEWER_INTRO_PAGE&&chrome.tabs.query({},p=>{const[u]=p.filter(h=>h.url&&h.url.includes("/intro-viewer"));u&&chrome.tabs.update(u.id,{url:ea()},()=>{chrome.runtime.lastError&&console.error("Error updating tab:",chrome.runtime.lastError)})});const o=e.queryParams||Object.fromEntries(Object.entries({url:e.url,copilotEntry:e.copilotEntry,searchEntry:e.searchEntry,closeAssistantOnBack:e.closeAssistantOnBack}).filter(([,p])=>p!=null));ul(e.route,{queryParams:o,frontendUrl:K.FRONTEND_URL})}if(e==="version"){r(chrome.runtime.getManifest().version);return}if(e==="options"){r(ct(d.getState()));return}if(e==="checkPermissions")return Rt({callSource:"checkPermissions message handler"}).then(o=>{o?r(!0):ts().then(p=>{r(p),d.dispatch(Je(!p))})}),!0;if(e.messageType==="checkServerAvailability")return kt().then(o=>{r(o)}),!0;if(e==="startRecording"){if(!n)return chrome.tabs.query({active:!0,currentWindow:!0}).then(o=>{Zt(o[0]),r({status:"success"})}),!0;r({status:"error",details:"Already recording."});return}if(e.messageType==="editRecordingFor"&&(d.dispatch(an(e)),rs(e,t,r)),e==="stopRecording"){n&&Ut();return}if(e.messageType==="openUrl"&&chrome.tabs.create({url:e.url}).then(o=>{if(e.pinDocument){d.dispatch(It(!0));const p=(u,h,m)=>{u===o.id&&h.status==="complete"&&m.status==="complete"&&(chrome.tabs.sendMessage(o.id,{messageType:"setPinDocument",document:e.pinDocument}),setTimeout(()=>{chrome.tabs.sendMessage(o.id,{messageType:"setPinDocument",document:e.pinDocument})},1e3),chrome.tabs.onUpdated.removeListener(p))};chrome.tabs.onUpdated.addListener(p)}}),e.messageType==="highlightElementWithId"){d.dispatch(pl(e.elementId)),chrome.tabs.query({active:!0,currentWindow:!0},function(o){var p;o&&((p=o[0])!=null&&p.id)&&chrome.tabs.sendMessage(o[0].id,{messageType:"highlightElementWithId",elementId:e.elementId,url:e.url,hasScreenshot:e.hasScreenshot,modalInstruction:e.modalInstruction,sessionId:e.sessionId,requestId:e.requestId})});return}if(e.messageType==="highlightAIFallbackElement"){ia().then(o=>{o&&ca({...o,aiFallbackElementId:e.elementId})});return}if(e.messageType==="userEditPermission"){Y().then(o=>{chrome.tabs.sendMessage(o.id,{messageType:"userEditPermission",canEdit:e.canEdit}),El(e.canEdit)});return}if(e.messageType==="removeCopilotClickTarget"&&(e.targetTabId?chrome.tabs.sendMessage(e.targetTabId,{messageType:"removeCopilotClickTarget"}):Y().then(o=>{chrome.tabs.sendMessage(o.id,{messageType:"removeCopilotClickTarget"})})),e.messageType==="startCopilotGenerating"&&Y().then(o=>{chrome.tabs.sendMessage(o.id,{messageType:"startCopilotGenerating"})}),e.messageType==="stopCopilotGenerating"&&Y().then(o=>{chrome.tabs.sendMessage(o.id,{messageType:"stopCopilotGenerating"})}),e==="enableExtensionNotifications")return chrome.permissions.contains({permissions:["notifications"]},function(o){o?r({status:"enabled"}):chrome.permissions.request({permissions:["notifications"]},function(p){r(p?{status:"enabled"}:{status:"disabled"})})}),!0;if(e==="isRecording"){r(n);return}if(e==="getTabs")return Gs().then(o=>r(o)),!0;if(e.messageType==="getLastFocusedWindow")return chrome.windows.getLastFocused({populate:!1},o=>{r(o)}),!0;if(e==="getRecordingState")return r(Z(d.getState())),!0;if(e.messageType==="openTabSelector")return chrome.tabs.create({url:"src/scripts/tab-selector/index.html"}),!0;if(e.messageType==="initializeRecordingPreview")return Wh(e,t,r);if(e.messageType==="updateAction"&&d.dispatch(gl(e.action)),e==="getExtensionState"){const{status:o}=fe(d.getState()),p=ct(d.getState());r({installed:!0,options:p,status:o,version:chrome.runtime.getManifest().version});return}if((e==null?void 0:e.messageType)==="setPinExtensionModalVisibility"&&chrome.storage.local.set({isPinExtensionModalVisible:e.isVisible}),e.messageType==="startDropPin"){Y().then(o=>{chrome.tabs.sendMessage(o.id,{messageType:"startDropPin"}),d.dispatch(It(!0)),e.scribe?d.dispatch(Tr(e.scribe)):d.dispatch(Tr(null))});return}r({unsupportedMessage:!0})};Bh(function(e,t,r){return om(e,t,r)});const im=new Do(2e3),cm=async({removed:e,cookie:t,cause:r})=>{Ec(t.domain)&&(t.name===Ic||t.name===kc)&&t.path===Dc&&r!=="overwrite"&&(e&&await Cc(t)?(d.dispatch(Nt(null)),chrome.tabs.query({}).then(n=>{const s={messageType:"loggedOut"};n.forEach(a=>le(a,s))}),d.dispatch(Ac()),Ws(se.Home),K.FRONTEND_URL=qs.FRONTEND_URL,K.BACKEND_BASE_URL=qs.BACKEND_BASE_URL):im.invoke(()=>{Rt({callSource:"cookieChangedListener",cause:r})}))};chrome.cookies.onChanged.addListener(cm),chrome.cookies.onChanged.addListener(vc);const lm=async()=>{if(chrome!=null&&chrome.notifications){const e=await j.get("/notifications/get/");if(e.status===200&&e.data.hasOwnProperty("description")){const t=ze();d.dispatch(Ig({notifId:t,res:e.data.url})),chrome.notifications.create(t,{type:"basic",iconUrl:"https://colony-labs-public.s3.us-east-2.amazonaws.com/images/logo/extension.svg",title:e.data.title,message:e.data.description})}}};(pi=chrome==null?void 0:chrome.notifications)==null||pi.onClicked.addListener(function(e){const{linkMap:t}=Fe(d.getState());e in t&&(chrome.tabs.create({url:t[e]}),delete t[e])});const dm=()=>{chrome.tabs.query({}).then(e=>{e.forEach(t=>{chrome.action.setBadgeText({text:"",tabId:t.id})})})},um=()=>{chrome.tabs.create({url:rn()})},pm=()=>{chrome.tabs.create({url:ea()})},gm=()=>{chrome.tabs.create({url:hl}),yt()},Zo=()=>!De(d.getState()),ei=e=>{var t,r,n,s;return e?((t=e.pendingUrl)==null?void 0:t.startsWith("chrome://newtab/"))||((r=e.url)==null?void 0:r.startsWith("chrome://newtab/"))||((n=e.pendingUrl)==null?void 0:n.startsWith("edge://newtab/"))||((s=e.url)==null?void 0:s.startsWith("edge://newtab/")):!1},hm=async e=>{var a;const t=ml(d.getState()),r=Z(d.getState());if(!t)return Promise.resolve(e);let n=null,s=null;try{n=await chrome.tabs.get(e)}catch(i){s=i}if(!n)return Promise.reject(`No tab was found with an id ${e}: ${s}`);if(!n.pendingUrl&&!n.url)return Promise.reject(`Tab has no valid URLs ${n}`);if(r.actionsQueue.length!==0){if((n.pendingUrl&&ke(n.pendingUrl)||n.url&&ke(n.url))&&!ei(n)||((a=r.currentTab)==null?void 0:a.id)===e||!n.title&&!n.url)return Promise.resolve(e);Be({kind:"instruction",description:ei(n)?"Open a new tab":`${ee.SPECIAL_INDICATORS.SWITCH_TO_TAB_PREFIX}${n.title}"`,tabId:e,tempId:ze()})}return!r.recordedTabs.find(i=>i===e)&&n.title&&ri(n).then(()=>{d.dispatch(dn({tab:n,host:mn(n==null?void 0:n.url),url:n==null?void 0:n.url}))}),Promise.resolve(e)},mm=new Do(150),fm=(e,t)=>{const{currentFocusedActiveTabId:r}=fe(e),{currentFocusedActiveTabId:n}=fe(t),s=Z(t);r!==n&&hm(n).catch(console.error),t.recordingState.scribeId&&mm.invoke(()=>{var o,p;const a=it(t),i=en(Z(t).actionsQueue,Fe(t).os,xs(t),a||s.isTranscribing);chrome.runtime.sendMessage({messageType:"extensionStateUpdate",data:{actions:i,scribeId:t.recordingState.scribeId,isTranscribing:s.isTranscribing,audioError:s.audioError,isTranscriberReady:s.isTranscriberReady,availableMicrophones:((o=t.microphones)==null?void 0:o.availableMicrophones)??[],selectedMicrophoneId:((p=t.microphones)==null?void 0:p.selectedMicrophoneId)??null,deletedActionIds:t.recordingState.deletedActionIds||[],status:fe(t).status}})})};Sr(d,fm);const ym=()=>{chrome.tabs.query({}).then(async e=>{e.forEach(async t=>{if(t!=null&&t.url&&!ke(t.url))try{await ti(t.id)}catch{}})})},ti=async e=>{await chrome.scripting.executeScript({target:{tabId:e},files:[Oo]}),await chrome.scripting.executeScript({target:{tabId:e,allFrames:!0},files:[Lo]})},ri=async e=>{const{areaSelectorRecording:t}=Se(d.getState()),{liveBlurEnabled:r,liveBlurSettings:n}=dr(d.getState()),s=mn(e==null?void 0:e.url),a=it(d.getState()),i={host:null,href:null,retried:!1},o=e.url?e.url:e.pendingUrl,p=_t(),u=fl();if(ke(o))return i;await Rt({callSource:"startRecordingOnTab"}),d.dispatch(un(e.id));try{return await le(e,{messageType:"startRecording",areaSelectorRecording:t,liveBlurEnabled:r,liveBlurSettings:n,liveTranscriptions:p,audioRecordingEnabled:a}),u&&hn(),P("recording_started_on_tab",{tab:e,voiceTranscriptionEnabled:a}),{host:s,href:e==null?void 0:e.url,retried:!1}}catch(h){P("recording_started_on_tab_failed",{tab:e,voiceTranscriptionEnabled:a,error:h,errorMessage:h==null?void 0:h.message}),console.warn("first start recording on tab attempt failed",h)}try{return await ti(e.id),await le(e,{messageType:"startRecording",omitStart:!0,areaSelectorRecording:t,liveBlurEnabled:r,liveBlurSettings:n,liveTranscriptions:p,audioRecordingEnabled:a}),u&&hn(),P("recording_started_on_tab_second_attempt",{tab:e}),{host:s,href:e==null?void 0:e.url,retried:!0}}catch(h){P("recording_started_on_tab_failed",{tab:e,error:h,errorMessage:h==null?void 0:h.message}),console.warn("second start recording on tab attempt failed",h)}return G("start_recording",{recorder:"extension",url:e.url}),{...i,retried:!0}},Zt=async(e,t,r)=>{var p;yt();const n=xt(d.getState()),s=mn(e==null?void 0:e.url);js(),$s();const{networkOrServerError:a}=Pt(d.getState());P("recording_started",{tab:e,networkOrServerError:a,recordingControls:(p=ct(d.getState()))==null?void 0:p.recordingControlsPreference}),d.dispatch(yl({currentTab:e,startTimestamp:Date.now()})),t?(d.dispatch(ta(t)),d.dispatch(ra(!1))):(d.dispatch(ta(ze())),d.dispatch(ra(!0))),await ri(e);try{const u=Jr();if(u&&(e!=null&&e.id)){const h=Z(d.getState()).scribeId;u.associateCapturesWithScribe(e.id,h),u.uploadInitialScreenshotToS3(e.id,h).then(m=>{}).catch(m=>{console.error("[DOM Settlement] Failed to upload initial screenshot:",m)})}}catch(u){console.error("[DOM Settlement] Error in DOM settlement upload:",u)}r&&d.dispatch(zs(r));let i=e.title;(!i||i==="New Tab"||i.indexOf("Scribe |")===0)&&(i="Untitled"),d.dispatch(Tg(i)),d.dispatch(dn({tab:e,host:s,url:e==null?void 0:e.url})),d.dispatch(Js(de.RECORDING)),n||d.dispatch(Xs(!0)),dm();const o=it(d.getState());if(r==="recapture"){G("recapture_started",{recorder:"extension",url:e.url});return}chrome.runtime.sendMessage({messageType:"startRecording",target:"sidepanel",data:{liveTranscriptions:_t(),frontendUrl:K.FRONTEND_URL,audioRecordingEnabled:o,inCopilotMode:n}})},Or=(e=!1)=>{const t=Z(d.getState());P("recording_deleted",{recordingState:t}),yt(),sn({isCopilot:e})},_m=async e=>{try{const t=await j.post("/extension_injection/",{page_url:e});if(t.status===200)return t.data.should_inject}catch(t){console.error("Error fetching extension injection",t)}return!1},wm=1e3;setInterval(()=>{var e,t;(t=(e=chrome.runtime.sendMessage({messageType:Fs.GetSidepanelActive}))==null?void 0:e.catch)==null||t.call(e,r=>{r.message.includes("Could not establish connection. Receiving end does not exist")?(chrome.storage.local.set({sidepanelActive:!1}),chrome.storage.local.remove("askAiId")):console.error("error getting sidepanel state",r)})},wm),chrome.storage.local.onChanged.addListener(e=>{const t=e==null?void 0:e.sidepanelActive;if(t){if(!t.oldValue&&t.newValue){const{showSidepanelFob:s}=ct(d.getState());s&&chrome.tabs.query({},a=>{a.forEach(i=>{le(i,{messageType:"sidepanelOpened"})})})}if(t.oldValue&&!t.newValue){chrome.storage.local.remove("askAiId");const s=xt(d.getState()),a=De(d.getState());s&&a&&Or(),chrome.tabs.query({},i=>{i.forEach(o=>{le(o,{messageType:Fs.SetSidepanelClosed}),chrome.scripting.executeScript({target:{tabId:o.id},func:()=>{var p;(p=document==null?void 0:document.querySelectorAll("[_i_d]"))==null||p.forEach(u=>u==null?void 0:u.removeAttribute("_i_d"))}}),le(o,{messageType:"removeCopilotClickTarget"}),le(o,{messageType:"stopCopilotGenerating"}),le(o,{messageType:"stopDropPin"}),d.dispatch(It(!1)),d.dispatch(Io(null))})}),vl().then(i=>{i&&(Wt(!1),Or()),pr()})}}const r=e==null?void 0:e.hiddenFobDomains;r&&(chrome.tabs.query({},s=>{s.forEach(a=>{le(a,{messageType:"hiddenFobDomainsUpdated",hiddenDomains:r.newValue})})}),chrome.runtime.sendMessage({messageType:"hiddenFobDomainsUpdated",hiddenDomains:r.newValue}));const n=e==null?void 0:e.isGuiding;n&&Wt(n.newValue==="true")}),chrome.runtime.onConnect.addListener(e=>{e.onMessage.addListener(async(t,r)=>{var n,s,a,i,o,p,u,h,m,y,w,b;if(t.messageType==="openSidePanel"){if(t.route===se.Assistant&&!((a=(s=(n=r.sender)==null?void 0:n.url)==null?void 0:s.startsWith)!=null&&a.call(s,"http"))){const v=await chrome.tabs.query({active:!0,lastFocusedWindow:!0});await Ce((o=(i=r.sender)==null?void 0:i.tab)==null?void 0:o.id,t.route,{queryParams:{url:(p=v==null?void 0:v[0])==null?void 0:p.url,searchEntry:t.clickedFromSearch,closeAssistantOnBack:t.closeAssistantOnBack},frontendUrl:K.FRONTEND_URL})}else{const v=De(d.getState())?se.Recorder:t!=null&&t.route?t.route:se.Home;(h=(u=r==null?void 0:r.sender)==null?void 0:u.url)!=null&&h.includes("chrome-extension://")?await Ft((y=(m=r==null?void 0:r.sender)==null?void 0:m.tab)==null?void 0:y.windowId,v):await Ce((b=(w=r.sender)==null?void 0:w.tab)==null?void 0:b.id,t.route,{queryParams:t.route===se.Assistant?{url:r.sender.url}:null,frontendUrl:K.FRONTEND_URL})}if(t.route===se.Assistant){let v="extension_dropdown_open_recommended_clicked";t.clickedFromSearch&&(v="extension_dropdown_open_search"),G(v,null,j)}else t.route===se.Recorder&&G("extension_dropdown_open_recorder_clicked",null,j)}})}),qh((e,t,r)=>{var n,s,a,i;if(e.messageType==="browserStartRecording"){const o=Qr(d.getState());if(o.scribeId)rs({...e,...o},t,r);else{const{taskId:p}=Z(d.getState());e.taskId=p,Jo(e,t,r)}}if(e.messageType==="openSidePanel"){Ft(t.tab.windowId,e.route,{queryParams:e.queryParams,frontendUrl:K.FRONTEND_URL});return}if(e.messageType==="openGuideMeSidepanel"&&ua(e,j),e.messageType==="getTabSelectorData"){const o=Mc();return r({allowMicrophone:o}),!0}if(e.messageType==="tldExtract"){const o=kl(e.url);r({result:o})}return e.messageType==="speechTranscriber"?(nh((n=e.payload)==null?void 0:n.message,(s=e.payload)==null?void 0:s.data).then(o=>{r(o)}),!0):e.messageType==="speechTranscriberV3"?(ah((a=e.payload)==null?void 0:a.message,(i=e.payload)==null?void 0:i.data).then(o=>{r(o)}).catch(o=>{console.error("Background script: speechTranscriberV3 handler error",o),r({error:o.message})}),!0):(Us().then(async()=>{var h,m,y,w,b,v,S,D,E,A,T,I,C,N,O,H,te,ae,he,re;if(!e.messageType)return;if(e.messageType==="getDWOptimizeState"){try{const l=we();r(l)}catch{r({isOptimizeConfigured:!1,isDWActive:!1,isUrlStreamingActive:!1,lastSyncedAt:0})}return!0}if(e.messageType==="captureAdditionalScreenshot"){const{url:l,timestamp:g,contentScriptLoadTimestamp:c,type:f}=e,_=d.getState(),k=(m=(h=Z(_))==null?void 0:h.actionsQueue)==null?void 0:m.at(-1);if(!k||f!=="initial"&&k.timestamp>=c)return;const R=await ir();if(!(R!=null&&R.base64Image))return;try{const{internal_url:L,download_url:$}=await Nc(R.base64Image);d.dispatch(Ps({tempId:k.tempId,partialAction:{additional_screenshot_data:{url:l,timestamp:g,type:f||"post_navigation",internal_url:L||null,download_url:$||null}}}))}catch(L){console.error("Failed to upload additional screenshot:",L)}}if(e.messageType==="runSuggestedScribeAnalysis")return;if(e.messageType==="analyzeActions"||e.messageType==="ANALYZE_LONG_RUNNING_ACTIONS")return r({success:!1,error:"Legacy analyze is removed"}),!0;if(e.messageType==="dwManualRun"){try{const l=Se(d.getState()),g=(l==null?void 0:l.lrrManualRefreshEnabled)??(l==null?void 0:l.lrr_manual_refresh_enabled);if(!((y=we())!=null&&y.isDWActive&&g))return r({success:!1,error:"disabled"}),!0;vh(),r({success:!0})}catch(l){W(l,{tags:{component:"discover_workflows"},extra:{message:"[DW] Error triggering manual run"}}),r({success:!1,error:(l==null?void 0:l.message)||"Unknown error"})}return!0}if(e.messageType==="dwPollOnce"){try{const l=Se(d.getState()),g=(l==null?void 0:l.lrrManualRefreshEnabled)??(l==null?void 0:l.lrr_manual_refresh_enabled);if(!((w=we())!=null&&w.isDWActive&&g))return r({success:!1,error:"disabled"}),!0;(async()=>{const c=await bh();r({success:!!(c!=null&&c.ok),stored:!!(c!=null&&c.stored)})})()}catch(l){r({success:!1,error:(l==null?void 0:l.message)||"Unknown error"})}return!0}if(e.messageType==="dwAutopollStart"){try{const l=Se(d.getState()),g=(l==null?void 0:l.lrrManualRefreshEnabled)??(l==null?void 0:l.lrr_manual_refresh_enabled);if(!((b=we())!=null&&b.isDWActive&&g))return r({success:!1,error:"disabled"}),!0;(async()=>{await Sh();const c=$o();r({success:!0,running:c.running})})()}catch(l){r({success:!1,error:(l==null?void 0:l.message)||"Unknown error"})}return!0}if(e.messageType==="dwAutopollStop"){try{const l=Se(d.getState()),g=(l==null?void 0:l.lrrManualRefreshEnabled)??(l==null?void 0:l.lrr_manual_refresh_enabled);if(!((v=we())!=null&&v.isDWActive&&g))return r({success:!1,error:"disabled"}),!0;(async()=>{await Th();const c=$o();r({success:!0,running:c.running})})()}catch(l){r({success:!1,error:(l==null?void 0:l.message)||"Unknown error"})}return!0}if(e.messageType==="dwCleanup")return(async()=>{var l,g,c,f,_,k,R,L,$,oe,ce,M,ue,_e,Te,Oe,Ee,Me,He;try{const F=Se(d.getState()),ie=(F==null?void 0:F.lrrManualRefreshEnabled)??(F==null?void 0:F.lrr_manual_refresh_enabled);if(!((l=we())!=null&&l.isDWActive&&ie)){try{chrome.runtime.sendMessage({messageType:"dwCleanupCompleted",ok:!1,status:403})}catch{}r({success:!1,status:403,error:"disabled"});return}const z=`${Ct}/api/v1/lrr/cleanup`,x=await At.request({method:"DELETE",url:z,data:{type:"both",dry_run:!1}}),We=(g=x==null?void 0:x.data)==null?void 0:g.actions_deleted,Ke=(c=x==null?void 0:x.data)==null?void 0:c.results_deleted,qe=((f=x==null?void 0:x.data)==null?void 0:f.total_deleted)!=null?x.data.total_deleted:typeof We=="number"&&typeof Ke=="number"?We+Ke:(_=x==null?void 0:x.data)==null?void 0:_.deleted_count,rr=(k=x==null?void 0:x.data)==null?void 0:k.dry_run;try{const Nr=((R=x==null?void 0:x.headers)==null?void 0:R[q.toLowerCase()])||((L=x==null?void 0:x.config)==null?void 0:L.headers)&&(x.config.headers[q]||x.config.headers[q.toLowerCase()]),Ie=(($=x==null?void 0:x.headers)==null?void 0:$[B.toLowerCase()])||((oe=x==null?void 0:x.config)==null?void 0:oe.headers)&&(x.config.headers[B]||x.config.headers[B.toLowerCase()]);J("DW.API.Cleanup.Success",{status:(x==null?void 0:x.status)||200,actionsDeleted:We,resultsDeleted:Ke,totalDeleted:qe,dryRun:rr,sessionId:Nr,requestId:Ie})}catch{}try{chrome.runtime.sendMessage({messageType:"dwCleanupCompleted",ok:!0,totalDeleted:qe,actionsDeleted:We,resultsDeleted:Ke})}catch{}r({success:!0,status:(x==null?void 0:x.status)||200,totalDeleted:qe,deletedCount:qe})}catch(F){const ie=((ce=F==null?void 0:F.response)==null?void 0:ce.status)??0;W(F,{tags:{component:"discover_workflows"},extra:{message:"[DW] Error calling cleanup endpoint",status:ie}});try{const z=((ue=(M=F==null?void 0:F.response)==null?void 0:M.headers)==null?void 0:ue[q.toLowerCase()])||((Te=(_e=F==null?void 0:F.response)==null?void 0:_e.config)==null?void 0:Te.headers)&&(F.response.config.headers[q]||F.response.config.headers[q.toLowerCase()]),x=((Ee=(Oe=F==null?void 0:F.response)==null?void 0:Oe.headers)==null?void 0:Ee[B.toLowerCase()])||((He=(Me=F==null?void 0:F.response)==null?void 0:Me.config)==null?void 0:He.headers)&&(F.response.config.headers[B]||F.response.config.headers[B.toLowerCase()]);J("DW.API.Cleanup.Failure",{status:ie,error:(F==null?void 0:F.message)||"network_error",sessionId:z,requestId:x})}catch{}try{chrome.runtime.sendMessage({messageType:"dwCleanupCompleted",ok:!1,status:ie})}catch{}r({success:!1,status:ie,error:(F==null?void 0:F.message)||"Unknown error"})}})(),!0;if(e.messageType==="dwClearLocal")return(async()=>{var l;try{const g=Se(d.getState()),c=(g==null?void 0:g.lrrManualRefreshEnabled)??(g==null?void 0:g.lrr_manual_refresh_enabled);if(!((l=we())!=null&&l.isDWActive&&c)){r({success:!1,status:403,error:"disabled"});return}const[f,_,k,R]=await Promise.all([Kl(),$l(),Dh(),jl()]);try{chrome.runtime.sendMessage({messageType:"dwLatestResultsUpdated"}),chrome.runtime.sendMessage({messageType:"dwHiddenUpdated"})}catch{}r({success:!0,totalDeleted:f+_+k+R})}catch(g){W(g,{tags:{component:"discover_workflows"},extra:{message:"[DW] Error clearing local DW DBs"}}),r({success:!1,error:(g==null?void 0:g.message)||"Unknown error"})}})(),!0;if(e.messageType==="dwActionLogGetEnabled")return(async()=>{try{const l=await Ro();r({success:!0,enabled:!!l})}catch{r({success:!0,enabled:!1})}})(),!0;if(e.messageType==="dwActionLogSetEnabled")return(async()=>{try{await qg(!!(e!=null&&e.enabled)),r({success:!0})}catch(l){r({success:!1,error:(l==null?void 0:l.message)||"Unknown error"})}})(),!0;if(e.messageType==="dwActionLogGetCount")return(async()=>{try{const l=await Bl();r({success:!0,count:l})}catch(l){r({success:!1,error:(l==null?void 0:l.message)||"Unknown error"})}})(),!0;if(e.messageType==="dwActionLogClear")return(async()=>{try{const l=await zl();r({success:!0,deleted:l})}catch(l){r({success:!1,error:(l==null?void 0:l.message)||"Unknown error"})}})(),!0;if(e.messageType==="dwActionLogReplay")return(async()=>{try{const l=await Gl();for(const g of l)try{await jo(g.action_id,g.payload)}catch{}try{is(0)}catch{}r({success:!0,enqueued:l.length})}catch(l){r({success:!1,error:(l==null?void 0:l.message)||"Unknown error"})}})(),!0;if(e.messageType==="long_running_recorder_action"){X({message:"long_running_recorder_action_received",category:"long_running_recorder",level:"info",data:{action:e.action}});const l=((S=t==null?void 0:t.tab)==null?void 0:S.id)??(t==null?void 0:t.tabId)??0,{action:g}=e;try{if(!((D=we())!=null&&D.isDWActive))return r({status:"disabled"}),!0}catch{return r({status:"disabled"}),!0}return g.kind===ee.KEYBOARD_ACTIONS.PRESS?Fm(g,l):(await ui(l),er.delete(l),await xr(g,l)),r({status:"success"}),!0}e.messageType==="selectMicrophone"&&e.microphoneId&&(Qo(e.microphoneId),r({status:"success"})),e.messageType==="audioDevicesEnumerated"&&(d.dispatch(Fc(e.devices)),r({status:"success"}));const{lastSentNotification:o}=Fe(d.getState()),p=Z(d.getState()),u=De(d.getState());if(e.messageType==="getTabs")return Gs().then(l=>r(l)),!0;if(e.messageType==="getAllWindows")return chrome.windows.getAll({populate:!1},l=>{r(l)}),!0;if(e.messageType==="getLastFocusedWindow")return chrome.windows.getLastFocused({populate:!1},l=>{r(l)}),!0;if(e.messageType==="removePopup"&&chrome.action.setPopup({popup:""}),e.messageType==="sidepanelClosed"&&(Wt(!1),pr(),chrome.tabs.sendMessage({messageType:"stopDropPin"}),d.dispatch(It(!1))),e.messageType==="liveTargetClicked"&&Ll(),e.messageType==="trackGuideMeDom"&&bl({...e,api:j}),e.messageType==="reducedDom"&&Pl(j,e.action,e.reducedDom),e.messageType==="shouldInjectScribeButton")return _m(t.tab.url).then(l=>{r(l)}).catch(()=>{r(!1)}),!0;if(e.messageType==="checkServerAvailability"&&kt(),e.messageType==="networkConnectionStatus"){const{isOnline:l}=e.data;return kt().then(g=>{if(!g){const{networkError:c,s3ConnectionError:f,backendConnectionError:_,networkOrServerError:k}=Pt(d.getState()),R=!!(c||k),L=!!(f||_);chrome.runtime.sendMessage({messageType:"networkConnectionStatus",data:{isOnline:l,internetConnection:R,scribeServerError:L}})}chrome.runtime.sendMessage({messageType:"networkConnectionStatus",data:{isOnline:l,internetConnection:null,scribeServerError:null}})}),!0}if(e.messageType==="checkForLocalStorageScribes")return nn().then(({localScribeDetected:l,scribeId:g})=>{r({localScribeDetected:l,scribeId:g})}),!0;if(e.messageType==="endAndSaveLocalStorageScribes")return Uc().then(l=>{r({savingLocalScribe:l})}),!0;if(e.messageType==="discardLocalStorageScribes"&&(yt(),r({message:"discarded"})),e.messageType==="getIsScribeEditMode"){const l=$c(d.getState());r({isScribeEditMode:l})}if(e.messageType==="getEntryPoint"){const{entryPoint:l}=Z(d.getState());r({entryPoint:l})}if(e.messageType==="getUserData"){const{userData:l,userSettings:g}=d.getState().auth,c={user_id:l==null?void 0:l.id,active_org_id:(E=l==null?void 0:l.active_organization)==null?void 0:E.id,super_org_id:(T=(A=l==null?void 0:l.active_organization)==null?void 0:A.super_organization)==null?void 0:T.id,url_streaming:g==null?void 0:g.url_streaming,...l};r(c)}if(e.messageType==="stream_url_data"){try{if(!e.data||!e.data.url||!e.data.timestamp){console.warn("[URL Streaming] Invalid stream_url_data request:",e.data),r({success:!1,error:"Invalid data"});return}if(!Ml(e.data.url)){e.data.url,r({success:!0,filtered:!0});return}em(e.data),r({success:!0})}catch(l){console.error("[URL Streaming] Error handling stream_url_data:",l),r({success:!1,error:l.message})}return}if(e.messageType==="getActiveTeam"){const l=(I=d.getState().auth.userData)==null?void 0:I.active_organization;r(l)}if(e.messageType==="setActiveTeam"){const l=await wt(j,"users/active_org/","PUT",{org_id:e.team.id});if(l.ok){const g=d.getState().auth.userData;g&&d.dispatch(Nt({...g,active_organization:l.data}))}}if(e.messageType==="getUserGrowthState"){const l=jc(d.getState());r(l)}if(e.messageType==="currentDomForCopilot"&&eh({dom:e.currentDom,url:e.url,sessionId:e.sessionId}),e.messageType==="widgetFetch"){const{url:l,method:g,body:c,params:f,headers:_,isAuthenticated:k}=e;return wt(j,l,g,c,f,_,k).then(R=>{r(R)}),!0}if(["widgetOpenSelectModal","widgetOpenRecordModal","widgetSelectedFromModal","widgetCancelModal"].includes(e.messageType))if(e.messageType==="widgetOpenRecordModal")d.dispatch(Vs(!0));else if(e.messageType==="widgetOpenSelectModal")d.dispatch(Hs(!0));else{if(e.messageType==="widgetSelectedFromModal")return le(t.tab,e,()=>{r(!0)}),!0;if(e.messageType==="widgetCancelModal")return le(t.tab,e,()=>{r(!0)}),!0}if(e.messageType==="closedGmailRecordModal")d.dispatch(Vs(!1));else if(e.messageType==="closedGmailSelectModal")d.dispatch(Hs(!1));else if(e.messageType==="requestDomainsReceived"){const{domains:l,currentRecommendedScribeCount:g}=Fe(d.getState());l!==void 0&&(chrome.runtime.sendMessage({messageType:"scribeCountReceived",count:g}),r(!0));return}if(e.messageType==="trackEvent"){const{name:l,details:g}=e;G(l,g),r(!0);return}if(e.messageType==="trackNewRelicLog"){const{name:l,details:g}=e;P(l,g),r(!0);return}if(e.messageType==="trackMixpanelEvent"){const{name:l,details:g}=e;G(l,g),r(!0);return}if(e.messageType==="getStore"){r(d.getState());return}if(e.messageType==="changeLiveBlurSettings"){Ks(e.liveBlurEnabled),d.dispatch(Wc(e.liveBlurSettings)),r({status:"success"});return}if(th(e,t,r,d),e.messageType===wn.MICROPHONE_ERROR&&d.dispatch(qc(e.errorType)),(e==null?void 0:e.messageType)==="startCopilot"&&(d.dispatch(cr(!0)),Ce((C=t.tab)==null?void 0:C.id,se.Copilot)),(e==null?void 0:e.messageType)==="startCopilotSearch"){const{askAiId:l}=e;if(!l)return;const g=await Y();chrome.storage.local.set({askAiId:l}),Ce(g==null?void 0:g.id,se.Assistant,{queryParams:{copilotEntry:!0,url:g.url}})}if(e.messageType==="startDropPin"){Y().then(l=>{chrome.tabs.sendMessage(l.id,{messageType:"startDropPin"}),d.dispatch(It(!0)),e.scribe?d.dispatch(Tr(e.scribe)):d.dispatch(Tr(null))});return}if(e.messageType==="stopDropPin"){Y().then(l=>{chrome.tabs.sendMessage(l.id,{messageType:"stopDropPin"}),d.dispatch(It(!1))});return}if(e.messageType==="setPinShiftClickThrough"&&d.dispatch(Ag(e.value)),e.messageType&&e.messageType.startsWith("popup")){if(P("popup_message",{messageType:e.messageType,request:e}),e.messageType==="popupLogIn")gm();else if(e.messageType==="popupGoToMyLibrary")um();else if(e.messageType==="popupGoToMyDocuments")pm();else if(e.messageType==="popupGoToOptionsPage")Ws(se.Options);else if(e.messageType==="popupStartRecord"){if(d.dispatch(cr(!1)),e.source===oa.SIDEPANEL){const l=(N=await Bc())==null?void 0:N.origin;if(ke(l))return si({openTabSelector:!0}),r({isRecording:!0}),!0;Ce((O=t.tab)==null?void 0:O.id,se.Recorder)}if(d.dispatch(cn),!De(d.getState()))return Y().then(l=>{d.dispatch(ln(e.source)),chrome.extension.isAllowedFileSchemeAccess().then(g=>{l&&!ke(l.url,g)?(Zt(l,null,ur.EXTENSION),r({isRecording:!0})):r({isRecording:!1,isAllowedFileSchemeAccess:g})})}),!0}else if(e.messageType==="popupStopRecording")Ut();else if(e.messageType==="popupOpenANewTab"){const l=`${rn()}${u?"":"?intent=newrecording"}`;chrome.tabs.create({url:l})}else if(e.messageType==="popupDiscardRecordingWhileStopping"){d.dispatch(lr(!1));const l=Z(d.getState());P("recording_deleted",{recordingState:l,reason:"user_aborted_while_stopping"}),sn()}return}if(e.messageType==="contentScriptLoaded"){const l=d.getState(),{userSettings:g}=Ne(l),{areaSelectorRecording:c}=Se(l),{liveBlurEnabled:f,liveBlurSettings:_}=dr(l),{status:k}=fe(l);(!o||Date.now()-o>6e4)&&(g!=null&&g.extension_notifications_enabled)&&(lm(),d.dispatch(bg(Date.now()))),r({recordingStatus:k,areaSelectorRecording:c,liveBlurEnabled:f,liveBlurSettings:_}),u&&((H=t.tab)==null?void 0:H.id)===p.currentTab.id&&d.dispatch(dn({url:e.currentTab,host:e.currentHost})),(te=t.tab)!=null&&te.id&&((ae=p.recordedTabs)==null?void 0:ae.indexOf(t.tab.id))===-1&&u&&d.dispatch(un(t.tab.id));return}if((he=t.tab)!=null&&he.id&&["getIframePosition","assignIframeId"].indexOf(e.messageType)!==-1)return chrome.tabs.sendMessage(t.tab.id,e).then(l=>{r({...l,error:null})}).catch(l=>{r({error:l})}),!0;if(e.messageType==="optionsChanged"&&Dr(),e.messageType==="getSPSEnabled"){const{userData:l}=Ne(d.getState());r((re=l==null?void 0:l.active_organization)==null?void 0:re.smart_privacy_screen_enabled)}if(e.messageType==="getCustomUrls"){r(K);return}if(e.messageType==="recordingControlsIndicatorPressed"){const{menuOpen:l}=dr(d.getState());d.dispatch($t(!l))}else if(e.messageType==="recordingControlsPausePressed")ci();else if(e.messageType==="recordingControlsDeletePressed")d.dispatch(lr(!0));else if(e.messageType==="recordingControlsDeleteConfirmPressed"){d.dispatch(lr(!1));const l=Z(d.getState());P("recording_deleted",{recordingState:l,reason:"user_aborted_capture"}),yt(),sn()}else if(e.messageType==="recordingControlsDeleteCancelPressed")d.dispatch(lr(!1));else if(e.messageType==="recordingControlsScreenPositionPressed"){const{screenPositionMenuOpen:l}=dr(d.getState());d.dispatch(pn(!l))}else e.messageType==="recordingControlsScreenPositionClosed"?d.dispatch(pn(!1)):e.messageType==="recordingControlsScreenPositionMenuButtonPressed"?(Jg("recordingControlsPosition",e.position),d.dispatch($t(!1))):e.messageType==="recordingCompletedPressed"?(d.dispatch($t(!1)),Ut()):e.messageType==="recordingControlsClickOutside"?d.dispatch($t(!1)):e.messageType==="recordingControlsScreenPositionMenuClickOutside"?d.dispatch(pn(!1)):e.messageType==="endRecordingWithCutoffCancelGotItPressed"&&d.dispatch(zc(!1));if(e.messageType==="scribeViewerCollapse")G("scribe_viewer_collapsed"),d.dispatch(Gc());else if(e.messageType==="scribeViewerExpand")G("scribe_viewer_expanded"),d.dispatch(Vc());else if(e.messageType==="scribeViewerSetPosition")G("scribe_viewer_position_set",{position:e.position===Hc.RIGHT?"right":"left"}),d.dispatch(Kc(e.position));else if(e.messageType==="scribeViewerOpenInScribe"){const{scribe:{id:l,name:g}}=Ys(d.getState());G("scribe_viewer_opened_in_scribe",{id:l,name:g});const c=Yc(l,g,!1,"","scribe",`${K.FRONTEND_URL}/`);chrome.tabs.query({currentWindow:!0}).then(f=>{f=f.filter(_=>_.url.includes(c)),f.length>0?chrome.tabs.update(f[0].id,{active:!0}):chrome.tabs.create({url:c})})}else if(e.messageType==="scribeViewerCloseViewer"){const{scribe:{id:l,name:g},progress:c}=Ys(d.getState());G("scribe_viewer_close_viewer",{id:l,name:g,progress:c}),d.dispatch(Xc())}else if(e.messageType==="openAssistant")pa(`${K.FRONTEND_URL}/sidebar/assistant?url=${e.href}`).then(l=>{l&&chrome.windows.update(l,{focused:!0})}),G("extension_dropdown_open_recommended_clicked",null,j);else if(e.messageType==="scribeViewerWidthChanged")d.dispatch(Jc(e.width));else if(e.messageType==="scribeViewerProgress")d.dispatch(Qc(e));else if(e.messageType==="closeStartingRecordingModal")d.dispatch(Xs(!1)),d.dispatch($t(!1));else if(e.messageType==="closeDropdown")d.dispatch(Je(!1));else if(e.messageType==="isSidepanelOpen"){const l=await chrome.storage.local.get("sidepanelActive");r({isSidepanelOpen:l.sidepanelActive})}else if(e.messageType==="createPin")Em(e).then(l=>{l.success||r({success:!1,error:l.error})});else if(e.messageType==="generateAiUrl")Im(e).then(l=>{r(l)});else if(e.messageType==="openUrl")chrome.tabs.create({url:e.url});else if(e.messageType==="openUrlInSidepanel"){const l=new URL(e.url),g=(l.pathname+l.search).replace(/^\//,"");chrome.windows.getLastFocused({populate:!1},c=>{c.id&&Ft(c.id,g,{frontendUrl:e.frontendUrl||K.FRONTEND_URL})})}else if(e.messageType==="deletePin")km(e).then(l=>{l.success||(e.location==="browser"?r({success:!1,error:l.error}):Y().then(g=>{chrome.tabs.sendMessage(g.id,{messageType:"showErrorToast",title:"Error deleting pin"})}))});else if(e.messageType==="updatePin")Dm(e).then(l=>{l.success||r({success:!1,error:l.error})});else if(e.messageType==="editPin")Y().then(l=>{chrome.tabs.sendMessage(l.id,{messageType:"editPin",pinId:e.pinId,pinCoordinates:e.pinCoordinates,location:"sidekick"})});else if(e.messageType==="cancelEditPin")Y().then(l=>{chrome.tabs.sendMessage(l.id,{messageType:"cancelEditPin"})});else if(e.messageType==="fetchViewedPins"){const{viewedPins:l=[]}=await chrome.storage.local.get("viewedPins");d.dispatch(Eo(l))}else if(e.messageType==="toggleHidePinsForUrl"){const l=Zc(d.getState()),{url:g}=e;if(!g)return;const c=l.indexOf(g);let f;c===-1?f=[...l,g]:f=l.filter(_=>_!==g),d.dispatch(Rg(f))}else if(e.messageType==="fetchPins"){const l=Date.now();if(l-Xo<200)return;Xo=l,Pr().then(g=>{g.success?d.dispatch(et(g.pins)):(d.dispatch(et([])),r({success:!1,error:g.error}))})}else if(e.messageType==="setHoveredPin")d.dispatch(Io(e.pinId));else if(e.messageType==="setViewedPin")Tm(e.data.pinId);else if(e.messageType==="updateGrowthState"){const{updates:l}=e,g={...d.getState().auth.userGrowthState,...l};return j.patch("/users/growth_state/",l).then(()=>{d.dispatch(ft(g))}).catch(c=>{d.dispatch(ft(g)),W(c,{tags:{component:"pins"},extra:{title:"Error updating growth state",error:c==null?void 0:c.message}})}),!0}else if(e.messageType==="openScribeGuideMe")xl(e);else if(e.messageType==="suggestionsRequested"){const{domains:l}=Fe(d.getState()),g=e.source===oa.SIDEPANEL,c=g?await Y():t.tab,f=e.domain||await el();return Cm({domain:f,query:e.query}).then(r),Zo()&&(c!=null&&c.id)&&(l!==void 0&&Lr(c.id,g),g||ss(c.id)),!0}else{if(e.messageType==="browserContextNeeded"&&t.tab)return chrome.windows.get(t.tab.windowId).then(l=>{r({tab:t.tab,window:l})}),!0;if(e.messageType==="action")Go(e,t,r);else if(e.messageType==="getExtensionStatus"){const{status:l}=fe(d.getState()),g=ct(d.getState());r({installed:!0,options:g,status:l,version:chrome.runtime.getManifest().version})}else{if(e.messageType==="updateSuggestedScribeStatus")return r({success:!1,error:"Legacy suggested scribes are deprecated"}),!0;if(e.messageType==="storeSuggestedScribe")return r({success:!1,error:"Legacy suggested scribes are deprecated"}),!0}}if(e.messageType==="updateLocalOption")return X({message:"local_option_updating",category:"local_options",level:"info",data:{key:e.key,value:e.value}}),_n(e.key,e.value).then(()=>{Dr(),r({status:"success"})}),!0;if(e.messageType==="getSuggestedScribeTask")return r({success:!1,error:"Legacy suggested scribes are deprecated"}),!0;if(e.messageType==="openScribeViewer"&&Vo(e),e.messageType==="updateSelectedSuggestionsFilter"){const{filter:l}=e;d.dispatch(tl(l)),chrome.tabs.query({active:!0,lastFocusedWindow:!0},g=>{var c;(c=g[0])!=null&&c.id&&ss(g[0].id)})}if(e.messageType==="getSelectedSuggestionsFilter"&&r(rl(d.getState())),e.messageType==="getActiveAnalyzeTask")return r({success:!0,taskId:null}),!0;if(e.messageType==="getAllowedDomains")return sa().then(l=>{r({allowedDomains:l})}).catch(()=>{r({allowedDomains:[]})}),!0;if(e.messageType==="getAllowedAppTags")return aa().then(l=>{r({allowedAppTags:l})}).catch(()=>{r({allowedAppTags:[]})}),!0}),!0)});function ni(){d.dispatch(Je(!0)),chrome.action.setPopup({popup:"src/scripts/main-content/index.html"}),chrome.action.openPopup(),chrome.action.setPopup({popup:""})}async function si({openTabSelector:e=!1}={}){const t=d.getState().auth.userData,r=await da("recordingControlsPreference")==="floating-button";if(t){const n=De(d.getState()),s={entryPoint:ur.EXTENSION,isScribeEditMode:!1,taskId:""};if(r){n?ni():ns(s);return}e&&ns(s);return}r&&ni()}async function vm(e){const t=_t();if(t){let s=se.Home;xt(d.getState())?s=se.Copilot:De(d.getState())&&(s=se.Recorder),Ce(e.id,s)}await ts(),P("icon_click_listener_entered",{tab:e}),G("sidekick_opened",{location:"extension_toolbar"});const r=await chrome.tabs.query({});r.length===1&&le(r[0],{messageType:"OverrideShowContent"});const[n]=await chrome.tabs.query({active:!0,currentWindow:!0});if(n){const s=new URL(n.url);if(ke(s.origin))si();else{zn({tabId:n.id});const{dropdownOpen:a}=fe(d.getState());a||(Rt({callSource:"iconClickListener"}),await ts(),await kt()),t||d.dispatch(Je(!a)),as(n)}}P("icon_click_listener_exited")}chrome.action.onClicked.addListener(vm);const bm=5*60*1e3;function Lr(e,t=!1){t?chrome.runtime.sendMessage({messageType:"domainsReceived"}):le(e,{messageType:"domainsReceived"})}async function ai(){var n,s;const{userData:e}=Ne(d.getState()),t=(s=(n=e==null?void 0:e.active_organization)==null?void 0:n.super_organization)==null?void 0:s.allow_community,r=await wt(Bs,"suggestions/domains/");if(r.ok){const{user:a,gallery:i}=r.data,o=t?i:{};return d.dispatch(Sg(Number(new Date))),Il(a,o)}}const oi=()=>{ai().then(e=>{chrome.tabs.query({active:!0,currentWindow:!0},function(t){var r;t&&((r=t[0])!=null&&r.id)&&Lr(t[0])}),d.dispatch(So(e))})},Sm=e=>e&&e.replace("www.","").toLowerCase(),Tm=async e=>{const{viewedPins:t=[]}=await chrome.storage.local.get("viewedPins");t.includes(e)||(t.length>1e3&&t.shift(),t.push(e),chrome.storage.local.set({viewedPins:t}),d.dispatch(Eo(t)))},Em=async e=>{try{return await j.post("/v1/pins/",e.pin),Pr().then(t=>{t.success?d.dispatch(et(t.pins)):d.dispatch(et([]))}),{success:!0}}catch(t){return{success:!1,error:t}}},Im=async e=>{var r,n,s,a,i,o,p,u;const t={metadata:{application:"frontend-pins-url"},messages:[{role:"system",content:[{type:"prompt_key",prompt_key:"pins_url_parse"}]},{role:"user",content:[{type:"text",text:e.originalUrl}]}],model:{provider:"openai",name:"gpt-5-nano"},parameters:{max_tokens:4e3,response_format:{type:"json_schema",schema:{type:"object",properties:{optimized_url:{type:"string"}},required:["optimized_url"]}}}};try{const h=(n=(r=await At.post(`${Ct}/api/v1/inference/unified`,t))==null?void 0:r.data)==null?void 0:n.output,m=(a=(s=JSON.parse(h))==null?void 0:s[0])==null?void 0:a.optimized_url;return m&&Wp(e.originalUrl,m)?G("pins_ai_url_generation_success",{originalUrl:e.originalUrl,aiGeneratedUrl:m,userId:(o=(i=d.getState())==null?void 0:i.auth.userData)==null?void 0:o.id}):G("pins_ai_url_generation_failure",{originalUrl:e.originalUrl,aiGeneratedUrl:m,userId:(u=(p=d.getState())==null?void 0:p.auth.userData)==null?void 0:u.id}),{success:!0,generatedUrl:m||e.originalUrl}}catch{return{success:!0,generatedUrl:e.originalUrl,usedFallback:!0}}},km=async e=>{const{pinId:t}=e;d.dispatch(Er(!0));try{return await j.delete(`/v1/pins/${t}/`),Pr().then(r=>r.success?(d.dispatch(et(r.pins)),{success:!0}):(d.dispatch(et([])),{success:!1})),{success:!0}}catch(r){return d.dispatch(Er(!1)),{success:!1,error:r}}},Dm=async e=>{const{pin:t,pinId:r}=e;d.dispatch(Er(!0));try{return await j.patch(`/v1/pins/${r}/`,t),Pr().then(n=>{n.success?d.dispatch(et(n.pins)):d.dispatch(et([]))}),{success:!0}}catch(n){return d.dispatch(Er(!1)),{success:!1,error:n}}},Pr=async()=>{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(e){const t=new URL(e.url);try{return{success:!0,pins:(await j.post("/v1/pins/search/",{url:`${t.href}`})).data}}catch(r){return console.error("[Pins] Error fetching pins:",r),{success:!1,error:r}}}return{success:!1,error:"No active tab found"}},Cm=async({domain:e,query:t})=>{const{domains:r}=Fe(d.getState())||{domains:[]};let n="search",s=`search?q=${encodeURIComponent(t)}`;const a=!t||t==="",i=null;if(a){if(r&&!(Sm(e)in r))return{user:[],gallery:[]};n="domainOnly",s=`suggestions?url=${e}`}const o=await wt(j,s);if(o.ok){let p=[],u=[];if(n==="domainOnly")p=o.data.user,u=o.data.gallery;else{const{active:h,gallery:m,super_org:y,other:w}=o.data,b=h.concat(y,w),v=b.map(({id:S})=>S);p=b.filter(({id:S},D)=>!v.includes(S,D+1)).sort((S,D)=>D.view_count-S.view_count),u=m}return{user:p,gallery:u,taskId:i,isAsynchronous:!!i}}return{user:[],gallery:[],taskId:i,isAsynchronous:!!i}},Am=async(e,t,r=0)=>{const{domains:n,lastFetched:s}=Fe(d.getState());let a;if(n===void 0||s+bm<Number(new Date)){const i=await ai();if(d.dispatch(So(i)),i===void 0)return r;Lr(t),a=la(e,i)}else a=la(e,n);return a!==null?a:r},Ot=new Map,Rm=async(e,t,r=0)=>{var h,m,y,w,b;const{userData:n}=Ne(d.getState()),s=(h=n==null?void 0:n.active_organization)==null?void 0:h.id,{selectedFilter:a}=d.getState().scribes,i=`${e}|${a}|${s}`;if(Ot.has(i))return Ot.get(i);if(!s)return r;if(a==="saved"){const v=await wt(j,"workspace/","GET",null,{category:"saved",limit:jt});if(v.ok&&((m=v.data)!=null&&m.documents)){const S=v.data.documents.length;return Ot.set(i,S),S}return Ot.set(i,r),r}const o=a||"popular",p=((w=(y=n==null?void 0:n.active_organization)==null?void 0:y.super_organization)==null?void 0:w.id)==="3e818212-8bf1-448a-8485-b11ace14e712"?void 0:s,u=await wt(Bs,"suggestions","GET",null,{url:ke(e)?"":e,sort:o,organization_id:p,limit:20});if(u.ok&&((b=u.data)!=null&&b.user)){const v=u.data.user.length;return Ot.set(i,v),v}return Ot.set(i,r),r},ss=async e=>{const{showBadgeNotifications:t}=ct(d.getState()),{userData:r}=Ne(d.getState()),n=De(d.getState()),{sidekickRefresh:s}=Se(d.getState());function a(i){const o=s?jt:99;return o===jt&&i===jt?`${jt}+`:i>o?`${o}+`:i.toString()}Lc&&chrome.action.setBadgeBackgroundColor({color:"#7048ec"}),r&&!n?chrome.tabs.get(e,async i=>{if(i!=null&&i.url){const o=new URL(i.url),{protocol:p}=o;if(p==="http:"||p==="https:"){const u=s?await Rm(i.url):await Am(i.url,i);u&&await Pc(e)?(t?chrome.action.setBadgeText({text:a(u),tabId:e}):chrome.action.setBadgeText({text:"",tabId:e}),d.dispatch(To(u)),as(i)):(d.dispatch(To(0)),as(i))}}}):chrome.action.setBadgeText({text:"",tabId:e})},as=e=>{const{currentRecommendedScribeCount:t}=Fe(d.getState());le(e,{messageType:"scribeCountReceived",count:t}),chrome.runtime.sendMessage({messageType:"scribeCountReceived",count:t})},ii=async()=>{const e=await Y();e&&(le(e,{messageType:"currentTabChanged",selfTab:e}),chrome.runtime.sendMessage({messageType:"currentTabChanged",selfTab:e}))};chrome.windows.onFocusChanged.addListener(ii);const os=async(e,t,r)=>{var a,i,o;if(((a=await Y())==null?void 0:a.id)!==e)return;const{domains:n}=Fe(d.getState());Zo()&&(n!==void 0&&(t.status==="complete"||t.status==="activated")&&Lr(r),(t.status==="loading"||t.status==="activated")&&ss(e)),ii();const s=Se(d.getState());if(!((s==null?void 0:s.sidekick_refresh)??(s==null?void 0:s.sidekickRefresh))&&await Rc()&&!((i=r.pendingUrl)!=null&&i.includes("/sidebar/assistant"))&&!r.url.includes("/sidebar/assistant")){const p=await Oc();Ol(r.url);const u=((o=p==null?void 0:p.queryParams)==null?void 0:o.url)||"",h=w=>{try{return new URL(w).hostname}catch{return""}},m=h(r.url),y=h(u);(!m||!y||m!==y)&&await Ce(r.id,se.Assistant,{queryParams:{...p.queryParams,url:r.url},frontendUrl:K.FRONTEND_URL})}};chrome.tabs.onActivated.addListener(async({tabId:e})=>{const t=await chrome.tabs.get(e);os(e,{status:"activated"},t)}),chrome.tabs.onUpdated.addListener(os),lh();const Om=(e,t)=>{const r=async(n,s)=>{if(!(!e||n!==e.id)&&s.status==="complete"){const a=await chrome.tabs.get(n);a&&t(a),chrome.tabs.onUpdated.removeListener(r)}};chrome.tabs.onUpdated.addListener(r)},ci=async()=>{var s;const{status:e}=fe(d.getState());let t=Z(d.getState());const r=e===de.RECORDING?de.PAUSED_RECORDING:de.RECORDING;if(d.dispatch(Js(r)),r===de.PAUSED_RECORDING)d.dispatch(nl(new Date(Date.now()))),d.dispatch(sl(t.isTranscribing)),d.dispatch(gn(!1));else if(r===de.RECORDING){const a=Date.now();try{const[o]=await chrome.tabs.query({active:!0,lastFocusedWindow:!0});o!=null&&o.id&&chrome.tabs.sendMessage(o.id,{messageType:"hideBlurControls"})}catch{}d.dispatch(al(a));const{isTranscribingBeforePause:i}=Z(d.getState());d.dispatch(gn(i))}if(r===de.RECORDING&&Sl(Ne(d.getState()).userData)&&Ks(!1),r===de.RECORDING){const[a]=await chrome.tabs.query({active:!0,currentWindow:!0});t.recordedTabs.find(i=>i===a.id)||(d.dispatch(un(a.id)),t=Z(d.getState()))}const n=(s=await ol())==null?void 0:s.id;[...t.recordedTabs,n].forEach(a=>{try{a&&chrome.tabs.sendMessage(a,{messageType:"extensionStatusChange",status:r})}catch{}})};chrome.windows.onFocusChanged.addListener(async function(e){if(e===chrome.windows.WINDOW_ID_NONE)chrome.tabs.query({active:!0,lastFocusedWindow:!0}).then(t=>{t.forEach(r=>chrome.tabs.sendMessage(r.id,{messageType:"switchedAwayFromBrowser"}))});else{const t=await Y();t&&os(t.id,{status:"activated"},t)}}),Us().then(()=>{const{status:e}=fe(d.getState());e===de.ENDING_RECORDING?Ut():e===de.RECORDING&&($s(),js())}),Ms.persist(),bc(e=>{e.addEventProcessor(t=>{var r;return t.release=(r=self.SENTRY_RELEASE)==null?void 0:r.id,t})});const Lm=async(e,t,r=null,n=1)=>{try{if(!e)return null;const s=await createImageBitmap(e),a=typeof n=="number"&&n>1?n:1,i=Math.round(s.width/a),o=Math.round(s.height/a),p=new OffscreenCanvas(i,o);p.getContext("2d").drawImage(s,0,0,i,o);const u=(t==null?void 0:t.x)!=null?t.x/a:i/2,h=(t==null?void 0:t.y)!=null?t.y/a:o/2;let m=Math.max(600,Math.min(1400,i)),y=Math.max(400,Math.min(768,o));m=Math.min(m,i),y=Math.min(y,o);let w=Math.max(0,Math.floor(u-m/2)),b=Math.max(0,Math.floor(h-y/2));w+m>i&&(w=i-m),b+y>o&&(b=o-y);let v=new OffscreenCanvas(m,y),S=v.getContext("2d");if(S.drawImage(p,w,b,m,y,0,0,m,y),Math.min(m,y)>768){const T=768/Math.min(m,y),I=Math.round(m*T),C=Math.round(y*T),N=new OffscreenCanvas(I,C);N.getContext("2d").drawImage(v,0,0,I,C),v=N,S=v.getContext("2d")}const D=v.width,E=v.height;if(t&&typeof t.x=="number"&&typeof t.y=="number"){const T=u-w,I=h-b,C=Math.max(D,E),N=Math.max(20,Math.min(60,C*.03)),O=N/2;S.strokeStyle="rgba(255,0,0,0.85)",S.lineWidth=Math.max(6,N*.25),S.lineCap="round",S.beginPath(),S.moveTo(T-O,I-O),S.lineTo(T+O,I+O),S.moveTo(T+O,I-O),S.lineTo(T-O,I+O),S.stroke()}let A;try{A=await v.convertToBlob({type:"image/webp",quality:.7})}catch{A=await v.convertToBlob({type:"image/jpeg",quality:.7})}return X({message:"long_running_recorder_annotated_screenshot",category:"long_running_recorder",level:"info",data:{size:(A==null?void 0:A.size)||0}}),A}catch(s){return W(s,{tags:{component:"long_running_recorder"},extra:{message:"[Long Running Recorder] Failed to optimise + annotate screenshot"}}),null}},xr=async(e,t,r)=>{var n,s;try{X({message:"long_running_recorder_screenshot_start",category:"long_running_recorder",level:"info",data:{actionId:e.id}});let a=null,i=null,o=null;const p=e.kind===ee.KEYBOARD_ACTIONS.SEQUENCE||e.kind===ee.KEYBOARD_ACTIONS.COMBINATION||e.kind==="keyboard_sequence_action"||e.kind==="keyboard_combination_action";let u=null,h=!!(r&&r.skip),m=r&&r.skip_reason?String(r.skip_reason):null;if(!h&&p)try{const E=await chrome.tabs.get(t),A=!!(E&&E.active);let T=!1,I="normal";if(E&&typeof E.windowId=="number"){const C=await chrome.windows.get(E.windowId);T=!!(C&&C.focused),I=C&&C.state||"normal",u=E.windowId}o={is_tab_active:A,is_window_focused:T,window_state:I},(!A||!T||I==="minimized")&&(h=!0,m="target_tab_not_visible")}catch{o={is_tab_active:!1,is_window_focused:!1,window_state:"unknown"},h=!0,m="target_tab_not_found"}if(e!=null&&e.earlyScreenshotTimestamp)try{const E=`early-screenshot-${e.earlyScreenshotTimestamp}`,A=(n=await chrome.storage.session.get(E))==null?void 0:n[E];if(typeof A=="string"&&A.startsWith("data:image/")){const T=await(await fetch(A)).blob();T&&T.size>0&&(a=T,chrome.storage.session.remove(E))}}catch{}if(a)X({message:"long_running_recorder_early_screenshot_used",category:"long_running_recorder",level:"info",data:{actionId:e.id,sizeKB:Math.round(a.size/1024)}});else if(h)try{J("DW.Capture.Skip",{actionId:e.id,kind:e.kind,skip_reason:m||"unknown"})}catch{}else try{try{J("DW.Capture.Attempt",{actionId:e.id,kind:e.kind,tabId:t,windowId:u})}catch{}const E=await chrome.tabs.captureVisibleTab(u??null,{format:"jpeg",quality:70});X({message:"long_running_recorder_screenshot_captured",category:"long_running_recorder",level:"info",data:{actionId:e.id,sizeKB:Math.round(E.length/1024)}}),a=await(await fetch(E)).blob();try{J("DW.Capture.Success",{actionId:e.id,kind:e.kind})}catch{}}catch(E){const A=E&&E.message||String(E);i=A;try{J("DW.Capture.Fail",{actionId:e.id,kind:e.kind,error:A})}catch{}}const y=a;let w=null;const b=e.kind===ee.MOUSE_ACTIONS.CLICK||e.kind==="mouse_click_action",v=(e.kind===ee.KEYBOARD_ACTIONS.SEQUENCE||e.kind===ee.KEYBOARD_ACTIONS.COMBINATION||e.kind==="keyboard_sequence_action"||e.kind==="keyboard_combination_action")&&!!e.position&&!!e.viewport&&!!e.devicePixelRatio;a&&(b||v)&&e.position&&(w=await Lm(y,e.position,e.viewport,e.devicePixelRatio));const S={...e,screenshot:y,...w?{annotated_screenshot:w}:{},timestamp:e.timestamp||Date.now(),tabId:t},D=!1;try{if((s=we())!=null&&s.isDWActive){if(S.id||(S.id=ze()),y)try{await Yl(S.id,y)}catch(O){W(O,{tags:{component:"dw_screenshots_db"},extra:{message:"[DW] Error storing full-resolution screenshot",actionId:S.id}})}let E=null;if(y)try{E=await Ph(y,{position:S.position,viewport:S.viewport,devicePixelRatio:S.devicePixelRatio})}catch{E=null}else E=null;const A=E&&E.blob||y;let T=null,I=null;if(A){const O=await Mh(A);T=O&&O.imageFormat,I=O&&O.base64}const C={...S};C.timestamp&&(C.timestamp=new Date(C.timestamp).toISOString()),delete C.screenshot,delete C.annotated_screenshot,delete C.long_description,delete C.action_confidence;try{C.current_description=$h(C)}catch{const O=typeof S.description=="string"?S.description:"";C.current_description=(O||"").trim().slice(0,1e3)}if(I)C.screenshot_data_base64=I,C.image_format=T||"jpeg";else{const O={};h?(O.screenshot_attempted=!1,O.screenshot_skip_reason=m||"unknown",p&&o&&(O.is_tab_active=o.is_tab_active,O.is_window_focused=o.is_window_focused,O.window_state=o.window_state)):(O.screenshot_attempted=!0,O.screenshot_error=i||"unknown_error"),C.additional_details=O}E&&E.relativeActionX!=null&&E.relativeActionY!=null&&E.imageWidth!=null&&E.imageHeight!=null&&(C.position_relative_to_image={x:E.relativeActionX,y:E.relativeActionY},C.image_dimensions={width:E.imageWidth,height:E.imageHeight});const N={action_id:S.id,action_data:Nh(C)};try{await jo(S.id,N)}catch(O){W(O,{tags:{component:"dw_streaming_queue_db"},extra:{message:"[DW] Error enqueuing action for streaming",actionId:S.id}})}try{di()}catch{}}}catch(E){W(E,{tags:{component:"dw_step3_capture_route"},extra:{message:"[DW] Error in Step 3 capture routing; falling back to legacy DB"}})}}catch(a){W(a,{tags:{component:"long_running_recorder"},extra:{message:"[Long Running Recorder] Error capturing screenshot"}})}},li=10,Pm=8e3;let Mr=null;async function di(){var e;try{if(!((e=we())!=null&&e.isDWActive))return;const t=await Wo(li);t.length>=li?is(0):t.length>0&&is(Pm)}catch{}}function is(e=0){Mr!==null&&clearTimeout(Mr),Mr=setTimeout(async()=>{Mr=null;try{await jh()}catch{}},e)}try{di()}catch{}const cs=new Map,xm=1e3,er=new Map,tr={count:0,windowStartMs:0};function Mm(){const e=Date.now();return e-tr.windowStartMs>=1e3&&(tr.windowStartMs=e,tr.count=0),tr.count>=1?!1:(tr.count+=1,!0)}function Nm(e=[],t=[]){const r=[...e];return t.forEach(n=>{n&&n.toLowerCase()===ee.BACKSPACE?r.length>0&&r.pop():r.push(n)}),r}function Fm(e,t){let r=cs.get(t);r||(r={actions:[],timeoutId:null},cs.set(t,r)),r.actions.push(e),r.timeoutId&&clearTimeout(r.timeoutId),r.timeoutId=setTimeout(()=>{ui(t)},xm)}async function ui(e){var a,i;const t=cs.get(e);if(!t||t.actions.length===0)return;const r=t.actions;t.actions=[],t.timeoutId&&(clearTimeout(t.timeoutId),t.timeoutId=null);let n;try{n=en(r,((i=(a=Qs())==null?void 0:a.toLowerCase)==null?void 0:i.call(a))||"mac")}catch{n=[]}const s=n.filter(o=>o.kind===ee.KEYBOARD_ACTIONS.SEQUENCE||o.kind===ee.KEYBOARD_ACTIONS.COMBINATION);for(const o of s){o.id||(o.id=ze());const p=o.kind===ee.KEYBOARD_ACTIONS.SEQUENCE,u=Mm()?void 0:{skip:!0,skip_reason:"local_budget_exceeded"};if(p){const h=er.get(e);if(h&&h.target_xpath&&h.target_xpath===o.target_xpath){const m=Nm(h.keys||[],o.keys||[]),y={...h,keys:m,end_timestamp:o.end_timestamp||o.timestamp||Date.now(),timestamp:o.end_timestamp||o.timestamp||Date.now()};y.long_description=void 0,await xr(y,e,u),er.set(e,y)}else await xr(o,e,u),er.set(e,o)}else await xr(o,e,u),er.delete(e)}}
