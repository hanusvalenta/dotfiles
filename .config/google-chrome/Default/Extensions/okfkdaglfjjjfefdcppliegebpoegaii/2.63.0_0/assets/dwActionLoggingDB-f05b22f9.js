const h="DWActionLoggingDB",w="actions",l=()=>new Promise((t,e)=>{const n=indexedDB.open(h,1);n.onupgradeneeded=r=>{const o=r.target.result;o.objectStoreNames.contains(w)||o.createObjectStore(w,{keyPath:"action_id"})},n.onsuccess=r=>t(r.target.result),n.onerror=()=>e(n.error)});function m(t,e,n=!0){return new Promise((r,o)=>{const a=u=>{try{e.close()}finally{u&&n?o(u):r()}};t.oncomplete=()=>a(),t.onabort=()=>a(t.error||new Error("Transaction aborted")),t.onerror=()=>a(t.error||new Error("Transaction error"))})}async function _(t,e){const n=await l(),r=n.transaction([w],"readwrite"),o=r.objectStore(w),a=m(r,n,!0);try{await new Promise((u,c)=>{const s=o.get(t);s.onsuccess=()=>{const i=s.result,d=Date.now(),p={action_id:t,payload:e,logged_at_ms:(i==null?void 0:i.logged_at_ms)??d,last_updated_ms:d,uploaded:(i==null?void 0:i.uploaded)??!1,streamed_at:(i==null?void 0:i.streamed_at)??null},y=o.put(p);y.onsuccess=()=>u(),y.onerror=()=>c(y.error)},s.onerror=()=>c(s.error)}),await a}catch(u){throw await a.catch(()=>{}),u}}async function b(t,e){if(!t||t.length===0)return;const n=await l(),r=n.transaction([w],"readwrite"),o=r.objectStore(w),a=typeof e=="number"&&Number.isFinite(e)?e:Date.now(),u=m(r,n,!1);await Promise.all(t.map(c=>new Promise(s=>{const i=o.get(c);i.onsuccess=()=>{const d=i.result;if(!d){s();return}const p=o.put({...d,uploaded:!0,streamed_at:a,last_updated_ms:Date.now()});p.onsuccess=()=>s(),p.onerror=()=>s()},i.onerror=()=>s()}))),await u}async function f(){const t=await l(),e=t.transaction([w],"readonly"),n=e.objectStore(w),r=[],o=m(e,t,!1);try{await new Promise((a,u)=>{const c=n.openCursor();c.onsuccess=()=>{const s=c.result;if(!s){a();return}r.push(s.value),s.continue()},c.onerror=()=>u(c.error)}),await o}catch(a){throw await o.catch(()=>{}),a}return r}function g(t){var e,n;try{const r=(n=(e=t==null?void 0:t.payload)==null?void 0:e.action_data)==null?void 0:n.timestamp;if(typeof r=="string"&&r){const o=new Date(r).getTime();if(Number.isFinite(o))return o}}catch{}return t.logged_at_ms||0}async function P(){return(await f()).sort((t,e)=>g(t)-g(e))}async function D(){const t=await l(),e=t.transaction([w],"readonly"),n=e.objectStore(w);let r=0;const o=m(e,t,!1);try{await new Promise((a,u)=>{const c=n.openCursor();c.onsuccess=()=>{const s=c.result;if(!s){a();return}r+=1,s.continue()},c.onerror=()=>u(c.error)}),await o}catch(a){throw await o.catch(()=>{}),a}return r}async function j(){const t=await l(),e=t.transaction([w],"readwrite"),n=e.objectStore(w);let r=0;const o=m(e,t,!0);try{await new Promise((a,u)=>{const c=n.openCursor();c.onsuccess=()=>{const s=c.result;if(!s){a();return}const i=s.delete();i.onsuccess=()=>{r+=1,s.continue()},i.onerror=()=>u(i.error)},c.onerror=()=>u(c.error)}),await o}catch(a){throw await o.catch(()=>{}),a}return r}export{j as a,P as b,D as c,f as l,b as m,_ as u};
