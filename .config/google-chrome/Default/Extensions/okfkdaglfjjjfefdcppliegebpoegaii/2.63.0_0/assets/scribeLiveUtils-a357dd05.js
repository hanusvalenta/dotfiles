import{dg as _,al as L,ef as N,e5 as S,p as x,m as M,eg as E,s as w,U as l,G as C,eh as $,c_ as b,ei as I,dM as D,aA as v,ej as y,ek as U,t as g}from"./store-f163b43d.js";const F=async({api:e,documentId:t,context:n})=>await _(e,`views/?id=${t}`,"post",{context:n}),O={create:F};function W(e,t,n){O.create({api:e,documentId:t,context:n})}const p=L("sidebar/initializeSidebar"),f=460;async function q(e,t){function n(i){i.id===e&&(chrome.windows.update(e,t),chrome.windows.onBoundsChanged.removeListener(n))}chrome.windows.onBoundsChanged.addListener(n),await chrome.windows.update(e,{state:"normal"})}async function G(e,t,n){if(e.left===void 0||e.width===void 0)throw new Error("Current window does not have a valid left or width. Is the window a closed window from the sessions API?");if((t==null?void 0:t.id)===void 0)throw new Error(`Current tab not passed ${t==null?void 0:t.url} ${t==null?void 0:t.status}`);let i=e.height,o=e.width-f,a=e.top,s=e.left;if(e.state==="fullscreen"||e.state==="maximized"&&C()!==$.MacOS){const r=await chrome.tabs.sendMessage(t.id,{messageType:"getScreenDimensions"});a=r.screenTop,s=r.screenLeft,i=r.height,o=r.width-f,await q(t.windowId,{left:s,top:a,width:o,height:i})}else await chrome.windows.update(t.windowId,{width:o});return await chrome.windows.create({url:n,type:"popup",left:s+o,top:a,width:f,height:i})}async function P(e,t){const n=await chrome.tabs.query({windowId:e});if(n.length>0){const i=n[0].id;if(n[0].pendingUrl===t||n[0].url===t)return;await chrome.tabs.update(i,{url:t});return}throw new Error("No tabs found in window")}async function k(){const e=await x();if(e!=null&&e.path)return e.path===M.Assistant?0:1}const R=async e=>{const{sidebar:t}=w.getState();if(t.sidebarWindowId)try{return await P(t.sidebarWindowId,e),t.sidebarWindowId}catch{w.dispatch(p({sidebarWindowId:void 0,contentWindowId:void 0,originalContentWindowWidth:void 0}))}const[n]=await chrome.tabs.query({active:!0,lastFocusedWindow:!0});if(n.windowId){const i=await chrome.windows.get(n.windowId),o=i.width;if(i.left!==void 0&&i.width!==void 0){const a=await G(i,n,e);w.dispatch(p({sidebarWindowId:a.id,contentWindowId:i.id,originalContentWindowWidth:o}));const s=async r=>{const{sidebar:d}=w.getState();if(d.sidebarWindowId&&r===d.sidebarWindowId){const c=d.originalContentWindowWidth;await chrome.windows.update(n.windowId,{width:c}),w.dispatch(p({sidebarWindowId:void 0,contentWindowId:void 0,originalContentWindowWidth:void 0}))}chrome.windows.onRemoved.removeListener(s)};return chrome.windows.onRemoved.addListener(s),a.id}}},A=async e=>{if(await k()===0){const t=`${l.FRONTEND_URL}/sidebar/assistant?url=${e}`,n=await N(),i=c=>{let u=E(c||"","url")||"";if(!u&&c){const h=c.includes("?")?c.split("?")[1]:"";h&&(u=new URLSearchParams(h).get("url")||"")}try{return decodeURIComponent(u)}catch{return u}},o=i(n),a=i(t),s=c=>{try{return new URL(c).hostname}catch{return""}},r=s(o),d=s(a);if(r&&d&&r===d||o&&a&&o===a)return;await S(t)}},j=(e,t,n)=>{const i=v(e,t,!1,"","scribe",`${l.FRONTEND_URL}/`);return i?y(i,{name:"startingUrl",value:n??""}):null},m=(e,t,n,i,o=!0)=>{const a=v(e,t,!1,"","scribe",`${l.FRONTEND_URL}/`);return a?y(a,{name:"sidepanel",value:"true"},{name:"startingUrl",value:encodeURI(n)},{name:"startGuiding",value:o?"true":"false"},{name:"actionIndex",value:i}).split(l.FRONTEND_URL)[1]:null},z=(e,t)=>{const n=w.getState(),{contentWindowId:i}=U(n),o=e.url,a=m(e.id,e.name,o,e.actionIndex);o&&chrome.tabs.create({url:o,windowId:i}),g("scribe_viewer_started",{startingUrl:o,viewerUrl:a,id:e.id,name:e.name,location:e.location}),W(t,e.id,"sidekick")},B=e=>{const{id:t,name:n,newTabUrl:i,viewerUrl:o,location:a,currentWindowId:s,actionIndex:r}=e,d=m(t,n,i,r,!0);b(s,I(d)??"",{frontendUrl:l.FRONTEND_URL}),i&&chrome.tabs.create({url:i,windowId:s})},H=(e,t)=>{const n=D(w.getState()),{scribe:i}=n,{scribe:o}=e,a=i||o,s=!i&&o;if(!a){console.error("Scribe is undefined");return}const{id:r,name:d}=a,c="url"in a?a.url:"",u="location"in a?a.location:"",h="actionIndex"in a&&a.actionIndex||"";if(!r||!d){console.error("Scribe ID or Name is undefined");return}const T=m(r,d,c,h,!s);e.targetWindowId&&b(e.targetWindowId,I(T)??"",{frontendUrl:l.FRONTEND_URL}),chrome.action.setPopup({popup:""}),chrome.runtime.sendMessage({messageType:"removePopup"}),!s&&z({id:r,name:d,url:c,location:u,actionIndex:h},t)},J=async(e,t,n)=>{const i=w.getState(),{contentWindowId:o}=U(i);g("scribe_viewer_started",{startingUrl:e.startingUrl,id:e.scribe.id,name:e.scribe.name,location:e.location}),W(t,e.scribe.id,"in-context-viewer");const a=`${j(e.scribe.id,e.scribe.name,e.startingUrl)}`;await R(a),e.startingUrl&&chrome.tabs.create({url:e.startingUrl,windowId:o})};function K(){var t;const e="*://*/*";chrome.runtime.sendMessage({messageType:"update-live-index",data:{url:e}}),(t=chrome==null?void 0:chrome.tabs)!=null&&t.query?chrome.tabs.query({url:e,active:!0},function(n){n&&n[0]&&n[0].id&&chrome.tabs.sendMessage(n[0].id,{messageType:"advanceLiveStep"})}):chrome.runtime.sendMessage({messageType:"advanceLiveStep"})}function Q({showMessage:e,message:t,dom:n,url:i,sessionId:o,requestId:a}){chrome.runtime.sendMessage({messageType:"setGuideMeStepNotFound",data:{showMessage:e,message:t,dom:n,url:i,sessionId:o,requestId:a}})}function V(e,t,n){chrome.runtime.lastError||e.post("/ghostwriter/suggest_selector/",{current_dom:n,action:t}).then(i=>{if(i.status&&i.status>=200&&i.status<300){const{target_selector:o}=i.data,a=`*://${t.domain}/*`;chrome.tabs.query({url:a,active:!0},function(s){s&&s[0]&&s[0].id&&chrome.tabs.sendMessage(s[0].id,{messageType:"highlightTargetGhostwriter",targetSelector:o,debugGhostwriter:!0,action:t})})}else g("error_guide_me",{location:"extension",response:i})})}export{H as a,J as b,K as c,V as d,B as e,m as g,R as o,Q as s,A as u};
