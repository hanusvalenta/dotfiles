import{l as Y,u as Z}from"./dwActionLoggingDB-f05b22f9.js";import{g as q,l as tt,p as $}from"./dwScreenshotsDB-956b9f9a.js";import{A as R}from"./store-f163b43d.js";import{g as et,p as nt}from"./dwResultsDB-a3d52d5f.js";async function rt(i){return new Promise((a,e)=>{try{const n=new FileReader;n.onloadend=()=>{const t=n.result,s=t.indexOf(",");a(s>=0?t.slice(s+1):t)},n.onerror=()=>e(n.error),n.readAsDataURL(i)}catch(n){e(n)}})}async function ot(i){try{const a=await Y(),e={},n={};for(const p of a){e[p.action_id]=p.payload;try{const k=await q(p.action_id);if(k){const l=await rt(k),j=k.type||"image/jpeg";n[p.action_id]={mime:j,data_base64:l}}}catch{}}const t={kind:"dw_action_log_bundle_v1",exported_at:new Date().toISOString(),metadata:i!=null&&i.orgScope?{org_scope:i.orgScope}:void 0,actions:e,screenshots:n},s=`dw_action_log_${Object.keys(e).length}.json`,d=JSON.stringify(t,null,2),h=new Blob([d],{type:"application/json"}),y=URL.createObjectURL(h);try{const p=document.createElement("a");p.href=y,p.download=s,document.body.appendChild(p),p.click(),p.remove()}finally{URL.revokeObjectURL(y)}return{fileName:s,actionCount:Object.keys(e).length,screenshotCount:Object.keys(n).length}}catch(a){R(a,{extra:{context:"exportDWActionLogBundleToFile failed"}});const e=a;throw new Error((e==null?void 0:e.message)||"Failed to export DW action log bundle")}}async function it(i){return new Promise((a,e)=>{try{const n=new FileReader;n.onloadend=()=>{const t=n.result,s=t.indexOf(",");a(s>=0?t.slice(s+1):t)},n.onerror=()=>e(n.error),n.readAsDataURL(i)}catch(n){e(n)}})}function st(i){const a=new Set;for(const e of i.scribes||[]){const n=Array.isArray(e==null?void 0:e.actions)?e.actions:[];for(const t of n){const s=typeof(t==null?void 0:t.id)=="string"?t.id:"";if(s&&a.add(s),typeof(t==null?void 0:t.kind)=="string"&&t.kind==="stack"){const d=Array.isArray(t==null?void 0:t.actions)?t.actions:[];for(const h of d){const y=typeof(h==null?void 0:h.id)=="string"?h.id:"";y&&a.add(y)}}}}return Array.from(a)}async function at(i,a){const e=`${i.superOrgId}|${i.orgId}`;try{const n=await et(e);if(!n||!n.payload)throw new Error("No DW results found for current org.");const t=n.payload,s=(t==null?void 0:t.metadata)&&t.metadata.job_id||(typeof n.id=="string"&&n.id.includes("|")?n.id.split("|")[2]:"unknown"),d=a!=null&&a.slim?st(t):await tt(),h={};for(const w of d){const N=await q(w);if(!N)continue;const B=await it(N),L=N.type||"image/jpeg";h[w]={mime:L,data_base64:B}}const y={kind:"dw_bundle_v1",exported_at:new Date().toISOString(),latest:t,screenshots:h},p=`dw_bundle_${i.orgId||"unknown"}_${s}.json`,k=JSON.stringify(y,null,2),l=new Blob([k],{type:"application/json"}),j=URL.createObjectURL(l);try{const w=document.createElement("a");w.href=j,w.download=p,document.body.appendChild(w),w.click(),w.remove()}finally{URL.revokeObjectURL(j)}return{fileName:p,screenshotCount:Object.keys(h).length}}catch(n){R(n,{extra:{context:"exportDWResultsBundleToFile failed"}});const t=n;throw new Error((t==null?void 0:t.message)||"Failed to export DW bundle")}}async function ct(i){const a=await i.text();let e;try{e=JSON.parse(a)}catch{throw new Error("Invalid JSON file")}if(!e||e.kind!=="dw_action_log_bundle_v1"||typeof e.actions!="object")throw new Error("Unsupported file format: expecting dw_action_log_bundle_v1");try{const n=Object.entries(e.actions||{});for(const[d,h]of n)!d||!h||await Z(d,h);let t=0;const s=e.screenshots||{};for(const[d,h]of Object.entries(s)){const y=((h==null?void 0:h.data_base64)||"").toString();if(!d||!y)continue;const p=typeof(h==null?void 0:h.mime)=="string"&&h.mime?h.mime:"image/jpeg",k=await(async()=>{try{const l=atob(y),j=new Uint8Array(l.length);for(let w=0;w<l.length;w+=1)j[w]=l.charCodeAt(w);return new Blob([j],{type:p})}catch{return new Blob}})();k.size>0&&(await $(d,k),t+=1)}return{actionsImported:n.length,screenshotsImported:t}}catch(n){R(n,{extra:{context:"importDWActionLogBundleFromFile failed"}});const t=n;throw new Error((t==null?void 0:t.message)||"Failed to import DW action log bundle")}}function G(i){return i&&Array.isArray(i.scribes)}function dt(i){return i&&Array.isArray(i.recommended_scribes)}function T(i){try{return i.toISOString()}catch{return new Date().toISOString()}}function C(i,a){const e=typeof i=="string"?i.trim():"";return!e||e.toLowerCase()==="unknown"?a:e}function H(i){if(!Array.isArray(i)||i.length===0)return Array.isArray(i)?i:[];const a=new Map,e=[];for(const s of i){const d=s==null?void 0:s.stack_id;d&&typeof d=="string"&&d.length>0&&(a.has(d)||(a.set(d,[]),e.push(d)),a.get(d).push(s))}if(e.length===0)return i;const n=new Set,t=[];for(const s of i){const d=s==null?void 0:s.stack_id;if(!d){t.push(s);continue}if(n.has(d))continue;const h=a.get(d)||[];n.add(d);let y;for(const l of h)typeof(l==null?void 0:l.stack_short_description)=="string"&&l.stack_short_description.trim()?y=l.stack_short_description.trim():typeof(l==null?void 0:l.stack_description)=="string"&&l.stack_description.trim()&&(y=l.stack_description.trim());const p=h[0]||{},k={id:`stack_${d}`,kind:"stack",type:"stack",url:(p==null?void 0:p.url)||"",timestamp:(p==null?void 0:p.timestamp)||void 0,description:y||void 0,actions:h.map(l=>({...l}))};t.push(k)}return t}function ut(i){const a=new Date,e=(i.recommended_scribes||[]).map((n,t)=>{const s=Array.isArray(n.actions)?n.actions:[],d=H(s);return{title:n.title,suggestion_id:n.candidate_id||`import-${t+1}`,description:n.description||"",start_time:T(a),actions:d}});return{metadata:{job_id:`dev-import-${Date.now()}`,job_start_time:T(a),starting_datetime:T(a),end_datetime:T(a),user_id:i.user_id||"unknown",org_id:"unknown",super_org_id:"unknown",status:"completed",total_actions:e.reduce((n,t)=>n+(Array.isArray(t.actions)?t.actions.length:0),0),total_candidates_analyzed:Array.isArray(i.recommended_scribes)?i.recommended_scribes.length:0},scribes:e}}function K(i){if(!i||!Array.isArray(i.scribes))return i;const a=i.scribes.map(e=>{const n=H(Array.isArray(e==null?void 0:e.actions)?e.actions:[]);return{...e,actions:n}});return{...i,scribes:a}}async function mt(i,a,e){var w,N,B,L,E,P,z;const n=await i.text();let t;try{t=JSON.parse(n)}catch{throw new Error("Invalid JSON file")}let s;if(t&&t.kind==="dw_bundle_v1"&&t.latest&&G(t.latest)){s=K(t.latest);try{const v=t.screenshots||{},_=Object.entries(v);for(const[U,A]of _){const D=((A==null?void 0:A.data_base64)||"").toString();if(!U||!D)continue;const F=typeof(A==null?void 0:A.mime)=="string"&&A.mime?A.mime:"image/jpeg",M=await(async()=>{try{const I=atob(D),o=new Uint8Array(I.length);for(let r=0;r<I.length;r+=1)o[r]=I.charCodeAt(r);return new Blob([o],{type:F})}catch{return new Blob}})();M.size>0&&await $(U,M)}}catch(v){R(v,{extra:{context:"dw_bundle_v1 screenshot import failed"}})}}else if(G(t))s=K(t);else if(dt(t))s=ut(t);else throw new Error("Unsupported file format: expecting /latest or recommended_scribes shape");const d=s.metadata&&s.metadata.job_id||`dev-import-${Date.now()}`,h=(e==null?void 0:e.importUnderCurrentUser)!==!1,y=h?a.orgId:C((w=s.metadata)==null?void 0:w.org_id,a.orgId),p=h?a.superOrgId:C((N=s.metadata)==null?void 0:N.super_org_id,a.superOrgId),k=h?C(e==null?void 0:e.currentUserId,"unknown"):C((B=s.metadata)==null?void 0:B.user_id,(e==null?void 0:e.currentUserId)||"unknown");s.metadata={...s.metadata||{},job_id:d,org_id:y,super_org_id:p,user_id:k,status:((L=s.metadata)==null?void 0:L.status)||"completed"};try{await nt(p,y,d,s)}catch(v){throw R(v,{extra:{context:"putLatestResult failed"}}),new Error("Failed to persist DW results")}if(e!=null&&e.generateDummyScreenshots)try{const v=async o=>"convertToBlob"in o?o.convertToBlob({type:"image/jpeg",quality:.92}):new Promise(r=>o.toBlob(u=>r(u||new Blob),"image/jpeg",.92)),_=(o,r=1,u=4096)=>!Number.isFinite(o)||o<=0?r:Math.max(r,Math.min(u,Math.round(o))),U=o=>{const r=(o==null?void 0:o.image_dimensions)||(o==null?void 0:o.imageDimensions)||null,u=(o==null?void 0:o.viewport)||null;let c=Number(r==null?void 0:r.width),f=Number(r==null?void 0:r.height);return c>0&&f>0?{width:_(c),height:_(f)}:(c=Number(u==null?void 0:u.width),f=Number(u==null?void 0:u.height),c>0&&f>0?{width:_(c),height:_(f)}:{width:1024,height:768})},A=async(o,r,u,c)=>{let f;try{f=new OffscreenCanvas(r,u)}catch{const S=document.createElement("canvas");S.width=r,S.height=u,f=S}const m=f.getContext("2d");if(!m)return new Blob;if(m.fillStyle="#f3f4f6",m.fillRect(0,0,r,u),c&&Number.isFinite(c.x)&&Number.isFinite(c.y)){const S=Math.max(8,Math.round(Math.min(r,u)*.03)),x=Math.round(S/2);m.strokeStyle="#ef4444",m.lineWidth=2,m.beginPath(),m.moveTo(c.x-x,c.y-x),m.lineTo(c.x+x,c.y+x),m.moveTo(c.x-x,c.y+x),m.lineTo(c.x+x,c.y-x),m.stroke()}m.fillStyle="#111827";const g=Math.max(16,Math.min(48,Math.round(r*.04)));m.font=`bold ${g}px system-ui, -apple-system, Segoe UI, Roboto, sans-serif`,m.textAlign="center",m.textBaseline="middle";const O=Math.max(20,Math.round(u*.05));m.fillText("Dummy screenshot",r/2,u/2-O,r-80);const W=Math.max(12,Math.min(28,Math.round(r*.02)));m.font=`${W}px system-ui, -apple-system, Segoe UI, Roboto, sans-serif`;const b=u/2+10,J=28;return o.slice(0,6).forEach((S,x)=>{m.fillText(S,r/2,b+x*J,r-120)}),v(f)},D=(o,r)=>{const u=(o||"").toString().trim();if(!u)return["(no description)"];const c=Math.max(20,Math.round(r/16)),f=u.split(/\s+/),m=[];let g="";for(const O of f)`${g} ${O}`.trim().length>c?(g&&m.push(g),g=O):g=(g?`${g} `:"")+O;return g&&m.push(g),m.slice(0,6)},F=(o,r,u)=>{const c=(o==null?void 0:o.position_relative_to_image)||(o==null?void 0:o.positionRelativeToImage);if(c&&Number.isFinite(c.x)&&Number.isFinite(c.y)){const m=_(Number(c.x),0,r),g=_(Number(c.y),0,u);return{x:m,y:g}}const f=o==null?void 0:o.position;if(f&&Number.isFinite(f.x)&&Number.isFinite(f.y)){const m=_(Number(f.x),0,r),g=_(Number(f.y),0,u);return{x:m,y:g}}return null},M=o=>((o==null?void 0:o.description)||(o==null?void 0:o.current_description)||(o==null?void 0:o.short_description)||(o==null?void 0:o.kind)||"Action").toString(),I=[];for(const o of s.scribes||[])for(const r of o.actions||[])if(typeof(r==null?void 0:r.id)=="string"&&r.id.startsWith("stack_")){const u=Array.isArray(r==null?void 0:r.actions)?r.actions:[];for(const b of u){const J=`Stack nested: ${M(b)}`,{width:S,height:x}=U(b),Q=D(J,S),V=F(b,S,x);I.push((async()=>{const X=await A(Q,S,x,V);await $(b.id,X)})())}const c=[...u].reverse().find(b=>(b==null?void 0:b.image_dimensions)||(b==null?void 0:b.viewport))||u[u.length-1]||{},{width:f,height:m}=U(c),g=`Stack: ${(r==null?void 0:r.description)||M(c)}`,O=D(g,f),W=F(c,f,m);I.push((async()=>{const b=await A(O,f,m,W);await $(r.id,b)})())}else if(r!=null&&r.id){const u=M(r),{width:c,height:f}=U(r),m=D(u,c),g=F(r,c,f);I.push((async()=>{const O=await A(m,c,f,g);await $(r.id,O)})())}await Promise.allSettled(I)}catch(v){R(v,{extra:{context:"generateDummyScreenshots failed"}})}try{(P=(E=chrome.runtime)==null?void 0:E.sendMessage)==null||P.call(E,{messageType:"dwLatestResultsUpdated"})}catch{}const l=Array.isArray(s.scribes)?s.scribes.length:0,j=(z=s.scribes)==null?void 0:z.reduce((v,_)=>v+(Array.isArray(_.actions)?_.actions.length:0),0);return{scribesImported:l,actionsImported:j,jobId:d}}export{ct as a,ot as b,at as e,mt as i};
