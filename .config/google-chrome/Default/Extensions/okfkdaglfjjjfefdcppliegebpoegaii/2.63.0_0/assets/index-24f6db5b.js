import"./index-8b3efc3f.js";import{c$ as d,f as y,s as l,em as m,en as g,x as E,cz as f}from"./store-f163b43d.js";import{g as w}from"./appTagUtils-f127d137.js";class S{constructor(){this.handlers={},this.isExternal=!1}on(r,e){return this.handlers[r]=this.wrapHandler(e),this}external(){return this.isExternal=!0,this}buildWithoutRegistration(){return{handlers:this.handlers,messageMap:{},send:this.createSender(),types:{}}}build(r){const e=this.createMessageListener(r);return this.isExternal?chrome.runtime.onMessageExternal.addListener(e):chrome.runtime.onMessage.addListener(e),{...this.buildWithoutRegistration(),unregister:()=>{this.isExternal?chrome.runtime.onMessageExternal.removeListener(e):chrome.runtime.onMessage.removeListener(e)}}}createMessageListener(r){return(e,t,s)=>{if(typeof e.type!="string")return console.warn("Received message without type:",e),r?r(e,t,s):!1;const a=this.handlers[e.type];if(a)try{const i=h=>{s(h)},c=h=>{const u=h instanceof Error?h.message:h;s({error:u})},o=e.payload;return a(o,t,i,c)!==!1}catch(i){console.error(`Error in message handler for ${e.type}:`,i);const c=i instanceof Error?i.message:String(i);return s({error:c}),!1}return r?r(e,t,s):(console.warn("No handler found for message type:",e.type),!1)}}createSender(){return(r,...e)=>{const[t]=e;return new Promise((s,a)=>{const i={type:r};t!==void 0&&(i.payload=t),(this.isExternal?(c,o)=>chrome.runtime.sendMessage(chrome.runtime.id,c,o):chrome.runtime.sendMessage)(i,c=>{if(chrome.runtime.lastError){a(new Error(chrome.runtime.lastError.message));return}if(c&&c.error){a(new Error(c.error));return}s(c)})})}}wrapHandler(r){return(e,t,s,a)=>{let i=!1;const c=o=>{i=!0,s(o)};try{const o=r(e,t,c,a);return o instanceof Promise?(o.catch(h=>{if(console.error("Async handler error:",h),a){const u=h instanceof Error?h.message:String(h);a(u)}}),!0):o===!1?!1:o===!0?!0:!i}catch(o){if(console.error("Handler error:",o),a){const h=o instanceof Error?o.message:String(o);a(h)}return!1}}}}function p(){return new S}const b=p().on("earlyScreenshot",async(n,r,e)=>{var t;try{const s=await chrome.tabs.captureVisibleTab({format:"jpeg"}),a=Date.now();await chrome.storage.session.set({[`early-screenshot-${a}`]:s}),e(a)}catch(s){(t=s==null?void 0:s.message)!=null&&t.includes("This request exceeds the MAX_CAPTURE_VISIBLE_TAB_CALLS_PER_SECOND quota.")||console.error("Early screenshot error:",s),e(null)}}).on("isCurrentTab",async(n,r,e)=>{var s;await d();const t=await y();e({isCurrent:(t==null?void 0:t.id)===((s=r.tab)==null?void 0:s.id),selfTab:r.tab})}).on("getStore",async(n,r,e)=>{await d();const t=l.getState();e(t)}).on("tldExtract",(n,r,e)=>{const t=w(n.url);e({domain:t})}).on("isExtensionPinned",async(n,r,e)=>{const t=await chrome.action.getUserSettings();e(t.isOnToolbar)}).on("deleteAction",async(n,r,e)=>{n.tempId&&(l.dispatch(m(n.tempId)),await g()),e()}).on("domSettlementStage",async(n,r,e)=>{const t=f();t&&r.tab&&n.stage&&t.handleStageCapture(r.tab.id,n.stage,n.data).catch(s=>console.error("Error handling stage capture",s)),e()}).on("requestFlags",async(n,r,e)=>{e(E(l.getState()))}).buildWithoutRegistration(),x=p().external().on("isExtensionPinned",async(n,r,e)=>{const t=await chrome.action.getUserSettings();e(t.isOnToolbar)}).on("deleteAction",async(n,r,e)=>{n.tempId&&(l.dispatch(m(n.tempId)),await g()),e()}).buildWithoutRegistration();export{x as e,b as m};
