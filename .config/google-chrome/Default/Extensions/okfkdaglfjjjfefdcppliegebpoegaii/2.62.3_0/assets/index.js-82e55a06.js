var Qo=Object.defineProperty;var Zo=(e,t,n)=>t in e?Qo(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var Be=(e,t,n)=>(Zo(e,typeof t!="symbol"?t+"":t,n),n);var Yo;import{b9 as An,ba as ei,bb as es,bc as Rn,bd as W,be as Ze,bf as ye,bg as ti,bh as fe,bi as ts,bj as On,bk as ni,bl as ns,bm as it,bn as xn,bo as Pn,bp as ct,bq as rs,br as ri,bs as si,bt as ai,bu as oi,bv as se,bw as ii,bx as ss,by as as,bz as Ln,bA as os,bB as ci,bC as li,bD as di,bE as ui,bF as Nn,bG as is,bH as pi,bI as cs,bJ as Ge,bK as Kt,bL as Mn,bM as Ae,bN as hi,bO as gi,bP as Un,bQ as Yt,A as X,bR as Fn,bS as ls,bT as mi,bU as fi,bV as $n,bW as yi,bX as _i,bY as wi,bZ as oe,b_ as bi,b$ as vi,c0 as ds,c1 as us,c2 as Si,c3 as Ti,c4 as ps,c5 as hs,ak as J,az as It,s as l,af as we,c6 as gs,c7 as ms,c8 as ze,c9 as ue,y as Ei,ca as Ii,cb as ki,ar as kt,E as ge,cc as F,cd as Ci,ce as Di,cf as Ai,cg as Ri,ch as Oi,R as xi,ci as Pi,cj as Li,ck as Re,cl as Ct,cm as Ni,cn as fs,p as ys,m as Q,co as Mi,U as z,G as Ui,cp as Fi,cq as et,cr as _s,cs as jn,aB as qn,ct as ws,cu as bs,t as Z,cv as $i,a as ji,cw as ee,S as Ve,cx as lt,cy as tt,cz as Xt,D as V,ay as Dt,cA as Jt,cB as dt,cC as qi,cD as Wi,cE as Bi,cF as Gi,F as zi,cG as Vi,cH as Hi,cI as Wn,cJ as Ki,x as ce,cK as ut,cL as Yi,cM as Xi,w as $e,V as Ji,cN as Bn,cO as vs,b0 as te,cP as je,cQ as Gn,cR as Ss,cS as Ts,f as Y,cT as zn,cU as Es,cV as Le,cW as Vn,cX as Qi,cY as Zi,J as Is,cZ as ec,c_ as tc,c$ as At,d0 as nc,d1 as rc,P as sc,d2 as ks,d3 as ac,av as oc,d4 as ic,d5 as Hn,d6 as Cs,d7 as cc,j as Ds,ai as nt,ag as Ee,o as Ie,d8 as As,d9 as Rt,da as Rs,db as Os,dc as lc,dd as Kn,de as dc,df as uc,dg as pc,dh as hc,di as gc,dj as mc,aW as fc,dk as xs,dl as Ps,dm as pt,dn as Yn,dp as ht,dq as yc,dr as _c,i as wc,ds as bc,dt as Xn,du as Ls,dv as Jn,dw as vc,dx as Sc,dy as Tc,dz as Ec,Q as Ns,dA as Ic,dB as kc,dC as Cc,dD as Ms,dE as Us,dF as Fs,dG as Dc,dH as Ac,dI as Qt,aC as Rc,dJ as Qn,dK as Zn,dL as Zt,ac as en,dM as er,dN as tr,dO as Ot,dP as nr,dQ as Oc,dR as xc,dS as Pc,dT as Lc,dU as Nc,dV as Mc,dW as Uc,dX as Fc,dY as $s,a8 as $c,dZ as jc,d_ as qc,d$ as Wc,e0 as js,e1 as Bc,e2 as Gc,e3 as rr,e4 as zc,e5 as Vc,ao as qs,e6 as Ws,e7 as Hc,e8 as Kc,e9 as Yc,ea as sr,eb as Bs,C as Xc,ec as Jc,ed as Qc,ee as Zc,a7 as el,ef as ar,eg as tl,eh as nl,ei as Gs,ej as zs}from"./store-09c6166c.js";import{a as Vs}from"./browserContext-fabb883d.js";import{m as rl,e as sl}from"./index-7bc06dca.js";import{E as tn}from"./entry-point-enums-c196ff5e.js";import{g as al,s as xt,m as nn,n as ol,M as Hs,b as il,j as Ks,o as Ys,e as cl,q as ll}from"./util-1d7a9308.js";import{c as dl,g as ul,a as Xs}from"./appTagUtils-c74c75cd.js";import{v as qe}from"./v4-c70744d4.js";import{l as le}from"./dw-telemetry-83cc94a3.js";import{c as rn,g as pl}from"./_commonjsHelpers-de833af9.js";import{g as hl,b as Js,s as or,a as gl}from"./options-7a3fe88d.js";import{a as ml,b as fl}from"./scribeLiveUtils-2439b7f4.js";import{V as ir}from"./messages-bb434fe1.js";import{b as Qs,g as Zs,a as yl,s as _l}from"./allowedDomainsDB-47151ce3.js";import{shouldStreamUrl as wl}from"./index.ts-5a1a24db.js";import{p as bl,g as cr,o as vl,a as Sl,c as Tl,b as El}from"./dwResultsDB-40675cfa.js";import{u as Il,m as kl,c as Cl,a as Dl,b as Al}from"./dwActionLoggingDB-f05b22f9.js";import{o as Rl,a as Ol,c as xl,p as Pl}from"./dwScreenshotsDB-956b9f9a.js";import{g as Ll}from"./scribeSuggestions-59cbe47c.js";import{u as Nl}from"./domUtils-fa446205.js";import"./index-8b3efc3f.js";import"./domCopyAnnotate-a2b92afc.js";import"./getTargetElementAttributes-3f1109f1.js";function ea(e,t,n=!1){const r=e.handlers,s=(a,i,o)=>{if(a&&typeof a=="object"&&"type"in a&&r[a.type]){const d=r[a.type];try{const p=y=>{o(y)},h=y=>{const b=y instanceof Error?y.message:y;o({error:b})},g=a.payload;return d(g,i,p,h)!==!1}catch(p){console.error(`Error in typed message handler for ${a.type}:`,p);const h=p instanceof Error?p.message:String(p);return o({error:h}),!1}}return t(a,i,o)};n?chrome.runtime.onMessageExternal.addListener(s):chrome.runtime.onMessage.addListener(s)}function Ml(e,t){ea(e,t,!1)}function Ul(e,t){ea(e,t,!0)}function Fl(e,t,n=250,r,s,a,i){if(!a.exception||!a.exception.values||!i||!An(i.originalException,Error))return;const o=a.exception.values.length>0?a.exception.values[a.exception.values.length-1]:void 0;o&&(a.exception.values=$l(lr(e,t,s,i.originalException,r,a.exception.values,o,0),n))}function lr(e,t,n,r,s,a,i,o){if(a.length>=n+1)return a;let d=[...a];if(An(r[s],Error)){ta(i,o);const p=e(t,r[s]),h=d.length;na(p,s,h,o),d=lr(e,t,n,r[s],s,[p,...d],p,h)}return Array.isArray(r.errors)&&r.errors.forEach((p,h)=>{if(An(p,Error)){ta(i,o);const g=e(t,p),y=d.length;na(g,`errors[${h}]`,y,o),d=lr(e,t,n,p,s,[g,...d],g,y)}}),d}function ta(e,t){e.mechanism=e.mechanism||{type:"generic",handled:!0},e.mechanism={...e.mechanism,...e.type==="AggregateError"&&{is_exception_group:!0},exception_id:t}}function na(e,t,n,r){e.mechanism=e.mechanism||{type:"generic",handled:!0},e.mechanism={...e.mechanism,type:"chained",source:t,exception_id:n,parent_id:r}}function $l(e,t){return e.map(n=>(n.value&&(n.value=ei(n.value,t)),n))}const jl=/^(?:(\w+):)\/\/(?:(\w+)(?::(\w+)?)?@)([\w.-]+)(?::(\d+))?\/(.+)/;function ql(e){return e==="http"||e==="https"}function Pt(e,t=!1){const{host:n,path:r,pass:s,port:a,projectId:i,protocol:o,publicKey:d}=e;return`${o}://${d}${t&&s?`:${s}`:""}@${n}${a?`:${a}`:""}/${r&&`${r}/`}${i}`}function Wl(e){const t=jl.exec(e);if(!t){es(()=>{console.error(`Invalid Sentry Dsn: ${e}`)});return}const[n,r,s="",a,i="",o]=t.slice(1);let d="",p=o;const h=p.split("/");if(h.length>1&&(d=h.slice(0,-1).join("/"),p=h.pop()),p){const g=p.match(/^\d+/);g&&(p=g[0])}return ra({host:a,pass:s,path:d,projectId:p,port:i,protocol:n,publicKey:r})}function ra(e){return{protocol:e.protocol,publicKey:e.publicKey||"",pass:e.pass||"",host:e.host,port:e.port||"",path:e.path||"",projectId:e.projectId}}function Bl(e){if(!Rn)return!0;const{port:t,projectId:n,protocol:r}=e;return["protocol","publicKey","host","projectId"].find(s=>e[s]?!1:(W.error(`Invalid Sentry Dsn: ${s} missing`),!0))?!1:n.match(/^\d+$/)?ql(r)?t&&isNaN(parseInt(t,10))?(W.error(`Invalid Sentry Dsn: Invalid port ${t}`),!1):!0:(W.error(`Invalid Sentry Dsn: Invalid protocol ${r}`),!1):(W.error(`Invalid Sentry Dsn: Invalid projectId ${n}`),!1)}function Gl(e){const t=typeof e=="string"?Wl(e):ra(e);if(!(!t||!Bl(t)))return t}class Ne extends Error{constructor(t,n="warn"){super(t),this.message=t,this.name=new.target.prototype.constructor.name,Object.setPrototypeOf(this,new.target.prototype),this.logLevel=n}}const sn={},sa={};function rt(e,t){sn[e]=sn[e]||[],sn[e].push(t)}function st(e,t){sa[e]||(t(),sa[e]=!0)}function Oe(e,t){const n=e&&sn[e];if(n)for(const r of n)try{r(t)}catch(s){Rn&&W.error(`Error while triggering instrumentation handler.
Type: ${e}
Name: ${Ze(r)}
Error:`,s)}}function zl(e){const t="console";rt(t,e),st(t,Vl)}function Vl(){"console"in ye&&ti.forEach(function(e){e in ye.console&&fe(ye.console,e,function(t){return ts[e]=t,function(...n){Oe("console",{args:n,level:e});const r=ts[e];r&&r.apply(ye.console,n)}})})}const gt=ye,Hl=1e3;let aa,dr,ur;function Kl(e){const t="dom";rt(t,e),st(t,Yl)}function Yl(){if(!gt.document)return;const e=Oe.bind(null,"dom"),t=oa(e,!0);gt.document.addEventListener("click",t,!1),gt.document.addEventListener("keypress",t,!1),["EventTarget","Node"].forEach(n=>{const r=gt[n]&&gt[n].prototype;!r||!r.hasOwnProperty||!r.hasOwnProperty("addEventListener")||(fe(r,"addEventListener",function(s){return function(a,i,o){if(a==="click"||a=="keypress")try{const d=this,p=d.__sentry_instrumentation_handlers__=d.__sentry_instrumentation_handlers__||{},h=p[a]=p[a]||{refCount:0};if(!h.handler){const g=oa(e);h.handler=g,s.call(this,a,g,o)}h.refCount++}catch{}return s.call(this,a,i,o)}}),fe(r,"removeEventListener",function(s){return function(a,i,o){if(a==="click"||a=="keypress")try{const d=this,p=d.__sentry_instrumentation_handlers__||{},h=p[a];h&&(h.refCount--,h.refCount<=0&&(s.call(this,a,h.handler,o),h.handler=void 0,delete p[a]),Object.keys(p).length===0&&delete d.__sentry_instrumentation_handlers__)}catch{}return s.call(this,a,i,o)}}))})}function Xl(e){if(e.type!==dr)return!1;try{if(!e.target||e.target._sentryId!==ur)return!1}catch{}return!0}function Jl(e,t){return e!=="keypress"?!1:!t||!t.tagName?!0:!(t.tagName==="INPUT"||t.tagName==="TEXTAREA"||t.isContentEditable)}function oa(e,t=!1){return n=>{if(!n||n._sentryCaptured)return;const r=Ql(n);if(Jl(n.type,r))return;On(n,"_sentryCaptured",!0),r&&!r._sentryId&&On(r,"_sentryId",ni());const s=n.type==="keypress"?"input":n.type;Xl(n)||(e({event:n,name:s,global:t}),dr=n.type,ur=r?r._sentryId:void 0),clearTimeout(aa),aa=gt.setTimeout(()=>{ur=void 0,dr=void 0},Hl)}}function Ql(e){try{return e.target}catch{return null}}const pr=ns();function ia(){if(!("fetch"in pr))return!1;try{return new Headers,new Request("http://www.example.com"),new Response,!0}catch{return!1}}function hr(e){return e&&/^function fetch\(\)\s+\{\s+\[native code\]\s+\}$/.test(e.toString())}function Zl(){if(typeof EdgeRuntime=="string")return!0;if(!ia())return!1;if(hr(pr.fetch))return!0;let e=!1;const t=pr.document;if(t&&typeof t.createElement=="function")try{const n=t.createElement("iframe");n.hidden=!0,t.head.appendChild(n),n.contentWindow&&n.contentWindow.fetch&&(e=hr(n.contentWindow.fetch)),t.head.removeChild(n)}catch(n){Rn&&W.warn("Could not create sandbox iframe for pure fetch check, bailing to window.fetch: ",n)}return e}function ed(e){const t="fetch";rt(t,e),st(t,td)}function td(){Zl()&&fe(ye,"fetch",function(e){return function(...t){const{method:n,url:r}=nd(t),s={args:t,fetchData:{method:n,url:r},startTimestamp:Date.now()};return Oe("fetch",{...s}),e.apply(ye,t).then(a=>{const i={...s,endTimestamp:Date.now(),response:a};return Oe("fetch",i),a},a=>{const i={...s,endTimestamp:Date.now(),error:a};throw Oe("fetch",i),a})}})}function gr(e,t){return!!e&&typeof e=="object"&&!!e[t]}function ca(e){return typeof e=="string"?e:e?gr(e,"url")?e.url:e.toString?e.toString():"":""}function nd(e){if(e.length===0)return{method:"GET",url:""};if(e.length===2){const[n,r]=e;return{url:ca(n),method:gr(r,"method")?String(r.method).toUpperCase():"GET"}}const t=e[0];return{url:ca(t),method:gr(t,"method")?String(t.method).toUpperCase():"GET"}}let an=null;function rd(e){const t="error";rt(t,e),st(t,sd)}function sd(){an=ye.onerror,ye.onerror=function(e,t,n,r,s){return Oe("error",{column:r,error:s,line:n,msg:e,url:t}),an&&!an.__SENTRY_LOADER__?an.apply(this,arguments):!1},ye.onerror.__SENTRY_INSTRUMENTED__=!0}let on=null;function ad(e){const t="unhandledrejection";rt(t,e),st(t,od)}function od(){on=ye.onunhandledrejection,ye.onunhandledrejection=function(e){return Oe("unhandledrejection",e),on&&!on.__SENTRY_LOADER__?on.apply(this,arguments):!0},ye.onunhandledrejection.__SENTRY_INSTRUMENTED__=!0}const cn=ns();function id(){const e=cn.chrome,t=e&&e.app&&e.app.runtime,n="history"in cn&&!!cn.history.pushState&&!!cn.history.replaceState;return!t&&n}const Lt=ye;let ln;function la(e){const t="history";rt(t,e),st(t,cd)}function cd(){if(!id())return;const e=Lt.onpopstate;Lt.onpopstate=function(...n){const r=Lt.location.href,s=ln;if(ln=r,Oe("history",{from:s,to:r}),e)try{return e.apply(this,n)}catch{}};function t(n){return function(...r){const s=r.length>2?r[2]:void 0;if(s){const a=ln,i=String(s);ln=i,Oe("history",{from:a,to:i})}return n.apply(this,r)}}fe(Lt.history,"pushState",t),fe(Lt.history,"replaceState",t)}const ld=ye,Nt="__sentry_xhr_v3__";function dd(e){const t="xhr";rt(t,e),st(t,ud)}function ud(){if(!ld.XMLHttpRequest)return;const e=XMLHttpRequest.prototype;fe(e,"open",function(t){return function(...n){const r=Date.now(),s=it(n[0])?n[0].toUpperCase():void 0,a=pd(n[1]);if(!s||!a)return t.apply(this,n);this[Nt]={method:s,url:a,request_headers:{}},s==="POST"&&a.match(/sentry_key/)&&(this.__sentry_own_request__=!0);const i=()=>{const o=this[Nt];if(o&&this.readyState===4){try{o.status_code=this.status}catch{}const d={args:[s,a],endTimestamp:Date.now(),startTimestamp:r,xhr:this};Oe("xhr",d)}};return"onreadystatechange"in this&&typeof this.onreadystatechange=="function"?fe(this,"onreadystatechange",function(o){return function(...d){return i(),o.apply(this,d)}}):this.addEventListener("readystatechange",i),fe(this,"setRequestHeader",function(o){return function(...d){const[p,h]=d,g=this[Nt];return g&&it(p)&&it(h)&&(g.request_headers[p.toLowerCase()]=h),o.apply(this,d)}}),t.apply(this,n)}}),fe(e,"send",function(t){return function(...n){const r=this[Nt];if(!r)return t.apply(this,n);n[0]!==void 0&&(r.body=n[0]);const s={args:[r.method,r.url],startTimestamp:Date.now(),xhr:this};return Oe("xhr",s),t.apply(this,n)}})}function pd(e){if(it(e))return e;try{return e.toString()}catch{}}function hd(){return"npm"}function gd(e){const t=[];function n(){return e===void 0||t.length<e}function r(i){return t.splice(t.indexOf(i),1)[0]}function s(i){if(!n())return xn(new Ne("Not adding Promise because buffer limit was reached."));const o=i();return t.indexOf(o)===-1&&t.push(o),o.then(()=>r(o)).then(null,()=>r(o).then(null,()=>{})),o}function a(i){return new Pn((o,d)=>{let p=t.length;if(!p)return o(!0);const h=setTimeout(()=>{i&&i>0&&o(!1)},i);t.forEach(g=>{ct(g).then(()=>{--p||(clearTimeout(h),o(!0))},d)})})}return{$:t,add:s,drain:a}}function mr(e){if(!e)return{};const t=e.match(/^(([^:/?#]+):)?(\/\/([^/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?$/);if(!t)return{};const n=t[6]||"",r=t[8]||"";return{host:t[4],path:t[5],protocol:t[2],search:n,hash:r,relative:t[5]+n+r}}const md=["fatal","error","warning","log","info","debug"];function fd(e){return e==="warn"?"warning":md.includes(e)?e:"log"}function mt(e,t=[]){return[e,t]}function yd(e,t){const[n,r]=e;return[n,[...r,t]]}function da(e,t){const n=e[1];for(const r of n){const s=r[0].type;if(t(r,s))return!0}return!1}function fr(e,t){return(t||new TextEncoder).encode(e)}function _d(e,t){const[n,r]=e;let s=JSON.stringify(n);function a(i){typeof s=="string"?s=typeof i=="string"?s+i:[fr(s,t),i]:s.push(typeof i=="string"?fr(i,t):i)}for(const i of r){const[o,d]=i;if(a(`
${JSON.stringify(o)}
`),typeof d=="string"||d instanceof Uint8Array)a(d);else{let p;try{p=JSON.stringify(d)}catch{p=JSON.stringify(ri(d))}a(p)}}return typeof s=="string"?s:wd(s)}function wd(e){const t=e.reduce((s,a)=>s+a.length,0),n=new Uint8Array(t);let r=0;for(const s of e)n.set(s,r),r+=s.length;return n}function bd(e,t){const n=typeof e.data=="string"?fr(e.data,t):e.data;return[rs({type:"attachment",length:n.length,filename:e.filename,content_type:e.contentType,attachment_type:e.attachmentType}),n]}const vd={session:"session",sessions:"session",attachment:"attachment",transaction:"transaction",event:"error",client_report:"internal",user_report:"default",profile:"profile",replay_event:"replay",replay_recording:"replay",check_in:"monitor",feedback:"feedback",span:"span",statsd:"metric_bucket"};function ua(e){return vd[e]}function pa(e){if(!e||!e.sdk)return;const{name:t,version:n}=e.sdk;return{name:t,version:n}}function Sd(e,t,n,r){const s=e.sdkProcessingMetadata&&e.sdkProcessingMetadata.dynamicSamplingContext;return{event_id:e.event_id,sent_at:new Date().toISOString(),...t&&{sdk:t},...!!n&&r&&{dsn:Pt(r)},...s&&{trace:rs({...s})}}}function Td(e,t,n){const r=[{type:"client_report"},{timestamp:n||si(),discarded_events:e}];return mt(t?{dsn:t}:{},[r])}const Ed=60*1e3;function Id(e,t=Date.now()){const n=parseInt(`${e}`,10);if(!isNaN(n))return n*1e3;const r=Date.parse(`${e}`);return isNaN(r)?Ed:r-t}function kd(e,t){return e[t]||e.all||0}function Cd(e,t,n=Date.now()){return kd(e,t)>n}function Dd(e,{statusCode:t,headers:n},r=Date.now()){const s={...e},a=n&&n["x-sentry-rate-limits"],i=n&&n["retry-after"];if(a)for(const o of a.trim().split(",")){const[d,p,,,h]=o.split(":",5),g=parseInt(d,10),y=(isNaN(g)?60:g)*1e3;if(!p)s.all=r+y;else for(const b of p.split(";"))b==="metric_bucket"?(!h||h.split(";").includes("custom"))&&(s[b]=r+y):s[b]=r+y}else i?s.all=r+Id(i,r):t===429&&(s.all=r+60*1e3);return s}function Ad(e,t){return t&&(e.sdk=e.sdk||{},e.sdk.name=e.sdk.name||t.name,e.sdk.version=e.sdk.version||t.version,e.sdk.integrations=[...e.sdk.integrations||[],...t.integrations||[]],e.sdk.packages=[...e.sdk.packages||[],...t.packages||[]]),e}function Rd(e,t,n,r){const s=pa(n),a={sent_at:new Date().toISOString(),...s&&{sdk:s},...!!r&&t&&{dsn:Pt(t)}},i="aggregates"in e?[{type:"sessions"},e]:[{type:"session"},e.toJSON()];return mt(a,[i])}function Od(e,t,n,r){const s=pa(n),a=e.type&&e.type!=="replay_event"?e.type:"event";Ad(e,n&&n.sdk);const i=Sd(e,s,r,t);return delete e.sdkProcessingMetadata,mt(i,[[{type:a},e]])}const xd="7";function Pd(e){const t=e.protocol?`${e.protocol}:`:"",n=e.port?`:${e.port}`:"";return`${t}//${e.host}${n}${e.path?`/${e.path}`:""}/api/`}function Ld(e){return`${Pd(e)}${e.projectId}/envelope/`}function Nd(e,t){return ai({sentry_key:e.publicKey,sentry_version:xd,...t&&{sentry_client:`${t.name}/${t.version}`}})}function Md(e,t={}){const n=typeof t=="string"?t:t.tunnel,r=typeof t=="string"||!t._metadata?void 0:t._metadata.sdk;return n||`${Ld(e)}?${Nd(e,r)}`}const ha=[];function Ud(e){const t={};return e.forEach(n=>{const{name:r}=n,s=t[r];s&&!s.isDefaultInstance&&n.isDefaultInstance||(t[r]=n)}),Object.keys(t).map(n=>t[n])}function Fd(e){const t=e.defaultIntegrations||[],n=e.integrations;t.forEach(i=>{i.isDefaultInstance=!0});let r;Array.isArray(n)?r=[...t,...n]:typeof n=="function"?r=oi(n(t)):r=t;const s=Ud(r),a=jd(s,i=>i.name==="Debug");if(a!==-1){const[i]=s.splice(a,1);s.push(i)}return s}function $d(e,t){const n={};return t.forEach(r=>{r&&ma(e,r,n)}),n}function ga(e,t){for(const n of t)n&&n.afterAllSetup&&n.afterAllSetup(e)}function ma(e,t,n){if(n[t.name]){se&&W.log(`Integration skipped because it was already installed: ${t.name}`);return}if(n[t.name]=t,ha.indexOf(t.name)===-1&&(t.setupOnce(ii,ss),ha.push(t.name)),t.setup&&typeof t.setup=="function"&&t.setup(e),e.on&&typeof t.preprocessEvent=="function"){const r=t.preprocessEvent.bind(t);e.on("preprocessEvent",(s,a)=>r(s,a,e))}if(e.addEventProcessor&&typeof t.processEvent=="function"){const r=t.processEvent.bind(t),s=Object.assign((a,i)=>r(a,i,e),{id:t.name});e.addEventProcessor(s)}se&&W.log(`Integration installed: ${t.name}`)}function jd(e,t){for(let n=0;n<e.length;n++)if(t(e[n])===!0)return n;return-1}function He(e,t){return Object.assign(function(...n){return t(...n)},{id:e})}function qd(e){let t="";for(const n of e){const r=Object.entries(n.tags),s=r.length>0?`|#${r.map(([a,i])=>`${a}:${i}`).join(",")}`:"";t+=`${n.name}@${n.unit}:${n.metric}|${n.metricType}${s}|T${n.timestamp}
`}return t}function Wd(e,t,n,r){const s={sent_at:new Date().toISOString()};n&&n.sdk&&(s.sdk={name:n.sdk.name,version:n.sdk.version}),r&&t&&(s.dsn=Pt(t));const a=Bd(e);return mt(s,[a])}function Bd(e){const t=qd(e);return[{type:"statsd",length:t.length},t]}const fa="Not capturing exception because it's already been captured.";class Gd{constructor(t){if(this._options=t,this._integrations={},this._integrationsInitialized=!1,this._numProcessing=0,this._outcomes={},this._hooks={},this._eventProcessors=[],t.dsn?this._dsn=Gl(t.dsn):se&&W.warn("No DSN provided, client will not send events."),this._dsn){const n=Md(this._dsn,t);this._transport=t.transport({tunnel:this._options.tunnel,recordDroppedEvent:this.recordDroppedEvent.bind(this),...t.transportOptions,url:n})}}captureException(t,n,r){if(as(t)){se&&W.log(fa);return}let s=n&&n.event_id;return this._process(this.eventFromException(t,n).then(a=>this._captureEvent(a,n,r)).then(a=>{s=a})),s}captureMessage(t,n,r,s){let a=r&&r.event_id;const i=is(t)?t:String(t),o=Ln(t)?this.eventFromMessage(i,n,r):this.eventFromException(t,r);return this._process(o.then(d=>this._captureEvent(d,r,s)).then(d=>{a=d})),a}captureEvent(t,n,r){if(n&&n.originalException&&as(n.originalException)){se&&W.log(fa);return}let s=n&&n.event_id;const a=(t.sdkProcessingMetadata||{}).capturedSpanScope;return this._process(this._captureEvent(t,n,a||r).then(i=>{s=i})),s}captureSession(t){typeof t.release!="string"?se&&W.warn("Discarded session because of missing or non-string release"):(this.sendSession(t),os(t,{init:!1}))}getDsn(){return this._dsn}getOptions(){return this._options}getSdkMetadata(){return this._options._metadata}getTransport(){return this._transport}flush(t){const n=this._transport;return n?(this.metricsAggregator&&this.metricsAggregator.flush(),this._isClientDoneProcessing(t).then(r=>n.flush(t).then(s=>r&&s))):ct(!0)}close(t){return this.flush(t).then(n=>(this.getOptions().enabled=!1,this.metricsAggregator&&this.metricsAggregator.close(),n))}getEventProcessors(){return this._eventProcessors}addEventProcessor(t){this._eventProcessors.push(t)}setupIntegrations(t){(t&&!this._integrationsInitialized||this._isEnabled()&&!this._integrationsInitialized)&&this._setupIntegrations()}init(){this._isEnabled()&&this._setupIntegrations()}getIntegrationById(t){return this.getIntegrationByName(t)}getIntegrationByName(t){return this._integrations[t]}getIntegration(t){try{return this._integrations[t.id]||null}catch{return se&&W.warn(`Cannot retrieve integration ${t.id} from the current Client`),null}}addIntegration(t){const n=this._integrations[t.name];ma(this,t,this._integrations),n||ga(this,[t])}sendEvent(t,n={}){this.emit("beforeSendEvent",t,n);let r=Od(t,this._dsn,this._options._metadata,this._options.tunnel);for(const a of n.attachments||[])r=yd(r,bd(a,this._options.transportOptions&&this._options.transportOptions.textEncoder));const s=this._sendEnvelope(r);s&&s.then(a=>this.emit("afterSendEvent",t,a),null)}sendSession(t){const n=Rd(t,this._dsn,this._options._metadata,this._options.tunnel);this._sendEnvelope(n)}recordDroppedEvent(t,n,r){if(this._options.sendClientReports){const s=typeof r=="number"?r:1,a=`${t}:${n}`;se&&W.log(`Recording outcome: "${a}"${s>1?` (${s} times)`:""}`),this._outcomes[a]=(this._outcomes[a]||0)+s}}captureAggregateMetrics(t){se&&W.log(`Flushing aggregated metrics, number of metrics: ${t.length}`);const n=Wd(t,this._dsn,this._options._metadata,this._options.tunnel);this._sendEnvelope(n)}on(t,n){this._hooks[t]||(this._hooks[t]=[]),this._hooks[t].push(n)}emit(t,...n){this._hooks[t]&&this._hooks[t].forEach(r=>r(...n))}_setupIntegrations(){const{integrations:t}=this._options;this._integrations=$d(this,t),ga(this,t),this._integrationsInitialized=!0}_updateSessionFromEvent(t,n){let r=!1,s=!1;const a=n.exception&&n.exception.values;if(a){s=!0;for(const o of a){const d=o.mechanism;if(d&&d.handled===!1){r=!0;break}}}const i=t.status==="ok";(i&&t.errors===0||i&&r)&&(os(t,{...r&&{status:"crashed"},errors:t.errors||Number(s||r)}),this.captureSession(t))}_isClientDoneProcessing(t){return new Pn(n=>{let r=0;const s=1,a=setInterval(()=>{this._numProcessing==0?(clearInterval(a),n(!0)):(r+=s,t&&r>=t&&(clearInterval(a),n(!1)))},s)})}_isEnabled(){return this.getOptions().enabled!==!1&&this._transport!==void 0}_prepareEvent(t,n,r,s=di()){const a=this.getOptions(),i=Object.keys(this._integrations);return!n.integrations&&i.length>0&&(n.integrations=i),this.emit("preprocessEvent",t,n),ci(a,t,n,r,this,s).then(o=>{if(o===null)return o;const d={...s.getPropagationContext(),...r?r.getPropagationContext():void 0};if(!(o.contexts&&o.contexts.trace)&&d){const{traceId:p,spanId:h,parentSpanId:g,dsc:y}=d;o.contexts={trace:{trace_id:p,span_id:h,parent_span_id:g},...o.contexts};const b=y||li(p,this,r);o.sdkProcessingMetadata={dynamicSamplingContext:b,...o.sdkProcessingMetadata}}return o})}_captureEvent(t,n={},r){return this._processEvent(t,n,r).then(s=>s.event_id,s=>{if(se){const a=s;a.logLevel==="log"?W.log(a.message):W.warn(a)}})}_processEvent(t,n,r){const s=this.getOptions(),{sampleRate:a}=s,i=_a(t),o=ya(t),d=t.type||"error",p=`before send for type \`${d}\``;if(o&&typeof a=="number"&&Math.random()>a)return this.recordDroppedEvent("sample_rate","error",t),xn(new Ne(`Discarding event because it's not included in the random sample (sampling rate = ${a})`,"log"));const h=d==="replay_event"?"replay":d,g=(t.sdkProcessingMetadata||{}).capturedSpanIsolationScope;return this._prepareEvent(t,n,r,g).then(y=>{if(y===null)throw this.recordDroppedEvent("event_processor",h,t),new Ne("An event processor returned `null`, will not send event.","log");if(n.data&&n.data.__sentry__===!0)return y;const b=Vd(s,y,n);return zd(b,p)}).then(y=>{if(y===null){if(this.recordDroppedEvent("before_send",h,t),i){const S=1+(t.spans||[]).length;this.recordDroppedEvent("before_send","span",S)}throw new Ne(`${p} returned \`null\`, will not send event.`,"log")}const b=r&&r.getSession();if(!i&&b&&this._updateSessionFromEvent(b,y),i){const S=y.sdkProcessingMetadata&&y.sdkProcessingMetadata.spanCountBeforeProcessing||0,C=y.spans?y.spans.length:0,I=S-C;I>0&&this.recordDroppedEvent("before_send","span",I)}const E=y.transaction_info;if(i&&E&&y.transaction!==t.transaction){const S="custom";y.transaction_info={...E,source:S}}return this.sendEvent(y,n),y}).then(null,y=>{throw y instanceof Ne?y:(this.captureException(y,{data:{__sentry__:!0},originalException:y}),new Ne(`Event processing pipeline threw an error, original event will not be sent. Details have been sent as a new event.
Reason: ${y}`))})}_process(t){this._numProcessing++,t.then(n=>(this._numProcessing--,n),n=>(this._numProcessing--,n))}_sendEnvelope(t){if(this.emit("beforeEnvelope",t),this._isEnabled()&&this._transport)return this._transport.send(t).then(null,n=>{se&&W.error("Error while sending event:",n)});se&&W.error("Transport disabled")}_clearOutcomes(){const t=this._outcomes;return this._outcomes={},Object.keys(t).map(n=>{const[r,s]=n.split(":");return{reason:r,category:s,quantity:t[n]}})}}function zd(e,t){const n=`${t} must return \`null\` or a valid event.`;if(ui(e))return e.then(r=>{if(!Nn(r)&&r!==null)throw new Ne(n);return r},r=>{throw new Ne(`${t} rejected with ${r}`)});if(!Nn(e)&&e!==null)throw new Ne(n);return e}function Vd(e,t,n){const{beforeSend:r,beforeSendTransaction:s}=e;if(ya(t)&&r)return r(t,n);if(_a(t)&&s){if(t.spans){const a=t.spans.length;t.sdkProcessingMetadata={...t.sdkProcessingMetadata,spanCountBeforeProcessing:a}}return s(t,n)}return t}function ya(e){return e.type===void 0}function _a(e){return e.type==="transaction"}function Hd(e,t){t.debug===!0&&(se?W.enable():es(()=>{console.warn("[Sentry] Cannot initialize SDK with `debug` option using a non-debug bundle.")})),pi().update(t.initialScope);const n=new e(t);Kd(n),Yd(n)}function Kd(e){const t=ss().getStackTop();t.client=e,t.scope.setClient(e)}function Yd(e){e.init?e.init():e.setupIntegrations&&e.setupIntegrations()}const Xd=30;function wa(e,t,n=gd(e.bufferSize||Xd)){let r={};const s=i=>n.drain(i);function a(i){const o=[];if(da(i,(g,y)=>{const b=ua(y);if(Cd(r,b)){const E=ba(g,y);e.recordDroppedEvent("ratelimit_backoff",b,E)}else o.push(g)}),o.length===0)return ct();const d=mt(i[0],o),p=g=>{da(d,(y,b)=>{const E=ba(y,b);e.recordDroppedEvent(g,ua(b),E)})},h=()=>t({body:_d(d,e.textEncoder)}).then(g=>(g.statusCode!==void 0&&(g.statusCode<200||g.statusCode>=300)&&se&&W.warn(`Sentry responded with status code ${g.statusCode} to sent event.`),r=Dd(r,g),g),g=>{throw p("network_error"),g});return n.add(h).then(g=>g,g=>{if(g instanceof Ne)return se&&W.error("Skipped sending event because buffer is full."),p("queue_overflow"),ct();throw g})}return a.__sentry__baseTransport__=!0,{send:a,flush:s}}function ba(e,t){if(!(t!=="event"&&t!=="transaction"))return Array.isArray(e)?e[1]:void 0}function Jd(e,t,n=[t],r="npm"){const s=e._metadata||{};s.sdk||(s.sdk={name:`sentry.javascript.${t}`,packages:n.map(a=>({name:`${r}:@sentry/${a}`,version:cs})),version:cs}),e._metadata=s}const Qd=[/^Script error\.?$/,/^Javascript error: Script error\.? on line 0$/,/^ResizeObserver loop completed with undelivered notifications.$/,/^Cannot redefine property: googletag$/],Zd=[/^.*\/healthcheck$/,/^.*\/healthy$/,/^.*\/live$/,/^.*\/ready$/,/^.*\/heartbeat$/,/^.*\/health$/,/^.*\/healthz$/],va="InboundFilters",eu=(e={})=>({name:va,setupOnce(){},processEvent(t,n,r){const s=r.getOptions(),a=tu(e,s);return nu(t,a)?null:t}}),Sa=eu;He(va,Sa);function tu(e={},t={}){return{allowUrls:[...e.allowUrls||[],...t.allowUrls||[]],denyUrls:[...e.denyUrls||[],...t.denyUrls||[]],ignoreErrors:[...e.ignoreErrors||[],...t.ignoreErrors||[],...e.disableErrorDefaults?[]:Qd],ignoreTransactions:[...e.ignoreTransactions||[],...t.ignoreTransactions||[],...e.disableTransactionDefaults?[]:Zd],ignoreInternal:e.ignoreInternal!==void 0?e.ignoreInternal:!0}}function nu(e,t){return t.ignoreInternal&&cu(e)?(se&&W.warn(`Event dropped due to being internal Sentry Error.
Event: ${Ge(e)}`),!0):ru(e,t.ignoreErrors)?(se&&W.warn(`Event dropped due to being matched by \`ignoreErrors\` option.
Event: ${Ge(e)}`),!0):su(e,t.ignoreTransactions)?(se&&W.warn(`Event dropped due to being matched by \`ignoreTransactions\` option.
Event: ${Ge(e)}`),!0):au(e,t.denyUrls)?(se&&W.warn(`Event dropped due to being matched by \`denyUrls\` option.
Event: ${Ge(e)}.
Url: ${dn(e)}`),!0):ou(e,t.allowUrls)?!1:(se&&W.warn(`Event dropped due to not being matched by \`allowUrls\` option.
Event: ${Ge(e)}.
Url: ${dn(e)}`),!0)}function ru(e,t){return e.type||!t||!t.length?!1:iu(e).some(n=>Kt(n,t))}function su(e,t){if(e.type!=="transaction"||!t||!t.length)return!1;const n=e.transaction;return n?Kt(n,t):!1}function au(e,t){if(!t||!t.length)return!1;const n=dn(e);return n?Kt(n,t):!1}function ou(e,t){if(!t||!t.length)return!0;const n=dn(e);return n?Kt(n,t):!0}function iu(e){const t=[];e.message&&t.push(e.message);let n;try{n=e.exception.values[e.exception.values.length-1]}catch{}return n&&n.value&&(t.push(n.value),n.type&&t.push(`${n.type}: ${n.value}`)),se&&t.length===0&&W.error(`Could not extract message for event ${Ge(e)}`),t}function cu(e){try{return e.exception.values[0].type==="SentryError"}catch{}return!1}function lu(e=[]){for(let t=e.length-1;t>=0;t--){const n=e[t];if(n&&n.filename!=="<anonymous>"&&n.filename!=="[native code]")return n.filename||null}return null}function dn(e){try{let t;try{t=e.exception.values[0].stacktrace.frames}catch{}return t?lu(t):null}catch{return se&&W.error(`Cannot extract url for event ${Ge(e)}`),null}}let Ta;const Ea="FunctionToString",Ia=new WeakMap,du=()=>({name:Ea,setupOnce(){Ta=Function.prototype.toString;try{Function.prototype.toString=function(...e){const t=Mn(this),n=Ia.has(Ae())&&t!==void 0?t:this;return Ta.apply(n,e)}}catch{}},setup(e){Ia.set(e,!0)}}),ka=du;He(Ea,ka);const K=ye;let yr=0;function Ca(){return yr>0}function uu(){yr++,setTimeout(()=>{yr--})}function ft(e,t={},n){if(typeof e!="function")return e;try{const s=e.__sentry_wrapped__;if(s)return typeof s=="function"?s:e;if(Mn(e))return e}catch{return e}const r=function(){const s=Array.prototype.slice.call(arguments);try{n&&typeof n=="function"&&n.apply(this,arguments);const a=s.map(i=>ft(i,t));return e.apply(this,a)}catch(a){throw uu(),gi(i=>{i.addEventProcessor(o=>(t.mechanism&&(Un(o,void 0,void 0),Yt(o,t.mechanism)),o.extra={...o.extra,arguments:s},o)),X(a)}),a}};try{for(const s in e)Object.prototype.hasOwnProperty.call(e,s)&&(r[s]=e[s])}catch{}hi(r,e),On(e,"__sentry_wrapped__",r);try{Object.getOwnPropertyDescriptor(r,"name").configurable&&Object.defineProperty(r,"name",{get(){return e.name}})}catch{}return r}const We=typeof __SENTRY_DEBUG__>"u"||__SENTRY_DEBUG__;function Da(e,t){const n=wr(e,t),r={type:t&&t.name,value:mu(t)};return n.length&&(r.stacktrace={frames:n}),r.type===void 0&&r.value===""&&(r.value="Unrecoverable error caught"),r}function pu(e,t,n,r){const s=Ae(),a=s&&s.getOptions().normalizeDepth,i={exception:{values:[{type:$n(t)?t.constructor.name:r?"UnhandledRejection":"Error",value:_u(t,{isUnhandledRejection:r})}]},extra:{__serialized__:yi(t,a)}};if(n){const o=wr(e,n);o.length&&(i.exception.values[0].stacktrace={frames:o})}return i}function _r(e,t){return{exception:{values:[Da(e,t)]}}}function wr(e,t){const n=t.stacktrace||t.stack||"",r=gu(t);try{return e(n,r)}catch{}return[]}const hu=/Minified React error #\d+;/i;function gu(e){if(e){if(typeof e.framesToPop=="number")return e.framesToPop;if(hu.test(e.message))return 1}return 0}function mu(e){const t=e&&e.message;return t?t.error&&typeof t.error.message=="string"?t.error.message:t:"No error message"}function fu(e,t,n,r){const s=n&&n.syntheticException||void 0,a=br(e,t,s,r);return Yt(a),a.level="error",n&&n.event_id&&(a.event_id=n.event_id),ct(a)}function yu(e,t,n="info",r,s){const a=r&&r.syntheticException||void 0,i=vr(e,t,a,s);return i.level=n,r&&r.event_id&&(i.event_id=r.event_id),ct(i)}function br(e,t,n,r,s){let a;if(Fn(t)&&t.error)return _r(e,t.error);if(ls(t)||mi(t)){const i=t;if("stack"in t)a=_r(e,t);else{const o=i.name||(ls(i)?"DOMError":"DOMException"),d=i.message?`${o}: ${i.message}`:o;a=vr(e,d,n,r),Un(a,d)}return"code"in i&&(a.tags={...a.tags,"DOMException.code":`${i.code}`}),a}return fi(t)?_r(e,t):Nn(t)||$n(t)?(a=pu(e,t,n,s),Yt(a,{synthetic:!0}),a):(a=vr(e,t,n,r),Un(a,`${t}`,void 0),Yt(a,{synthetic:!0}),a)}function vr(e,t,n,r){const s={};if(r&&n){const a=wr(e,n);a.length&&(s.exception={values:[{value:t,stacktrace:{frames:a}}]})}if(is(t)){const{__sentry_template_string__:a,__sentry_template_values__:i}=t;return s.logentry={message:a,params:i},s}return s.message=t,s}function _u(e,{isUnhandledRejection:t}){const n=_i(e),r=t?"promise rejection":"exception";return Fn(e)?`Event \`ErrorEvent\` captured as ${r} with message \`${e.message}\``:$n(e)?`Event \`${wu(e)}\` (type=${e.type}) captured as ${r}`:`Object captured as ${r} with keys: ${n}`}function wu(e){try{const t=Object.getPrototypeOf(e);return t?t.constructor.name:void 0}catch{}}function bu(e,{metadata:t,tunnel:n,dsn:r}){const s={event_id:e.event_id,sent_at:new Date().toISOString(),...t&&t.sdk&&{sdk:{name:t.sdk.name,version:t.sdk.version}},...!!n&&!!r&&{dsn:Pt(r)}},a=vu(e);return mt(s,[a])}function vu(e){return[{type:"user_report"},e]}class Su extends Gd{constructor(t){const n=K.SENTRY_SDK_SOURCE||hd();Jd(t,"browser",["browser"],n),super(t),t.sendClientReports&&K.document&&K.document.addEventListener("visibilitychange",()=>{K.document.visibilityState==="hidden"&&this._flushOutcomes()})}eventFromException(t,n){return fu(this._options.stackParser,t,n,this._options.attachStacktrace)}eventFromMessage(t,n="info",r){return yu(this._options.stackParser,t,n,r,this._options.attachStacktrace)}captureUserFeedback(t){if(!this._isEnabled()){We&&W.warn("SDK not enabled, will not capture user feedback.");return}const n=bu(t,{metadata:this.getSdkMetadata(),dsn:this.getDsn(),tunnel:this.getOptions().tunnel});this._sendEnvelope(n)}_prepareEvent(t,n,r){return t.platform=t.platform||"javascript",super._prepareEvent(t,n,r)}_flushOutcomes(){const t=this._clearOutcomes();if(t.length===0){We&&W.log("No outcomes to send");return}if(!this._dsn){We&&W.log("No dsn provided, will not send outcomes");return}We&&W.log("Sending outcomes:",t);const n=Td(t,this._options.tunnel&&Pt(this._dsn));this._sendEnvelope(n)}}let Mt;function Tu(){if(Mt)return Mt;if(hr(K.fetch))return Mt=K.fetch.bind(K);const e=K.document;let t=K.fetch;if(e&&typeof e.createElement=="function")try{const n=e.createElement("iframe");n.hidden=!0,e.head.appendChild(n);const r=n.contentWindow;r&&r.fetch&&(t=r.fetch),e.head.removeChild(n)}catch(n){We&&W.warn("Could not create sandbox iframe for pure fetch check, bailing to window.fetch: ",n)}return Mt=t.bind(K)}function Eu(){Mt=void 0}function Iu(e,t=Tu()){let n=0,r=0;function s(a){const i=a.body.length;n+=i,r++;const o={body:a.body,method:"POST",referrerPolicy:"origin",headers:e.headers,keepalive:n<=6e4&&r<15,...e.fetchOptions};try{return t(e.url,o).then(d=>(n-=i,r--,{statusCode:d.status,headers:{"x-sentry-rate-limits":d.headers.get("X-Sentry-Rate-Limits"),"retry-after":d.headers.get("Retry-After")}}))}catch(d){return Eu(),n-=i,r--,xn(d)}}return wa(e,s)}const ku=4;function Cu(e){function t(n){return new Pn((r,s)=>{const a=new XMLHttpRequest;a.onerror=s,a.onreadystatechange=()=>{a.readyState===ku&&r({statusCode:a.status,headers:{"x-sentry-rate-limits":a.getResponseHeader("X-Sentry-Rate-Limits"),"retry-after":a.getResponseHeader("Retry-After")}})},a.open("POST",e.url);for(const i in e.headers)Object.prototype.hasOwnProperty.call(e.headers,i)&&a.setRequestHeader(i,e.headers[i]);a.send(n.body)})}return wa(e,t)}const un="?",Du=30,Au=40,Ru=50;function Sr(e,t,n,r){const s={filename:e,function:t,in_app:!0};return n!==void 0&&(s.lineno=n),r!==void 0&&(s.colno=r),s}const Ou=/^\s*at (?:(.+?\)(?: \[.+\])?|.*?) ?\((?:address at )?)?(?:async )?((?:<anonymous>|[-a-z]+:|.*bundle|\/)?.*?)(?::(\d+))?(?::(\d+))?\)?\s*$/i,xu=/\((\S*)(?::(\d+))(?::(\d+))\)/,Pu=e=>{const t=Ou.exec(e);if(t){if(t[2]&&t[2].indexOf("eval")===0){const s=xu.exec(t[2]);s&&(t[2]=s[1],t[3]=s[2],t[4]=s[3])}const[n,r]=Aa(t[1]||un,t[2]);return Sr(r,n,t[3]?+t[3]:void 0,t[4]?+t[4]:void 0)}},Lu=[Du,Pu],Nu=/^\s*(.*?)(?:\((.*?)\))?(?:^|@)?((?:[-a-z]+)?:\/.*?|\[native code\]|[^@]*(?:bundle|\d+\.js)|\/[\w\-. /=]+)(?::(\d+))?(?::(\d+))?\s*$/i,Mu=/(\S+) line (\d+)(?: > eval line \d+)* > eval/i,Uu=e=>{const t=Nu.exec(e);if(t){if(t[3]&&t[3].indexOf(" > eval")>-1){const s=Mu.exec(t[3]);s&&(t[1]=t[1]||"eval",t[3]=s[1],t[4]=s[2],t[5]="")}let n=t[3],r=t[1]||un;return[r,n]=Aa(r,n),Sr(n,r,t[4]?+t[4]:void 0,t[5]?+t[5]:void 0)}},Fu=[Ru,Uu],$u=/^\s*at (?:((?:\[object object\])?.+) )?\(?((?:[-a-z]+):.*?):(\d+)(?::(\d+))?\)?\s*$/i,ju=e=>{const t=$u.exec(e);return t?Sr(t[2],t[1]||un,+t[3],t[4]?+t[4]:void 0):void 0},qu=[Au,ju],Wu=[Lu,Fu,qu],Bu=wi(...Wu),Aa=(e,t)=>{const n=e.indexOf("safari-extension")!==-1,r=e.indexOf("safari-web-extension")!==-1;return n||r?[e.indexOf("@")!==-1?e.split("@")[0]:un,n?`safari-extension:${t}`:`safari-web-extension:${t}`]:[e,t]},pn=1024,Ra="Breadcrumbs",Gu=(e={})=>{const t={console:!0,dom:!0,fetch:!0,history:!0,sentry:!0,xhr:!0,...e};return{name:Ra,setupOnce(){},setup(n){t.console&&zl(Hu(n)),t.dom&&Kl(Vu(n,t.dom)),t.xhr&&dd(Ku(n)),t.fetch&&ed(Yu(n)),t.history&&la(Xu(n)),t.sentry&&n.on&&n.on("beforeSendEvent",zu(n))}}},Oa=Gu;He(Ra,Oa);function zu(e){return function(t){Ae()===e&&oe({category:`sentry.${t.type==="transaction"?"transaction":"event"}`,event_id:t.event_id,level:t.level,message:Ge(t)},{event:t})}}function Vu(e,t){return function(n){if(Ae()!==e)return;let r,s,a=typeof t=="object"?t.serializeAttribute:void 0,i=typeof t=="object"&&typeof t.maxStringLength=="number"?t.maxStringLength:void 0;i&&i>pn&&(We&&W.warn(`\`dom.maxStringLength\` cannot exceed ${pn}, but a value of ${i} was configured. Sentry will use ${pn} instead.`),i=pn),typeof a=="string"&&(a=[a]);try{const d=n.event,p=Ju(d)?d.target:d;r=bi(p,{keyAttrs:a,maxStringLength:i}),s=vi(p)}catch{r="<unknown>"}if(r.length===0)return;const o={category:`ui.${n.name}`,message:r};s&&(o.data={"ui.component_name":s}),oe(o,{event:n.event,name:n.name,global:n.global})}}function Hu(e){return function(t){if(Ae()!==e)return;const n={category:"console",data:{arguments:t.args,logger:"console"},level:fd(t.level),message:ds(t.args," ")};if(t.level==="assert")if(t.args[0]===!1)n.message=`Assertion failed: ${ds(t.args.slice(1)," ")||"console.assert"}`,n.data.arguments=t.args.slice(1);else return;oe(n,{input:t.args,level:t.level})}}function Ku(e){return function(t){if(Ae()!==e)return;const{startTimestamp:n,endTimestamp:r}=t,s=t.xhr[Nt];if(!n||!r||!s)return;const{method:a,url:i,status_code:o,body:d}=s,p={method:a,url:i,status_code:o},h={xhr:t.xhr,input:d,startTimestamp:n,endTimestamp:r};oe({category:"xhr",data:p,type:"http"},h)}}function Yu(e){return function(t){if(Ae()!==e)return;const{startTimestamp:n,endTimestamp:r}=t;if(r&&!(t.fetchData.url.match(/sentry_key/)&&t.fetchData.method==="POST"))if(t.error){const s=t.fetchData,a={data:t.error,input:t.args,startTimestamp:n,endTimestamp:r};oe({category:"fetch",data:s,level:"error",type:"http"},a)}else{const s=t.response,a={...t.fetchData,status_code:s&&s.status},i={input:t.args,response:s,startTimestamp:n,endTimestamp:r};oe({category:"fetch",data:a,type:"http"},i)}}}function Xu(e){return function(t){if(Ae()!==e)return;let n=t.from,r=t.to;const s=mr(K.location.href);let a=n?mr(n):void 0;const i=mr(r);(!a||!a.path)&&(a=s),s.protocol===i.protocol&&s.host===i.host&&(r=i.relative),s.protocol===a.protocol&&s.host===a.host&&(n=a.relative),oe({category:"navigation",data:{from:n,to:r}})}}function Ju(e){return!!e&&!!e.target}const xa="Dedupe",Qu=()=>{let e;return{name:xa,setupOnce(){},processEvent(t){if(t.type)return t;try{if(Zu(t,e))return We&&W.warn("Event dropped due to being a duplicate of previously captured event."),null}catch{}return e=t}}},Pa=Qu;He(xa,Pa);function Zu(e,t){return t?!!(ep(e,t)||tp(e,t)):!1}function ep(e,t){const n=e.message,r=t.message;return!(!n&&!r||n&&!r||!n&&r||n!==r||!Na(e,t)||!La(e,t))}function tp(e,t){const n=Ma(t),r=Ma(e);return!(!n||!r||n.type!==r.type||n.value!==r.value||!Na(e,t)||!La(e,t))}function La(e,t){let n=Ua(e),r=Ua(t);if(!n&&!r)return!0;if(n&&!r||!n&&r||(n=n,r=r,r.length!==n.length))return!1;for(let s=0;s<r.length;s++){const a=r[s],i=n[s];if(a.filename!==i.filename||a.lineno!==i.lineno||a.colno!==i.colno||a.function!==i.function)return!1}return!0}function Na(e,t){let n=e.fingerprint,r=t.fingerprint;if(!n&&!r)return!0;if(n&&!r||!n&&r)return!1;n=n,r=r;try{return n.join("")===r.join("")}catch{return!1}}function Ma(e){return e.exception&&e.exception.values&&e.exception.values[0]}function Ua(e){const t=e.exception;if(t)try{return t.values[0].stacktrace.frames}catch{return}}const Fa="GlobalHandlers",np=(e={})=>{const t={onerror:!0,onunhandledrejection:!0,...e};return{name:Fa,setupOnce(){Error.stackTraceLimit=50},setup(n){t.onerror&&(rp(n),qa("onerror")),t.onunhandledrejection&&(sp(n),qa("onunhandledrejection"))}}},$a=np;He(Fa,$a);function rp(e){rd(t=>{const{stackParser:n,attachStacktrace:r}=Wa();if(Ae()!==e||Ca())return;const{msg:s,url:a,line:i,column:o,error:d}=t,p=d===void 0&&it(s)?ip(s,a,i,o):ja(br(n,d||s,void 0,r,!1),a,i,o);p.level="error",us(p,{originalException:d,mechanism:{handled:!1,type:"onerror"}})})}function sp(e){ad(t=>{const{stackParser:n,attachStacktrace:r}=Wa();if(Ae()!==e||Ca())return;const s=ap(t),a=Ln(s)?op(s):br(n,s,void 0,r,!0);a.level="error",us(a,{originalException:s,mechanism:{handled:!1,type:"onunhandledrejection"}})})}function ap(e){if(Ln(e))return e;const t=e;try{if("reason"in t)return t.reason;if("detail"in t&&"reason"in t.detail)return t.detail.reason}catch{}return e}function op(e){return{exception:{values:[{type:"UnhandledRejection",value:`Non-Error promise rejection captured with value: ${String(e)}`}]}}}function ip(e,t,n,r){const s=/^(?:[Uu]ncaught (?:exception: )?)?(?:((?:Eval|Internal|Range|Reference|Syntax|Type|URI|)Error): )?(.*)$/i;let a=Fn(e)?e.message:e,i="Error";const o=a.match(s);return o&&(i=o[1],a=o[2]),ja({exception:{values:[{type:i,value:a}]}},t,n,r)}function ja(e,t,n,r){const s=e.exception=e.exception||{},a=s.values=s.values||[],i=a[0]=a[0]||{},o=i.stacktrace=i.stacktrace||{},d=o.frames=o.frames||[],p=isNaN(parseInt(r,10))?void 0:r,h=isNaN(parseInt(n,10))?void 0:n,g=it(t)&&t.length>0?t:Si();return d.length===0&&d.push({colno:p,filename:g,function:"?",in_app:!0,lineno:h}),e}function qa(e){We&&W.log(`Global Handler attached: ${e}`)}function Wa(){const e=Ae();return e&&e.getOptions()||{stackParser:()=>[],attachStacktrace:!1}}const Ba="HttpContext",cp=()=>({name:Ba,setupOnce(){},preprocessEvent(e){if(!K.navigator&&!K.location&&!K.document)return;const t=e.request&&e.request.url||K.location&&K.location.href,{referrer:n}=K.document||{},{userAgent:r}=K.navigator||{},s={...e.request&&e.request.headers,...n&&{Referer:n},...r&&{"User-Agent":r}},a={...e.request,...t&&{url:t},headers:s};e.request=a}}),Ga=cp;He(Ba,Ga);const lp="cause",dp=5,za="LinkedErrors",up=(e={})=>{const t=e.limit||dp,n=e.key||lp;return{name:za,setupOnce(){},preprocessEvent(r,s,a){const i=a.getOptions();Fl(Da,i.stackParser,i.maxValueLength,n,t,r,s)}}},Va=up;He(za,Va);const pp=["EventTarget","Window","Node","ApplicationCache","AudioTrackList","BroadcastChannel","ChannelMergerNode","CryptoOperation","EventSource","FileReader","HTMLUnknownElement","IDBDatabase","IDBRequest","IDBTransaction","KeyOperation","MediaController","MessagePort","ModalWindow","Notification","SVGElementInstance","Screen","SharedWorker","TextTrack","TextTrackCue","TextTrackList","WebSocket","WebSocketWorker","Worker","XMLHttpRequest","XMLHttpRequestEventTarget","XMLHttpRequestUpload"],Ha="TryCatch",hp=(e={})=>{const t={XMLHttpRequest:!0,eventTarget:!0,requestAnimationFrame:!0,setInterval:!0,setTimeout:!0,...e};return{name:Ha,setupOnce(){t.setTimeout&&fe(K,"setTimeout",Ya),t.setInterval&&fe(K,"setInterval",Ya),t.requestAnimationFrame&&fe(K,"requestAnimationFrame",gp),t.XMLHttpRequest&&"XMLHttpRequest"in K&&fe(XMLHttpRequest.prototype,"send",mp);const n=t.eventTarget;n&&(Array.isArray(n)?n:pp).forEach(fp)}}},Ka=hp;He(Ha,Ka);function Ya(e){return function(...t){const n=t[0];return t[0]=ft(n,{mechanism:{data:{function:Ze(e)},handled:!1,type:"instrument"}}),e.apply(this,t)}}function gp(e){return function(t){return e.apply(this,[ft(t,{mechanism:{data:{function:"requestAnimationFrame",handler:Ze(e)},handled:!1,type:"instrument"}})])}}function mp(e){return function(...t){const n=this;return["onload","onerror","onprogress","onreadystatechange"].forEach(r=>{r in n&&typeof n[r]=="function"&&fe(n,r,function(s){const a={mechanism:{data:{function:r,handler:Ze(s)},handled:!1,type:"instrument"}},i=Mn(s);return i&&(a.mechanism.data.handler=Ze(i)),ft(s,a)})}),e.apply(this,t)}}function fp(e){const t=K,n=t[e]&&t[e].prototype;!n||!n.hasOwnProperty||!n.hasOwnProperty("addEventListener")||(fe(n,"addEventListener",function(r){return function(s,a,i){try{typeof a.handleEvent=="function"&&(a.handleEvent=ft(a.handleEvent,{mechanism:{data:{function:"handleEvent",handler:Ze(a),target:e},handled:!1,type:"instrument"}}))}catch{}return r.apply(this,[s,ft(a,{mechanism:{data:{function:"addEventListener",handler:Ze(a),target:e},handled:!1,type:"instrument"}}),i])}}),fe(n,"removeEventListener",function(r){return function(s,a,i){const o=a;try{const d=o&&o.__sentry_wrapped__;d&&r.call(this,s,d,i)}catch{}return r.call(this,s,o,i)}}))}const yp=[Sa(),ka(),Ka(),Oa(),$a(),Va(),Pa(),Ga()];function _p(e){return[...yp]}function wp(e={}){e.defaultIntegrations===void 0&&(e.defaultIntegrations=_p()),e.release===void 0&&(typeof __SENTRY_RELEASE__=="string"&&(e.release=__SENTRY_RELEASE__),K.SENTRY_RELEASE&&K.SENTRY_RELEASE.id&&(e.release=K.SENTRY_RELEASE.id)),e.autoSessionTracking===void 0&&(e.autoSessionTracking=!0),e.sendClientReports===void 0&&(e.sendClientReports=!0);const t={...e,stackParser:Ti(e.stackParser||Bu),integrations:Fd(e),transport:e.transport||(ia()?Iu:Cu)};Hd(Su,t),e.autoSessionTracking&&bp()}function bp(){if(typeof K.document>"u"){We&&W.warn("Session tracking in non-browser environment with @sentry/browser is not supported.");return}ps({ignoreDuration:!0}),hs(),la(({from:e,to:t})=>{e!==void 0&&e!==t&&(ps({ignoreDuration:!0}),hs())})}const vp=J("preFlightChecks/setNetworkError"),Tr=J("preFlightChecks/setS3ConnectionError"),Er=J("preFlightChecks/setAssemblyAIConnectionError"),Xa=J("preFlightChecks/setBackendConnectionError"),Ut=J("preFlightChecks/setIsRecordingStartedFromBrowser"),Sp=async({tabId:e,windowId:t})=>{const n=await chrome.tabs.get(e),r=await chrome.windows.get(t),{networkError:s,s3ConnectionError:a,backendConnectionError:i,isRecordingStartedFromBrowser:o}=It(l.getState()),d=(await chrome.tabs.query({})).length;l.dispatch(Vs(d));const{lastUsableContentWindowId:p}=we(l.getState()),h=r.type==="normal"||r.type==="popup";r.focused&&h&&p!==t&&r.id&&l.dispatch(gs(r.id)),n.id&&r.focused&&(l.dispatch(ms(n.id)),o&&(s||a||i)&&(l.dispatch(ze(!0)),l.dispatch(Ut(!1)))),ue(n,{messageType:"browserContextNeeded",browserContext:{tab:n,window:r}})},Ir=async()=>{const{lastUsableContentWindowId:e}=we(l.getState()),{currentFocusedActiveTabId:t}=we(l.getState()),n=await chrome.tabs.query({active:!0}),r=(await chrome.tabs.query({})).length;l.dispatch(Vs(r)),n.forEach(s=>{chrome.windows.get(s.windowId).then(a=>{s.id!==void 0&&(t===s.id&&e===a.id||(a.focused&&(a.type==="normal"||a.type==="popup")&&a.id&&l.dispatch(gs(a.id)),a.focused&&s.active&&l.dispatch(ms(s.id)),ue(s,{messageType:"browserContextChanged",tab:s,window:a})))})})};chrome.tabs.onActivated.addListener(Sp),chrome.windows.onCreated.addListener(Ir),chrome.windows.onFocusChanged.addListener(Ir),chrome.runtime.onInstalled.addListener(Ir);const Tp={}.NODE_ENV!=="production",Ja={}.NODE_ENV==="production",Ep={}.VITE_E2E==="true";wp({debug:Tp,dsn:"https://7f832b1e318847f49f65d4d716db714a@o385127.ingest.sentry.io/6071844",environment:Ja?"production":"development",enabled:Ja&&!Ep,includeLocalVariables:!0,ignoreErrors:["Could not establish connection. Receiving end does not exist.","The message port closed before a response was received.","No host permissions for cookies at url","ResizeObserver loop limit exceeded","No tab with id"],beforeSend:function(e,t){const n=t.originalException;return n instanceof Ii&&(e.fingerprint=["extension-api-screenshot-error"]),n instanceof ki&&(e.fingerprint=["backup-screenshot-error"]),e}}),Ei("version",chrome.runtime.getManifest().version.toString());const Ip=e=>{try{return new URL(e),!0}catch{return!1}},kp=(e,t)=>{if(!(t!==null&&t!==""&&t!==void 0&&Ip(t)))return!1;const{baseDomain:n,pathSegments:r}=Qa(e),{baseDomain:s,pathSegments:a}=Qa(t),i=v=>v.replace(/^[a-zA-Z][a-zA-Z0-9+.-]*:\/\//,""),o=v=>i(v).replace(/:\d+$/,"").toLowerCase(),d=o(n),p=o(s);if(d!==p)return!1;const h=v=>v.split("#")[0].split("?")[0],g=r.map(h).filter(v=>v!=="").length,y=a.map(h).filter(v=>v!=="").length;if(g!==y)return!1;const b=r.map(h).filter(v=>v!==""),E=a.map(h).filter(v=>v!=="");for(let v=0;v<b.length;v+=1){const k=b[v],A=E[v];if(!(A===k||A==="*"))return!1}const S=v=>{const k=v.indexOf("#"),A=v.indexOf("?");return A!==-1&&(k===-1||A<k)?v.slice(A,k===-1?void 0:k):""},C=S(e),I=S(t);if(C!==I)return!1;const D=e.includes("#"),P=t.includes("#");return!(!D&&P)},Qa=e=>{const t=e.match(/^[a-zA-Z][a-zA-Z0-9+.-]*:\/\//);if(t){const a=e.slice(t[0].length).split("/").filter(d=>d!==""),i=t[0]+a[0],o=a.slice(1);return{baseDomain:i,pathSegments:o}}const n=e.split("/").filter(a=>a!==""),r=n[0]||"",s=n.slice(1);return{baseDomain:r,pathSegments:s}},kr=(e,t)=>{let n=e.getState();const r=()=>{const a=e.getState();a!==n&&(t(n,a),n=a)},s=e.subscribe(r);return r(),s},Za=e=>{ue(e,{messageType:"replaceStore",store:l.getState()})},Cp=()=>{chrome.runtime.sendMessage({messageType:"replaceStore",store:l.getState()})},Dp=()=>{chrome.tabs.query({active:!0}).then(e=>{e.forEach(t=>{Za(t)})}),Cp()},Ap=async()=>{kr(l,Dp),chrome.tabs.onActivated.addListener(e=>Za(e))};Ap();const _e=128,ke=128,Rp=new OffscreenCanvas(_e,ke),Me={iconContext:Rp.getContext("2d",{willReadFrequently:!0}),recordingInterval:null,loadingInterval:null,startingTime:new Date,redOn:!0},Op=_e/6,xp=_e/2-2,Pp="#3730a3",Lp="#f87171",Np="#1f2937",Mp="#9ca3af",Ft=2500,Up=60,Fp=e=>{const t=_e/2-1,n=ke-2,r=e.createLinearGradient(0,0,0,_e);r.addColorStop(0,"#3730a3"),r.addColorStop(1,"#4f46e5");const s=e.createLinearGradient(0,0,0,_e);s.addColorStop(0,"#818cf8"),s.addColorStop(1,"#4f46e5");const a=2;e.lineWidth=16,e.save(),e.translate(_e/2,ke/2),e.rotate(Math.PI*2*(new Date().getTime()%Ft/Ft)),e.translate(-_e/2+4,-ke/2+4),e.beginPath(),e.rect(-a,-a,t+a,n+a*2),e.clip(),e.strokeStyle=r,e.beginPath(),e.arc(t-6,t-6,t-6,0,Math.PI*2,!1),e.stroke(),e.restore(),e.save(),e.translate(_e/2,ke/2),e.rotate(Math.PI*2*(new Date().getTime()%Ft/Ft)),e.translate(-_e/2+4,-ke/2+4),e.beginPath(),e.rect(t,-a,t+a,n+a*2),e.clip(),e.strokeStyle=s,e.beginPath(),e.arc(t-6,t-6,t-6,0,Math.PI*2,!1),e.stroke(),e.restore()},$p=(e,t)=>{e.beginPath(),e.arc(_e/2,ke/2,xp,0,2*Math.PI,!1),e.fillStyle=t,e.strokeStyle=t,e.fill(),e.lineWidth=2,e.stroke()},eo=(e,t,n,r,s=Op)=>(e.save(),e.fillStyle=n,e.strokeStyle=n,$p(e,t),e.beginPath(),e.arc(_e/2,ke/2,s,0,2*Math.PI,!1),e.fillStyle=r?n:t,e.strokeStyle=r?n:t,e.fill(),e.lineWidth=2,e.stroke(),e.restore(),e.getImageData(0,0,_e,ke)),jp=e=>(e.save(),e.clearRect(0,0,_e,ke),Fp(e),e.restore(),e.getImageData(0,0,_e,ke)),qp=()=>{Me.recordingInterval=setInterval(()=>{const e=new Date().getTime()%1500;chrome.action.setIcon({imageData:eo(Me.iconContext,Pp,Lp,e<=1e3)})},500)},Wp=()=>{Me.loadingInterval=setInterval(()=>{chrome.action.setIcon({imageData:jp(Me.iconContext)})},Ft/Up)},Bp=()=>{chrome.action.setIcon({imageData:eo(Me.iconContext,Np,Mp,!0)})},to=()=>{const e="production";chrome.management.getSelf(t=>{["development","sideload"].includes(t.installType)?chrome.action.setIcon({path:{16:chrome.runtime.getURL("logo-16-preview.png"),48:chrome.runtime.getURL("logo-48-preview.png"),128:chrome.runtime.getURL("logo-128-preview.png")}}):chrome.action.setIcon({path:{16:chrome.runtime.getURL(`public/logo-16-${e}.png`),48:chrome.runtime.getURL(`public/logo-48-${e}.png`),128:chrome.runtime.getURL(`public/logo-128-${e}.png`)}})})},Gp=()=>{clearInterval(Me.loadingInterval),clearInterval(Me.recordingInterval),Me.loadingInterval=null,Me.recordingInterval=null},zp=e=>{if(Gp(),Me.iconContext.clearRect(0,0,_e,ke),!kt(l.getState()))switch(e){case ge.RECORDING:case ge.STARTING_RECORDING:qp();break;case ge.PAUSED_RECORDING:Bp();break;case ge.ENDING_RECORDING:Wp();break;case ge.IDLE:default:to();break}},Vp=(e,t)=>{const n=we(e).status,r=we(t).status;n!==r&&zp(r)};kr(l,Vp);const Hp=J("globalVariables/setLastSentNotification"),no=J("globalVariables/setDomains"),Kp=J("globalVariables/setLastFetched"),ro=J("globalVariables/setCurrentRecommendedScribeCount"),Yp=J("globalVariables/setDefaultName"),Xp=J("globalVariables/setOs"),Jp=J("globalVariables/updateLinkMap"),Qp=J("globalVariables/setIpAddress"),Zp=J("globalVariables/setBenchmark"),eh=J("permissions/setMissingPermissions"),yt=J("pins/setPinDropping"),Ke=J("pins/setPins"),so=J("pins/setViewedPins"),ao=J("pins/setHoveredPinId"),hn=J("pins/setPinDocument"),th=J("pins/setPinShiftClickThrough"),gn=J("pins/setPinsLoading"),nh=J("pins/setHiddenPinsUrlList"),mn="https://api.assemblyai.com";async function oo(e,t={}){try{const n=await fetch(e,{cache:"no-cache",headers:t});if(n.ok)return F("server_reachable",{url:e}),n;throw F("server_unreachable",{url:e,status:n.status}),new Error(`Server is not reachable. Status: ${n.status}`)}catch(n){throw console.error("Error:",n),F("server_error",{url:e,error:n.message}),n}}async function rh(){return oo("https://scribe-api.scribehow.com/health_check/",{"X-Product":"extension","X-Product-Version":Ci.version}).then(()=>{l.dispatch(Xa(!1))}).catch(e=>{throw l.dispatch(Xa(!0)),e})}async function sh(){try{const e=await fetch(mn,{cache:"no-cache"});if(e.status===404||e.status<400)return F("server_reachable",{url:mn}),l.dispatch(Er(!1)),!0;throw F("assemblyai_unreachable",{url:mn,status:e.status}),l.dispatch(Er(!0)),new Error(`AssemblyAI returned unexpected status: ${e.status}`)}catch(e){throw l.dispatch(Er(!0)),console.error("AssemblyAI connection error:",e),F("assemblyai_unreachable",{url:mn,error:e.message}),e}}async function ah(){try{await oo("https://colony-recorder.s3-accelerate.amazonaws.com/connection-check.txt")}catch(t){throw l.dispatch(Tr(!0)),t}const e="https://colony-labs-public.s3.us-east-2.amazonaws.com/test.json";try{const t=await fetch(e,{method:"HEAD"});if(!t.ok)throw new Error(`S3 bucket returned unexpected status: ${t.status}`);l.dispatch(Tr(!1)),F("s3_put_reachable",{url:e})}catch(t){throw console.error("Error:",t),X(t),F("s3_put_unreachable",{url:e,error:t.message}),l.dispatch(Tr(!0)),t}}async function _t(){return l.dispatch(vp(!1)),Promise.all([rh(),ah(),sh()]).then(()=>!0).catch(e=>(F("no_internet_connection"),!1))}class io{constructor(t){Be(this,"delay");Be(this,"timeout",null);Be(this,"queue",[]);this.delay=t}invoke(t){this.queue.push(t),this.timeout===null?(this.callLatest(),this.timeout=setTimeout(()=>{this.callLatest(),this.timeout=null},this.delay)):this.queue.push(t)}callLatest(){var t;(t=this.queue.pop())==null||t(),this.queue=[]}}const Cr="cortexDailySession";function oh(e=new Date){const t=e.getFullYear(),n=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getDate()).padStart(2,"0");return`${t}-${n}-${r}`}async function ih(){var e;try{const t=(e=await chrome.storage.local.get(Cr))==null?void 0:e[Cr];if(t&&typeof t=="object"){const n=t;if(typeof n.id=="string"&&typeof n.date=="string")return{id:n.id,date:n.date}}}catch{}return null}async function ch(e){try{await chrome.storage.local.set({[Cr]:e})}catch{}}async function lh(){const e=oh(),t=await ih();if(t&&t.date===e&&t.id)return t.id;const n=qe();return await ch({id:n,date:e}),n}function dh(){return qe()}async function uh(){const e=await lh(),t=dh();return{"X-Session-ID":e,"X-Request-ID":t}}const ne="X-Session-ID",re="X-Request-ID",ph="ExtensionPreferences",hh=1,wt="settings";let fn=null;function co(){return fn?Promise.resolve(fn):new Promise((e,t)=>{const n=indexedDB.open(ph,hh);n.onupgradeneeded=()=>{const r=n.result;r.objectStoreNames.contains(wt)||r.createObjectStore(wt,{keyPath:"key"})},n.onsuccess=()=>{fn=n.result,e(fn)},n.onerror=()=>t(n.error)})}const lo="dwActionLoggingEnabled";async function uo(){const e=await co();return new Promise(t=>{const n=e.transaction(wt,"readonly").objectStore(wt).get(lo);n.onsuccess=()=>{var s;const r=(s=n.result)==null?void 0:s.value;t(!!r)},n.onerror=()=>t(!1)})}async function gh(e){const t=await co();return new Promise((n,r)=>{const s=t.transaction(wt,"readwrite").objectStore(wt).put({key:lo,value:!!e});s.onsuccess=()=>n(),s.onerror=()=>r(s.error)})}var Dr={exports:{}};(function(e,t){(function(n,r){r(t)})(rn,function(n){var r={getItemSync:function(_){try{return localStorage.getItem(_)||null}catch{return null}},getItem:function(_,m){var c=this;return new Promise(function(f,w){try{var O=c.getItemSync(_);m==null||m(null,O),f(O)}catch(M){m&&m(M,null),w(M)}})},setItem:function(_,m,c){return new Promise(function(f,w){try{localStorage.setItem(_,m),c&&c(null,m),f(m)}catch(O){c&&c(O,null),w(O)}})}},s=function(){return s=Object.assign||function(_){for(var m,c=1,f=arguments.length;c<f;c++)for(var w in m=arguments[c])Object.prototype.hasOwnProperty.call(m,w)&&(_[w]=m[w]);return _},s.apply(this,arguments)};function a(_,m,c){if(c||arguments.length===2)for(var f,w=0,O=m.length;w<O;w++)!f&&w in m||(f||(f=Array.prototype.slice.call(m,0,w)),f[w]=m[w]);return _.concat(f||Array.prototype.slice.call(m))}var i,o,d=function _(m,c){if(m===c)return!0;if(m&&c&&typeof m=="object"&&typeof c=="object"){if(m.constructor!==c.constructor)return!1;var f,w,O;if(Array.isArray(m)){if((f=m.length)!=c.length)return!1;for(w=f;w--!=0;)if(!_(m[w],c[w]))return!1;return!0}if(m.constructor===RegExp)return m.source===c.source&&m.flags===c.flags;if(m.valueOf!==Object.prototype.valueOf)return m.valueOf()===c.valueOf();if(m.toString!==Object.prototype.toString)return m.toString()===c.toString();if((f=(O=Object.keys(m)).length)!==Object.keys(c).length)return!1;for(w=f;w--!=0;)if(!Object.prototype.hasOwnProperty.call(c,O[w]))return!1;for(w=f;w--!=0;){var M=O[w];if(!_(m[M],c[M]))return!1}return!0}return m!=m&&c!=c};(function(_){_.NONE="NONE",_.DEFAULT_FLAGS="DEFAULT_FLAGS",_.CACHE="CACHE",_.SERVER="SERVER"})(i||(i={}));var p,h=null,g="BULLET_TRAIN_DB",y="BULLET_TRAIN_EVENT",b="https://edge.api.flagsmith.com/api/v1/",E=function(_){return"Attempted to "+_+" a user before calling flagsmith.init. Call flagsmith.init first, if you wish to prevent it sending a request for flags, call init with preventFetch:true."},S="flagsmith_value_",C="flagsmith_enabled_",I="flagsmith_trait_",D=function(){function _(m){var c=this;this._trigger=null,this._triggerLoadingState=null,this.timestamp=null,this.isLoading=!1,this.eventSource=null,this.getJSON=function(f,w,O){var M=c,j=M.environmentID,B=M.headers,ae={method:w||"GET",body:O,cache:"no-cache",headers:{"x-environment-key":"".concat(j)}};w&&w!=="GET"&&(ae.headers["Content-Type"]="application/json; charset=utf-8"),B&&Object.assign(ae.headers,B),o||console.error("Flagsmith: fetch is undefined, please specify a fetch implementation into flagsmith.init to support SSR.");var ie="".concat(c.identity);return o(f,ae).then(function($){var pe,L="".concat(c.identity);if(ie===L){var me=(pe=$.headers)===null||pe===void 0?void 0:pe.get("x-flagsmith-document-updated-at");if(me)try{var Te=parseFloat(me);if(isNaN(Te))throw"Failed to parse x-flagsmith-document-updated-at";c.timestamp=Te}catch(Se){c.log(Se,"Failed to parse x-flagsmith-document-updated-at",me)}return c.log("Fetch response: "+$.status+" "+(w||"GET")+0+f),$.text().then(function(Se){var U=Se;try{U=JSON.parse(Se)}catch{}return $.status&&$.status>=200&&$.status<300?U:Promise.reject(U)})}c.log("Received response with identity miss-match, ignoring response. Requested: ".concat(ie,", Current: ").concat(L))}).catch(function($){throw console.error("Flagsmith: Fetch error: "+$),new Error("Flagsmith: Fetch error:"+$)})},this._onChange=function(f,w,O){c.setLoadingState(O),c.onChange&&c.onChange(f,w,c.loadingState),c._trigger&&(c.log("trigger called"),c._trigger())},this.getFlags=function(f,w){var O=c;O.onChange;var M=O.onError,j=O.identity,B=O.api,ae=!1;c.log("Get Flags"),c.isLoading=!0,c.loadingState.isFetching||c.setLoadingState(s(s({},c.loadingState),{isFetching:!0}));var ie=function($){var pe=$.flags,L=$.traits;c.isLoading=!1,j&&(c.withTraits=null);var me={},Te={};L=L||[],(pe=pe||[]).forEach(function(H){me[H.feature.name.toLowerCase().replace(/ /g,"_")]={id:H.feature.id,enabled:H.enabled,value:H.feature_state_value}}),L.forEach(function(H){Te[H.trait_key.toLowerCase().replace(/ /g,"_")]=H.trait_value}),c.oldFlags=s({},c.flags);var Se=d(c.flags,me),U=d(c.traits,Te);if(c.flags=me,c.traits=Te,c.updateStorage(),c.datadogRum)try{if(c.datadogRum.trackTraits){var xe={};Object.keys(c.traits).map(function(H){xe[I+H]=c.getTrait(H)});var Fe=s(s(s({},c.datadogRum.client.getUser()),{id:c.datadogRum.client.getUser().id||c.identity}),xe);c.log("Setting Datadog user",Fe),c.datadogRum.client.setUser(Fe)}}catch(H){console.error(H)}if(c.dtrum)try{var de={javaDouble:{},date:{},shortString:{},javaLongOrObject:{}};Object.keys(c.flags).map(function(H){k(de,S+H,c.getValue(H,{},!0)),k(de,C+H,c.hasFeature(H,!0))}),Object.keys(c.traits).map(function(H){k(de,I+H,c.getTrait(H))}),c.log("Sending javaLongOrObject traits to dynatrace",de.javaLongOrObject),c.log("Sending date traits to dynatrace",de.date),c.log("Sending shortString traits to dynatrace",de.shortString),c.log("Sending javaDouble to dynatrace",de.javaDouble),c.dtrum.sendSessionProperties(de.javaLongOrObject,de.date,de.shortString,de.javaDouble)}catch(H){console.error(H)}c._onChange(c.oldFlags,{isFromServer:!0,flagsChanged:!Se,traitsChanged:!U},c._loadedState(null,i.SERVER))};return j?Promise.all([c.withTraits?c.getJSON(B+"identities/","POST",JSON.stringify({identifier:j,traits:Object.keys(c.withTraits).map(function($){return{trait_key:$,trait_value:c.withTraits[$]}}).filter(function($){return $.trait_value!==void 0||(c.log("Warning - attempted to set an undefined trait value for key",$.trait_key),!1)})})):c.getJSON(B+"identities/?identifier="+encodeURIComponent(j))]).then(function($){c.withTraits=null,ie($[0]),f&&!ae&&(ae=!0,f())}).catch(function($){var pe=$.message;M&&M(new Error(pe))}):Promise.all([c.getJSON(B+"flags/")]).then(function($){ie({flags:$[0],traits:void 0}),f&&!ae&&(ae=!0,f())}).catch(function($){w&&!ae&&(ae=!0,w($)),M&&M($)})},this.analyticsFlags=function(){var f=c.api;if(c.evaluationEvent&&c.evaluationEvent[c.environmentID])return c.evaluationEvent&&Object.getOwnPropertyNames(c.evaluationEvent).length!==0&&Object.getOwnPropertyNames(c.evaluationEvent[c.environmentID]).length!==0?c.getJSON(f+"analytics/flags/","POST",JSON.stringify(c.evaluationEvent[c.environmentID])).then(function(w){var O=c.getState();c.evaluationEvent||(c.evaluationEvent={}),c.evaluationEvent[c.environmentID]={},c.setState(s(s({},O),{evaluationEvent:c.evaluationEvent})),c.updateEventStorage()}).catch(function(w){c.log("Exception fetching evaluationEvent",w)}):void 0},this.datadogRum=null,this.loadingState={isLoading:!0,isFetching:!0,error:null,source:i.NONE},this.canUseStorage=!1,this.analyticsInterval=null,this.api=null,this.cacheFlags=!1,this.ts=null,this.enableAnalytics=!1,this.enableLogs=!1,this.environmentID="",this.evaluationEvent=null,this.flags=null,this.getFlagInterval=null,this.headers=null,this.initialised=!1,this.oldFlags=null,this.onChange=null,this.onError=null,this.identity=null,this.ticks=null,this.timer=null,this.traits=null,this.dtrum=null,this.withTraits=null,this.cacheOptions={ttl:0,skipAPI:!1},this.evaluateFlag=function(f,w){if(c.datadogRum&&(c.datadogRum.client.addFeatureFlagEvaluation?w==="VALUE"?c.datadogRum.client.addFeatureFlagEvaluation(S+f,c.getValue(f,{},!0)):c.datadogRum.client.addFeatureFlagEvaluation(C+f,c.hasFeature(f,!0)):console.error("Flagsmith: Your datadog RUM client does not support the function addFeatureFlagEvaluation, please update it.")),c.enableAnalytics){if(!c.evaluationEvent)return;c.evaluationEvent[c.environmentID]||(c.evaluationEvent[c.environmentID]={}),c.evaluationEvent[c.environmentID][f]===void 0&&(c.evaluationEvent[c.environmentID][f]=0),c.evaluationEvent[c.environmentID][f]+=1}c.updateEventStorage()},this.getValue=function(f,w,O){var M=c.flags&&c.flags[f.toLowerCase().replace(/ /g,"_")],j=null;if(M&&(j=M.value),O||c.evaluateFlag(f,"VALUE"),j===null&&(w==null?void 0:w.fallback)!==void 0)return w.fallback;if(w!=null&&w.json)try{return j===null?(c.log("Tried to parse null flag as JSON: "+f),null):JSON.parse(j)}catch{return w.fallback}return j},this.getTrait=function(f){return c.traits&&c.traits[f.toLowerCase().replace(/ /g,"_")]},this.getAllTraits=function(){return c.traits},this.setTrait=function(f,w){if(c.api){var O={};return O[f]=w,c.setTraits(O)}console.error(E("setTrait"))},this.setTraits=function(f){if(c.api){if(f&&typeof f=="object"||console.error("Expected object for flagsmith.setTraits"),c.withTraits=s(s({},c.withTraits||{}),f),c.identity)return c.initialised?c.getFlags():void 0;c.log("Set traits prior to identifying",c.withTraits)}else console.error(E("setTraits"))},this.hasFeature=function(f,w){var O=c.flags&&c.flags[f.toLowerCase().replace(/ /g,"_")],M=!1;return O&&O.enabled&&(M=!0),w||c.evaluateFlag(f,"ENABLED"),M},o=m.fetch?m.fetch:typeof fetch<"u"?fetch:rn===null||rn===void 0?void 0:rn.fetch,this.canUseStorage=typeof window<"u"||!!m.browserlessStorage,this.log("Constructing flagsmith instance "+m),m.eventSource&&(p=m.eventSource),m.AsyncStorage&&(h=m.AsyncStorage)}return _.prototype.init=function(m){var c=this,f=m.environmentID,w=m.api,O=w===void 0?b:w,M=m.headers,j=m.onChange,B=m.cacheFlags,ae=m.datadogRum,ie=m.onError,$=m.defaultFlags,pe=m.fetch,L=m.preventFetch,me=m.enableLogs,Te=m.enableDynatrace,Se=m.enableAnalytics,U=m.realtime,xe=m.eventSourceUrl,Fe=xe===void 0?"https://realtime.flagsmith.com/":xe,de=m.AsyncStorage,H=m.identity,Tt=m.traits,ot=m.state,kn=m.cacheOptions,Vt=m.angularHttpClient,Kr=m._trigger,Xo=m._triggerLoadingState;return new Promise(function(Pe,Ht){var Cn,Dn;c.environmentID=f,c.api=O,c.headers=M,c.getFlagInterval=null,c.analyticsInterval=null,c.onChange=j;var Yr="Wrong Flagsmith Configuration: preventFetch is true and no defaulFlags provided";if(c._trigger=Kr||c._trigger,c._triggerLoadingState=Xo||c._triggerLoadingState,c.onError=function(he){c.setLoadingState(s(s({},c.loadingState),{isFetching:!1,isLoading:!1,error:he})),ie&&(he instanceof Error?ie(he):ie(new Error(he)))},c.identity=H,c.withTraits=Tt,c.enableLogs=me||!1,c.cacheOptions=kn?{skipAPI:!!kn.skipAPI,ttl:kn.ttl||0}:c.cacheOptions,!c.cacheOptions.ttl&&c.cacheOptions.skipAPI&&console.warn("Flagsmith: you have set a cache ttl of 0 and are skipping API calls, this means the API will not be hit unless you clear local storage."),pe&&(o=pe),c.enableAnalytics=Se||!1,c.flags=Object.assign({},$)||{},c.traits=Object.assign({},Tt)||{},c.initialised=!0,c.ticks=1e4,Object.keys(c.flags).length&&(c.loadingState=s(s({},c.loadingState),{isLoading:!1,source:i.DEFAULT_FLAGS})),U&&typeof window<"u"){var Xr=Fe+"sse/environments/"+f+"/stream";p?c.eventSource||(c.log("Creating event source with url "+Xr),c.eventSource=new p(Xr),c.eventSource.addEventListener("environment_updated",function(he){var be;try{be=JSON.parse(he.data).updated_at}catch(De){c.log("Could not parse sse event",De)}be?!c.timestamp||be>c.timestamp?c.isLoading?c.log("updated_at is new, but flags are loading",he.data,c.timestamp):(c.log("updated_at is new, fetching flags",he.data,c.timestamp),c.getFlags()):c.log("updated_at is outdated, skipping get flags",he.data,c.timestamp):c.log("No updated_at received, fetching flags",he)})):c.log("Error, EventSource is undefined")}if(c.log("Initialising with properties",{environmentID:f,api:O,headers:M,onChange:j,cacheFlags:B,onError:ie,defaultFlags:$,preventFetch:L,enableLogs:me,enableAnalytics:Se,AsyncStorage:h,identity:H,traits:Tt,_trigger:Kr,state:ot,angularHttpClient:Vt},c),c.timer=c.enableLogs?new Date().valueOf():null,de&&(h=de),c.cacheFlags=h!==void 0&&!!B,c.setState(ot),!f)throw Ht("Please specify a environment id"),"Please specify a environment id";if(ae&&(c.datadogRum=ae),Te&&(typeof dtrum>"u"?console.error("You have attempted to enable dynatrace but dtrum is undefined, please check you have the Dynatrace RUM JavaScript API installed."):c.dtrum=dtrum),Vt&&(o=function(he,be){var De=be.headers,Et=be.method,ve=be.body;return new Promise(function(Je){switch(Et){case"GET":return Vt.get(he,{headers:De}).subscribe(function(Qe){Je({ok:!0,text:function(){return Promise.resolve(Qe)}})});case"POST":case"PUT":return Vt.post(he,ve,{headers:De}).subscribe(function(Qe){Je({ok:!0,text:function(){return Promise.resolve(Qe)}})})}})}),h&&c.canUseStorage&&h.getItem(y).then(function(he){if(he)try{c.evaluationEvent=JSON.parse(he)}catch{c.evaluationEvent={}}else c.evaluationEvent={};return c.analyticsInterval=setInterval(c.analyticsFlags,c.ticks),!0}),c.enableAnalytics&&(c.analyticsInterval&&clearInterval(c.analyticsInterval),h&&c.canUseStorage&&h.getItem(y,function(he,be){if(be){var De=JSON.parse(be);De[c.environmentID]&&(ot=c.getState(),c.log("Retrieved events from cache",be),c.setState(s(s({},ot),{evaluationEvent:De[c.environmentID]})))}return!0})),B){if(h&&c.canUseStorage){var Jr=function(he,be){var De,Et;if(be)try{var ve=JSON.parse(be),Je=!1;if(ve&&ve.api===c.api&&ve.environmentID===c.environmentID){var Qe=!0;c.identity&&ve.identity!==c.identity&&(c.log("Ignoring cache,  identity has changed from "+ve.identity+" to "+c.identity),Qe=!1),c.cacheOptions.ttl&&(!ve.ts||new Date().valueOf()-ve.ts>c.cacheOptions.ttl)&&ve.ts&&(c.log("Ignoring cache, timestamp is too old ts:"+ve.ts+" ttl: "+c.cacheOptions.ttl+" time elapsed since cache: "+(new Date().valueOf()-ve.ts)+"ms"),Qe=!1),Qe&&(Je=!0,c.setState(ve),c.log("Retrieved flags from cache",ve))}if(Je){var Zr=!(L||c.cacheOptions.skipAPI&&Je);c._onChange(null,{isFromServer:!1,flagsChanged:!0,traitsChanged:!!c.traits&&!!Object.keys(c.traits).length},c._loadedState(null,i.CACHE,Zr)),c.oldFlags=c.flags,Pe(!0),c.cacheOptions.skipAPI&&Je&&c.log("Skipping API, using cache"),Zr&&c.getFlags()}else L?Pe(!0):c.getFlags(Pe,Ht)}catch(Jo){c.log("Exception fetching cached logs",Jo)}else L?($?c._onChange(null,{isFromServer:!1,flagsChanged:!0,traitsChanged:!!c.traits&&!!Object.keys(c.traits).length},c._loadedState(null,i.DEFAULT_FLAGS)):c.flags?(De=c._onChange)===null||De===void 0||De.call(c,null,{isFromServer:!1,flagsChanged:!0,traitsChanged:!!c.traits&&!!Object.keys(c.traits).length},c._loadedState(null,i.DEFAULT_FLAGS)):(Et=c.onError)===null||Et===void 0||Et.call(c,new Error(Yr)),Pe(!0)):c.getFlags(Pe,Ht);return!0};if(h.getItemSync)try{Jr(0,h.getItemSync(g))}catch{}else h.getItem(g,Jr)}}else if(L){if($)(Cn=c._onChange)===null||Cn===void 0||Cn.call(c,null,{isFromServer:!1,flagsChanged:!0,traitsChanged:!!c.traits&&!!Object.keys(c.traits).length},c._loadedState(null,i.DEFAULT_FLAGS));else if(c.flags){var Qr=null;Object.keys(c.flags).length===0&&(Qr=Yr),(Dn=c._onChange)===null||Dn===void 0||Dn.call(c,null,{isFromServer:!1,flagsChanged:!0,traitsChanged:!!c.traits&&!!Object.keys(c.traits).length},c._loadedState(Qr,i.DEFAULT_FLAGS))}Pe(!0)}else c.getFlags(Pe,Ht)}).catch(function(Pe){c.log("Error during initialisation ",Pe),ie&&ie(Pe)})},_.prototype._loadedState=function(m,c,f){return m===void 0&&(m=null),f===void 0&&(f=!1),{error:m,isFetching:f,isLoading:!1,source:c}},_.prototype.getAllFlags=function(){return this.flags},_.prototype.identify=function(m,c){return this.identity=m,this.log("Identify: "+this.identity),c&&(this.withTraits=s(s({},this.withTraits||{}),c)),this.initialised?this.getFlags():Promise.resolve()},_.prototype.getState=function(){return{api:this.api,environmentID:this.environmentID,flags:this.flags,identity:this.identity,ts:this.ts,traits:this.traits,evaluationEvent:this.evaluationEvent}},_.prototype.setState=function(m){m&&(this.initialised=!0,this.api=m.api||this.api||b,this.environmentID=m.environmentID||this.environmentID,this.flags=m.flags||this.flags,this.identity=m.identity||this.identity,this.traits=m.traits||this.traits,this.withTraits=s(s({},this.withTraits||{}),this.traits),this.evaluationEvent=m.evaluationEvent||this.evaluationEvent,this.log("setState called",this))},_.prototype.log=function(){for(var m=[],c=0;c<arguments.length;c++)m[c]=arguments[c];this.enableLogs&&console.log.apply(this,a(["FLAGSMITH:",new Date().valueOf()-(this.timer||0),"ms"],m,!0))},_.prototype.updateStorage=function(){if(this.cacheFlags){this.ts=new Date().valueOf();var m=JSON.stringify(this.getState());this.log("Setting storage",m),h.setItem(g,m)}},_.prototype.updateEventStorage=function(){if(this.enableAnalytics){var m=JSON.stringify(this.getState().evaluationEvent);h.setItem(y,m)}},_.prototype.setLoadingState=function(m){var c;d(m,this.loadingState)||(this.loadingState=s({},m),this.log("Loading state changed",m),(c=this._triggerLoadingState)===null||c===void 0||c.call(this))},_.prototype.logout=function(){return this.identity=null,this.traits={},this.initialised?this.getFlags():Promise.resolve()},_.prototype.startListening=function(m){m===void 0&&(m=1e3),this.getFlagInterval&&clearInterval(this.getFlagInterval),this.getFlagInterval=setInterval(this.getFlags,m)},_.prototype.stopListening=function(){this.getFlagInterval&&(clearInterval(this.getFlagInterval),this.getFlagInterval=null)},_.prototype.getSegments=function(){},_}();function P(_){var m=_.fetch,c=_.AsyncStorage,f=_.eventSource;return new D({fetch:m,AsyncStorage:c,eventSource:f})}var v,k=function(_,m,c){var f="shortString",w=!0;typeof c=="number"&&(f="javaDouble",w=!1),_[f]=_[f]||{},_[f][m]=w?c+"":c},A=(v=function(_,m){return v=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(c,f){c.__proto__=f}||function(c,f){for(var w in f)Object.prototype.hasOwnProperty.call(f,w)&&(c[w]=f[w])},v(_,m)},function(_,m){if(typeof m!="function"&&m!==null)throw new TypeError("Class extends value "+String(m)+" is not a constructor or null");function c(){this.constructor=_}v(_,m),_.prototype=m===null?Object.create(m):(c.prototype=m.prototype,new c)}),q=function(_){var m=typeof Symbol=="function"&&Symbol.iterator,c=m&&_[m],f=0;if(c)return c.call(_);if(_&&typeof _.length=="number")return{next:function(){return _&&f>=_.length&&(_=void 0),{value:_&&_[f++],done:!_}}};throw new TypeError(m?"Object is not iterable.":"Symbol.iterator is not defined.")},x=function(_,m){var c=typeof Symbol=="function"&&_[Symbol.iterator];if(!c)return _;var f,w,O=c.call(_),M=[];try{for(;(m===void 0||m-- >0)&&!(f=O.next()).done;)M.push(f.value)}catch(j){w={error:j}}finally{try{f&&!f.done&&(c=O.return)&&c.call(O)}finally{if(w)throw w.error}}return M},u=function(_,m,c){if(c||arguments.length===2)for(var f,w=0,O=m.length;w<O;w++)!f&&w in m||(f||(f=Array.prototype.slice.call(m,0,w)),f[w]=m[w]);return _.concat(f||Array.prototype.slice.call(m))},T=function(_){function m(){return _.call(this,`EventSource not available.
Consider loading an EventSource polyfill and making it available globally as EventSource, or passing one in as eventSourceClass to the ReconnectingEventSource constructor.`)||this}return A(m,_),m}(Error),R=function(){function _(m,c){var f=this;if(this.CONNECTING=0,this.OPEN=1,this.CLOSED=2,this._configuration=c!=null?Object.assign({},c):void 0,this.withCredentials=!1,this._eventSource=null,this._lastEventId=null,this._timer=null,this._listeners={open:[],error:[],message:[]},this.url=m.toString(),this.readyState=this.CONNECTING,this.max_retry_time=3e3,this.eventSourceClass=globalThis.FlagsmithEventSource,this._configuration!=null&&(this._configuration.lastEventId&&(this._lastEventId=this._configuration.lastEventId,delete this._configuration.lastEventId),this._configuration.max_retry_time&&(this.max_retry_time=this._configuration.max_retry_time,delete this._configuration.max_retry_time),this._configuration.eventSourceClass&&(this.eventSourceClass=this._configuration.eventSourceClass,delete this._configuration.eventSourceClass)),this.eventSourceClass==null||typeof this.eventSourceClass!="function")throw new T;this._onevent_wrapped=function(w){f._onevent(w)},this._start()}return _.prototype.dispatchEvent=function(m){throw new Error("Method not implemented.")},_.prototype._start=function(){var m,c,f=this,w=this.url;this._lastEventId&&(w.indexOf("?")===-1?w+="?":w+="&",w+="lastEventId="+encodeURIComponent(this._lastEventId)),this._eventSource=new this.eventSourceClass(w,this._configuration),this._eventSource.onopen=function(B){f._onopen(B)},this._eventSource.onerror=function(B){f._onerror(B)},this._eventSource.onmessage=function(B){f.onmessage(B)};try{for(var O=q(Object.keys(this._listeners)),M=O.next();!M.done;M=O.next()){var j=M.value;this._eventSource.addEventListener(j,this._onevent_wrapped)}}catch(B){m={error:B}}finally{try{M&&!M.done&&(c=O.return)&&c.call(O)}finally{if(m)throw m.error}}},_.prototype._onopen=function(m){this.readyState===0&&(this.readyState=1,this.onopen(m))},_.prototype._onerror=function(m){var c=this;if(this.readyState===1&&(this.readyState=0,this.onerror(m)),this._eventSource){this._eventSource.close(),this._eventSource=null;var f=Math.round(this.max_retry_time*Math.random());this._timer=setTimeout(function(){return c._start()},f)}},_.prototype._onevent=function(m){var c,f;m&&m.lastEventId&&(this._lastEventId=m.lastEventId);var w=this._listeners[m.type];if(w!=null)try{for(var O=q(u([],x(w),!1)),M=O.next();!M.done;M=O.next())M.value.call(this,m)}catch(j){c={error:j}}finally{try{M&&!M.done&&(f=O.return)&&f.call(O)}finally{if(c)throw c.error}}m.type==="message"&&this.onmessage(m)},_.prototype.onopen=function(m){},_.prototype.onerror=function(m){},_.prototype.onmessage=function(m){},_.prototype.close=function(){this._timer&&(clearTimeout(this._timer),this._timer=null),this._eventSource&&(this._eventSource.close(),this._eventSource=null),this.readyState=2},_.prototype.addEventListener=function(m,c,f){this._listeners[m]==null&&(this._listeners[m]=[],this._eventSource!=null&&this._eventSource.addEventListener(m,this._onevent_wrapped));var w=this._listeners[m];w.includes(c)||(this._listeners[m]=u(u([],x(w),!1),[c],!1))},_.prototype.removeEventListener=function(m,c,f){var w=this._listeners[m];this._listeners[m]=w.filter(function(O){return O!==c})},_}();globalThis.FlagsmithEventSource=typeof EventSource<"u"?EventSource:null;var N=function(_,m){return m=m||{},new Promise(function(c,f){var w=new XMLHttpRequest,O=[],M=[],j={},B=function(){return{ok:(w.status/100|0)==2,statusText:w.statusText,status:w.status,url:w.responseURL,text:function(){return Promise.resolve(w.responseText)},json:function(){return Promise.resolve(w.responseText).then(JSON.parse)},blob:function(){return Promise.resolve(new Blob([w.response]))},clone:B,headers:{keys:function(){return O},entries:function(){return M},get:function(ie){return j[ie.toLowerCase()]},has:function(ie){return ie.toLowerCase()in j}}}};for(var ae in w.open(m.method||"get",_,!0),w.onload=function(){w.getAllResponseHeaders().replace(/^(.*?):[^\S\n]*([\s\S]*?)$/gm,function(ie,$,pe){O.push($=$.toLowerCase()),M.push([$,pe]),j[$]=j[$]?j[$]+","+pe:pe}),c(B())},w.onerror=f,w.withCredentials=m.credentials=="include",m.headers)w.setRequestHeader(ae,m.headers[ae]);w.send(m.body||null)})},G=P({AsyncStorage:r,fetch:N,eventSource:R});typeof window<"u"&&(window.flagsmith=G),n.createFlagsmithInstance=function(){return P({AsyncStorage:r,fetch:N,eventSource:R})},n.default=G,Object.defineProperty(n,"__esModule",{value:!0})})})(Dr,Dr.exports);var mh=Dr.exports;const Ar=pl(mh),fh=e=>e.replace(/_./g,t=>t[1].toUpperCase()).replace(/-./g,t=>t[1].toUpperCase()),yh=e=>{const t={...e};return Object.entries(t).forEach(([n,r])=>{const s=fh(n);delete t[n],t[s]=r}),t},_h=e=>{const t={};return Object.entries(e).forEach(([n,r])=>{if(r.enabled){const s=r.value!==void 0&&r.value!==null&&r.value!=="";t[n]=s?r.value:!0}}),t},wh=async e=>(e==null?void 0:e.email)||await Ri(Oi,qe()),bh=e=>{var s,a,i,o,d,p,h,g,y;const t=e!=null&&e.date_joined?new Date(e.date_joined).valueOf():void 0,n=(a=(s=e==null?void 0:e.active_organization)==null?void 0:s.super_organization)==null?void 0:a.created,r=n?new Date(n).valueOf():t;return e?{super_organization_id:(o=(i=e.active_organization)==null?void 0:i.super_organization)==null?void 0:o.id,organization_id:(d=e.active_organization)==null?void 0:d.id,email_address:e.email,first_name:e.first_name,last_name:e.last_name,date_joined:e.date_joined,date_joined_timestamp:t,super_organization_created_date:n,super_organization_created_date_timestamp:r,plan_name:(g=(h=(p=e.active_organization)==null?void 0:p.super_organization)==null?void 0:h.plan)==null?void 0:g.name,signup_method:e.signup_method,browser:xi(),extension_version:chrome.runtime.getManifest().version,signup_source:e.signup_source,sps_enabled:!!((y=e.active_organization)!=null&&y.smart_privacy_screen_enabled)}:null},vh=async e=>{const t=await wh(e),n=bh(e);t!==null&&Ar.identify(t,n).then(()=>Ar.getAllFlags()).then(r=>{const s=_h(yh(r));l.dispatch(Di(s))})},Sh=async()=>{Ar.init({environmentID:Ai,fetch,preventFetch:!0})};Sh().catch(e=>{console.error(e)});const yn=async()=>{const e=await hl();l.dispatch(Pi(e));const t=await Js("recordingControlsPosition");l.dispatch(Li(t))},Th=async(e,t)=>{await or(e,t),yn()},po="/assets/index.tsx-loader.js",ho="/assets/index.js-loader.js",Eh=async e=>{!e.id||!(e!=null&&e.url)||Re(e.url)||await chrome.scripting.executeScript({target:{tabId:e.id,allFrames:!0},files:[po,ho]})},Rr=async({tabId:e})=>{const t=await chrome.tabs.get(e);try{ue(t,{messageType:"pingContentScript"},n=>{n||Eh(t)})}catch(n){F("error_in_refreshContentScriptIfStale",{error:n})}},Ih=async()=>{(await chrome.tabs.query({active:!0})).forEach(e=>{e.id!==void 0&&Rr({tabId:e.id})})};chrome.tabs.onActivated.addListener(Rr),chrome.windows.onFocusChanged.addListener(Ih);const kh=async({api:e,documentId:t,context:n})=>await Ct(e,`views/?id=${t}`,"post",{context:n}),Ch={create:kh};function go(e,t,n){Ch.create({api:e,documentId:t,context:n})}const Or=J("sidebar/initializeSidebar"),xr=460;async function Dh(e,t){function n(r){r.id===e&&(chrome.windows.update(e,t),chrome.windows.onBoundsChanged.removeListener(n))}chrome.windows.onBoundsChanged.addListener(n),await chrome.windows.update(e,{state:"normal"})}async function Ah(e,t,n){if(e.left===void 0||e.width===void 0)throw new Error("Current window does not have a valid left or width. Is the window a closed window from the sessions API?");if((t==null?void 0:t.id)===void 0)throw new Error(`Current tab not passed ${t==null?void 0:t.url} ${t==null?void 0:t.status}`);let r=e.height,s=e.width-xr,a=e.top,i=e.left;if(e.state==="fullscreen"||e.state==="maximized"&&Ui()!==Fi.MacOS){const o=await chrome.tabs.sendMessage(t.id,{messageType:"getScreenDimensions"});a=o.screenTop,i=o.screenLeft,r=o.height,s=o.width-xr,await Dh(t.windowId,{left:i,top:a,width:s,height:r})}else await chrome.windows.update(t.windowId,{width:s});return await chrome.windows.create({url:n,type:"popup",left:i+s,top:a,width:xr,height:r})}async function Rh(e,t){const n=await chrome.tabs.query({windowId:e});if(n.length>0){const r=n[0].id;if(n[0].pendingUrl===t||n[0].url===t)return;await chrome.tabs.update(r,{url:t});return}throw new Error("No tabs found in window")}async function Oh(){const e=await ys();if(e!=null&&e.path)return e.path===Q.Assistant?0:1}const Pr=async e=>{const{sidebar:t}=l.getState();if(t.sidebarWindowId)try{return await Rh(t.sidebarWindowId,e),t.sidebarWindowId}catch{l.dispatch(Or({sidebarWindowId:void 0,contentWindowId:void 0,originalContentWindowWidth:void 0}))}const[n]=await chrome.tabs.query({active:!0,lastFocusedWindow:!0});if(n.windowId){const r=await chrome.windows.get(n.windowId),s=r.width;if(r.left!==void 0&&r.width!==void 0){const a=await Ah(r,n,e);l.dispatch(Or({sidebarWindowId:a.id,contentWindowId:r.id,originalContentWindowWidth:s}));const i=async o=>{const{sidebar:d}=l.getState();if(d.sidebarWindowId&&o===d.sidebarWindowId){const p=d.originalContentWindowWidth;await chrome.windows.update(n.windowId,{width:p}),l.dispatch(Or({sidebarWindowId:void 0,contentWindowId:void 0,originalContentWindowWidth:void 0}))}chrome.windows.onRemoved.removeListener(i)};return chrome.windows.onRemoved.addListener(i),a.id}}},xh=async e=>{if(await Oh()===0){const t=`${z.FRONTEND_URL}/sidebar/assistant?url=${e}`,n=await Ni(),r=p=>{let h=Mi(p||"","url")||"";if(!h&&p){const g=p.includes("?")?p.split("?")[1]:"";g&&(h=new URLSearchParams(g).get("url")||"")}try{return decodeURIComponent(h)}catch{return h}},s=r(n),a=r(t),i=p=>{try{return new URL(p).hostname}catch{return""}},o=i(s),d=i(a);if(o&&d&&o===d||s&&a&&s===a)return;await fs(t)}},Ph=(e,t,n)=>{const r=qn(e,t,!1,"","scribe",`${z.FRONTEND_URL}/`);return r?ws(r,{name:"startingUrl",value:n??""}):null},Lr=(e,t,n,r,s=!0)=>{const a=qn(e,t,!1,"","scribe",`${z.FRONTEND_URL}/`);return a?ws(a,{name:"sidepanel",value:"true"},{name:"startingUrl",value:encodeURI(n)},{name:"startGuiding",value:s?"true":"false"},{name:"actionIndex",value:r}).split(z.FRONTEND_URL)[1]:null},Lh=(e,t)=>{const n=l.getState(),{contentWindowId:r}=bs(n),s=e.url,a=Lr(e.id,e.name,s,e.actionIndex);s&&chrome.tabs.create({url:s,windowId:r}),Z("scribe_viewer_started",{startingUrl:s,viewerUrl:a,id:e.id,name:e.name,location:e.location}),go(t,e.id,"sidekick")},Nh=e=>{const{id:t,name:n,newTabUrl:r,viewerUrl:s,location:a,currentWindowId:i,actionIndex:o}=e,d=Lr(t,n,r,o,!0);et(i,_s(d)??"",{frontendUrl:z.FRONTEND_URL}),r&&chrome.tabs.create({url:r,windowId:i})},mo=(e,t)=>{const n=jn(l.getState()),{scribe:r}=n,{scribe:s}=e,a=r||s,i=!r&&s;if(!a){console.error("Scribe is undefined");return}const{id:o,name:d}=a,p="url"in a?a.url:"",h="location"in a?a.location:"",g="actionIndex"in a&&a.actionIndex||"";if(!o||!d){console.error("Scribe ID or Name is undefined");return}const y=Lr(o,d,p,g,!i);e.targetWindowId&&et(e.targetWindowId,_s(y)??"",{frontendUrl:z.FRONTEND_URL}),chrome.action.setPopup({popup:""}),chrome.runtime.sendMessage({messageType:"removePopup"}),!i&&Lh({id:o,name:d,url:p,location:h,actionIndex:g},t)},Mh=async(e,t,n)=>{const r=l.getState(),{contentWindowId:s}=bs(r);Z("scribe_viewer_started",{startingUrl:e.startingUrl,id:e.scribe.id,name:e.scribe.name,location:e.location}),go(t,e.scribe.id,"in-context-viewer");const a=`${Ph(e.scribe.id,e.scribe.name,e.startingUrl)}`;await Pr(a),e.startingUrl&&chrome.tabs.create({url:e.startingUrl,windowId:s})};function fo(e=null){chrome.tabs.query({active:!0,currentWindow:!0},function(t){t&&t[0]&&t[0].id&&chrome.tabs.sendMessage(t[0].id,{messageType:"getCurrentDom",sessionId:e})})}function Uh({dom:e,url:t,sessionId:n}){chrome.runtime.sendMessage({messageType:"send-dom-to-sidepanel",data:{dom:e,url:t,sessionId:n}})}const Fh=(e,t,n,r)=>{var s,a;if(e.messageType===ir.ON_MEDIA_PERMISSIONS_TAB_INITALIZED&&$i(t.tab,e.microphonePermission),e.messageType===ir.MEDIA_PERMISSION_CHANGED&&e.microphonePermission===ji.GRANTED){const i=(a=(s=ee(r.getState()))==null?void 0:s.recordedTabs)==null?void 0:a[0];i&&chrome.tabs.update(i,{active:!0})}},$h=async()=>{try{const{data:e}=await V.get("/transcript_token/");return e.token}catch(e){throw X({title:"Failed to fetch AssemblyAI auth token",error:e.message}),new Error("Failed to fetch AssemblyAI auth token",e.message)}},yo=(e,t)=>{var s,a;const n=((s=e.words[0])==null?void 0:s.start)||0,r=((a=e.words[e.words.length-1])==null?void 0:a.end)||0;return{...e,audio_start_timestamp:n+t,audio_end_timestamp:r+t,relative_audio_start:t}},jh=async(e,t)=>{var n,r;switch(e){case Ve.GET_AUTH_TOKEN:try{return{token:await $h()}}catch(s){throw console.error("Failed to fetch auth token:",s),l.dispatch(lt(!1)),s}case Ve.TRANSCRIPT:{const s=l.getState(),{isTranscribing:a,lastPauseTimestamp:i,pauseRanges:o}=ee(s),d=tt(s);if((n=t.transcript)!=null&&n.words.length&&(a||d)){const p=t.startTimestamp||Date.now().valueOf();let h=0;o&&o.length>0&&(h=o.reduce((b,E)=>E.unpauseTimestamp?b+(E.unpauseTimestamp-E.pauseTimestamp):b,0));const g={...t.transcript,words:t.transcript.words.map(b=>({...b,start:b.start+h,end:b.end+h}))},y=yo(g,p);l.dispatch(Xt(y))}else if((r=t.transcript)!=null&&r.words.length&&!a&&!d&&i){const p=t.startTimestamp||Date.now().valueOf();let h=0;o&&o.length>0&&(h=o.reduce((b,E)=>E.unpauseTimestamp?b+(E.unpauseTimestamp-E.pauseTimestamp):b,0));const g={...t.transcript,words:t.transcript.words.map(b=>({...b,start:b.start+h,end:b.end+h}))},y=yo(g,p);l.dispatch(Xt(y))}break}case Ve.ERROR:X({title:t.title,error:t.error}),l.dispatch(lt(!1));break;case Ve.ON_READY:l.dispatch(lt(!0));break}},qh=async()=>{try{const{data:e}=await V.get("/transcript_token_v3/");return e.token}catch(e){throw X({title:"Failed to fetch AssemblyAI V3 auth token",error:e.message}),new Error("Failed to fetch AssemblyAI V3 auth token",e.message)}},_o=(e,t)=>{var s,a;const n=((s=e.words[0])==null?void 0:s.start)??0,r=((a=e.words[e.words.length-1])==null?void 0:a.end)??0;return{message_type:e.turn_is_formatted?"FinalTranscript":"PartialTranscript",confidence:e.confidence||0,text:e.transcript,words:e.words,created:new Date().toISOString(),audio_start_timestamp:n+t,audio_end_timestamp:r+t,relative_audio_start:t}},Wh=async(e,t)=>{var n,r;switch(e){case Ve.GET_AUTH_TOKEN:try{return{token:await qh()}}catch(s){throw console.error("V3: Failed to fetch auth token:",s),l.dispatch(lt(!1)),s}case Ve.TRANSCRIPT:{const s=l.getState(),{isTranscribing:a,lastPauseTimestamp:i,pauseRanges:o}=ee(s),d=tt(s);if((n=t.transcript)!=null&&n.words.length&&(a||d)){const p=t.startTimestamp||Date.now().valueOf();let h=t.transcript.words;if(o&&o.length>0&&(h=t.transcript.words.filter(b=>{const E=b.start+p;return!o.some(S=>S.unpauseTimestamp?E>=S.pauseTimestamp&&E<S.unpauseTimestamp:E>=S.pauseTimestamp)}),h.length===0))break;const g={...t.transcript,words:h},y=_o(g,p);l.dispatch(Xt(y))}else if((r=t.transcript)!=null&&r.words.length&&!a&&!d&&i){const p=t.startTimestamp||Date.now().valueOf();let h=t.transcript.words;if(o&&o.length>0&&(h=t.transcript.words.filter(b=>{const E=b.start+p;return!o.some(S=>S.unpauseTimestamp?E>=S.pauseTimestamp&&E<S.unpauseTimestamp:E>=S.pauseTimestamp)}),h.length===0))break;const g={...t.transcript,words:h},y=_o(g,p);l.dispatch(Xt(y))}break}case Ve.ERROR:X({title:t.title,error:t.error}),l.dispatch(lt(!1));break;case Ve.ON_READY:l.dispatch(lt(!0));break}},Bh=e=>e.domSettlement||{captures:{}},_n=Dt(Bh,e=>e.captures);Dt(_n,e=>{const t=Date.now(),n=[];return Object.entries(e).forEach(([r,s])=>{s.ttl&&s.ttl<t&&n.push(r)}),n}),Dt(_n,e=>{const t={};return Object.entries(e).forEach(([n,r])=>{r.scribeId||(t[n]=r)}),t}),Dt(_n,e=>Object.keys(e).length),Dt(_n,e=>{const t={};return Object.entries(e).forEach(([n,r])=>{r.scribeId&&!r.ttl&&(t[n]=r)}),t});class Gh{constructor(t){Be(this,"isEnabled");Be(this,"lastDomainByTab");Be(this,"capturedDomains");Be(this,"config");this.config=t,this.isEnabled=!0,this.lastDomainByTab=new Map,this.capturedDomains=new Set}async handleStageCapture(t,n,r){if(this.isEnabled&&!(n!=="networkIdle"&&n!=="fullySettled"))try{const s=await this.getTab(t);if(!s||!s.url||!this.shouldMonitorUrl(s.url))return;const a=this.getDomainFromUrl(s.url);if(!a)return;const i=`${t}-${a}-${n}`;if(this.capturedDomains.has(i))return;const o=await Jt();if(!o||!o.base64Image)return;const d=await dt.saveScreenshot(o.base64Image,t,a,s.url,n);l.dispatch(qi({tabId:t,domain:a,screenshotId:d})),this.capturedDomains.add(i),this.lastDomainByTab.set(t,a)}catch(s){console.error("[DOM Settlement] Failed to capture screenshot:",s)}}async handleDomainChange(t,n){var a,i;if(!this.isEnabled)return;const r=this.getDomainFromUrl(n),s=this.lastDomainByTab.get(t);if(s&&r&&s!==r){const o=l.getState(),d=`${t}-${s}`,p=(i=(a=o.domSettlement)==null?void 0:a.captures)==null?void 0:i[d];p!=null&&p.screenshotId&&await dt.deleteScreenshot(p.screenshotId),l.dispatch(Wi({tabId:t,domain:s})),this.lastDomainByTab.set(t,r);const h=[];this.capturedDomains.forEach(g=>{g.startsWith(`${t}-`)&&h.push(g)}),h.forEach(g=>this.capturedDomains.delete(g))}}associateCapturesWithScribe(t,n){var r;try{const s=((r=l.getState().domSettlement)==null?void 0:r.captures)||{};Object.entries(s).forEach(([a,i])=>{if(a.startsWith(`${t}-`)){const{domain:o}=i;l.dispatch(Bi({tabId:t,domain:o,scribeId:n}))}})}catch(s){console.error("[DOM Settlement] Error associating captures:",s)}}async getCapturesForScribe(t){var a;const n=((a=l.getState().domSettlement)==null?void 0:a.captures)||{},r=[],s=Object.entries(n).filter(([i,o])=>o.scribeId===t&&o.screenshotId);for(const[i,o]of s){const d=await dt.getScreenshotWithMetadata(o.screenshotId);d&&r.push({tabId:o.tabId,domain:o.domain,screenshot:d.base64Data,captureTime:o.captureTime,stage:d.stage,url:d.href,s3DownloadUrl:d.s3DownloadUrl,s3InternalUrl:d.s3InternalUrl})}return r}async clearScribeCaptures(t){var s;const n=((s=l.getState().domSettlement)==null?void 0:s.captures)||{},r=[];Object.entries(n).forEach(([a,i])=>{i.scribeId===t&&i.screenshotId&&r.push(i.screenshotId)}),r.length>0&&await dt.deleteScreenshots(r),l.dispatch(Gi(t))}async uploadInitialScreenshotToS3(t,n){var r,s;try{const a=l.getState(),i=this.lastDomainByTab.get(t);if(!i)return null;const o=`${t}-${i}`,d=(s=(r=a.domSettlement)==null?void 0:r.captures)==null?void 0:s[o];if(!(d!=null&&d.screenshotId)||d.scribeId!==n)return null;const p=await dt.getScreenshot(d.screenshotId);if(!p)return null;const h=await V.post("/signed_urls/",{name:"dom_settlement_screenshot",file_type:"jpeg"}),{internal_url:g,upload_url:y,download_url:b}=h.data;let E=p;E.includes(",")&&(E=E.split(",")[1]);const S=atob(E),C=new Uint8Array(S.length);for(let D=0;D<S.length;D++)C[D]=S.charCodeAt(D);const I=new Blob([C],{type:"image/jpeg"});return await zi(y,I,"image/jpeg",{timeout:6e4}),await dt.updateS3Urls(d.screenshotId,g,b,y),{internalUrl:g,downloadUrl:b}}catch(a){return console.error("[DOM Settlement] Failed to upload screenshot to S3:",a),X(a),null}}setEnabled(t){this.isEnabled=t}getDomainFromUrl(t){try{return new URL(t).hostname}catch{return null}}shouldMonitorUrl(t){return!(t.startsWith("chrome://")||t.startsWith("chrome-extension://")||t.startsWith("about:")||t.startsWith("file://"))}async getTab(t){return new Promise(n=>{chrome.tabs.get(t,r=>{chrome.runtime.lastError?n(null):n(r)})})}downloadScreenshot(t,n){let r=t;r.startsWith("data:")||(r=`data:image/png;base64,${t}`),chrome.downloads.download({url:r,filename:n,saveAs:!1},s=>{chrome.runtime.lastError&&console.error(`[DOM Settlement] Failed to download screenshot: ${chrome.runtime.lastError.message}`)})}downloadJson(t,n){const r=JSON.stringify(t,null,2),s=new TextEncoder().encode(r),a=`data:application/json;base64,${btoa(String.fromCharCode(...s))}`;chrome.downloads.download({url:a,filename:n,saveAs:!1},i=>{chrome.runtime.lastError&&console.error(`[DOM Settlement] Failed to download JSON: ${chrome.runtime.lastError.message}`)})}}const zh=()=>{let e=Wn();return e||(e=new Gh({}),Ki(e),setInterval(()=>{l.dispatch(Vi())},30*1e3)),e},Vh=()=>{chrome.tabs.onRemoved.addListener(e=>{l.dispatch(Hi(e))}),chrome.tabs.onUpdated.addListener((e,t,n)=>{if(t.url&&n.url){const r=Wn();r&&r.handleDomainChange(e,n.url)}})};function Hh(e){if(!Array.isArray(e)||e.length===0)return Array.isArray(e)?e:[];const t=new Map,n=[];for(const a of e){const i=a==null?void 0:a.stack_id;i&&typeof i=="string"&&i.length>0&&(t.has(i)||(t.set(i,[]),n.push(i)),t.get(i).push(a))}if(n.length===0)return e;const r=new Set,s=[];for(const a of e){const i=a==null?void 0:a.stack_id;if(!i){s.push(a);continue}if(r.has(i))continue;const o=t.get(i)||[];r.add(i);let d;for(const g of o)typeof(g==null?void 0:g.stack_short_description)=="string"&&g.stack_short_description.trim()?d=g.stack_short_description.trim():typeof(g==null?void 0:g.stack_description)=="string"&&g.stack_description.trim()&&(d=g.stack_description.trim());const p=o[0]||{},h={id:`stack_${i}`,kind:"stack",type:"stack",url:(p==null?void 0:p.url)||"",timestamp:(p==null?void 0:p.timestamp)||void 0,description:d||void 0,actions:o.map(g=>({...g}))};s.push(h)}return s}function Kh(e){if(!e||!Array.isArray(e.scribes))return e;const t=e.scribes.map(n=>{const r=Hh(Array.isArray(n==null?void 0:n.actions)?n.actions:[]);return{...n,actions:r}});return{...e,scribes:t}}function Yh(){const e=new Date,t=(e.getDay()+6)%7,n=new Date(e);return n.setHours(0,0,0,0),n.setDate(e.getDate()-t),{mondayMidnightMs:n.getTime()}}function Xh(e){if(!e||typeof e!="string")return null;const t=e.match(/^(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2})(\.(\d+))?Z$/);if(t){const r=t[1],s=(t[3]||"").slice(0,3),a=s?`${r}.${s}Z`:`${r}Z`,i=new Date(a).getTime();return Number.isFinite(i)?i:null}const n=new Date(e).getTime();return Number.isFinite(n)?n:null}function Jh(e){const t=Xh(e);if(t==null)return!1;const{mondayMidnightMs:n}=Yh();return t>=n}async function wn(e){var t;try{const n=ce(l.getState());if(!((n==null?void 0:n.lrr2025)??(n==null?void 0:n.lrr_2025)))return{ok:!0,stored:!1,reason:"disabled"}}catch{return{ok:!0,stored:!1,reason:"flags_unavailable"}}try{const n=`${z.BACKEND_BASE_URL}/discover_workflows/sessions/latest`,r=await ut(),s={...r!=null&&r.token?{Authorization:`Bearer ${r.token}`}:{}},a=await fetch(n,{headers:s}),i=await a.json();if(!i||!i.metadata)return oe({message:"dw_latest_results_empty_response",category:"discover_workflows",level:"warning"}),{ok:!1,stored:!1,reason:"empty_response"};const{metadata:o}=i;if(!Jh(o.job_start_time))return oe({message:"dw_latest_results_stale",category:"discover_workflows",level:"info",data:{job_start_time:o.job_start_time}}),{ok:!0,stored:!1,reason:"stale"};const d=Kh(i);await bl(o.super_org_id,o.org_id,o.job_id,d),oe({message:"dw_latest_results_stored",category:"discover_workflows",level:"info",data:{super_org_id:o.super_org_id,org_id:o.org_id,job_id:o.job_id}});try{const p=a.headers.get(ne)||a.headers.get(ne.toLowerCase()),h=a.headers.get(re)||a.headers.get(re.toLowerCase());le("DW.API.Latest.Success",{status:a.status,sessionId:p,requestId:h,super_org_id:o.super_org_id,org_id:o.org_id,job_id:o.job_id})}catch{}return{ok:!0,stored:!0}}catch(n){const r=((t=n==null?void 0:n.response)==null?void 0:t.status)??void 0;X(n,{tags:{component:"discover_workflows"},extra:{context:"Failed to fetch DW latest results",status:r}});try{le("DW.API.Latest.Failure",{status:r,sessionId:void 0,requestId:void 0,error:(n==null?void 0:n.message)||"network_error"})}catch{}return{ok:!1,stored:!1,reason:String(r||"network_error")}}}const bt=(()=>({BASE_URL:"/",MODE:"production",DEV:!1,PROD:!0,SSR:!1}).VITE_CORTEX_BASE_URL?{}.VITE_CORTEX_BASE_URL:"https://cortex.scribehow.com")(),vt=Yi({baseURL:bt,getAuthToken:async()=>ut(),setAuthToken:async e=>{await Xi(e)}});vt.interceptors.request.use(async e=>{try{const t=await uh();return{...e,headers:{...e.headers||{},...t}}}catch{}return e});const Nr="dw-weekly-check",Ye="dw-retry-check",wo=4*60,Qh=7*24*60;let Ce=null,at,Xe;function $t(e){if(!e||typeof e!="string")return null;const t=e.match(/^(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2})(\.(\d+))?Z$/);if(t){const r=t[1],s=(t[3]||"").slice(0,3),a=s?`${r}.${s}Z`:`${r}Z`,i=new Date(a).getTime();return Number.isFinite(i)?i:null}const n=new Date(e).getTime();return Number.isFinite(n)?n:null}function jt(){try{const e=ce(l.getState());return!!((e==null?void 0:e.lrr2025)??(e==null?void 0:e.lrr_2025))}catch{return!1}}function Mr(){try{const e=ce(l.getState());return!!((e==null?void 0:e.lrrManualRefreshEnabled)??(e==null?void 0:e.lrr_manual_refresh_enabled))}catch{return!1}}function Zh(){const e=new Date,t=(e.getDay()+6)%7,n=new Date(e);return n.setDate(e.getDate()-t),n.setHours(8,0,0,0),e.getTime()<n.getTime()?n.getTime():new Date(n.getTime()+7*24*60*60*1e3).getTime()}function eg(){const e=new Date,t=(e.getDay()+6)%7,n=new Date(e);return n.setDate(e.getDate()-t),n.setHours(8,0,0,0),n.getTime()}async function tg(){try{const e=Zh();chrome.alarms.create(Nr,{when:e,periodInMinutes:Qh}),le("DW.Scheduler.WeeklyRun.Scheduled",{when:e})}catch{}}async function ng(){try{await chrome.alarms.clear(Nr),await chrome.alarms.clear(Ye),le("DW.Scheduler.Alarms.Cleared",{})}catch{}}async function rg(e){try{chrome.alarms.create(Ye,{delayInMinutes:wo}),le("DW.Scheduler.Retry.Scheduled",{delayMinutes:wo,reason:e||void 0})}catch{}}async function bo(){var s,a,i,o,d;if(!jt())return;let e=null;try{const p=l.getState(),h=$e(p),g=(i=(a=(s=h==null?void 0:h.userData)==null?void 0:s.active_organization)==null?void 0:a.super_organization)==null?void 0:i.id,y=(d=(o=h==null?void 0:h.userData)==null?void 0:o.active_organization)==null?void 0:d.id;g&&y&&(e=`${g}|${y}`)}catch{}const{ok:t,stored:n,reason:r}=await wn();if(t&&n){le("DW.Scheduler.WeeklyRun.Triggered",{org_scope:e||null});try{chrome.runtime.sendMessage({messageType:"dwLatestResultsUpdated"})}catch{}try{await chrome.alarms.clear(Ye)}catch{}}else await rg(r)}async function vo(){var n,r,s,a,i,o,d,p;if(!jt()){await ng();return}await tg();const e=Date.now(),t=eg();if(e>=t){try{const h=l.getState(),g=$e(h),y=(s=(r=(n=g==null?void 0:g.userData)==null?void 0:n.active_organization)==null?void 0:r.super_organization)==null?void 0:s.id,b=(i=(a=g==null?void 0:g.userData)==null?void 0:a.active_organization)==null?void 0:i.id,E=y&&b?`${y}|${b}`:null;if(E){const S=(p=(d=(o=await cr(E))==null?void 0:o.payload)==null?void 0:d.metadata)==null?void 0:p.job_start_time;if((()=>{if(!S)return!1;const C=$t(S);if(C==null)return!1;const I=C,D=(()=>{const P=new Date,v=(P.getDay()+6)%7,k=new Date(P);return k.setHours(0,0,0,0),k.setDate(P.getDate()-v),k.getTime()})();return Number.isFinite(I)&&I>=D})()){try{await chrome.alarms.clear(Ye)}catch{}le("DW.Scheduler.StartupRecovery.SkippedFetchDueToFreshData",{orgScope:E});return}}}catch{}le("DW.Scheduler.StartupRecovery.FetchTriggered",{}),bo()}}try{chrome.alarms.onAlarm.addListener(e=>{((e==null?void 0:e.name)===Nr||(e==null?void 0:e.name)===Ye)&&bo()})}catch{}async function sg(){var e,t,n,r,s,a,i,o,d,p,h,g,y,b,E,S,C,I,D,P,v;if(!(!jt()||!Mr())){try{chrome.runtime.sendMessage({messageType:"dwManualRunStarted"})}catch{}le("DW.Scheduler.ManualRun.Started",{});try{const k=`${bt}/api/v1/discoverworkflows/run`,A=await vt.post(k,{}),{status:q}=A;if(q<200||q>=300)throw new Error(`Unexpected status ${q}`);try{const x=((e=A.headers)==null?void 0:e[ne.toLowerCase()])||((t=A.config)==null?void 0:t.headers)&&(A.config.headers[ne]||A.config.headers[ne.toLowerCase()])||null,u=((n=A.headers)==null?void 0:n[re.toLowerCase()])||((r=A.config)==null?void 0:r.headers)&&(A.config.headers[re]||A.config.headers[re.toLowerCase()])||null;le("DW.API.Run.Success",{status:q,sessionId:x,requestId:u})}catch{}try{chrome.runtime.sendMessage({messageType:"dwManualRunCompleted",ok:!0})}catch{}}catch(k){X(k,{tags:{component:"discover_workflows"},extra:{context:"Failed to POST DW run"}});try{const A=((a=(s=k==null?void 0:k.response)==null?void 0:s.headers)==null?void 0:a[ne.toLowerCase()])||((d=(o=(i=k==null?void 0:k.response)==null?void 0:i.config)==null?void 0:o.headers)==null?void 0:d[ne])||((g=(h=(p=k==null?void 0:k.response)==null?void 0:p.config)==null?void 0:h.headers)==null?void 0:g[ne.toLowerCase()]),q=((b=(y=k==null?void 0:k.response)==null?void 0:y.headers)==null?void 0:b[re.toLowerCase()])||((C=(S=(E=k==null?void 0:k.response)==null?void 0:E.config)==null?void 0:S.headers)==null?void 0:C[re])||((P=(D=(I=k==null?void 0:k.response)==null?void 0:I.config)==null?void 0:D.headers)==null?void 0:P[re.toLowerCase()]);le("DW.API.Run.Failure",{status:(v=k==null?void 0:k.response)==null?void 0:v.status,sessionId:A,requestId:q,error:(k==null?void 0:k.message)||"network_error"})}catch{}try{chrome.runtime.sendMessage({messageType:"dwManualRunCompleted",ok:!1,error:"run_failed"})}catch{}}}}async function ag(){var e,t,n,r,s,a,i,o,d,p,h;if(!(!jt()||!Mr()))try{let g=null;try{const T=l.getState(),R=$e(T),N=(n=(t=(e=R==null?void 0:R.userData)==null?void 0:e.active_organization)==null?void 0:t.super_organization)==null?void 0:n.id,G=(s=(r=R==null?void 0:R.userData)==null?void 0:r.active_organization)==null?void 0:s.id;N&&G&&(g=`${N}|${G}`)}catch{}const y=g?await cr(g):null,b=(i=(a=y==null?void 0:y.payload)==null?void 0:a.metadata)==null?void 0:i.job_id,E=(d=(o=y==null?void 0:y.payload)==null?void 0:o.metadata)==null?void 0:d.job_start_time,S=$t(E||void 0)||void 0,C=`${z.BACKEND_BASE_URL}/discover_workflows/sessions/latest`,I=await ut(),D={...I!=null&&I.token?{Authorization:`Bearer ${I.token}`}:{}},P=await(await fetch(C,{headers:D})).json(),v=(p=P==null?void 0:P.metadata)==null?void 0:p.job_id,k=(h=P==null?void 0:P.metadata)==null?void 0:h.job_start_time,A=$t(k||void 0),q=A??void 0,x=!!(b&&v&&v!==b),u=(()=>typeof q=="number"&&Number.isFinite(q)?typeof S=="number"&&Number.isFinite(S)?q>S:!0:!1)();if(x||u){const{ok:T,stored:R}=await wn("");if(T&&R){try{chrome.runtime.sendMessage({messageType:"dwLatestResultsUpdated"})}catch{}try{await chrome.alarms.clear(Ye)}catch{}}return{ok:T,stored:R}}return{ok:!0,stored:!1}}catch{return{ok:!1,stored:!1}}}async function og(){var e,t,n,r,s,a,i;if(!(!jt()||!Mr())&&Ce==null){try{const o=`${z.BACKEND_BASE_URL}/discover_workflows/sessions/latest`,d=await ut(),p={...d!=null&&d.token?{Authorization:`Bearer ${d.token}`}:{}},h=await(await fetch(o,{headers:p})).json();at=(e=h==null?void 0:h.metadata)==null?void 0:e.job_id;const g=(t=h==null?void 0:h.metadata)==null?void 0:t.job_start_time;Xe=$t(g||void 0)??void 0;let b=null;try{const S=l.getState(),C=$e(S),I=(s=(r=(n=C==null?void 0:C.userData)==null?void 0:n.active_organization)==null?void 0:r.super_organization)==null?void 0:s.id,D=(i=(a=C==null?void 0:C.userData)==null?void 0:a.active_organization)==null?void 0:i.id;I&&D&&(b=`${I}|${D}`)}catch{}const E=b?await cr(b):null;if(!(E&&(E!=null&&E.payload))){const{ok:S,stored:C}=await wn("");if(S&&C){try{chrome.runtime.sendMessage({messageType:"dwLatestResultsUpdated"})}catch{}try{await chrome.alarms.clear(Ye)}catch{}Ce!=null&&(clearInterval(Ce),Ce=null),at=void 0,Xe=void 0;try{chrome.runtime.sendMessage({messageType:"dwAutopollFoundNewResults"})}catch{}try{chrome.runtime.sendMessage({messageType:"dwAutopollStopped"})}catch{}return}}}catch{at=void 0,Xe=void 0}try{chrome.runtime.sendMessage({messageType:"dwAutopollStarted"})}catch{}Ce=setInterval(async()=>{var o,d;try{const p=`${z.BACKEND_BASE_URL}/discover_workflows/sessions/latest`,h=await ut(),g={...h!=null&&h.token?{Authorization:`Bearer ${h.token}`}:{}},y=await(await fetch(p,{headers:g})).json(),b=(o=y==null?void 0:y.metadata)==null?void 0:o.job_id,E=(d=y==null?void 0:y.metadata)==null?void 0:d.job_start_time,S=$t(E||void 0),C=S??void 0,I=!!(at&&b&&b!==at),D=(()=>typeof C=="number"&&Number.isFinite(C)?typeof Xe=="number"&&Number.isFinite(Xe)?C>Xe:!0:!1)();if(I||D){const{ok:P,stored:v}=await wn("");if(P&&v){try{chrome.runtime.sendMessage({messageType:"dwLatestResultsUpdated"})}catch{}try{await chrome.alarms.clear(Ye)}catch{}}Ce!=null&&(clearInterval(Ce),Ce=null),at=void 0,Xe=void 0;try{chrome.runtime.sendMessage({messageType:"dwAutopollFoundNewResults"})}catch{}try{chrome.runtime.sendMessage({messageType:"dwAutopollStopped"})}catch{}}}catch{}},5e3)}}async function ig(){Ce!=null&&(clearInterval(Ce),Ce=null),at=void 0,Xe=void 0;try{chrome.runtime.sendMessage({messageType:"dwAutopollStopped"})}catch{}}function So(){return{running:Ce!=null}}const cg="DWStreamingQueueDB",lg=1,Ue="actions",qt=()=>new Promise((e,t)=>{const n=indexedDB.open(cg,lg);n.onupgradeneeded=r=>{const s=r.target.result;s.objectStoreNames.contains(Ue)||s.createObjectStore(Ue,{keyPath:"action_id"})},n.onsuccess=r=>e(r.target.result),n.onerror=()=>t(n.error)});async function To(e,t){const n=await qt(),r=n.transaction([Ue],"readwrite"),s=r.objectStore(Ue);await new Promise((a,i)=>{const o=s.put({action_id:e,payload:t});o.onsuccess=()=>a(),o.onerror=()=>i(o.error||new Error("enqueueAction request error")),r.oncomplete=()=>n.close(),r.onerror=()=>i(r.error||new Error("enqueueAction transaction error"))});try{await uo()&&await Il(e,t)}catch{}}async function Eo(e){const t=await qt(),n=t.transaction([Ue],"readonly"),r=n.objectStore(Ue),s=[];return await new Promise((a,i)=>{const o=r.openCursor();o.onsuccess=()=>{const d=o.result;if(!d){a();return}if(s.push(d.value),s.length>=e){a();return}d.continue()},o.onerror=()=>i(o.error)}),await new Promise(a=>{n.oncomplete=()=>{t.close(),a()}}),s}async function dg(e){if(!e.length)return;const t=await qt(),n=t.transaction([Ue],"readwrite"),r=n.objectStore(Ue);await Promise.all(e.map(s=>new Promise((a,i)=>{const o=r.delete(s);o.onsuccess=()=>a(),o.onerror=()=>i(o.error)}))),await new Promise(s=>{n.oncomplete=()=>{t.close(),s()}})}async function ug(){const e=await qt(),t=e.transaction([Ue],"readwrite"),n=t.objectStore(Ue);let r=0;return await new Promise((s,a)=>{const i=n.openCursor();i.onsuccess=()=>{const o=i.result;if(!o){s();return}const d=o.delete();d.onsuccess=()=>{r+=1,o.continue()},d.onerror=()=>a(d.error)},i.onerror=()=>a(i.error)}),await new Promise(s=>{t.oncomplete=()=>{e.close(),s()}}),r}const pg=e=>new Promise((t,n)=>{if(!e){t(null);return}const r=new FileReader;r.onloadend=()=>t(r.result),r.onerror=n,r.readAsDataURL(e)}),hg=10;let Ur=!1;const gg=1e3,Io=!1;async function mg(){try{return await Ll()}catch(e){return X(e,{tags:{component:"long_running_recorder_streaming"},extra:{message:"Error checking if streaming should be enabled"}}),!1}}function fg(e){try{const t=e.match(/^data:(.*?);base64,(.*)$/);if(!t)return null;const n=t[1]||"image/jpeg",r=t[2],s=atob(r),a=s.length,i=new Uint8Array(a);for(let o=0;o<a;o+=1)i[o]=s.charCodeAt(o);return new Blob([i],{type:n})}catch{return null}}async function yg(e,t={}){var n,r;try{if(!e)return{blob:null,imageWidth:null,imageHeight:null,relativeActionX:null,relativeActionY:null};let s=null;if(typeof e=="string"?s=fg(e):e instanceof Blob&&(s=e),!s)return{blob:null,imageWidth:null,imageHeight:null,relativeActionX:null,relativeActionY:null};const a=await createImageBitmap(s),i=typeof t.devicePixelRatio=="number"&&t.devicePixelRatio>1?t.devicePixelRatio:1,o=Math.round(a.width/i),d=Math.round(a.height/i),p=new OffscreenCanvas(o,d),h=p.getContext("2d");if(!h)return{blob:s,imageWidth:null,imageHeight:null,relativeActionX:null,relativeActionY:null};h.drawImage(a,0,0,o,d);const g=2048,y=768,b=!!t.position&&typeof((n=t.position)==null?void 0:n.x)=="number"&&typeof((r=t.position)==null?void 0:r.y)=="number";let E,S=null,C=null;if(b){const I=t.position,D=(I.x||0)/i,P=(I.y||0)/i,v=o>=d,k=Math.min(y,Math.min(o,d)),A=Math.min(g,Math.max(o,d)),q=Math.min(v?A:k,o),x=Math.min(v?k:A,d);let u=Math.max(0,Math.floor(D-q/2)),T=Math.max(0,Math.floor(P-x/2));u+q>o&&(u=o-q),T+x>d&&(T=d-x),E=new OffscreenCanvas(q,x);const R=E.getContext("2d");if(!R)return{blob:s,imageWidth:null,imageHeight:null,relativeActionX:null,relativeActionY:null};R.drawImage(p,u,T,q,x,0,0,q,x);const N=Math.min(q,x);if(N>y){const G=y/N,_=Math.round(q*G),m=Math.round(x*G),c=new OffscreenCanvas(_,m),f=c.getContext("2d");if(!f)return{blob:s,imageWidth:null,imageHeight:null,relativeActionX:null,relativeActionY:null};f.drawImage(E,0,0,_,m),E=c,S=(D-u)*G,C=(P-T)*G}else S=D-u,C=P-T}else{let I=o,D=d;const P=Math.max(I,D);if(P>g){const A=g/P;I=Math.round(I*A),D=Math.round(D*A)}const v=Math.min(I,D);if(v>y){const A=y/v;I=Math.round(I*A),D=Math.round(D*A)}E=new OffscreenCanvas(I,D);const k=E.getContext("2d");if(!k)return{blob:s,imageWidth:null,imageHeight:null,relativeActionX:null,relativeActionY:null};if(k.drawImage(p,0,0,I,D),b){const A=t.position,q=(A.x||0)/i,x=(A.y||0)/i,u=I/o;S=q*u,C=x*u}}try{const I=await E.convertToBlob({type:"image/jpeg",quality:.8});return Io&&S!=null&&C!=null,{blob:I,imageWidth:E.width,imageHeight:E.height,relativeActionX:S,relativeActionY:C}}catch{const I=await E.convertToBlob();return Io&&S!=null&&C!=null,{blob:I,imageWidth:E.width,imageHeight:E.height,relativeActionX:S,relativeActionY:C}}}catch{return{blob:null,imageWidth:null,imageHeight:null,relativeActionX:null,relativeActionY:null}}}function _g(e){let t="click";switch(e.kind){case"mouse_click_action":case"mouse_start_drag_action":case"mouse_end_drag_action":case"mouse_cancel_drag_action":t="click";break;case"keyboard_action":case"keyboard_sequence_action":case"keyboard_combination_action":t="type";break;case"scroll_action":t="scroll";break;default:t="click"}let n;const r=(e.target_tag||"").toLowerCase();return["input","button","select","textarea","a"].includes(r)&&(n=r==="a"?"link":r),{mappedType:t,mappedKind:n}}async function wg(e){var r;if(!e)return{base64:"",imageFormat:"jpeg"};if(typeof e=="string"){const s=e.match(/^data:image\/(.*?);base64,(.*)$/);return s?{imageFormat:s[1]||"jpeg",base64:s[2]}:{base64:"",imageFormat:"jpeg"}}const t=await pg(e);if(!t)return{base64:"",imageFormat:"jpeg"};const n=t.match(/^data:image\/(.*?);base64,(.*)$/);return n?{imageFormat:n[1]||"jpeg",base64:n[2]}:{imageFormat:((r=e.type)==null?void 0:r.split("/")[1])||"webp",base64:t}}function bg(e){if(!e||typeof e!="object")return e;const t={};for(const n of Object.keys(e))e[n]!==void 0&&(t[n]=e[n]);return t}const vg=e=>["enter","return","tab","escape"].includes(e.toLowerCase()),Sg={space:" ",period:".",dot:".",comma:",",minus:"-",dash:"-",plus:"+",equals:"=",semicolon:";",colon:":",quote:"'",doublequote:'"',backslash:"\\",forwardslash:"/",slash:"/",underscore:"_",leftbracket:"[",rightbracket:"]",leftparen:"(",rightparen:")",leftbrace:"{",rightbrace:"}",lessthan:"<",greaterthan:">",questionmark:"?",exclamation:"!",at:"@",hash:"#",dollar:"$",percent:"%",caret:"^",ampersand:"&",asterisk:"*",tilde:"~",backtick:"`",pipe:"|"},bn=(e,t=!1)=>!e||e.length===0?"":t||e.some(n=>vg(n))?`Press ${e.join(" + ")}`:`Type "${e.map(n=>{const r=n.toLowerCase();return Sg[r]||n}).join("")}"`;function Tg(e){let t=typeof e.description=="string"?e.description:"";if(t=t.trim().slice(0,gg),t)return t;if((e==null?void 0:e.kind)==="keyboard_combination_action"&&(e!=null&&e.keys))return bn(e.keys,!0);if((e==null?void 0:e.kind)==="keyboard_sequence_action"&&(e!=null&&e.keys))return bn(e.keys,!1);if((e==null?void 0:e.kind)==="keyboard_action"&&(e!=null&&e.key)&&(e!=null&&e.modifiers)){const{modifiers:r}=e,s=Object.values(r).filter(a=>a).length;if(s>1||s>0&&!r.shiftKey){const a=[];return r.metaKey&&a.push("cmd"),r.ctrlKey&&a.push("ctrl"),r.altKey&&a.push("alt"),r.shiftKey&&a.push("shift"),a.push(e.key),bn(a,!0)}return bn([e.key],!1)}const{mappedType:n}=_g(e);return n==="type"?"Type text":n==="scroll"?"Scroll page":"Click element"}async function Eg(){var t,n,r,s,a,i,o,d,p,h,g,y,b,E,S,C,I,D,P,v,k,A,q,x,u,T,R,N,G;if(!await mg())return;let e=!1;try{const _=ce(l.getState());e=!!((_==null?void 0:_.lrr2025)??(_==null?void 0:_.lrr_2025))}catch{e=!1}if(e){if(Ur)return;Ur=!0;try{for(;;){const _=await Eo(hg);if(!_.length)break;const m={metadata:{action_count:_.length},actions:_.map(f=>f.payload)};oe({message:"dw_streaming_actions_to_cortex",category:"long_running_recorder_streaming",level:"info",data:{actionCount:_.length}});let c=0;try{const f=await vt.post(`${bt}/api/v1/long_recorder/actions/stream_data`,m),w=((t=f==null?void 0:f.data)==null?void 0:t.results)||[],O=w.filter(j=>j==null?void 0:j.success).map(j=>j.action_id);if(O.length){await dg(O);try{await kl(O,Date.now())}catch{}}c=O.length;const M=_.length-c;oe({message:"dw_streaming_actions_completed",category:"long_running_recorder_streaming",level:"info",data:{actionCount:_.length,successCount:c,failureCount:M}});try{const j=((n=f==null?void 0:f.headers)==null?void 0:n[ne.toLowerCase()])||((s=(r=f==null?void 0:f.config)==null?void 0:r.headers)==null?void 0:s[ne])||((i=(a=f==null?void 0:f.config)==null?void 0:a.headers)==null?void 0:i[ne.toLowerCase()]),B=((o=f==null?void 0:f.headers)==null?void 0:o[re.toLowerCase()])||((p=(d=f==null?void 0:f.config)==null?void 0:d.headers)==null?void 0:p[re])||((g=(h=f==null?void 0:f.config)==null?void 0:h.headers)==null?void 0:g[re.toLowerCase()]);le("DW.Streaming.BatchSuccess",{actionCount:_.length,successCount:c,failureCount:M,sessionId:j,requestId:B})}catch{}if(M>0){const j=w.filter(B=>!(B!=null&&B.success));oe({message:"dw_streaming_individual_failures",category:"long_running_recorder_streaming",level:"warning",data:{failures:j}});try{const B=((y=f==null?void 0:f.headers)==null?void 0:y[ne.toLowerCase()])||((E=(b=f==null?void 0:f.config)==null?void 0:b.headers)==null?void 0:E[ne])||((C=(S=f==null?void 0:f.config)==null?void 0:S.headers)==null?void 0:C[ne.toLowerCase()]),ae=((I=f==null?void 0:f.headers)==null?void 0:I[re.toLowerCase()])||((P=(D=f==null?void 0:f.config)==null?void 0:D.headers)==null?void 0:P[re])||((k=(v=f==null?void 0:f.config)==null?void 0:v.headers)==null?void 0:k[re.toLowerCase()]);le("DW.Streaming.BatchPartialFailure",{actionCount:_.length,failures:j,sessionId:B,requestId:ae})}catch{}}}catch(f){X(f,{tags:{component:"dw_streaming_queue"},extra:{message:"[DW] Error streaming actions from DW queue"}});try{const w=((q=(A=f==null?void 0:f.response)==null?void 0:A.headers)==null?void 0:q[ne.toLowerCase()])||((u=(x=f==null?void 0:f.response)==null?void 0:x.config)==null?void 0:u.headers)&&(f.response.config.headers[ne]||f.response.config.headers[ne.toLowerCase()]),O=((R=(T=f==null?void 0:f.response)==null?void 0:T.headers)==null?void 0:R[re.toLowerCase()])||((G=(N=f==null?void 0:f.response)==null?void 0:N.config)==null?void 0:G.headers)&&(f.response.config.headers[re]||f.response.config.headers[re.toLowerCase()]);le("DW.Streaming.BatchFailure",{error:(f==null?void 0:f.message)||"network_error",sessionId:w,requestId:O})}catch{}break}if(c===0)break}}finally{Ur=!1}}}let ko=null;const Co=/^(chrome-extension:\/\/[^/]+\/|chrome:\/\/|extension:\/\/|edge:\/\/|opera:\/\/settings|arc:\/\/extensions\/|[^:]+:\/\/extensions\/).*/,Fr=async(e,t,n="click",r)=>{var o,d,p,h,g,y,b,E,S,C,I,D,P;let s,a,i=null;try{t?s=t:s=await Jt(),a=(()=>{const{base64Image:v,...k}=s;return k})(),i=(s==null?void 0:s.base64Image)??null,n==="click"&&(ko=i)}catch(v){const k=await Gn(),A={timestamp:e.timestamp,scribeId:k.scribeId,privacyScreen:k.privacyScreen};(o=v==null?void 0:v.message)!=null&&o.includes("This request exceeds the MAX_CAPTURE_VISIBLE_TAB_CALLS_PER_SECOND quota.")?(i=ko,F("fallback_screenshot_taken")):(Z("screenshot_upload_failed",{errorMessage:v==null?void 0:v.message}),F("screenshot_upload_failed",{reason:"chrome_failed_screenshot_capture",errorName:(d=v==null?void 0:v.metadata)==null?void 0:d.errorName,errorMessage:v==null?void 0:v.message,errorStack:v==null?void 0:v.stack,screenshot_data:A,actionUrl:e.url,fallbackMethodCaptureUrl:(p=v==null?void 0:v.metadata)==null?void 0:p.fallbackMethodCaptureUrl,x:(h=e==null?void 0:e.position)==null?void 0:h.x,y:(g=e==null?void 0:e.position)==null?void 0:g.y,selector:e==null?void 0:e.target_selector,screenshotAttemptId:(s==null?void 0:s.attemptId)??((y=v==null?void 0:v.metadata)==null?void 0:y.screenshotAttemptId)??null,captureDuration:((b=v==null?void 0:v.metadata)==null?void 0:b.captureDuration)||null,failDuration:((E=v==null?void 0:v.metadata)==null?void 0:E.failDuration)||null,wasEarlyScreenshot:(s==null?void 0:s.wasEarlyScreenshot)??!1,wasFallback:(s==null?void 0:s.wasFallback)??((S=v==null?void 0:v.metadata)==null?void 0:S.wasFallback)??null,didNotAttemptFallback:(C=v==null?void 0:v.metadata)==null?void 0:C.didNotAttemptFallback,was_in_iframe:(e==null?void 0:e.was_in_iframe)??null}),l.dispatch(Ts({tempId:e.tempId,partialAction:{failed_ss:!0,screenshot_upload_status:te.UPLOAD_STATUS.ERROR}})))}if(i){const v=i==null?void 0:i.split(",")[1],{scribeId:k,privacyScreen:A}=await Gn(),{domUpload:q}=r||ce(l.getState());if(n==="click"&&e.domString&&q){const x=((P=(D=(I=l.getState())==null?void 0:I.auth)==null?void 0:D.userData)==null?void 0:P.email)||null;Nl(V,k,e.tempId,e.domString,e.timestamp,0,null,A,x).catch(u=>{const T={scribeId:k,timestamp:e.timestamp};F("dom_upload_queued_for_retry",{dom_data:T,error:u.message})})}Ss(k,A,e.tempId,v,e.timestamp,0,a).catch(x=>{const u={...x},T={scribeId:k,timestamp:e.timestamp,privacyScreen:A};F("screenshot_upload_queued_for_retry",{screenshot_data:T,error:x.message}),Z("screenshot_upload_queued_for_retry",u)})}},Do=(e,t,n)=>{var g;const r=["domString","key","target_element"],s=Ji.omit({...e.action},r),a=ee(l.getState());F("action_captured",{action:s});const i=l.getState(),{status:o}=we(i),d=ce(i);if(o===ge.PAUSED_RECORDING||o===ge.ENDING_RECORDING||o===ge.IDLE){n();return}const p={...e.action,favIconUrl:t.tab&&t.tab.favIconUrl,tabId:t.tab&&t.tab.id,tempId:qe()},{domString:h}=p;if(delete p.domString,a.actionsQueue.length===0&&p.url&&!((g=Bn(i))!=null&&g.scribeId)&&(Co.test(p.url)||vs(p)),p.kind===te.MOUSE_ACTIONS.START_DRAG)je(p);else if(p.kind===te.MOUSE_ACTIONS.END_DRAG)je({...p,screenshot_url:null,dom_url:null,screenshot_upload_status:te.UPLOAD_STATUS.WAITING}),(async()=>{const y=await Jt(),b=(()=>{const{base64Image:S,...C}=y;return C})(),E=(y==null?void 0:y.base64Image)??null;if(E){const S=E==null?void 0:E.split(",")[1],{scribeId:C,privacyScreen:I}=await Gn();Ss(C,I,p.tempId,S,p.timestamp,0,b).catch(D=>{const P={...D},v={scribeId:C,timestamp:p.timestamp,privacyScreen:I};F("screenshot_upload_queued_for_retry",{screenshot_data:v,error:D.message}),Z("screenshot_upload_queued_for_retry",P)})}})();else if(p.kind===te.MOUSE_ACTIONS.CANCEL_DRAG)je(p);else if(p.kind===te.MOUSE_ACTIONS.CLICK)je({...p,screenshot_url:null,dom_url:null,screenshot_upload_status:te.UPLOAD_STATUS.WAITING}),(async()=>{let y;if(p!=null&&p.earlyScreenshotTimestamp){const b=`early-screenshot-${p.earlyScreenshotTimestamp}`,E=await new Promise(async S=>{let C=0;for(;C<5;){const I=(await chrome.storage.session.get(b))[b];if(I){chrome.storage.session.remove(b),S(I);break}C++,await new Promise(D=>{setTimeout(D,200)})}});E&&(y={base64Image:E,attemptId:Math.random().toString(),successDuration:0,wasEarlyScreenshot:!0,wasFallback:!1,didNotAttemptFallback:!0})}p.domString=h,await Fr(p,y,"click",d)})();else if(p.kind===te.KEYBOARD_ACTIONS.PRESS){const{modifiers:y={}}=p,{shiftKey:b=!1,altKey:E=!1,ctrlKey:S=!1,metaKey:C=!1}=y,I=[b,E,S,C].filter(Boolean).length;(I>1||I>0&&!b)&&d.screenshotWithKeyboardCombo===!0?(je({...p,screenshot_url:null,dom_url:null,screenshot_upload_status:te.UPLOAD_STATUS.WAITING}),(async()=>await Fr(p,null,"keyboard_combo",d))()):je(p)}else if(p.kind===te.INPUT_BLUR){const y=a.actionsQueue[a.actionsQueue.length-1];if(y&&y.kind!==te.KEYBOARD_ACTIONS.PRESS)return;je({...p,screenshot_url:null,dom_url:null,screenshot_upload_status:te.UPLOAD_STATUS.WAITING}),(async()=>await Fr(p,null,"click",d))()}else je(p)},Ig=(e,t,n)=>{const r=l.getState(),s=ee(r),a=Bn(r),i=tt(r),o=d=>{const p=tt(d);return zn(ee(d).actionsQueue,Le(d).os,Es(d),!!p)};return((d,p)=>{if(p)return!1;switch(d){case Vn.AUDIO_ONLY:return i&&s.actionsQueue.length===0;case Vn.ALWAYS:return s.actionsQueue.length===0;case Vn.NEVER:return!1;default:return!1}})(e.setFirstAction,!!(a!=null&&a.scribeId))?(Y().then(d=>{d&&!Co.test((d==null?void 0:d.url)||"")&&vs({url:d.url??"",tabId:d.id??0}),n({actions:o(l.getState()),deletedActionIds:ee(l.getState()).deletedActionIds||[]})}),!0):(n({actions:o(l.getState()),deletedActionIds:ee(l.getState()).deletedActionIds||[]}),!1)},kg=e=>Ml(rl,e),Cg=e=>Ul(sl,e);function Ao(e,t){const{extensionSidepanel2024q1:n}=ce(l.getState()),r=Qi()||0;if(n||r>128){const s={url:e.startingUrl||"",id:e.scribe.id,name:e.scribe.name,location:e.location,actionIndex:e.scribe.actionIndex||""};l.dispatch(Zi(s)),e.isOnPages?(chrome.action.setPopup({popup:"src/scripts/confirm-guide-me/index.html"}),chrome.action.openPopup(),chrome.action.setPopup({popup:""})):chrome.windows.getLastFocused({populate:!1},a=>{a.id&&(e.targetWindowId=a.id,mo(e,V))})}else Mh(e,V)}const Ro=50,Dg=3,Ag=[1e3,2e3,5e3];let Wt=[],$r=null;const Rg=5e3;async function Oo(e,t=0){var n;try{const r={metadata:{url_count:e.length,batch_timestamp:Date.now()},urls:e.map(a=>({url:a.url,timestamp:new Date(a.timestamp).toISOString(),user_id:a.user_id,active_org_id:a.active_org_id,super_org_id:a.super_org_id,app_tag_uuid:a.app_tag_uuid}))},s=await vt.post(`${bt}/api/v1/long_recorder/actions/stream_url`,r);return oe({message:"url_streaming_success",category:"url_streaming",level:"info",data:{urlCount:e.length,retryCount:t}}),s}catch(r){if((!r.response||((n=r.response)==null?void 0:n.status)>=500)&&t<Dg){const s=Ag[t];return oe({message:"url_streaming_retry_attempt",category:"url_streaming",level:"warning",data:{retryCount:t+1,delay:s,error:r.message,urlCount:e.length}}),await new Promise(a=>setTimeout(a,s)),Oo(e,t+1)}throw X(r,{tags:{component:"url_streaming"},extra:{message:"Failed to stream URLs after all retries",urlCount:e.length,retryCount:t}}),r}}async function Og(e){try{const t=await V.post("/app_tag/batch_search/",{urls:e}),n=new Map;if(t.data&&Array.isArray(t.data))for(const r of t.data)r&&typeof r.url=="string"&&n.set(r.url,r.id??null);return n}catch(t){return console.error("[URL Streaming] Failed to fetch app tag UUIDs:",t),new Map}}async function xg(){if(Wt.length===0)return;const e=[];for(let t=0;t<Wt.length;t+=Ro)e.push(Wt.slice(t,t+Ro));Wt=[];for(const t of e)try{const n=[...new Set(t.map(a=>a.url))],r=await Og(n),s=t.map(a=>{const i=r.get(a.url);return{...a,app_tag_uuid:i??void 0}});await Oo(s)}catch(n){console.error(`[URL Streaming] Failed to stream batch of ${t.length} URLs:`,n)}}function Pg(){$r&&clearTimeout($r),$r=setTimeout(()=>{xg().catch(e=>{console.error("[URL Streaming] Error in batch processing:",e)})},Rg)}function Lg(e){if(!e.url||!e.timestamp){console.warn("[URL Streaming] Missing required fields, skipping:",e);return}Wt.push(e),e.url,Pg()}var Ng=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};Ng.SENTRY_RELEASE={id:"8effd506599f6fafb1a48c2ce96f05fa857d4332"};let xo=0;const Mg=()=>{const e=performance.now();let t=0;for(let r=1;r<6e6;r++)t+=Math.sqrt(r)*Math.sin(r%360)*Math.cos(Math.random()*r)/(Math.log(r+1)+1);const n=performance.now();return globalThis.cpuResult=t,Math.floor(n-e)},jr=async()=>{var n,r;Kn(),await chrome.storage.local.remove("persist:localStorage"),l.dispatch({type:"PURGE_REDUX"});const e=await dc();l.dispatch(Qp(e)),await yn(),Jg();try{try{indexedDB.deleteDatabase("LongRunningRecorderDB")}catch{}try{indexedDB.deleteDatabase("SuggestedScribesDB")}catch{}try{indexedDB.deleteDatabase("RejectedLongSummariesDB")}catch{}const s=ce(l.getState());if((s==null?void 0:s.lrr2025)??(s==null?void 0:s.lrr_2025)){const[a]=await Promise.all([Rl(),qt(),vl()]);a&&a.close();try{await Promise.all([Ol(),Sl()])}catch{}}}catch{}chrome.runtime.getPlatformInfo(s=>{s&&l.dispatch(Xp(s.os))});const t=Mg();l.dispatch(Zp({bench:t,cores:(navigator==null?void 0:navigator.hardwareConcurrency)??null,rtt:((n=navigator==null?void 0:navigator.connection)==null?void 0:n.rtt)??null,downlink:((r=navigator==null?void 0:navigator.connection)==null?void 0:r.downlink)??null})),(await gl()).isSupported||(or("recordingControlsPreference","floating-button"),chrome.runtime.sendMessage({messageType:"optionsChanged"})),Promise.all([Qs(),Zs()]).then(([s,a])=>{Array.isArray(s)||yl([]),Array.isArray(a)||_l([])})};chrome.runtime.onStartup.addListener(async()=>{await jr(),St({callSource:"onStartup listener"}).then(e=>{e&&Wo()}),_t(),await Is.flush();try{vo()}catch{}chrome.runtime.reload()}),chrome.runtime.onInstalled.addListener(async e=>{to(),e.reason===chrome.runtime.OnInstalledReason.INSTALL?(jr(),Z("installed_extension"),F("extension_installed"),chrome.runtime.setUninstallURL(ec)):e.reason===chrome.runtime.OnInstalledReason.UPDATE&&jr(),St({callSource:"onInstalled listener"}).then(t=>{t&&Wo(),e.reason===chrome.runtime.OnInstalledReason.INSTALL&&$g(t)});try{vo()}catch{}});const qr=async()=>{const{permissions:e,origins:t}=await chrome.permissions.getAll(),n=t.includes("<all_urls>");return n||F("permissions_missing",{origins:t,permissions:e}),l.dispatch(eh(!n)),n},Ug=e=>{chrome.action.getUserSettings().then(t=>{(e==null?void 0:e.extension_currently_pinned)!==t.isOnToolbar&&(V.patch("/users/growth_state/",{extension_currently_pinned:t.isOnToolbar}),Z(t.isOnToolbar?"extension_pinned":"extension_unpinned"))})},St=async e=>{var t,n;try{await tc();const[r,s,a]=await Promise.all([V.get("/users/"),V.get("/users/growth_state/"),V.get("/users/user_settings/")]);let i=r==null?void 0:r.data;try{const o=[i==null?void 0:i.active_organization,...(i==null?void 0:i.organizations)||[]].filter(Boolean),d=[...new Set(o.map(g=>{var y;return(y=g==null?void 0:g.super_organization)==null?void 0:y.id}).filter(Boolean))],p=(await Promise.all(d.map(g=>V.get(`/super_organization_admin/${g}/`).then(y=>{var b;return{id:g,role:(b=y==null?void 0:y.data)==null?void 0:b.role}}).catch(y=>(X(y,{extra:{title:"Error fetching super organization role"}}),null))))).filter(g=>g&&g.role).reduce((g,{id:y,role:b})=>({...g,[y]:b}),{}),h=g=>{var b;if(!((b=g==null?void 0:g.super_organization)!=null&&b.id))return g;const y=p[g.super_organization.id];return y?{...g,super_organization:{...g.super_organization,role:y}}:g};i={...i,active_organization:h(i.active_organization),organizations:((t=i.organizations)==null?void 0:t.map(h))||[]}}catch(o){X(o,{extra:{title:"Error enriching user data with roles"}})}return r&&r.status===200?(vh(i),l.dispatch(At(i)),l.dispatch(nc(a==null?void 0:a.data)),i&&(F("user_logged_in",{email:i.email,options:e}),rc({email:i.email}),sc(i,s==null?void 0:s.data),(n=s==null?void 0:s.data)!=null&&n.installed_extension?l.dispatch(ks(s==null?void 0:s.data)):(V.patch("/users/growth_state/",{installed_extension:!0}),l.dispatch(ks({...s==null?void 0:s.data,installed_extension:!0}))),l.dispatch(ac({api:V})),Ug(s==null?void 0:s.data),zh()),i):(l.dispatch(At(null)),null)}catch(r){if(await _t())return l.dispatch(At(null)),null;X({title:"Error fetching user",err:r}),console.error("Error fetching user",r)}return null},Fg=async()=>{var t,n,r;let e=!1;try{await new Promise(a=>setTimeout(a,200));const s=(t=await chrome.storage.managed.get())==null?void 0:t.SuppressWelcomeTab;s===!0||s===1||s==="1"||s==="true"?(e=!0,F("suppress_welcome_tab_active",{matchedValue:s,matchedType:typeof s})):s!==void 0&&F("suppress_welcome_tab_unexpected_value",{unexpectedValue:s,unexpectedType:typeof s})}catch(s){F("suppress_welcome_tab_error",{error:s.message||s,errorType:s.name,errorStack:s.stack}),X({title:"Error checking managed storage for SuppressWelcomeTab",error:s})}if(!e)try{const s=await chrome.tabs.query({index:0,lastFocusedWindow:!0});if(s.length>0){const a=s[0];((n=a.url)!=null&&n.includes("altamed.org")||(r=a.url)!=null&&r.includes("login.microsoftonline.com"))&&(e=!0,F("suppress_welcome_tab_altamed_domain_detected"))}}catch(s){F("altamed_domain_check_error",{error:s.message||s,errorType:s.name,errorStack:s.stack})}return e},$g=async e=>{if(!oc){if(await Fg()){F("suppress_welcome_tab_managed_policy_set");return}e?chrome.tabs.query({currentWindow:!0}).then(t=>{t=t.filter(n=>n.url.includes(Hn())),t.length>0?chrome.tabs.update(t[0].id,{highlighted:!0,url:Cs()}):chrome.tabs.create({url:Cs()})}):chrome.tabs.create({url:ic()})}},Po=(e,t,n)=>{var d;l.dispatch(Qn());const{networkError:r,s3ConnectionError:s,backendConnectionError:a,networkOrServerError:i}=It(l.getState());e.targetTaskId&&l.dispatch(Jn(e.targetTaskId));const o=p=>{F("browser_start_recording",{request:e}),l.dispatch(Zn(e.source)),Bt(p,void 0,e.entryPoint),n({isRecording:!0})};if(!Ee(l.getState())){if(e.startRecordingFromNewTab||e.startRecordingFromUrl){const p=e.startRecordingFromUrl&&e.url?e.url:Ws;chrome.tabs.create({url:p}).then(h=>{if(r||s||a){l.dispatch(Ut(!0)),l.dispatch(ze(!0)),F("create_new_tab_error",{networkOrServerError:i});return}h.status==="complete"?o(h):dm(h,o)})}else e.targetTabId&&chrome.tabs.query({}).then(p=>{p=p.filter(h=>h.id===e.targetTabId),chrome.extension.isAllowedFileSchemeAccess().then(h=>{if(p.length>0&&!Re(p[0].url,h)){if(chrome.tabs.update(p[0].id,{active:!0}),chrome.windows.update(p[0].windowId,{focused:!0}),r||s||a){F("browser_initiated_recording_failed",{networkOrServerError:i}),l.dispatch(Ut(!0));return}o(p[0])}else n({isRecording:!1,isAllowedFileSchemeAccess:h})})});if(ht()){const p=e.targetTabId||((d=t==null?void 0:t.tab)==null?void 0:d.id);e.targetWindowId?et(e.targetWindowId,Q.Recorder,{frontendUrl:z.FRONTEND_URL}):p?Ie(p,Q.Recorder,{frontendUrl:z.FRONTEND_URL}):F("side_panel_not_opened",{reason:"No target tab nor window ID provided",request:e,sender:t,function:"browserStartRecording"})}return chrome.action.setPopup({popup:""}),!0}},Wr=(e,t,n,r=!1)=>{var p;const{networkError:s,s3ConnectionError:a,backendConnectionError:i,networkOrServerError:o}=It(l.getState()),d=h=>{F("edit_recording_for",{request:e}),Z("edited_file_add_recording",{platform:qs(),capture_type:"extension",file_id:e.scribeId});const g=r?"recapture":void 0;Bt(h,e.scribeId,g),n({status:"success"})};if(!Ee(l.getState())){if(Y().then(h=>{l.dispatch(Hc(h==null?void 0:h.id))}),!e.startRecordingFromNewTab&&e.targetTabId)ht()&&!r&&Ie(e.targetTabId||((p=t.tab)==null?void 0:p.id),Q.Recorder,{frontendUrl:z.FRONTEND_URL}),chrome.tabs.query({}).then(h=>{h=h.filter(g=>g.id===e.targetTabId),chrome.extension.isAllowedFileSchemeAccess().then(g=>{if(h.length>0&&!Re(h[0].url,g)){if(chrome.tabs.update(h[0].id,{active:!0}),chrome.windows.update(h[0].windowId,{focused:!0}),s||a||i){F("browser_initiated_recording_failed",{networkOrServerError:o}),l.dispatch(Ut(!0));return}d(h[0])}else n({isRecording:!1,isAllowedFileSchemeAccess:g})})});else{e.targetWindowId&&ht()&&!r&&et(e.targetWindowId,Q.Recorder,{frontendUrl:z.FRONTEND_URL});const h=Ws;chrome.tabs.create({url:h}).then(g=>{if(s||a||i){l.dispatch(Ut(!0)),l.dispatch(ze(!0)),F("create_new_tab_error",{networkOrServerError:o});return}d(g)})}return!0}n({status:"error",details:"Already recording."})},Br=e=>{e.scribeId&&l.dispatch(Xn(e)),e.entryPoint&&l.dispatch(Ls(e.entryPoint)),e.taskId?l.dispatch(Jn(e.taskId)):l.dispatch(Jn("")),l.dispatch(vc(!!e.isScribeEditMode)),chrome.action.setPopup({popup:"src/scripts/tab-selector/index.html"}),chrome.action.openPopup(),chrome.action.setPopup({popup:""})};async function Lo(e){l.dispatch(Kc(e))}const jg=(e,t,n)=>{var s,a,i;if(e.messageType==="selectMicrophone"&&e.microphoneId&&(Lo(e.microphoneId),n({status:"success"})),e.messageType==="getAuthToken")return ut().then(o=>{n(o)}).catch(o=>{console.error("[Auth] Error getting auth token:",o),n({error:o.message||"Failed to get auth token"})}),!0;if((e==null?void 0:e.messageType)==="startCopilot"){l.dispatch(Qt(!0));const o={};e!=null&&e.copilotPrompt&&(o.copilotPrompt=e.copilotPrompt),e!=null&&e.copilotSuggestionsTitle&&(o.copilotSuggestionsTitle=e.copilotSuggestionsTitle),e!=null&&e.copilotSuggestionsSubtitle&&(o.copilotSuggestionsSubtitle=e.copilotSuggestionsSubtitle),e!=null&&e.copilotSuggestedPrompts&&(o.copilotSuggestedPrompts=e.copilotSuggestedPrompts),e!=null&&e.copilotSearch&&(o.copilotSearch=e.copilotSearch),Ie((s=t.tab)==null?void 0:s.id,Q.Copilot,{queryParams:o})}if(e.messageType==="submitCopilotPrompt"&&(fo(e.sessionId),l.dispatch(Qn),!Ee(l.getState())))return Y().then(o=>{l.dispatch(Zn(e.source)),chrome.extension.isAllowedFileSchemeAccess().then(d=>{o&&!Re(o.url,d)?(Bt(o,null,tn.EXTENSION),n({isRecording:!0})):n({isRecording:!1,isAllowedFileSchemeAccess:d})})}),!0;if(e.messageType==="getDomForCopilot"&&fo(),e.messageType==="toggleDropdownExtension"){const o=Yc(l.getState());l.dispatch(ze(!o));return}if(e.messageType==="currentVisibleAction"&&(xt(!0),Ks().then(o=>{var d;(o==null?void 0:o.id)!==((d=e==null?void 0:e.action)==null?void 0:d.id)&&Ys(e.action)})),e.messageType==="guideMeStepForward"){Y().then(o=>{chrome.tabs.sendMessage(o.id,{messageType:"guideMeStepForward"})});return}if(e.messageType==="showGuideMeLoading"){Y().then(o=>{chrome.tabs.sendMessage(o.id,{messageType:"showGuideMeLoading"})});return}if(e.messageType==="hideGuideMeLoading"){Y().then(o=>{chrome.tabs.sendMessage(o.id,{messageType:"hideGuideMeLoading"})});return}if(e.messageType==="setIsAutopilot"){Y().then(o=>{chrome.tabs.sendMessage(o.id,{messageType:"setIsAutopilot",isAutopilot:e.isAutopilot})});return}if(e.messageType==="navigateActiveTabToActionUrl"){const o=(a=e==null?void 0:e.action)==null?void 0:a.url;o&&chrome.tabs.query({active:!0,lastFocusedWindow:!0},d=>{try{chrome.tabs.update(d[0].id,{url:o})}catch(p){console.error("Error updating tab with url",p)}})}if(e.messageType==="checkForLocalStorageScribes")return Kn().then(({localScribeDetected:o,scribeId:d})=>{n({localScribeDetected:o,scribeId:d})}),!0;if(e.messageType==="discardLocalStorageScribes"&&(pt(),n({message:"discarded"})),e.messageType==="getGuideMeSessionId")return cl().then(o=>{n({sessionId:o})}),!0;e.messageType==="setIsGuiding"&&(xt(e.isGuiding),e.isGuiding===!1&&nn()),e.messageType==="removeLiveOverlay"&&nn(),e.messageType==="launchRecommendedScribes"&&Pr(e.url);const r=Ee(l.getState());if(e.messageType&&e.messageType!=="editRecordingFor")if(e.messageType==="browserStartRecording")Po(e,t,n);else if(e.messageType==="browserStopRecording")chrome.tabs.create({url:`${z.FRONTEND_URL}/billing`}),vn();else if(e.messageType==="browserDeleteRecording")vn(e.isCopilot);else if(e.messageType==="browserCompleteCapture")F("browser_complete_capture",{request:e,isRecording:r,recordingControls:(i=nt(l.getState()))==null?void 0:i.recordingControlsPreference}),r&&Rt({isCopilot:e.isCopilot,copilotPrompt:e.copilotPrompt,isLocalScribe:e.isLocalScribe,isLocalImageRetry:e.isLocalImageRetry,deletedActionIds:e.deletedActionIds});else if(e.messageType==="browserPauseCapture")r&&zo();else if(e.messageType==="browserBlurCapture")chrome.tabs.query({active:!0,currentWindow:!0}).then(o=>{chrome.tabs.sendMessage(o[0].id,{messageType:"toggleBlurControls"})});else if(e.messageType==="setIsTranscribing")l.dispatch(rr(e.isTranscribing)),e.isTranscribing&&sr();else if(e.messageType==="action"){Do(e,t,n);return}else e.messageType==="updateSidepanelContentUrl"&&Y().then(o=>{var h,g,y,b;const d=(g=(h=e.url)==null?void 0:h.match(/\?url=(.*)/))==null?void 0:g[1],p=(o==null?void 0:o.url)||d;if(fs(e==null?void 0:e.url),p&&(e==null?void 0:e.url.includes(Q.Assistant))&&!e.copilotEntry){const E=((b=(y=e.url)==null?void 0:y.split("?"))==null?void 0:b[1])||"",S=new URLSearchParams(E);S.delete("url"),Ie(o==null?void 0:o.id,Q.Assistant,{queryParams:{url:p,...Object.fromEntries(S)},frontendUrl:z.FRONTEND_URL})}});if(e.messageType==="openPopup"&&Br(e),e.messageType==="recaptureStep"&&Y().then(o=>{if(o){const d={...e,isStepRecapture:!0,targetTabId:o.id,targetWindowId:o==null?void 0:o.windowId,stepRecaptureDescription:e.description};l.dispatch(Xn(d)),Wr(d,t,n,!0)}}),e.messageType==="openScribeViewer"&&Ao(e),e.messageType==="cleanupDomFromCopilot"&&chrome.tabs.query({},o=>{o.forEach(d=>{chrome.scripting.executeScript({target:{tabId:d.id},func:()=>{var p;(p=document==null?void 0:document.querySelectorAll("[_i_d]"))==null||p.forEach(h=>h==null?void 0:h.removeAttribute("_i_d"))}})})}),e.messageType==="openSidePanel"&&Ie(t.tab.id,e.route,{frontendUrl:z.FRONTEND_URL}),e.messageType==="setSidePanelRoute"){kt(l.getState())&&l.dispatch(Qt(!1)),e.entryPoint&&e.entryPoint===tn.VIEWER_INTRO_PAGE&&chrome.tabs.query({},d=>{const[p]=d.filter(h=>h.url&&h.url.includes("/intro-viewer"));p&&chrome.tabs.update(p.id,{url:Bs()},()=>{chrome.runtime.lastError&&console.error("Error updating tab:",chrome.runtime.lastError)})});const o=e.queryParams||Object.fromEntries(Object.entries({url:e.url,copilotEntry:e.copilotEntry,searchEntry:e.searchEntry,closeAssistantOnBack:e.closeAssistantOnBack}).filter(([,d])=>d!=null));Xc(e.route,{queryParams:o,frontendUrl:z.FRONTEND_URL})}if(e==="version"){n(chrome.runtime.getManifest().version);return}if(e==="options"){n(nt(l.getState()));return}if(e==="checkPermissions")return St({callSource:"checkPermissions message handler"}).then(o=>{o?n(!0):qr().then(d=>{n(d),l.dispatch(ze(!d))})}),!0;if(e.messageType==="checkServerAvailability")return _t().then(o=>{n(o)}),!0;if(e==="startRecording"){if(!r)return chrome.tabs.query({active:!0,currentWindow:!0}).then(o=>{Bt(o[0]),n({status:"success"})}),!0;n({status:"error",details:"Already recording."});return}if(e.messageType==="editRecordingFor"&&(l.dispatch(Xn(e)),Wr(e,t,n)),e==="stopRecording"){r&&Rt();return}if(e.messageType==="openUrl"&&chrome.tabs.create({url:e.url}).then(o=>{if(e.pinDocument){l.dispatch(yt(!0));const d=(p,h,g)=>{p===o.id&&h.status==="complete"&&g.status==="complete"&&(chrome.tabs.sendMessage(o.id,{messageType:"setPinDocument",document:e.pinDocument}),setTimeout(()=>{chrome.tabs.sendMessage(o.id,{messageType:"setPinDocument",document:e.pinDocument})},1e3),chrome.tabs.onUpdated.removeListener(d))};chrome.tabs.onUpdated.addListener(d)}}),e.messageType==="highlightElementWithId"){l.dispatch(Jc(e.elementId)),chrome.tabs.query({active:!0,currentWindow:!0},function(o){var d;o&&((d=o[0])!=null&&d.id)&&chrome.tabs.sendMessage(o[0].id,{messageType:"highlightElementWithId",elementId:e.elementId,url:e.url,hasScreenshot:e.hasScreenshot,modalInstruction:e.modalInstruction,sessionId:e.sessionId,requestId:e.requestId})});return}if(e.messageType==="highlightAIFallbackElement"){Ks().then(o=>{o&&Ys({...o,aiFallbackElementId:e.elementId})});return}if(e.messageType==="userEditPermission"){Y().then(o=>{chrome.tabs.sendMessage(o.id,{messageType:"userEditPermission",canEdit:e.canEdit}),ll(e.canEdit)});return}if(e.messageType==="removeCopilotClickTarget"&&(e.targetTabId?chrome.tabs.sendMessage(e.targetTabId,{messageType:"removeCopilotClickTarget"}):Y().then(o=>{chrome.tabs.sendMessage(o.id,{messageType:"removeCopilotClickTarget"})})),e.messageType==="startCopilotGenerating"&&Y().then(o=>{chrome.tabs.sendMessage(o.id,{messageType:"startCopilotGenerating"})}),e.messageType==="stopCopilotGenerating"&&Y().then(o=>{chrome.tabs.sendMessage(o.id,{messageType:"stopCopilotGenerating"})}),e==="enableExtensionNotifications")return chrome.permissions.contains({permissions:["notifications"]},function(o){o?n({status:"enabled"}):chrome.permissions.request({permissions:["notifications"]},function(d){n(d?{status:"enabled"}:{status:"disabled"})})}),!0;if(e==="isRecording"){n(r);return}if(e==="getTabs")return Ns().then(o=>n(o)),!0;if(e.messageType==="getLastFocusedWindow")return chrome.windows.getLastFocused({populate:!1},o=>{n(o)}),!0;if(e==="getRecordingState")return n(ee(l.getState())),!0;if(e.messageType==="openTabSelector")return chrome.tabs.create({url:"src/scripts/tab-selector/index.html"}),!0;if(e.messageType==="initializeRecordingPreview")return Ig(e,t,n);if(e.messageType==="updateAction"&&l.dispatch(Qc(e.action)),e==="getExtensionState"){const{status:o}=we(l.getState()),d=nt(l.getState());n({installed:!0,options:d,status:o,version:chrome.runtime.getManifest().version});return}if((e==null?void 0:e.messageType)==="setPinExtensionModalVisibility"&&chrome.storage.local.set({isPinExtensionModalVisible:e.isVisible}),e.messageType==="startDropPin"){Y().then(o=>{chrome.tabs.sendMessage(o.id,{messageType:"startDropPin"}),l.dispatch(yt(!0)),e.scribe?l.dispatch(hn(e.scribe)):l.dispatch(hn(null))});return}n({unsupportedMessage:!0})};Cg(function(e,t,n){return jg(e,t,n)});const qg=new io(2e3),Wg=async({removed:e,cookie:t,cause:n})=>{uc(t.domain)&&(t.name===pc||t.name===hc)&&t.path===gc&&n!=="overwrite"&&(e&&await mc(t)?(l.dispatch(At(null)),chrome.tabs.query({}).then(r=>{const s={messageType:"loggedOut"};r.forEach(a=>ue(a,s))}),l.dispatch(fc()),xs(Q.Home),z.FRONTEND_URL=Ps.FRONTEND_URL,z.BACKEND_BASE_URL=Ps.BACKEND_BASE_URL):qg.invoke(()=>{St({callSource:"cookieChangedListener",cause:n})}))};chrome.cookies.onChanged.addListener(Wg),chrome.cookies.onChanged.addListener(cc);const Bg=async()=>{if(chrome!=null&&chrome.notifications){const e=await V.get("/notifications/get/");if(e.status===200&&e.data.hasOwnProperty("description")){const t=qe();l.dispatch(Jp({notifId:t,res:e.data.url})),chrome.notifications.create(t,{type:"basic",iconUrl:"https://colony-labs-public.s3.us-east-2.amazonaws.com/images/logo/extension.svg",title:e.data.title,message:e.data.description})}}};(Yo=chrome==null?void 0:chrome.notifications)==null||Yo.onClicked.addListener(function(e){const{linkMap:t}=Le(l.getState());e in t&&(chrome.tabs.create({url:t[e]}),delete t[e])});const Gg=()=>{chrome.tabs.query({}).then(e=>{e.forEach(t=>{chrome.action.setBadgeText({text:"",tabId:t.id})})})},zg=()=>{chrome.tabs.create({url:Hn()})},Vg=()=>{chrome.tabs.create({url:Bs()})},Hg=()=>{chrome.tabs.create({url:Zc}),pt()},No=()=>!Ee(l.getState()),Mo=e=>{var t,n,r,s;return e?((t=e.pendingUrl)==null?void 0:t.startsWith("chrome://newtab/"))||((n=e.url)==null?void 0:n.startsWith("chrome://newtab/"))||((r=e.pendingUrl)==null?void 0:r.startsWith("edge://newtab/"))||((s=e.url)==null?void 0:s.startsWith("edge://newtab/")):!1},Kg=async e=>{var a;const t=el(l.getState()),n=ee(l.getState());if(!t)return Promise.resolve(e);let r=null,s=null;try{r=await chrome.tabs.get(e)}catch(i){s=i}if(!r)return Promise.reject(`No tab was found with an id ${e}: ${s}`);if(!r.pendingUrl&&!r.url)return Promise.reject(`Tab has no valid URLs ${r}`);if(n.actionsQueue.length!==0){if((r.pendingUrl&&Re(r.pendingUrl)||r.url&&Re(r.url))&&!Mo(r)||((a=n.currentTab)==null?void 0:a.id)===e||!r.title&&!r.url)return Promise.resolve(e);je({kind:"instruction",description:Mo(r)?"Open a new tab":`${te.SPECIAL_INDICATORS.SWITCH_TO_TAB_PREFIX}${r.title}"`,tabId:e,tempId:qe()})}return!n.recordedTabs.find(i=>i===e)&&r.title&&Fo(r).then(()=>{l.dispatch(er({tab:r,host:ar(r==null?void 0:r.url),url:r==null?void 0:r.url}))}),Promise.resolve(e)},Yg=new io(150),Xg=(e,t)=>{const{currentFocusedActiveTabId:n}=we(e),{currentFocusedActiveTabId:r}=we(t),s=ee(t);n!==r&&Kg(r).catch(console.error),t.recordingState.scribeId&&Yg.invoke(()=>{var o,d;const a=tt(t),i=zn(ee(t).actionsQueue,Le(t).os,Es(t),a||s.isTranscribing);chrome.runtime.sendMessage({messageType:"extensionStateUpdate",data:{actions:i,scribeId:t.recordingState.scribeId,isTranscribing:s.isTranscribing,audioError:s.audioError,isTranscriberReady:s.isTranscriberReady,availableMicrophones:((o=t.microphones)==null?void 0:o.availableMicrophones)??[],selectedMicrophoneId:((d=t.microphones)==null?void 0:d.selectedMicrophoneId)??null,deletedActionIds:t.recordingState.deletedActionIds||[],status:we(t).status}})})};kr(l,Xg);const Jg=()=>{chrome.tabs.query({}).then(async e=>{e.forEach(async t=>{if(t!=null&&t.url&&!Re(t.url))try{await Uo(t.id)}catch{}})})},Uo=async e=>{await chrome.scripting.executeScript({target:{tabId:e},files:[po]}),await chrome.scripting.executeScript({target:{tabId:e,allFrames:!0},files:[ho]})},Fo=async e=>{const{areaSelectorRecording:t}=ce(l.getState()),{liveBlurEnabled:n,liveBlurSettings:r}=en(l.getState()),s=ar(e==null?void 0:e.url),a=tt(l.getState()),i={host:null,href:null,retried:!1},o=e.url?e.url:e.pendingUrl,d=ht(),p=tl();if(Re(o))return i;await St({callSource:"startRecordingOnTab"}),l.dispatch(tr(e.id));try{return await ue(e,{messageType:"startRecording",areaSelectorRecording:t,liveBlurEnabled:n,liveBlurSettings:r,liveTranscriptions:d,audioRecordingEnabled:a}),p&&sr(),F("recording_started_on_tab",{tab:e,voiceTranscriptionEnabled:a}),{host:s,href:e==null?void 0:e.url,retried:!1}}catch(h){F("recording_started_on_tab_failed",{tab:e,voiceTranscriptionEnabled:a,error:h,errorMessage:h==null?void 0:h.message}),console.warn("first start recording on tab attempt failed",h)}try{return await Uo(e.id),await ue(e,{messageType:"startRecording",omitStart:!0,areaSelectorRecording:t,liveBlurEnabled:n,liveBlurSettings:r,liveTranscriptions:d,audioRecordingEnabled:a}),p&&sr(),F("recording_started_on_tab_second_attempt",{tab:e}),{host:s,href:e==null?void 0:e.url,retried:!0}}catch(h){F("recording_started_on_tab_failed",{tab:e,error:h,errorMessage:h==null?void 0:h.message}),console.warn("second start recording on tab attempt failed",h)}return Z("start_recording",{recorder:"extension",url:e.url}),{...i,retried:!0}},Bt=async(e,t,n)=>{var d;pt();const r=kt(l.getState()),s=ar(e==null?void 0:e.url);Os(),Rs();const{networkOrServerError:a}=It(l.getState());F("recording_started",{tab:e,networkOrServerError:a,recordingControls:(d=nt(l.getState()))==null?void 0:d.recordingControlsPreference}),l.dispatch(nl({currentTab:e,startTimestamp:Date.now()})),t?(l.dispatch(Gs(t)),l.dispatch(zs(!1))):(l.dispatch(Gs(qe())),l.dispatch(zs(!0))),await Fo(e);try{const p=Wn();if(p&&(e!=null&&e.id)){const h=ee(l.getState()).scribeId;p.associateCapturesWithScribe(e.id,h),p.uploadInitialScreenshotToS3(e.id,h).then(g=>{}).catch(g=>{console.error("[DOM Settlement] Failed to upload initial screenshot:",g)})}}catch(p){console.error("[DOM Settlement] Error in DOM settlement upload:",p)}n&&l.dispatch(Ls(n));let i=e.title;(!i||i==="New Tab"||i.indexOf("Scribe |")===0)&&(i="Untitled"),l.dispatch(Yp(i)),l.dispatch(er({tab:e,host:s,url:e==null?void 0:e.url})),l.dispatch(js(ge.RECORDING)),r||l.dispatch($s(!0)),Gg();const o=tt(l.getState());if(n==="recapture"){Z("recapture_started",{recorder:"extension",url:e.url});return}chrome.runtime.sendMessage({messageType:"startRecording",target:"sidepanel",data:{liveTranscriptions:ht(),frontendUrl:z.FRONTEND_URL,audioRecordingEnabled:o,inCopilotMode:r}})},vn=(e=!1)=>{const t=ee(l.getState());F("recording_deleted",{recordingState:t}),pt(),Yn({isCopilot:e})},Qg=async e=>{try{const t=await V.post("/extension_injection/",{page_url:e});if(t.status===200)return t.data.should_inject}catch(t){console.error("Error fetching extension injection",t)}return!1},Zg=1e3;setInterval(()=>{var e,t;(t=(e=chrome.runtime.sendMessage({messageType:Ds.GetSidepanelActive}))==null?void 0:e.catch)==null||t.call(e,n=>{n.message.includes("Could not establish connection. Receiving end does not exist")?(chrome.storage.local.set({sidepanelActive:!1}),chrome.storage.local.remove("askAiId")):console.error("error getting sidepanel state",n)})},Zg),chrome.storage.local.onChanged.addListener(e=>{const t=e==null?void 0:e.sidepanelActive;if(t){if(!t.oldValue&&t.newValue){const{showSidepanelFob:s}=nt(l.getState());s&&chrome.tabs.query({},a=>{a.forEach(i=>{ue(i,{messageType:"sidepanelOpened"})})})}if(t.oldValue&&!t.newValue){chrome.storage.local.remove("askAiId");const s=kt(l.getState()),a=Ee(l.getState());s&&a&&vn(),chrome.tabs.query({},i=>{i.forEach(o=>{ue(o,{messageType:Ds.SetSidepanelClosed}),chrome.scripting.executeScript({target:{tabId:o.id},func:()=>{var d;(d=document==null?void 0:document.querySelectorAll("[_i_d]"))==null||d.forEach(p=>p==null?void 0:p.removeAttribute("_i_d"))}}),ue(o,{messageType:"removeCopilotClickTarget"}),ue(o,{messageType:"stopCopilotGenerating"}),ue(o,{messageType:"stopDropPin"}),l.dispatch(yt(!1)),l.dispatch(ao(null))})}),al().then(i=>{i&&(xt(!1),vn()),nn()})}}const n=e==null?void 0:e.hiddenFobDomains;n&&(chrome.tabs.query({},s=>{s.forEach(a=>{ue(a,{messageType:"hiddenFobDomainsUpdated",hiddenDomains:n.newValue})})}),chrome.runtime.sendMessage({messageType:"hiddenFobDomainsUpdated",hiddenDomains:n.newValue}));const r=e==null?void 0:e.isGuiding;r&&xt(r.newValue==="true")}),chrome.runtime.onConnect.addListener(e=>{e.onMessage.addListener(async(t,n)=>{var r,s,a,i,o,d,p,h,g,y,b,E;if(t.messageType==="openSidePanel"){if(t.route===Q.Assistant&&!((a=(s=(r=n.sender)==null?void 0:r.url)==null?void 0:s.startsWith)!=null&&a.call(s,"http"))){const S=await chrome.tabs.query({active:!0,lastFocusedWindow:!0});await Ie((o=(i=n.sender)==null?void 0:i.tab)==null?void 0:o.id,t.route,{queryParams:{url:(d=S==null?void 0:S[0])==null?void 0:d.url,searchEntry:t.clickedFromSearch,closeAssistantOnBack:t.closeAssistantOnBack},frontendUrl:z.FRONTEND_URL})}else{const S=Ee(l.getState())?Q.Recorder:t!=null&&t.route?t.route:Q.Home;(h=(p=n==null?void 0:n.sender)==null?void 0:p.url)!=null&&h.includes("chrome-extension://")?await et((y=(g=n==null?void 0:n.sender)==null?void 0:g.tab)==null?void 0:y.windowId,S):await Ie((E=(b=n.sender)==null?void 0:b.tab)==null?void 0:E.id,t.route,{queryParams:t.route===Q.Assistant?{url:n.sender.url}:null,frontendUrl:z.FRONTEND_URL})}if(t.route===Q.Assistant){let S="extension_dropdown_open_recommended_clicked";t.clickedFromSearch&&(S="extension_dropdown_open_search"),Z(S,null,V)}else t.route===Q.Recorder&&Z("extension_dropdown_open_recorder_clicked",null,V)}})}),kg((e,t,n)=>{var r,s,a,i;if(e.messageType==="browserStartRecording"){const o=Bn(l.getState());if(o.scribeId)Wr({...e,...o},t,n);else{const{taskId:d}=ee(l.getState());e.taskId=d,Po(e,t,n)}}if(e.messageType==="openSidePanel"){et(t.tab.windowId,e.route,{queryParams:e.queryParams,frontendUrl:z.FRONTEND_URL});return}if(e.messageType==="openGuideMeSidepanel"&&mo(e,V),e.messageType==="getTabSelectorData"){const o=Sc();return n({allowMicrophone:o}),!0}if(e.messageType==="tldExtract"){const o=ul(e.url);n({result:o})}return e.messageType==="speechTranscriber"?(jh((r=e.payload)==null?void 0:r.message,(s=e.payload)==null?void 0:s.data).then(o=>{n(o)}),!0):e.messageType==="speechTranscriberV3"?(Wh((a=e.payload)==null?void 0:a.message,(i=e.payload)==null?void 0:i.data).then(o=>{n(o)}).catch(o=>{console.error("Background script: speechTranscriberV3 handler error",o),n({error:o.message})}),!0):(As().then(async()=>{var h,g,y,b,E,S,C,I,D,P,v,k,A,q,x;if(!e.messageType)return;if(e.messageType==="captureAdditionalScreenshot"){const{url:u,timestamp:T,contentScriptLoadTimestamp:R,type:N}=e,G=l.getState(),_=(g=(h=ee(G))==null?void 0:h.actionsQueue)==null?void 0:g.at(-1);if(!_||N!=="initial"&&_.timestamp>=R)return;const m=await Jt();if(!(m!=null&&m.base64Image))return;try{const{internal_url:c,download_url:f}=await Tc(m.base64Image);l.dispatch(Ts({tempId:_.tempId,partialAction:{additional_screenshot_data:{url:u,timestamp:T,type:N||"post_navigation",internal_url:c||null,download_url:f||null}}}))}catch(c){console.error("Failed to upload additional screenshot:",c)}}if(e.messageType==="runSuggestedScribeAnalysis")return;if(e.messageType==="analyzeActions"||e.messageType==="ANALYZE_LONG_RUNNING_ACTIONS")return n({success:!1,error:"Legacy analyze is removed"}),!0;if(e.messageType==="dwManualRun"){try{const u=ce(l.getState()),T=(u==null?void 0:u.lrr2025)??(u==null?void 0:u.lrr_2025),R=(u==null?void 0:u.lrrManualRefreshEnabled)??(u==null?void 0:u.lrr_manual_refresh_enabled);if(!(T&&R))return n({success:!1,error:"disabled"}),!0;sg(),n({success:!0})}catch(u){X(u,{tags:{component:"discover_workflows"},extra:{message:"[DW] Error triggering manual run"}}),n({success:!1,error:(u==null?void 0:u.message)||"Unknown error"})}return!0}if(e.messageType==="dwPollOnce"){try{const u=ce(l.getState()),T=(u==null?void 0:u.lrr2025)??(u==null?void 0:u.lrr_2025),R=(u==null?void 0:u.lrrManualRefreshEnabled)??(u==null?void 0:u.lrr_manual_refresh_enabled);if(!(T&&R))return n({success:!1,error:"disabled"}),!0;(async()=>{const N=await ag();n({success:!!(N!=null&&N.ok),stored:!!(N!=null&&N.stored)})})()}catch(u){n({success:!1,error:(u==null?void 0:u.message)||"Unknown error"})}return!0}if(e.messageType==="dwAutopollStart"){try{const u=ce(l.getState()),T=(u==null?void 0:u.lrr2025)??(u==null?void 0:u.lrr_2025),R=(u==null?void 0:u.lrrManualRefreshEnabled)??(u==null?void 0:u.lrr_manual_refresh_enabled);if(!(T&&R))return n({success:!1,error:"disabled"}),!0;(async()=>{await og();const N=So();n({success:!0,running:N.running})})()}catch(u){n({success:!1,error:(u==null?void 0:u.message)||"Unknown error"})}return!0}if(e.messageType==="dwAutopollStop"){try{const u=ce(l.getState()),T=(u==null?void 0:u.lrr2025)??(u==null?void 0:u.lrr_2025),R=(u==null?void 0:u.lrrManualRefreshEnabled)??(u==null?void 0:u.lrr_manual_refresh_enabled);if(!(T&&R))return n({success:!1,error:"disabled"}),!0;(async()=>{await ig();const N=So();n({success:!0,running:N.running})})()}catch(u){n({success:!1,error:(u==null?void 0:u.message)||"Unknown error"})}return!0}if(e.messageType==="dwCleanup")return(async()=>{var u,T,R,N,G,_,m,c,f,w,O,M,j,B,ae,ie,$,pe;try{const L=ce(l.getState()),me=(L==null?void 0:L.lrr2025)??(L==null?void 0:L.lrr_2025),Te=(L==null?void 0:L.lrrManualRefreshEnabled)??(L==null?void 0:L.lrr_manual_refresh_enabled);if(!(me&&Te)){try{chrome.runtime.sendMessage({messageType:"dwCleanupCompleted",ok:!1,status:403})}catch{}n({success:!1,status:403,error:"disabled"});return}const Se=`${bt}/api/v1/lrr/cleanup`,U=await vt.request({method:"DELETE",url:Se,data:{type:"both",dry_run:!1}}),xe=(u=U==null?void 0:U.data)==null?void 0:u.actions_deleted,Fe=(T=U==null?void 0:U.data)==null?void 0:T.results_deleted,de=((R=U==null?void 0:U.data)==null?void 0:R.total_deleted)!=null?U.data.total_deleted:typeof xe=="number"&&typeof Fe=="number"?xe+Fe:(N=U==null?void 0:U.data)==null?void 0:N.deleted_count,H=(G=U==null?void 0:U.data)==null?void 0:G.dry_run;try{const Tt=((_=U==null?void 0:U.headers)==null?void 0:_[ne.toLowerCase()])||((m=U==null?void 0:U.config)==null?void 0:m.headers)&&(U.config.headers[ne]||U.config.headers[ne.toLowerCase()]),ot=((c=U==null?void 0:U.headers)==null?void 0:c[re.toLowerCase()])||((f=U==null?void 0:U.config)==null?void 0:f.headers)&&(U.config.headers[re]||U.config.headers[re.toLowerCase()]);le("DW.API.Cleanup.Success",{status:(U==null?void 0:U.status)||200,actionsDeleted:xe,resultsDeleted:Fe,totalDeleted:de,dryRun:H,sessionId:Tt,requestId:ot})}catch{}try{chrome.runtime.sendMessage({messageType:"dwCleanupCompleted",ok:!0,totalDeleted:de,actionsDeleted:xe,resultsDeleted:Fe})}catch{}n({success:!0,status:(U==null?void 0:U.status)||200,totalDeleted:de,deletedCount:de})}catch(L){const me=((w=L==null?void 0:L.response)==null?void 0:w.status)??0;X(L,{tags:{component:"discover_workflows"},extra:{message:"[DW] Error calling cleanup endpoint",status:me}});try{const Te=((M=(O=L==null?void 0:L.response)==null?void 0:O.headers)==null?void 0:M[ne.toLowerCase()])||((B=(j=L==null?void 0:L.response)==null?void 0:j.config)==null?void 0:B.headers)&&(L.response.config.headers[ne]||L.response.config.headers[ne.toLowerCase()]),Se=((ie=(ae=L==null?void 0:L.response)==null?void 0:ae.headers)==null?void 0:ie[re.toLowerCase()])||((pe=($=L==null?void 0:L.response)==null?void 0:$.config)==null?void 0:pe.headers)&&(L.response.config.headers[re]||L.response.config.headers[re.toLowerCase()]);le("DW.API.Cleanup.Failure",{status:me,error:(L==null?void 0:L.message)||"network_error",sessionId:Te,requestId:Se})}catch{}try{chrome.runtime.sendMessage({messageType:"dwCleanupCompleted",ok:!1,status:me})}catch{}n({success:!1,status:me,error:(L==null?void 0:L.message)||"Unknown error"})}})(),!0;if(e.messageType==="dwClearLocal")return(async()=>{try{const u=ce(l.getState()),T=(u==null?void 0:u.lrr2025)??(u==null?void 0:u.lrr_2025),R=(u==null?void 0:u.lrrManualRefreshEnabled)??(u==null?void 0:u.lrr_manual_refresh_enabled);if(!(T&&R)){n({success:!1,status:403,error:"disabled"});return}const[N,G,_,m]=await Promise.all([xl(),Tl(),ug(),El()]);try{chrome.runtime.sendMessage({messageType:"dwLatestResultsUpdated"}),chrome.runtime.sendMessage({messageType:"dwHiddenUpdated"})}catch{}n({success:!0,totalDeleted:N+G+_+m})}catch(u){X(u,{tags:{component:"discover_workflows"},extra:{message:"[DW] Error clearing local DW DBs"}}),n({success:!1,error:(u==null?void 0:u.message)||"Unknown error"})}})(),!0;if(e.messageType==="dwActionLogGetEnabled")return(async()=>{try{const u=await uo();n({success:!0,enabled:!!u})}catch{n({success:!0,enabled:!1})}})(),!0;if(e.messageType==="dwActionLogSetEnabled")return(async()=>{try{await gh(!!(e!=null&&e.enabled)),n({success:!0})}catch(u){n({success:!1,error:(u==null?void 0:u.message)||"Unknown error"})}})(),!0;if(e.messageType==="dwActionLogGetCount")return(async()=>{try{const u=await Cl();n({success:!0,count:u})}catch(u){n({success:!1,error:(u==null?void 0:u.message)||"Unknown error"})}})(),!0;if(e.messageType==="dwActionLogClear")return(async()=>{try{const u=await Dl();n({success:!0,deleted:u})}catch(u){n({success:!1,error:(u==null?void 0:u.message)||"Unknown error"})}})(),!0;if(e.messageType==="dwActionLogReplay")return(async()=>{try{const u=await Al();for(const T of u)try{await To(T.action_id,T.payload)}catch{}try{Vr(0)}catch{}n({success:!0,enqueued:u.length})}catch(u){n({success:!1,error:(u==null?void 0:u.message)||"Unknown error"})}})(),!0;if(e.messageType==="long_running_recorder_action"){oe({message:"long_running_recorder_action_received",category:"long_running_recorder",level:"info",data:{action:e.action}});const u=((y=t==null?void 0:t.tab)==null?void 0:y.id)??(t==null?void 0:t.tabId)??0,{action:T}=e;try{const R=ce(l.getState());if(!((R==null?void 0:R.lrr2025)??(R==null?void 0:R.lrr_2025)))return n({status:"disabled"}),!0}catch{return n({status:"disabled"}),!0}return T.kind===te.KEYBOARD_ACTIONS.PRESS?fm(T,u):(await Ko(u),Gt.delete(u),await En(T,u)),n({status:"success"}),!0}e.messageType==="selectMicrophone"&&e.microphoneId&&(Lo(e.microphoneId),n({status:"success"})),e.messageType==="audioDevicesEnumerated"&&(l.dispatch(Ec(e.devices)),n({status:"success"}));const{lastSentNotification:o}=Le(l.getState()),d=ee(l.getState()),p=Ee(l.getState());if(e.messageType==="getTabs")return Ns().then(u=>n(u)),!0;if(e.messageType==="getAllWindows")return chrome.windows.getAll({populate:!1},u=>{n(u)}),!0;if(e.messageType==="getLastFocusedWindow")return chrome.windows.getLastFocused({populate:!1},u=>{n(u)}),!0;if(e.messageType==="removePopup"&&chrome.action.setPopup({popup:""}),e.messageType==="sidepanelClosed"&&(xt(!1),nn(),chrome.tabs.sendMessage({messageType:"stopDropPin"}),l.dispatch(yt(!1))),e.messageType==="liveTargetClicked"&&ml(),e.messageType==="trackGuideMeDom"&&ol({...e,api:V}),e.messageType==="reducedDom"&&fl(V,e.action,e.reducedDom),e.messageType==="shouldInjectScribeButton")return Qg(t.tab.url).then(u=>{n(u)}).catch(()=>{n(!1)}),!0;if(e.messageType==="checkServerAvailability"&&_t(),e.messageType==="networkConnectionStatus"){const{isOnline:u}=e.data;return _t().then(T=>{if(!T){const{networkError:R,s3ConnectionError:N,backendConnectionError:G,networkOrServerError:_}=It(l.getState()),m=!!(R||_),c=!!(N||G);chrome.runtime.sendMessage({messageType:"networkConnectionStatus",data:{isOnline:u,internetConnection:m,scribeServerError:c}})}chrome.runtime.sendMessage({messageType:"networkConnectionStatus",data:{isOnline:u,internetConnection:null,scribeServerError:null}})}),!0}if(e.messageType==="checkForLocalStorageScribes")return Kn().then(({localScribeDetected:u,scribeId:T})=>{n({localScribeDetected:u,scribeId:T})}),!0;if(e.messageType==="endAndSaveLocalStorageScribes")return Ic().then(u=>{n({savingLocalScribe:u})}),!0;if(e.messageType==="discardLocalStorageScribes"&&(pt(),n({message:"discarded"})),e.messageType==="getIsScribeEditMode"){const u=kc(l.getState());n({isScribeEditMode:u})}if(e.messageType==="getEntryPoint"){const{entryPoint:u}=ee(l.getState());n({entryPoint:u})}if(e.messageType==="getUserData"){const{userData:u,userSettings:T}=l.getState().auth,R={user_id:u==null?void 0:u.id,active_org_id:(b=u==null?void 0:u.active_organization)==null?void 0:b.id,super_org_id:(S=(E=u==null?void 0:u.active_organization)==null?void 0:E.super_organization)==null?void 0:S.id,url_streaming:T==null?void 0:T.url_streaming,...u};n(R)}if(e.messageType==="stream_url_data"){try{if(!e.data||!e.data.url||!e.data.timestamp){console.warn("[URL Streaming] Invalid stream_url_data request:",e.data),n({success:!1,error:"Invalid data"});return}if(!wl(e.data.url)){e.data.url,n({success:!0,filtered:!0});return}Lg(e.data),n({success:!0})}catch(u){console.error("[URL Streaming] Error handling stream_url_data:",u),n({success:!1,error:u.message})}return}if(e.messageType==="getActiveTeam"){const u=(C=l.getState().auth.userData)==null?void 0:C.active_organization;n(u)}if(e.messageType==="setActiveTeam"){const u=await Ct(V,"users/active_org/","PUT",{org_id:e.team.id});if(u.ok){const T=l.getState().auth.userData;T&&l.dispatch(At({...T,active_organization:u.data}))}}if(e.messageType==="getUserGrowthState"){const u=Cc(l.getState());n(u)}if(e.messageType==="currentDomForCopilot"&&Uh({dom:e.currentDom,url:e.url,sessionId:e.sessionId}),e.messageType==="widgetFetch"){const{url:u,method:T,body:R,params:N,headers:G,isAuthenticated:_}=e;return Ct(V,u,T,R,N,G,_).then(m=>{n(m)}),!0}if(["widgetOpenSelectModal","widgetOpenRecordModal","widgetSelectedFromModal","widgetCancelModal"].includes(e.messageType))if(e.messageType==="widgetOpenRecordModal")l.dispatch(Ms(!0));else if(e.messageType==="widgetOpenSelectModal")l.dispatch(Us(!0));else{if(e.messageType==="widgetSelectedFromModal")return ue(t.tab,e,()=>{n(!0)}),!0;if(e.messageType==="widgetCancelModal")return ue(t.tab,e,()=>{n(!0)}),!0}if(e.messageType==="closedGmailRecordModal")l.dispatch(Ms(!1));else if(e.messageType==="closedGmailSelectModal")l.dispatch(Us(!1));else if(e.messageType==="requestDomainsReceived"){const{domains:u,currentRecommendedScribeCount:T}=Le(l.getState());u!==void 0&&(chrome.runtime.sendMessage({messageType:"scribeCountReceived",count:T}),n(!0));return}if(e.messageType==="trackEvent"){const{name:u,details:T}=e;Z(u,T),n(!0);return}if(e.messageType==="trackNewRelicLog"){const{name:u,details:T}=e;F(u,T),n(!0);return}if(e.messageType==="trackMixpanelEvent"){const{name:u,details:T}=e;Z(u,T),n(!0);return}if(e.messageType==="getStore"){n(l.getState());return}if(e.messageType==="changeLiveBlurSettings"){Fs(e.liveBlurEnabled),l.dispatch(Dc(e.liveBlurSettings)),n({status:"success"});return}if(Fh(e,t,n,l),e.messageType===ir.MICROPHONE_ERROR&&l.dispatch(Ac(e.errorType)),(e==null?void 0:e.messageType)==="startCopilot"&&(l.dispatch(Qt(!0)),Ie((I=t.tab)==null?void 0:I.id,Q.Copilot)),(e==null?void 0:e.messageType)==="startCopilotSearch"){const{askAiId:u}=e;if(!u)return;const T=await Y();chrome.storage.local.set({askAiId:u}),Ie(T==null?void 0:T.id,Q.Assistant,{queryParams:{copilotEntry:!0,url:T.url}})}if(e.messageType==="startDropPin"){Y().then(u=>{chrome.tabs.sendMessage(u.id,{messageType:"startDropPin"}),l.dispatch(yt(!0)),e.scribe?l.dispatch(hn(e.scribe)):l.dispatch(hn(null))});return}if(e.messageType==="stopDropPin"){Y().then(u=>{chrome.tabs.sendMessage(u.id,{messageType:"stopDropPin"}),l.dispatch(yt(!1))});return}if(e.messageType==="setPinShiftClickThrough"&&l.dispatch(th(e.value)),e.messageType&&e.messageType.startsWith("popup")){if(F("popup_message",{messageType:e.messageType,request:e}),e.messageType==="popupLogIn")Hg();else if(e.messageType==="popupGoToMyLibrary")zg();else if(e.messageType==="popupGoToMyDocuments")Vg();else if(e.messageType==="popupGoToOptionsPage")xs(Q.Options);else if(e.messageType==="popupStartRecord"){if(l.dispatch(Qt(!1)),e.source===Hs.SIDEPANEL){const u=(D=await Rc())==null?void 0:D.origin;if(Re(u))return jo({openTabSelector:!0}),n({isRecording:!0}),!0;Ie((P=t.tab)==null?void 0:P.id,Q.Recorder)}if(l.dispatch(Qn),!Ee(l.getState()))return Y().then(u=>{l.dispatch(Zn(e.source)),chrome.extension.isAllowedFileSchemeAccess().then(T=>{u&&!Re(u.url,T)?(Bt(u,null,tn.EXTENSION),n({isRecording:!0})):n({isRecording:!1,isAllowedFileSchemeAccess:T})})}),!0}else if(e.messageType==="popupStopRecording")Rt();else if(e.messageType==="popupOpenANewTab"){const u=`${Hn()}${p?"":"?intent=newrecording"}`;chrome.tabs.create({url:u})}else if(e.messageType==="popupDiscardRecordingWhileStopping"){l.dispatch(Zt(!1));const u=ee(l.getState());F("recording_deleted",{recordingState:u,reason:"user_aborted_while_stopping"}),Yn()}return}if(e.messageType==="contentScriptLoaded"){const u=l.getState(),{userSettings:T}=$e(u),{areaSelectorRecording:R}=ce(u),{liveBlurEnabled:N,liveBlurSettings:G}=en(u),{status:_}=we(u);(!o||Date.now()-o>6e4)&&(T!=null&&T.extension_notifications_enabled)&&(Bg(),l.dispatch(Hp(Date.now()))),n({recordingStatus:_,areaSelectorRecording:R,liveBlurEnabled:N,liveBlurSettings:G}),p&&((v=t.tab)==null?void 0:v.id)===d.currentTab.id&&l.dispatch(er({url:e.currentTab,host:e.currentHost})),(k=t.tab)!=null&&k.id&&((A=d.recordedTabs)==null?void 0:A.indexOf(t.tab.id))===-1&&p&&l.dispatch(tr(t.tab.id));return}if((q=t.tab)!=null&&q.id&&["getIframePosition","assignIframeId"].indexOf(e.messageType)!==-1)return chrome.tabs.sendMessage(t.tab.id,e).then(u=>{n({...u,error:null})}).catch(u=>{n({error:u})}),!0;if(e.messageType==="optionsChanged"&&yn(),e.messageType==="getSPSEnabled"){const{userData:u}=$e(l.getState());n((x=u==null?void 0:u.active_organization)==null?void 0:x.smart_privacy_screen_enabled)}if(e.messageType==="getCustomUrls"){n(z);return}if(e.messageType==="recordingControlsIndicatorPressed"){const{menuOpen:u}=en(l.getState());l.dispatch(Ot(!u))}else if(e.messageType==="recordingControlsPausePressed")zo();else if(e.messageType==="recordingControlsDeletePressed")l.dispatch(Zt(!0));else if(e.messageType==="recordingControlsDeleteConfirmPressed"){l.dispatch(Zt(!1));const u=ee(l.getState());F("recording_deleted",{recordingState:u,reason:"user_aborted_capture"}),pt(),Yn()}else if(e.messageType==="recordingControlsDeleteCancelPressed")l.dispatch(Zt(!1));else if(e.messageType==="recordingControlsScreenPositionPressed"){const{screenPositionMenuOpen:u}=en(l.getState());l.dispatch(nr(!u))}else e.messageType==="recordingControlsScreenPositionClosed"?l.dispatch(nr(!1)):e.messageType==="recordingControlsScreenPositionMenuButtonPressed"?(Th("recordingControlsPosition",e.position),l.dispatch(Ot(!1))):e.messageType==="recordingCompletedPressed"?(l.dispatch(Ot(!1)),Rt()):e.messageType==="recordingControlsClickOutside"?l.dispatch(Ot(!1)):e.messageType==="recordingControlsScreenPositionMenuClickOutside"?l.dispatch(nr(!1)):e.messageType==="endRecordingWithCutoffCancelGotItPressed"&&l.dispatch(Oc(!1));if(e.messageType==="scribeViewerCollapse")Z("scribe_viewer_collapsed"),l.dispatch(xc());else if(e.messageType==="scribeViewerExpand")Z("scribe_viewer_expanded"),l.dispatch(Pc());else if(e.messageType==="scribeViewerSetPosition")Z("scribe_viewer_position_set",{position:e.position===Lc.RIGHT?"right":"left"}),l.dispatch(Nc(e.position));else if(e.messageType==="scribeViewerOpenInScribe"){const{scribe:{id:u,name:T}}=jn(l.getState());Z("scribe_viewer_opened_in_scribe",{id:u,name:T});const R=qn(u,T,!1,"","scribe",`${z.FRONTEND_URL}/`);chrome.tabs.query({currentWindow:!0}).then(N=>{N=N.filter(G=>G.url.includes(R)),N.length>0?chrome.tabs.update(N[0].id,{active:!0}):chrome.tabs.create({url:R})})}else if(e.messageType==="scribeViewerCloseViewer"){const{scribe:{id:u,name:T},progress:R}=jn(l.getState());Z("scribe_viewer_close_viewer",{id:u,name:T,progress:R}),l.dispatch(Mc())}else if(e.messageType==="openAssistant")Pr(`${z.FRONTEND_URL}/sidebar/assistant?url=${e.href}`).then(u=>{u&&chrome.windows.update(u,{focused:!0})}),Z("extension_dropdown_open_recommended_clicked",null,V);else if(e.messageType==="scribeViewerWidthChanged")l.dispatch(Uc(e.width));else if(e.messageType==="scribeViewerProgress")l.dispatch(Fc(e));else if(e.messageType==="closeStartingRecordingModal")l.dispatch($s(!1)),l.dispatch(Ot(!1));else if(e.messageType==="closeDropdown")l.dispatch(ze(!1));else if(e.messageType==="isSidepanelOpen"){const u=await chrome.storage.local.get("sidepanelActive");n({isSidepanelOpen:u.sidepanelActive})}else if(e.messageType==="createPin")sm(e).then(u=>{u.success||n({success:!1,error:u.error})});else if(e.messageType==="generateAiUrl")am(e).then(u=>{n(u)});else if(e.messageType==="openUrl")chrome.tabs.create({url:e.url});else if(e.messageType==="openUrlInSidepanel"){const u=new URL(e.url),T=(u.pathname+u.search).replace(/^\//,"");chrome.windows.getLastFocused({populate:!1},R=>{R.id&&et(R.id,T,{frontendUrl:e.frontendUrl||z.FRONTEND_URL})})}else if(e.messageType==="deletePin")om(e).then(u=>{u.success||(e.location==="browser"?n({success:!1,error:u.error}):Y().then(T=>{chrome.tabs.sendMessage(T.id,{messageType:"showErrorToast",title:"Error deleting pin"})}))});else if(e.messageType==="updatePin")im(e).then(u=>{u.success||n({success:!1,error:u.error})});else if(e.messageType==="editPin")Y().then(u=>{chrome.tabs.sendMessage(u.id,{messageType:"editPin",pinId:e.pinId,pinCoordinates:e.pinCoordinates,location:"sidekick"})});else if(e.messageType==="cancelEditPin")Y().then(u=>{chrome.tabs.sendMessage(u.id,{messageType:"cancelEditPin"})});else if(e.messageType==="fetchViewedPins"){const{viewedPins:u=[]}=await chrome.storage.local.get("viewedPins");l.dispatch(so(u))}else if(e.messageType==="toggleHidePinsForUrl"){const u=$c(l.getState()),{url:T}=e;if(!T)return;const R=u.indexOf(T);let N;R===-1?N=[...u,T]:N=u.filter(G=>G!==T),l.dispatch(nh(N))}else if(e.messageType==="fetchPins"){const u=Date.now();if(u-xo<200)return;xo=u,Tn().then(T=>{T.success?l.dispatch(Ke(T.pins)):(l.dispatch(Ke([])),n({success:!1,error:T.error}))})}else if(e.messageType==="setHoveredPin")l.dispatch(ao(e.pinId));else if(e.messageType==="setViewedPin")rm(e.data.pinId);else if(e.messageType==="openScribeGuideMe")Nh(e);else if(e.messageType==="suggestionsRequested"){const{domains:u}=Le(l.getState()),T=e.source===Hs.SIDEPANEL,R=T?await Y():t.tab,N=e.domain||await jc();return cm({domain:N,query:e.query}).then(n),No()&&(R!=null&&R.id)&&(u!==void 0&&Sn(R.id,T),T||Bo(R.id)),!0}else{if(e.messageType==="browserContextNeeded"&&t.tab)return chrome.windows.get(t.tab.windowId).then(u=>{n({tab:t.tab,window:u})}),!0;if(e.messageType==="action")Do(e,t,n);else if(e.messageType==="getExtensionStatus"){const{status:u}=we(l.getState()),T=nt(l.getState());n({installed:!0,options:T,status:u,version:chrome.runtime.getManifest().version})}else{if(e.messageType==="updateSuggestedScribeStatus")return n({success:!1,error:"Legacy suggested scribes are deprecated"}),!0;if(e.messageType==="storeSuggestedScribe")return n({success:!1,error:"Legacy suggested scribes are deprecated"}),!0}}if(e.messageType==="updateLocalOption")return oe({message:"local_option_updating",category:"local_options",level:"info",data:{key:e.key,value:e.value}}),or(e.key,e.value).then(()=>{yn(),n({status:"success"})}),!0;if(e.messageType==="getSuggestedScribeTask")return n({success:!1,error:"Legacy suggested scribes are deprecated"}),!0;if(e.messageType==="openScribeViewer"&&Ao(e),e.messageType==="updateSelectedSuggestionsFilter"){const{filter:u}=e;l.dispatch(qc(u))}if(e.messageType==="getSelectedSuggestionsFilter"&&n(Wc(l.getState())),e.messageType==="getActiveAnalyzeTask")return n({success:!0,taskId:null}),!0;if(e.messageType==="getAllowedDomains")return Qs().then(u=>{n({allowedDomains:u})}).catch(()=>{n({allowedDomains:[]})}),!0;if(e.messageType==="getAllowedAppTags")return Zs().then(u=>{n({allowedAppTags:u})}).catch(()=>{n({allowedAppTags:[]})}),!0}),!0)});function $o(){l.dispatch(ze(!0)),chrome.action.setPopup({popup:"src/scripts/main-content/index.html"}),chrome.action.openPopup(),chrome.action.setPopup({popup:""})}async function jo({openTabSelector:e=!1}={}){const t=l.getState().auth.userData,n=await Js("recordingControlsPreference")==="floating-button";if(t){const r=Ee(l.getState()),s={entryPoint:tn.EXTENSION,isScribeEditMode:!1,taskId:""};if(n){r?$o():Br(s);return}e&&Br(s);return}n&&$o()}async function em(e){const t=ht();if(t){let s=Q.Home;kt(l.getState())?s=Q.Copilot:Ee(l.getState())&&(s=Q.Recorder),Ie(e.id,s)}await qr(),F("icon_click_listener_entered",{tab:e}),Z("sidekick_opened",{location:"extension_toolbar"});const n=await chrome.tabs.query({});n.length===1&&ue(n[0],{messageType:"OverrideShowContent"});const[r]=await chrome.tabs.query({active:!0,currentWindow:!0});if(r){const s=new URL(r.url);if(Re(s.origin))jo();else{Rr({tabId:r.id});const{dropdownOpen:a}=we(l.getState());a||(St({callSource:"iconClickListener"}),await qr(),await _t()),t||l.dispatch(ze(!a)),Gr(r)}}F("icon_click_listener_exited")}chrome.action.onClicked.addListener(em);const tm=5*60*1e3;function Sn(e,t=!1){t?chrome.runtime.sendMessage({messageType:"domainsReceived"}):ue(e,{messageType:"domainsReceived"})}async function qo(){var r,s;const{userData:e}=$e(l.getState()),t=(s=(r=e==null?void 0:e.active_organization)==null?void 0:r.super_organization)==null?void 0:s.allow_community,n=await Ct(yc,"suggestions/domains/");if(n.ok){const{user:a,gallery:i}=n.data,o=t?i:{};return l.dispatch(Kp(Number(new Date))),dl(a,o)}}const Wo=()=>{qo().then(e=>{chrome.tabs.query({active:!0,currentWindow:!0},function(t){var n;t&&((n=t[0])!=null&&n.id)&&Sn(t[0])}),l.dispatch(no(e))})},nm=e=>e&&e.replace("www.","").toLowerCase(),rm=async e=>{const{viewedPins:t=[]}=await chrome.storage.local.get("viewedPins");t.includes(e)||(t.length>1e3&&t.shift(),t.push(e),chrome.storage.local.set({viewedPins:t}),l.dispatch(so(t)))},sm=async e=>{try{return await V.post("/v1/pins/",e.pin),Tn().then(t=>{t.success?l.dispatch(Ke(t.pins)):l.dispatch(Ke([]))}),{success:!0}}catch(t){return{success:!1,error:t}}},am=async e=>{var n,r,s,a,i,o,d,p;const t={metadata:{application:"frontend-pins-url"},messages:[{role:"system",content:[{type:"prompt_key",prompt_key:"pins_url_parse"}]},{role:"user",content:[{type:"text",text:e.originalUrl}]}],model:{provider:"openai",name:"gpt-5-nano"},parameters:{max_tokens:4e3,response_format:{type:"json_schema",schema:{type:"object",properties:{optimized_url:{type:"string"}},required:["optimized_url"]}}}};try{const h=(r=(n=await vt.post(`${bt}/api/v1/inference/unified`,t))==null?void 0:n.data)==null?void 0:r.output,g=(a=(s=JSON.parse(h))==null?void 0:s[0])==null?void 0:a.optimized_url;return g&&kp(e.originalUrl,g)?Z("pins_ai_url_generation_success",{originalUrl:e.originalUrl,aiGeneratedUrl:g,userId:(o=(i=l.getState())==null?void 0:i.auth.userData)==null?void 0:o.id}):Z("pins_ai_url_generation_failure",{originalUrl:e.originalUrl,aiGeneratedUrl:g,userId:(p=(d=l.getState())==null?void 0:d.auth.userData)==null?void 0:p.id}),{success:!0,generatedUrl:g||e.originalUrl}}catch{return{success:!0,generatedUrl:e.originalUrl,usedFallback:!0}}},om=async e=>{const{pinId:t}=e;l.dispatch(gn(!0));try{return await V.delete(`/v1/pins/${t}/`),Tn().then(n=>n.success?(l.dispatch(Ke(n.pins)),{success:!0}):(l.dispatch(Ke([])),{success:!1})),{success:!0}}catch(n){return l.dispatch(gn(!1)),{success:!1,error:n}}},im=async e=>{const{pin:t,pinId:n}=e;l.dispatch(gn(!0));try{return await V.patch(`/v1/pins/${n}/`,t),Tn().then(r=>{r.success?l.dispatch(Ke(r.pins)):l.dispatch(Ke([]))}),{success:!0}}catch(r){return l.dispatch(gn(!1)),{success:!1,error:r}}},Tn=async()=>{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(e){const t=new URL(e.url);try{return{success:!0,pins:(await V.post("/v1/pins/search/",{url:`${t.href}`})).data}}catch(n){return console.error("[Pins] Error fetching pins:",n),{success:!1,error:n}}}return{success:!1,error:"No active tab found"}},cm=async({domain:e,query:t})=>{const{domains:n}=Le(l.getState())||{domains:[]};let r="search",s=`search?q=${encodeURIComponent(t)}`;const a=!t||t==="",i=null;if(a){if(n&&!(nm(e)in n))return{user:[],gallery:[]};r="domainOnly",s=`suggestions?url=${e}`}const o=await Ct(V,s);if(o.ok){let d=[],p=[];if(r==="domainOnly")d=o.data.user,p=o.data.gallery;else{const{active:h,gallery:g,super_org:y,other:b}=o.data,E=h.concat(y,b),S=E.map(({id:C})=>C);d=E.filter(({id:C},I)=>!S.includes(C,I+1)).sort((C,I)=>I.view_count-C.view_count),p=g}return{user:d,gallery:p,taskId:i,isAsynchronous:!!i}}return{user:[],gallery:[],taskId:i,isAsynchronous:!!i}},lm=async(e,t,n=0)=>{const{domains:r,lastFetched:s}=Le(l.getState());let a;if(r===void 0||s+tm<Number(new Date)){const i=await qo();if(l.dispatch(no(i)),i===void 0)return n;Sn(t),a=Xs(e,i)}else a=Xs(e,r);return a!==null?a:n},Bo=async e=>{const{showBadgeNotifications:t}=nt(l.getState()),{userData:n}=$e(l.getState()),r=Ee(l.getState());wc&&chrome.action.setBadgeBackgroundColor({color:"#7048ec"}),n&&!r?chrome.tabs.get(e,async s=>{if(s!=null&&s.url){const a=new URL(s.url),{protocol:i}=a;if(i==="http:"||i==="https:"){const o=await lm(s.url,s);o&&await bc(e)?(t?chrome.action.setBadgeText({text:o>99?"99+":o.toString(),tabId:e}):chrome.action.setBadgeText({text:"",tabId:e}),l.dispatch(ro(o)),Gr(s)):(l.dispatch(ro(0)),Gr(s))}}}):chrome.action.setBadgeText({text:"",tabId:e})},Gr=e=>{const{currentRecommendedScribeCount:t}=Le(l.getState());ue(e,{messageType:"scribeCountReceived",count:t}),chrome.runtime.sendMessage({messageType:"scribeCountReceived",count:t})},Go=async()=>{const e=await Y();e&&(ue(e,{messageType:"currentTabChanged",selfTab:e}),chrome.runtime.sendMessage({messageType:"currentTabChanged",selfTab:e}))};chrome.windows.onFocusChanged.addListener(Go);const zr=async(e,t,n)=>{var a,i,o;if(((a=await Y())==null?void 0:a.id)!==e)return;const{domains:r}=Le(l.getState());No()&&(r!==void 0&&(t.status==="complete"||t.status==="activated")&&Sn(n),(t.status==="loading"||t.status==="activated")&&Bo(e)),Go();const s=ce(l.getState());if(!((s==null?void 0:s.sidekick_refresh)??(s==null?void 0:s.sidekickRefresh))&&await _c()&&!((i=n.pendingUrl)!=null&&i.includes("/sidebar/assistant"))&&!n.url.includes("/sidebar/assistant")){const d=await ys();xh(n.url);const p=((o=d==null?void 0:d.queryParams)==null?void 0:o.url)||"",h=b=>{try{return new URL(b).hostname}catch{return""}},g=h(n.url),y=h(p);(!g||!y||g!==y)&&await Ie(n.id,Q.Assistant,{queryParams:{...d.queryParams,url:n.url},frontendUrl:z.FRONTEND_URL})}};chrome.tabs.onActivated.addListener(async({tabId:e})=>{const t=await chrome.tabs.get(e);zr(e,{status:"activated"},t)}),chrome.tabs.onUpdated.addListener(zr),Vh();const dm=(e,t)=>{const n=async(r,s)=>{if(!(!e||r!==e.id)&&s.status==="complete"){const a=await chrome.tabs.get(r);a&&t(a),chrome.tabs.onUpdated.removeListener(n)}};chrome.tabs.onUpdated.addListener(n)},zo=async()=>{var s;const{status:e}=we(l.getState());let t=ee(l.getState());const n=e===ge.RECORDING?ge.PAUSED_RECORDING:ge.RECORDING;if(l.dispatch(js(n)),n===ge.PAUSED_RECORDING)l.dispatch(Bc(new Date(Date.now()))),l.dispatch(Gc(t.isTranscribing)),l.dispatch(rr(!1));else if(n===ge.RECORDING){const a=Date.now();try{const[o]=await chrome.tabs.query({active:!0,lastFocusedWindow:!0});o!=null&&o.id&&chrome.tabs.sendMessage(o.id,{messageType:"hideBlurControls"})}catch{}l.dispatch(zc(a));const{isTranscribingBeforePause:i}=ee(l.getState());l.dispatch(rr(i))}if(n===ge.RECORDING&&il($e(l.getState()).userData)&&Fs(!1),n===ge.RECORDING){const[a]=await chrome.tabs.query({active:!0,currentWindow:!0});t.recordedTabs.find(i=>i===a.id)||(l.dispatch(tr(a.id)),t=ee(l.getState()))}const r=(s=await Vc())==null?void 0:s.id;[...t.recordedTabs,r].forEach(a=>{try{a&&chrome.tabs.sendMessage(a,{messageType:"extensionStatusChange",status:n})}catch{}})};chrome.windows.onFocusChanged.addListener(async function(e){if(e===chrome.windows.WINDOW_ID_NONE)chrome.tabs.query({active:!0,lastFocusedWindow:!0}).then(t=>{t.forEach(n=>chrome.tabs.sendMessage(n.id,{messageType:"switchedAwayFromBrowser"}))});else{const t=await Y();t&&zr(t.id,{status:"activated"},t)}}),As().then(()=>{const{status:e}=we(l.getState());e===ge.ENDING_RECORDING?Rt():e===ge.RECORDING&&(Rs(),Os())}),Is.persist(),lc(e=>{e.addEventProcessor(t=>{var n;return t.release=(n=self.SENTRY_RELEASE)==null?void 0:n.id,t})});const um=async(e,t,n=null,r=1)=>{try{if(!e)return null;const s=await createImageBitmap(e),a=typeof r=="number"&&r>1?r:1,i=Math.round(s.width/a),o=Math.round(s.height/a),d=new OffscreenCanvas(i,o);d.getContext("2d").drawImage(s,0,0,i,o);const p=(t==null?void 0:t.x)!=null?t.x/a:i/2,h=(t==null?void 0:t.y)!=null?t.y/a:o/2;let g=Math.max(600,Math.min(1400,i)),y=Math.max(400,Math.min(768,o));g=Math.min(g,i),y=Math.min(y,o);let b=Math.max(0,Math.floor(p-g/2)),E=Math.max(0,Math.floor(h-y/2));b+g>i&&(b=i-g),E+y>o&&(E=o-y);let S=new OffscreenCanvas(g,y),C=S.getContext("2d");if(C.drawImage(d,b,E,g,y,0,0,g,y),Math.min(g,y)>768){const v=768/Math.min(g,y),k=Math.round(g*v),A=Math.round(y*v),q=new OffscreenCanvas(k,A);q.getContext("2d").drawImage(S,0,0,k,A),S=q,C=S.getContext("2d")}const I=S.width,D=S.height;if(t&&typeof t.x=="number"&&typeof t.y=="number"){const v=p-b,k=h-E,A=Math.max(I,D),q=Math.max(20,Math.min(60,A*.03)),x=q/2;C.strokeStyle="rgba(255,0,0,0.85)",C.lineWidth=Math.max(6,q*.25),C.lineCap="round",C.beginPath(),C.moveTo(v-x,k-x),C.lineTo(v+x,k+x),C.moveTo(v+x,k-x),C.lineTo(v-x,k+x),C.stroke()}let P;try{P=await S.convertToBlob({type:"image/webp",quality:.7})}catch{P=await S.convertToBlob({type:"image/jpeg",quality:.7})}return oe({message:"long_running_recorder_annotated_screenshot",category:"long_running_recorder",level:"info",data:{size:(P==null?void 0:P.size)||0}}),P}catch(s){return X(s,{tags:{component:"long_running_recorder"},extra:{message:"[Long Running Recorder] Failed to optimise + annotate screenshot"}}),null}},En=async(e,t,n)=>{var r;try{oe({message:"long_running_recorder_screenshot_start",category:"long_running_recorder",level:"info",data:{actionId:e.id}});let s=null,a=null,i=null;const o=e.kind===te.KEYBOARD_ACTIONS.SEQUENCE||e.kind===te.KEYBOARD_ACTIONS.COMBINATION||e.kind==="keyboard_sequence_action"||e.kind==="keyboard_combination_action";let d=null,p=!!(n&&n.skip),h=n&&n.skip_reason?String(n.skip_reason):null;if(!p&&o)try{const I=await chrome.tabs.get(t),D=!!(I&&I.active);let P=!1,v="normal";if(I&&typeof I.windowId=="number"){const k=await chrome.windows.get(I.windowId);P=!!(k&&k.focused),v=k&&k.state||"normal",d=I.windowId}i={is_tab_active:D,is_window_focused:P,window_state:v},(!D||!P||v==="minimized")&&(p=!0,h="target_tab_not_visible")}catch{i={is_tab_active:!1,is_window_focused:!1,window_state:"unknown"},p=!0,h="target_tab_not_found"}if(e!=null&&e.earlyScreenshotTimestamp)try{const I=`early-screenshot-${e.earlyScreenshotTimestamp}`,D=(r=await chrome.storage.session.get(I))==null?void 0:r[I];if(typeof D=="string"&&D.startsWith("data:image/")){const P=await(await fetch(D)).blob();P&&P.size>0&&(s=P,chrome.storage.session.remove(I))}}catch{}if(s)oe({message:"long_running_recorder_early_screenshot_used",category:"long_running_recorder",level:"info",data:{actionId:e.id,sizeKB:Math.round(s.size/1024)}});else if(p)try{le("DW.Capture.Skip",{actionId:e.id,kind:e.kind,skip_reason:h||"unknown"})}catch{}else try{try{le("DW.Capture.Attempt",{actionId:e.id,kind:e.kind,tabId:t,windowId:d})}catch{}const I=await chrome.tabs.captureVisibleTab(d??null,{format:"jpeg",quality:70});oe({message:"long_running_recorder_screenshot_captured",category:"long_running_recorder",level:"info",data:{actionId:e.id,sizeKB:Math.round(I.length/1024)}}),s=await(await fetch(I)).blob();try{le("DW.Capture.Success",{actionId:e.id,kind:e.kind})}catch{}}catch(I){const D=I&&I.message||String(I);a=D;try{le("DW.Capture.Fail",{actionId:e.id,kind:e.kind,error:D})}catch{}}const g=s;let y=null;const b=e.kind===te.MOUSE_ACTIONS.CLICK||e.kind==="mouse_click_action",E=(e.kind===te.KEYBOARD_ACTIONS.SEQUENCE||e.kind===te.KEYBOARD_ACTIONS.COMBINATION||e.kind==="keyboard_sequence_action"||e.kind==="keyboard_combination_action")&&!!e.position&&!!e.viewport&&!!e.devicePixelRatio;s&&(b||E)&&e.position&&(y=await um(g,e.position,e.viewport,e.devicePixelRatio));const S={...e,screenshot:g,...y?{annotated_screenshot:y}:{},timestamp:e.timestamp||Date.now(),tabId:t},C=!1;try{const I=ce(l.getState());if((I==null?void 0:I.lrr2025)??(I==null?void 0:I.lrr_2025)){if(S.id||(S.id=qe()),g)try{await Pl(S.id,g)}catch(x){X(x,{tags:{component:"dw_screenshots_db"},extra:{message:"[DW] Error storing full-resolution screenshot",actionId:S.id}})}let D=null;if(g)try{D=await yg(g,{position:S.position,viewport:S.viewport,devicePixelRatio:S.devicePixelRatio})}catch{D=null}else D=null;const P=D&&D.blob||g;let v=null,k=null;if(P){const x=await wg(P);v=x&&x.imageFormat,k=x&&x.base64}const A={...S};A.timestamp&&(A.timestamp=new Date(A.timestamp).toISOString()),delete A.screenshot,delete A.annotated_screenshot,delete A.long_description,delete A.action_confidence;try{A.current_description=Tg(A)}catch{const x=typeof S.description=="string"?S.description:"";A.current_description=(x||"").trim().slice(0,1e3)}if(k)A.screenshot_data_base64=k,A.image_format=v||"jpeg";else{const x={};p?(x.screenshot_attempted=!1,x.screenshot_skip_reason=h||"unknown",o&&i&&(x.is_tab_active=i.is_tab_active,x.is_window_focused=i.is_window_focused,x.window_state=i.window_state)):(x.screenshot_attempted=!0,x.screenshot_error=a||"unknown_error"),A.additional_details=x}D&&D.relativeActionX!=null&&D.relativeActionY!=null&&D.imageWidth!=null&&D.imageHeight!=null&&(A.position_relative_to_image={x:D.relativeActionX,y:D.relativeActionY},A.image_dimensions={width:D.imageWidth,height:D.imageHeight});const q={action_id:S.id,action_data:bg(A)};try{await To(S.id,q)}catch(x){X(x,{tags:{component:"dw_streaming_queue_db"},extra:{message:"[DW] Error enqueuing action for streaming",actionId:S.id}})}try{Ho()}catch{}}}catch(I){X(I,{tags:{component:"dw_step3_capture_route"},extra:{message:"[DW] Error in Step 3 capture routing; falling back to legacy DB"}})}}catch(s){X(s,{tags:{component:"long_running_recorder"},extra:{message:"[Long Running Recorder] Error capturing screenshot"}})}},Vo=10,pm=8e3;let In=null;async function Ho(){try{const e=ce(l.getState());if(!((e==null?void 0:e.lrr2025)??(e==null?void 0:e.lrr_2025)))return;const t=await Eo(Vo);t.length>=Vo?Vr(0):t.length>0&&Vr(pm)}catch{}}function Vr(e=0){In!==null&&clearTimeout(In),In=setTimeout(async()=>{In=null;try{await Eg()}catch{}},e)}try{Ho()}catch{}const Hr=new Map,hm=1e3,Gt=new Map,zt={count:0,windowStartMs:0};function gm(){const e=Date.now();return e-zt.windowStartMs>=1e3&&(zt.windowStartMs=e,zt.count=0),zt.count>=1?!1:(zt.count+=1,!0)}function mm(e=[],t=[]){const n=[...e];return t.forEach(r=>{r&&r.toLowerCase()===te.BACKSPACE?n.length>0&&n.pop():n.push(r)}),n}function fm(e,t){let n=Hr.get(t);n||(n={actions:[],timeoutId:null},Hr.set(t,n)),n.actions.push(e),n.timeoutId&&clearTimeout(n.timeoutId),n.timeoutId=setTimeout(()=>{Ko(t)},hm)}async function Ko(e){var a,i;const t=Hr.get(e);if(!t||t.actions.length===0)return;const n=t.actions;t.actions=[],t.timeoutId&&(clearTimeout(t.timeoutId),t.timeoutId=null);let r;try{r=zn(n,((i=(a=qs())==null?void 0:a.toLowerCase)==null?void 0:i.call(a))||"mac")}catch{r=[]}const s=r.filter(o=>o.kind===te.KEYBOARD_ACTIONS.SEQUENCE||o.kind===te.KEYBOARD_ACTIONS.COMBINATION);for(const o of s){o.id||(o.id=qe());const d=o.kind===te.KEYBOARD_ACTIONS.SEQUENCE,p=gm()?void 0:{skip:!0,skip_reason:"local_budget_exceeded"};if(d){const h=Gt.get(e);if(h&&h.target_xpath&&h.target_xpath===o.target_xpath){const g=mm(h.keys||[],o.keys||[]),y={...h,keys:g,end_timestamp:o.end_timestamp||o.timestamp||Date.now(),timestamp:o.end_timestamp||o.timestamp||Date.now()};y.long_description=void 0,await En(y,e,p),Gt.set(e,y)}else await En(o,e,p),Gt.set(e,o)}else await En(o,e,p),Gt.delete(e)}}
