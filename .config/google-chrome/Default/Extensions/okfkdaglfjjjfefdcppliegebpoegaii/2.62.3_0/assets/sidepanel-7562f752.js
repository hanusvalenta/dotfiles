import"./modulepreload-polyfill-3cfb730f.js";import{d as _,h as E,e as i,f as L,t as P,j as a,k as I,l as M,u as f,o as x,m as U,r as h,n as A,p as q,q as G,U as B}from"./store-09c6166c.js";import{v as N}from"./v4-c70744d4.js";import"./sidepanel-active-state-4b19f7ad.js";import{g as D}from"./capture-helpers-b7ccc610.js";import"./_commonjsHelpers-de833af9.js";import"./index.esm-e3d6f8ec.js";import"./domUtils-fa446205.js";import"./getTargetElementAttributes-3f1109f1.js";const $=()=>{q().then(s=>{s!=null&&s.url&&G(`${(s==null?void 0:s.frontendUrl)??B.FRONTEND_URL}/${s==null?void 0:s.url}`)})};$(),chrome.storage.local.onChanged.addListener(s=>{s!=null&&s[_.RouteConfig]&&E(s[_.RouteConfig])}),window.addEventListener("message",s=>{s.data&&s.data.messageType==="requestAskAiId"&&chrome.storage.local.get("askAiId").then(e=>{const n=i();n!=null&&n.contentWindow&&e.askAiId?n.contentWindow.postMessage({messageType:"askAiIdResponse",askAiId:e.askAiId},"*"):n!=null&&n.contentWindow&&setTimeout(()=>{chrome.storage.local.get("askAiId").then(m=>{if(m.askAiId&&(n!=null&&n.contentWindow))n.contentWindow.postMessage({messageType:"askAiIdResponse",askAiId:m.askAiId},"*");else if(n!=null&&n.contentWindow){const p=N();chrome.storage.local.set({askAiId:p}),L().then(g=>{g&&P("copilot_entry_point_click",{url:g.url,ask_ai_id:p,entry_method:"extension_icon"})}),n.contentWindow.postMessage({messageType:"askAiIdResponse",askAiId:p},"*")}})},100)})}),chrome.runtime.onMessage.addListener(({messageType:s,data:e})=>{var n,m,p,g,y,T,S,W,C,k,R,b;if(s===a.UpdateLiveIndex){const t=i();t&&((n=t.contentWindow)==null||n.postMessage("advanceLiveStep","*"))}if(s===a.PreviousLiveStep){const t=i();t&&((m=t.contentWindow)==null||m.postMessage({messageType:"guideMePreviousStep"},"*"))}if(s===a.SetGuideMeStepNotFound){const t=i();t&&(e!=null&&e.dom?chrome.tabs.captureVisibleTab({format:"jpeg"}).then(async o=>{var l;const{uploadUrl:r,downloadUrl:c}=await I({sessionId:e.sessionId,requestId:e.requestId,pathPrefix:`guide_me/current_dom_screenshot/${e.sessionId}`,name:"Guide Me"}),d=M(o);f({screenshotBlob:d,uploadUrl:r}),(l=t.contentWindow)==null||l.postMessage({messageType:"showGuideMeStepNotFoundMsg",data:{showMessage:e==null?void 0:e.showMessage,message:e==null?void 0:e.message,dom:e==null?void 0:e.dom,url:e==null?void 0:e.url,sessionId:e==null?void 0:e.sessionId,requestId:e==null?void 0:e.requestId,currentDomScreenshot:c}},"*")}):(p=t.contentWindow)==null||p.postMessage({messageType:"showGuideMeStepNotFoundMsg",data:{showMessage:e==null?void 0:e.showMessage,message:e==null?void 0:e.message,dom:e==null?void 0:e.dom,url:e==null?void 0:e.url,sessionId:e==null?void 0:e.sessionId,requestId:e==null?void 0:e.requestId}},"*"))}if(s===a.Recapture){const t=i();t&&((g=t.contentWindow)==null||g.postMessage({messageType:"initRecapture"},"*"))}if(s===a.CompleteStepRecapture){const t=i();t&&((y=t.contentWindow)==null||y.postMessage({messageType:"completeStepRecapture"},"*"))}if(s===a.CancelStepRecapture){const t=i();t&&((T=t.contentWindow)==null||T.postMessage({messageType:"cancelStepRecapture"},"*"))}if(s===a.ExtensionStateUpdate&&h.isRecording){const t=i();t&&((S=t.contentWindow)==null||S.postMessage({messageType:s,data:e},"*"))}if(s===a.StartRecording&&e.liveTranscriptions&&(h.isRecording=!0,chrome.tabs.query({active:!0,lastFocusedWindow:!0},t=>{const o=t[0];e.inCopilotMode||x(o==null?void 0:o.id,U.Recorder,{queryParams:{url:e.url||(o==null?void 0:o.url)||""},frontendUrl:e.frontendUrl})})),s==="savedCopilotScribe"){const t=i();if(t){const o={messageType:"savedCopilotScribe"};(W=t==null?void 0:t.contentWindow)==null||W.postMessage(o,"*")}}if(s===a.EndRecording&&(chrome.runtime.sendMessage({messageType:"trackNewRelicLog",name:"sidepanel_end_recording",details:{liveTranscriptions:e.liveTranscriptions,localRecordingState:h}}),h.isRecording=!1,e.liveTranscriptions?(A(),setTimeout(()=>{window.close()},50)):q().then(t=>{(t==null?void 0:t.path)===U.Recorder&&(A(),window.close())})),s===a.GuideMeOtherElementClicked||s===a.GuideMeCaptureFreshPageScreenshot){const t=i(),o=s===a.GuideMeOtherElementClicked?`guide_me/user_screenshots/${e.sessionId}`:`guide_me/fresh_page_screenshots/${e.sessionId}`;chrome.tabs.captureVisibleTab({format:"jpeg"}).then(async r=>{var u;const{uploadUrl:c,downloadUrl:d}=await I({sessionId:e.sessionId,requestId:e.requestId,pathPrefix:o,name:"Guide Me"}),l=M(r);f({screenshotBlob:l,uploadUrl:c});const w={messageType:s,screenshot:r,downloadUrl:d,...e};(u=t==null?void 0:t.contentWindow)==null||u.postMessage(w,"*")})}if(s===a.SendScreenshotCoordinates){const t=i();chrome.tabs.query({active:!0,lastFocusedWindow:!0},o=>{const r=o[0];chrome.scripting.executeScript({target:{tabId:r==null?void 0:r.id},func:()=>window.devicePixelRatio}).then(c=>{chrome.tabs.captureVisibleTab({format:"jpeg"}).then(async d=>{var v;const{uploadUrl:l,downloadUrl:w}=await I({sessionId:e.sessionId,requestId:e.requestId,pathPrefix:`copilot/model_screenshots/${e.sessionId}`,name:"Copilot"}),u=M(d);f({screenshotBlob:u,uploadUrl:l});const F={messageType:"sendScreenshotCoordinates",screenshot:d,dpr:c[0].result,downloadUrl:w,...e};(v=t==null?void 0:t.contentWindow)==null||v.postMessage(F,"*")}).then(()=>{chrome.tabs.sendMessage(r.id,{messageType:"screenshotCaptureDone"})})}).catch(()=>{var d;const c={messageType:"sendScreenshotCoordinates",dpr:1,...e};chrome.tabs.sendMessage(r.id,{messageType:"screenshotCaptureDone"}),(d=t==null?void 0:t.contentWindow)==null||d.postMessage(c,"*")})})}if(s===a.SendDomtoSidepanel){const t=i(),{dom:o,url:r,sessionId:c}=e;if(t){const d={messageType:"sendDomToSidepanel",dom:o,url:r,sessionId:c};(C=t==null?void 0:t.contentWindow)==null||C.postMessage(d,"*")}}if(s===a.PauseCopilotFromBrowser){const t=i();if(t){const o={messageType:"pauseCopilotFromBrowser",source:"sidepanel.ts"};(k=t==null?void 0:t.contentWindow)==null||k.postMessage(o,"*")}}if(s===a.StopCopilotFromBrowser){const t=i();if(t){const o={messageType:"stopCopilotFromBrowser"};(R=t==null?void 0:t.contentWindow)==null||R.postMessage(o,"*")}}if(s===a.NetworkConnectionStatus){const t=i();t&&((b=t.contentWindow)==null||b.postMessage({messageType:"checkServerAvailability",isOnline:e.isOnline,internetConnection:e==null?void 0:e.internetConnection,scribeServerError:e==null?void 0:e.scribeServerError},"*"))}}),document.addEventListener("keydown",D(document));
