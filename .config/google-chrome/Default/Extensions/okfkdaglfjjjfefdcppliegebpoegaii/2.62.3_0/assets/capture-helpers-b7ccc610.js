import{f as v,g as b}from"./index.esm-e3d6f8ec.js";import{b4 as x,O as L,m as N,b5 as K,b6 as D,b0 as w,b7 as O,b8 as C}from"./store-09c6166c.js";import{v as A}from"./v4-c70744d4.js";import{g as P}from"./domUtils-fa446205.js";import{g as p}from"./getTargetElementAttributes-3f1109f1.js";const h=1e3,M=e=>{var r,t,a;try{return(e==null?void 0:e.contentDocument)||((r=e==null?void 0:e.contentWindow)==null?void 0:r.document)||null}catch(n){console.error("Error getting iframe inner document",{iframeUrl:e==null?void 0:e.src,iframeParentUrl:(a=(t=e==null?void 0:e.parentElement)==null?void 0:t.ownerDocument)==null?void 0:a.URL,error:n==null?void 0:n.message})}return null};async function U(){const e=A(),r=e;return new Promise((t,a)=>{let n=!1;setTimeout(()=>{n||a(new Error(`Timeout while waiting over ${h}ms for iframe offset response in experimental CAP-440 algorithm.`))},h);const i=m=>{var l;(l=m.data)!=null&&l.iframeOffsetResponseId&&(n=!0,window.removeEventListener("message",i),t({left:m.data.left,top:m.data.top}))};window.addEventListener("message",i);const c={tempFramePathId:r,iframeOffsetRequestId:e,left:0,top:0};window.parent.postMessage(c,"*")})}const R=async e=>{let r={left:0,top:0};if(window!==window.top)try{r=await U()}catch(t){console.warn(`Failed to get accumulated frame offset for ${e}:`,t)}return r},y={iframeId:null},E=e=>{try{return e.self!==e.top}catch{return!0}},S=()=>window.frameElement?window.frameElement.src:window.location.href,k=async e=>e?new Promise(r=>{chrome.runtime.sendMessage({messageType:"getIframePosition",location:C(S()),iframeId:e},t=>{chrome.runtime.lastError||!t?r({error:chrome.runtime.lastError||!0}):r(t)})}):{error:"No iframeId provided"},_=e=>{const r=e||window;return E(r)?r.frameElement===null?!0:r.frameElement?_(r.parent):!1:!1},I=async(e,r)=>{var n,i;const{iframeId:t}=r;window.location&&(e.url=window.location.href,e.domain=window.location.hostname,e.page_title=document.title);let a=e;if(_(window)){if((i=x((n=L(e.url))==null?void 0:n.pathname))!=null&&i.endsWith(N.Recorder))return;let{url:c,domain:m,page_title:l,error:o}=await k(t);a={...e,...o?{}:{url:c,domain:m,page_title:l}}}chrome.runtime.sendMessage({messageType:"action",action:a})},W=e=>r=>{var g,u;if(e.activeElement&&e.activeElement.type==="password")return;const t=Date.now(),{key:a,code:n,shiftKey:i,altKey:c,ctrlKey:m,metaKey:l}=r;if(!a||K(a))return;let o=null;try{r.target&&(o=v(r.target))}catch{}const s=p(r.target),d=b(r.target,{ignoreId:!0}),f=D(a,n);I({kind:w.KEYBOARD_ACTIONS.PRESS,direction:w.KEY_DIRECTIONS.DOWN,modifiers:{shiftKey:i,altKey:c,ctrlKey:m,metaKey:l},target_selector:o,target_xpath:d,target_tag:(g=r.target)==null?void 0:g.tagName,target_element:P((u=r.target)==null?void 0:u.outerHTML),target_element_attributes:s,key:O(f),timestamp:t},{iframeId:y.iframeId})},Y=(e,r)=>{let t;const a=i=>{r(i),t()},n=()=>{t()};t=()=>{e.removeEventListener("blur",n),e.removeEventListener("change",a)},e.addEventListener("blur",n),e.addEventListener("change",a)},B=e=>async r=>{var n;const t=r.target,a=t;if((a==null?void 0:a.type)!=="password"&&(t!=null&&t.isContentEditable)||(t==null?void 0:t.tagName)==="TEXTAREA"||(t==null?void 0:t.tagName)==="INPUT"&&["text","email","search","tel","url","number"].includes(a==null?void 0:a.type)){let i=null;try{i=v(t)}catch{}const c=p(t),m=p((n=e==null?void 0:e.defaultView)==null?void 0:n.frameElement),l=b(t,{ignoreId:!0}),o=window,s=t.getBoundingClientRect(),d=o&&o.devicePixelRatio||1,f=await R("input blur"),g=s.left+s.width/2,u=s.top+s.height/2,T={kind:w.INPUT_BLUR,direction:"blur",timestamp:Date.now(),position:{x:(s.x+f.left+s.width/2)*d,y:(s.y+f.top+s.height/2)*d},viewport:{width:o.innerWidth,height:o.innerHeight},was_in_iframe:E(o),iframe_attributes:m,scrollPosition:{x:o.scrollX,y:o.scrollY},position_within_element:{x:g,y:u},devicePixelRatio:d,target_selector:i,target_xpath:l,target_tag:t==null?void 0:t.tagName,target_element:P(t==null?void 0:t.outerHTML),target_element_attributes:c};I(T,{iframeId:y.iframeId})}};export{h as C,y as a,R as b,E as c,I as d,M as e,B as f,W as g,_ as i,Y as r};
