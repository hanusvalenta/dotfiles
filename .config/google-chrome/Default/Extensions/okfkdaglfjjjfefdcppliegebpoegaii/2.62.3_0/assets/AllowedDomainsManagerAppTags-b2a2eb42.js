import{j as u,c as B,I as xe}from"./Icon-709cfd25.js";import{k as _e}from"./index-7ec85ebb.js";import{B as Re,f as at,b as nt,c as lt}from"./Button-28102c4e.js";import{r as e,R as Ie,a as st}from"./index-8b3efc3f.js";import{t as we,g as re}from"./Badge-efc00514.js";import{b as De,a as ot,g as Me,s as it}from"./allowedDomainsDB-47151ce3.js";import{p as ie}from"./appTagUtils-c74c75cd.js";import{D as pe,z as ct}from"./store-09c6166c.js";import{s as Ae}from"./scribeSuggestions-59cbe47c.js";import{C as Pe,A as ut,I as dt}from"./Chip-fcb36839.js";import{I as mt,P as W,f as ce}from"./Label-7e7b0c43.js";import{S as be,R as ft,P as pt,O as ht,C as gt}from"./ScrollArea-64a9fc3d.js";import{T as Te}from"./TextInput-531917ab.js";import{T as ye,P as vt,a as xt,b as wt}from"./index-961cf08f.js";const ze=()=>{const[r,t]=e.useState(null),[a,i]=e.useState(!0),[l,d]=e.useState(null);return e.useEffect(()=>{let s=!1;return(async()=>{var f;try{const w=await pe.get("workspace/featured_app_tags/");if(!s){const o={app_tags:((f=w.data.app_tags)==null?void 0:f.slice(0,10))||[]};t(o)}}catch(w){s||d(w)}finally{s||i(!1)}})(),()=>{s=!0}},[]),{data:r,loading:a,error:l}},bt=({includeTopDomains:r=!1,onChange:t}={})=>{const[a,i]=e.useState([]),[l,d]=e.useState(!0),{data:s}=ze(),[f,w]=e.useState(!1),o=e.useMemo(()=>{if(!r||!(s!=null&&s.app_tags))return[];const m=[];return s.app_tags.forEach(x=>{if(typeof x.root_domain_url=="string")try{const S=ie(x.root_domain_url.toLowerCase());S&&m.push(S)}catch{}Array.isArray(x.multi_root_domains_urls)&&x.multi_root_domains_urls.filter(Boolean).forEach(S=>{try{const P=ie(S.toLowerCase());P&&m.push(P)}catch{}})}),[...new Set(m)]},[r,s]);e.useEffect(()=>{(async()=>{try{const m=await De(),x=Array.from(new Set(m.map(S=>S.toLowerCase())));i(x),t==null||t(x)}catch(m){console.error("Failed to load existing domains:",m)}finally{d(!1)}})()},[t]),e.useEffect(()=>{if(!r||f||o.length===0)return;const m=[...new Set([...a,...o])];i(m),t==null||t(m),w(!0)},[r,o,a,f,t]);const y=e.useCallback(m=>{const x=m.toLowerCase();if(!a.includes(x)){const S=[x,...a];i(S),t==null||t(S)}},[a,t]),C=e.useCallback(m=>{const x=m.toLowerCase(),S=a.filter(P=>P!==x);i(S),t==null||t(S)},[a,t]),E=e.useCallback(()=>{i([]),t==null||t([])},[t]);return{allowedDomains:a,isLoading:l,addDomain:y,removeDomain:C,clearDomains:E,topDomains:o}},yt=Ie.memo(({className:r,onChange:t,addButtonType:a="icon",maxChipHeight:i,includeTopDomains:l=!1})=>{const[d,s]=e.useState(""),[f,w]=e.useState(null),[o,y]=e.useState({}),C=e.useRef(new Set),E=e.useRef(t),m=e.useRef(l),x=bt({includeTopDomains:l,onChange:t}),[S,P]=e.useState([]);e.useEffect(()=>{m.current||De().then(g=>{var N;P(g),(N=E.current)==null||N.call(E,g),g.length===0&&Ae(!1)})},[]);const G=e.useCallback(g=>{m.current||ot(g).then(()=>{var N;P(g),(N=E.current)==null||N.call(E,g)})},[]),{domains:z,isLoading:$,add:V,remove:U}=e.useMemo(()=>l?{domains:x.allowedDomains,isLoading:x.isLoading,add:x.addDomain,remove:x.removeDomain}:{domains:S,isLoading:!1,add:g=>G([g,...S]),remove:g=>G(S.filter(N=>N!==g))},[l,x,S,G]),L=e.useMemo(()=>{const g={};return z.forEach(N=>{const D=Object.prototype.hasOwnProperty.call(we,N),R=o[N];g[N]=D||R}),g},[z,o]),T=g=>{let N=g.trim().toLowerCase().replace(/^https?:\/\//,"").replace(/^www\./,"");const[D]=N.split("/");if(N=D,!/^[a-z0-9.-]+\.[a-z]{2,}$/i.test(N))return null;try{const R=ie(N);return R?R.toLowerCase():null}catch{return null}},O=e.useCallback(()=>{const g=d.trim().toLowerCase();if(!g)return;const[N]=g.replace(/^https?:\/\//,"").replace(/^www\./,"").split("/");let D=null;try{D=ie(N)||null}catch{D=null}if(!D){w("Please enter a valid domain");return}if(N!==D){w(`Only parent domains are supported. Try: ${D}`);return}const R=T(D);if(!R){w("Please enter a valid domain");return}if(z.includes(R)){w(`Url ${R} is already on your allow list`);return}ct("auto_capture_add_domain_clicked",{location:"extension",auto_capture_domains_added:[R,...z]}),V(R),s(""),w(null)},[d,z,V]),Y=e.useCallback(g=>{U(g)},[U]),p=g=>{g.key==="Enter"&&(g.preventDefault(),O())},q=g=>{f&&w(null),s(g.target.value)};return e.useEffect(()=>{z.filter(g=>!we[g]&&!C.current.has(g)).forEach(g=>{const N=re(g,32,!0),D=new Image;D.onload=()=>y(R=>({...R,[g]:!0})),D.onerror=()=>y(R=>({...R,[g]:!1})),D.src=N,C.current.add(g)})},[z]),$?u.jsx("div",{className:B("flex flex-col gap-3 w-full",r),children:u.jsx("div",{className:"text-sm text-slate-500",children:"Loading domains..."})}):u.jsxs("div",{className:B("flex flex-col gap-3 w-full",r),children:[u.jsxs("div",{className:B("flex w-full items-center gap-2",{relative:a==="icon"}),children:[u.jsx(mt,{id:"allowed-domain-input",placeholder:"Add domain (e.g. google.com)",value:d,onChange:q,onKeyDown:p,error:!!f,small:!0,className:B("flex-grow",a==="icon"&&"pr-9")}),a==="icon"?u.jsx(Re,{type:"button",variant:"ghost",size:"small",icon:at,className:"shrink-0 absolute right-2 top-1/2 -translate-y-1/2",onClick:O,"aria-label":"Add domain"}):u.jsx(Re,{type:"button",variant:"secondary",size:"default",onClick:O,className:"shrink-0 px-3 py-2.5",children:"Add"})]}),f&&u.jsx("p",{className:"m-0 font-sans text-sm leading-4 text-red-600 dark:text-red-300",children:f}),u.jsx(be,{style:i?{maxHeight:i,overflowY:"auto"}:void 0,children:z.length>0&&u.jsx("div",{className:B("flex flex-wrap gap-3 p-1",i&&"pb-3"),children:z.map(g=>{const N=L[g];return u.jsx(Pe,{label:g.replace(/^www\./,""),img:N?{src:re(g,32,!0),alt:`${g} favicon`}:void 0,icon:N?void 0:_e,onRemove:()=>Y(g)},g)})})})]})});function Ct(r){return{id:r,domain:r,name:we[r]??r.replace(/^www\./,""),icon_url:re(r,32,!0)}}const St=({includeTopDomains:r=!1,onChange:t}={})=>{const[a,i]=e.useState([]),[l,d]=e.useState(!0),{data:s}=ze(),[f,w]=e.useState(!1),o=e.useMemo(()=>{if(!r||!(s!=null&&s.app_tags))return[];const m=[];return s.app_tags.forEach(x=>{typeof x.domain=="string"&&m.push(x.domain.toLowerCase())}),[...new Set(m)].map(x=>Ct(x))},[r,s]);e.useEffect(()=>{(async()=>{try{const m=(await Me()).map(x=>({...x,domain:x.domain.toLowerCase()}));i(m),t==null||t(m)}catch(m){console.error("Failed to load existing app-tags:",m)}finally{d(!1)}})()},[t]),e.useEffect(()=>{if(!r||f||o.length===0)return;const m=[...a,...o.filter(x=>!a.some(S=>S.domain===x.domain))];i(m),t==null||t(m),w(!0)},[r,o,a,f,t]);const y=e.useCallback(m=>{const x=m==null?void 0:m.domain.toLowerCase();if(!a.some(S=>S.domain===x)){const S=[m,...a];i(S),t==null||t(S)}},[a,t]),C=e.useCallback(m=>{const x=m.toLowerCase(),S=a.filter(P=>P.domain!==x);i(S),t==null||t(S)},[a,t]),E=e.useCallback(()=>{i([]),t==null||t([])},[t]);return{allowedDomains:a,isLoading:l,addDomain:y,removeDomain:C,clearDomains:E,topDomains:o}},kt=()=>{const[r,t]=e.useState(null),[a,i]=e.useState(!0),[l,d]=e.useState(null);return e.useEffect(()=>{let s=!1;return(async()=>{var f;try{const w=await pe.get("workspace/featured_app_tags/");if(!s){const o=((f=w.data.app_tags)==null?void 0:f.slice(0,10))||[];t({app_tags:o})}}catch(w){s||d(w)}finally{s||i(!1)}})(),()=>{s=!0}},[]),{data:r,loading:a,error:l}};var $e=1,Et=.9,jt=.8,Nt=.17,Ce=.1,Se=.999,Lt=.9999,_t=.99,Rt=/[\\\/_+.#"@\[\(\{&]/,It=/[\\\/_+.#"@\[\(\{&]/g,Dt=/[\s-]/,Ve=/[\s-]/g;function ke(r,t,a,i,l,d,s){if(d===t.length)return l===r.length?$e:_t;var f=`${l},${d}`;if(s[f]!==void 0)return s[f];for(var w=i.charAt(d),o=a.indexOf(w,l),y=0,C,E,m,x;o>=0;)C=ke(r,t,a,i,o+1,d+1,s),C>y&&(o===l?C*=$e:Rt.test(r.charAt(o-1))?(C*=jt,m=r.slice(l,o-1).match(It),m&&l>0&&(C*=Math.pow(Se,m.length))):Dt.test(r.charAt(o-1))?(C*=Et,x=r.slice(l,o-1).match(Ve),x&&l>0&&(C*=Math.pow(Se,x.length))):(C*=Nt,l>0&&(C*=Math.pow(Se,o-l))),r.charAt(o)!==t.charAt(d)&&(C*=Lt)),(C<Ce&&a.charAt(o-1)===i.charAt(d+1)||i.charAt(d+1)===i.charAt(d)&&a.charAt(o-1)!==i.charAt(d))&&(E=ke(r,t,a,i,o+1,d+2,s),E*Ce>C&&(C=E*Ce)),C>y&&(y=C),o=a.indexOf(w,o+1);return s[f]=y,y}function Oe(r){return r.toLowerCase().replace(Ve," ")}function Mt(r,t,a){return r=a&&a.length>0?`${r+" "+a.join(" ")}`:r,ke(r,t,Oe(r),Oe(t),0,0,{})}var At=globalThis!=null&&globalThis.document?e.useLayoutEffect:()=>{},Pt=st["useId".toString()]||(()=>{}),Tt=0;function ae(r){const[t,a]=e.useState(Pt());return At(()=>{r||a(i=>i??String(Tt++))},[r]),r||(t?`radix-${t}`:"")}var ue='[cmdk-group=""]',Ee='[cmdk-group-items=""]',zt='[cmdk-group-heading=""]',Fe='[cmdk-item=""]',Ke=`${Fe}:not([aria-disabled="true"])`,je="cmdk-item-select",ne="data-value",$t=(r,t,a)=>Mt(r,t,a),Ue=e.createContext(void 0),de=()=>e.useContext(Ue),qe=e.createContext(void 0),Ne=()=>e.useContext(qe),Be=e.createContext(void 0),He=e.forwardRef((r,t)=>{let a=le(()=>{var n,v;return{search:"",value:(v=(n=r.value)!=null?n:r.defaultValue)!=null?v:"",selectedItemId:void 0,filtered:{count:0,items:new Map,groups:new Set}}}),i=le(()=>new Set),l=le(()=>new Map),d=le(()=>new Map),s=le(()=>new Set),f=Ge(r),{label:w,children:o,value:y,onValueChange:C,filter:E,shouldFilter:m,loop:x,disablePointerSelection:S=!1,vimBindings:P=!0,...G}=r,z=ae(),$=ae(),V=ae(),U=e.useRef(null),L=Jt();ee(()=>{if(y!==void 0){let n=y.trim();a.current.value=n,T.emit()}},[y]),ee(()=>{L(6,N)},[]);let T=e.useMemo(()=>({subscribe:n=>(s.current.add(n),()=>s.current.delete(n)),snapshot:()=>a.current,setState:(n,v,k)=>{var h,_,M,F;if(!Object.is(a.current[n],v)){if(a.current[n]=v,n==="search")g(),p(),L(1,q);else if(n==="value"){if(document.activeElement.hasAttribute("cmdk-input")||document.activeElement.hasAttribute("cmdk-root")){let K=document.getElementById(V);K?K.focus():(h=document.getElementById(z))==null||h.focus()}if(L(7,()=>{var K;a.current.selectedItemId=(K=D())==null?void 0:K.id,T.emit()}),k||L(5,N),((_=f.current)==null?void 0:_.value)!==void 0){let K=v??"";(F=(M=f.current).onValueChange)==null||F.call(M,K);return}}T.emit()}},emit:()=>{s.current.forEach(n=>n())}}),[]),O=e.useMemo(()=>({value:(n,v,k)=>{var h;v!==((h=d.current.get(n))==null?void 0:h.value)&&(d.current.set(n,{value:v,keywords:k}),a.current.filtered.items.set(n,Y(v,k)),L(2,()=>{p(),T.emit()}))},item:(n,v)=>(i.current.add(n),v&&(l.current.has(v)?l.current.get(v).add(n):l.current.set(v,new Set([n]))),L(3,()=>{g(),p(),a.current.value||q(),T.emit()}),()=>{d.current.delete(n),i.current.delete(n),a.current.filtered.items.delete(n);let k=D();L(4,()=>{g(),(k==null?void 0:k.getAttribute("id"))===n&&q(),T.emit()})}),group:n=>(l.current.has(n)||l.current.set(n,new Set),()=>{d.current.delete(n),l.current.delete(n)}),filter:()=>f.current.shouldFilter,label:w||r["aria-label"],getDisablePointerSelection:()=>f.current.disablePointerSelection,listId:z,inputId:V,labelId:$,listInnerRef:U}),[]);function Y(n,v){var k,h;let _=(h=(k=f.current)==null?void 0:k.filter)!=null?h:$t;return n?_(n,a.current.search,v):0}function p(){if(!a.current.search||f.current.shouldFilter===!1)return;let n=a.current.filtered.items,v=[];a.current.filtered.groups.forEach(h=>{let _=l.current.get(h),M=0;_.forEach(F=>{let K=n.get(F);M=Math.max(K,M)}),v.push([h,M])});let k=U.current;R().sort((h,_)=>{var M,F;let K=h.getAttribute("id"),X=_.getAttribute("id");return((M=n.get(X))!=null?M:0)-((F=n.get(K))!=null?F:0)}).forEach(h=>{let _=h.closest(Ee);_?_.appendChild(h.parentElement===_?h:h.closest(`${Ee} > *`)):k.appendChild(h.parentElement===k?h:h.closest(`${Ee} > *`))}),v.sort((h,_)=>_[1]-h[1]).forEach(h=>{var _;let M=(_=U.current)==null?void 0:_.querySelector(`${ue}[${ne}="${encodeURIComponent(h[0])}"]`);M==null||M.parentElement.appendChild(M)})}function q(){let n=R().find(k=>k.getAttribute("aria-disabled")!=="true"),v=n==null?void 0:n.getAttribute(ne);T.setState("value",v||void 0)}function g(){var n,v,k,h;if(!a.current.search||f.current.shouldFilter===!1){a.current.filtered.count=i.current.size;return}a.current.filtered.groups=new Set;let _=0;for(let M of i.current){let F=(v=(n=d.current.get(M))==null?void 0:n.value)!=null?v:"",K=(h=(k=d.current.get(M))==null?void 0:k.keywords)!=null?h:[],X=Y(F,K);a.current.filtered.items.set(M,X),X>0&&_++}for(let[M,F]of l.current)for(let K of F)if(a.current.filtered.items.get(K)>0){a.current.filtered.groups.add(M);break}a.current.filtered.count=_}function N(){var n,v,k;let h=D();h&&(((n=h.parentElement)==null?void 0:n.firstChild)===h&&((k=(v=h.closest(ue))==null?void 0:v.querySelector(zt))==null||k.scrollIntoView({block:"nearest"})),h.scrollIntoView({block:"nearest"}))}function D(){var n;return(n=U.current)==null?void 0:n.querySelector(`${Fe}[aria-selected="true"]`)}function R(){var n;return Array.from(((n=U.current)==null?void 0:n.querySelectorAll(Ke))||[])}function se(n){let v=R()[n];v&&T.setState("value",v.getAttribute(ne))}function Q(n){var v;let k=D(),h=R(),_=h.findIndex(F=>F===k),M=h[_+n];(v=f.current)!=null&&v.loop&&(M=_+n<0?h[h.length-1]:_+n===h.length?h[0]:h[_+n]),M&&T.setState("value",M.getAttribute(ne))}function oe(n){let v=D(),k=v==null?void 0:v.closest(ue),h;for(;k&&!h;)k=n>0?Gt(k,ue):Yt(k,ue),h=k==null?void 0:k.querySelector(Ke);h?T.setState("value",h.getAttribute(ne)):Q(n)}let me=()=>se(R().length-1),te=n=>{n.preventDefault(),n.metaKey?me():n.altKey?oe(1):Q(1)},fe=n=>{n.preventDefault(),n.metaKey?se(0):n.altKey?oe(-1):Q(-1)};return e.createElement(W.div,{ref:t,tabIndex:-1,...G,"cmdk-root":"",onKeyDown:n=>{var v;(v=G.onKeyDown)==null||v.call(G,n);let k=n.nativeEvent.isComposing||n.keyCode===229;if(!(n.defaultPrevented||k))switch(n.key){case"n":case"j":{P&&n.ctrlKey&&te(n);break}case"ArrowDown":{te(n);break}case"p":case"k":{P&&n.ctrlKey&&fe(n);break}case"ArrowUp":{fe(n);break}case"Home":{n.preventDefault(),se(0);break}case"End":{n.preventDefault(),me();break}case"Enter":{n.preventDefault();let h=D();if(h){let _=new Event(je);h.dispatchEvent(_)}}}}},e.createElement("label",{"cmdk-label":"",htmlFor:O.inputId,id:O.labelId,style:Zt},w),he(r,n=>e.createElement(qe.Provider,{value:T},e.createElement(Ue.Provider,{value:O},n))))}),Vt=e.forwardRef((r,t)=>{var a,i;let l=ae(),d=e.useRef(null),s=e.useContext(Be),f=de(),w=Ge(r),o=(i=(a=w.current)==null?void 0:a.forceMount)!=null?i:s==null?void 0:s.forceMount;ee(()=>{if(!o)return f.item(l,s==null?void 0:s.id)},[o]);let y=Ye(l,d,[r.value,r.children,d],r.keywords),C=Ne(),E=Z(L=>L.value&&L.value===y.current),m=Z(L=>o||f.filter()===!1?!0:L.search?L.filtered.items.get(l)>0:!0);e.useEffect(()=>{let L=d.current;if(!(!L||r.disabled))return L.addEventListener(je,x),()=>L.removeEventListener(je,x)},[m,r.onSelect,r.disabled]);function x(){var L,T;S(),(T=(L=w.current).onSelect)==null||T.call(L,y.current)}function S(){C.setState("value",y.current,!0)}if(!m)return null;let{disabled:P,value:G,onSelect:z,forceMount:$,keywords:V,...U}=r;return e.createElement(W.div,{ref:ce(d,t),...U,id:l,"cmdk-item":"",role:"option","aria-disabled":!!P,"aria-selected":!!E,"data-disabled":!!P,"data-selected":!!E,onPointerMove:P||f.getDisablePointerSelection()?void 0:S,onClick:P?void 0:x},r.children)}),Ot=e.forwardRef((r,t)=>{let{heading:a,children:i,forceMount:l,...d}=r,s=ae(),f=e.useRef(null),w=e.useRef(null),o=ae(),y=de(),C=Z(m=>l||y.filter()===!1?!0:m.search?m.filtered.groups.has(s):!0);ee(()=>y.group(s),[]),Ye(s,f,[r.value,r.heading,w]);let E=e.useMemo(()=>({id:s,forceMount:l}),[l]);return e.createElement(W.div,{ref:ce(f,t),...d,"cmdk-group":"",role:"presentation",hidden:C?void 0:!0},a&&e.createElement("div",{ref:w,"cmdk-group-heading":"","aria-hidden":!0,id:o},a),he(r,m=>e.createElement("div",{"cmdk-group-items":"",role:"group","aria-labelledby":a?o:void 0},e.createElement(Be.Provider,{value:E},m))))}),Ft=e.forwardRef((r,t)=>{let{alwaysRender:a,...i}=r,l=e.useRef(null),d=Z(s=>!s.search);return!a&&!d?null:e.createElement(W.div,{ref:ce(l,t),...i,"cmdk-separator":"",role:"separator"})}),Kt=e.forwardRef((r,t)=>{let{onValueChange:a,...i}=r,l=r.value!=null,d=Ne(),s=Z(o=>o.search),f=Z(o=>o.selectedItemId),w=de();return e.useEffect(()=>{r.value!=null&&d.setState("search",r.value)},[r.value]),e.createElement(W.input,{ref:t,...i,"cmdk-input":"",autoComplete:"off",autoCorrect:"off",spellCheck:!1,"aria-autocomplete":"list",role:"combobox","aria-expanded":!0,"aria-controls":w.listId,"aria-labelledby":w.labelId,"aria-activedescendant":f,id:w.inputId,type:"text",value:l?r.value:s,onChange:o=>{l||d.setState("search",o.target.value),a==null||a(o.target.value)}})}),Ut=e.forwardRef((r,t)=>{let{children:a,label:i="Suggestions",...l}=r,d=e.useRef(null),s=e.useRef(null),f=Z(o=>o.selectedItemId),w=de();return e.useEffect(()=>{if(s.current&&d.current){let o=s.current,y=d.current,C,E=new ResizeObserver(()=>{C=requestAnimationFrame(()=>{let m=o.offsetHeight;y.style.setProperty("--cmdk-list-height",m.toFixed(1)+"px")})});return E.observe(o),()=>{cancelAnimationFrame(C),E.unobserve(o)}}},[]),e.createElement(W.div,{ref:ce(d,t),...l,"cmdk-list":"",role:"listbox",tabIndex:-1,"aria-activedescendant":f,"aria-label":i,id:w.listId},he(r,o=>e.createElement("div",{ref:ce(s,w.listInnerRef),"cmdk-list-sizer":""},o)))}),qt=e.forwardRef((r,t)=>{let{open:a,onOpenChange:i,overlayClassName:l,contentClassName:d,container:s,...f}=r;return e.createElement(ft,{open:a,onOpenChange:i},e.createElement(pt,{container:s},e.createElement(ht,{"cmdk-overlay":"",className:l}),e.createElement(gt,{"aria-label":r.label,"cmdk-dialog":"",className:d},e.createElement(He,{ref:t,...f}))))}),Bt=e.forwardRef((r,t)=>Z(a=>a.filtered.count===0)?e.createElement(W.div,{ref:t,...r,"cmdk-empty":"",role:"presentation"}):null),Ht=e.forwardRef((r,t)=>{let{progress:a,children:i,label:l="Loading...",...d}=r;return e.createElement(W.div,{ref:t,...d,"cmdk-loading":"",role:"progressbar","aria-valuenow":a,"aria-valuemin":0,"aria-valuemax":100,"aria-label":l},he(r,s=>e.createElement("div",{"aria-hidden":!0},s)))}),H=Object.assign(He,{List:Ut,Item:Vt,Input:Kt,Group:Ot,Separator:Ft,Dialog:qt,Empty:Bt,Loading:Ht});function Gt(r,t){let a=r.nextElementSibling;for(;a;){if(a.matches(t))return a;a=a.nextElementSibling}}function Yt(r,t){let a=r.previousElementSibling;for(;a;){if(a.matches(t))return a;a=a.previousElementSibling}}function Ge(r){let t=e.useRef(r);return ee(()=>{t.current=r}),t}var ee=typeof window>"u"?e.useEffect:e.useLayoutEffect;function le(r){let t=e.useRef();return t.current===void 0&&(t.current=r()),t}function Z(r){let t=Ne(),a=()=>r(t.snapshot());return e.useSyncExternalStore(t.subscribe,a,a)}function Ye(r,t,a,i=[]){let l=e.useRef(),d=de();return ee(()=>{var s;let f=(()=>{var o;for(let y of a){if(typeof y=="string")return y.trim();if(typeof y=="object"&&"current"in y)return y.current?(o=y.current.textContent)==null?void 0:o.trim():l.current}})(),w=i.map(o=>o.trim());d.value(r,f,w),(s=t.current)==null||s.setAttribute(ne,f),l.current=f}),l}var Jt=()=>{let[r,t]=e.useState(),a=le(()=>new Map);return ee(()=>{a.current.forEach(i=>i()),a.current=new Map},[r]),(i,l)=>{a.current.set(i,l),t({})}};function Wt(r){let t=r.type;return typeof t=="function"?t(r.props):"render"in t?t.render(r.props):r}function he({asChild:r,children:t},a){return r&&e.isValidElement(t)?e.cloneElement(Wt(t),{ref:t.ref},a(t.props.children)):a(t)}var Zt={position:"absolute",width:"1px",height:"1px",padding:"0",margin:"-1px",overflow:"hidden",clip:"rect(0, 0, 0, 0)",whiteSpace:"nowrap",borderWidth:"0"};const Je=e.forwardRef(({className:r,...t},a)=>u.jsx(H,{ref:a,className:B("bg-popover text-popover-foreground flex h-full w-full flex-col rounded-md",r),...t}));Je.displayName=H.displayName;const Qt=e.forwardRef(({className:r,...t},a)=>u.jsxs("div",{className:"flex items-center border-b px-3","cmdk-input-wrapper":"",children:[u.jsx(xe,{icon:nt,className:"mr-2 h-4 w-4 shrink-0 opacity-50"}),u.jsx(H.Input,{ref:a,className:B("placeholder:text-muted-foreground flex h-10 w-full rounded-md bg-transparent py-3 text-sm outline-none disabled:cursor-not-allowed disabled:opacity-50",r),...t})]}));Qt.displayName=H.Input.displayName;const Le=e.forwardRef(({className:r,...t},a)=>u.jsx(H.List,{ref:a,className:B("max-h-[300px] overflow-y-auto overflow-x-hidden",r),...t}));Le.displayName=H.List.displayName;const We=e.forwardRef((r,t)=>u.jsx(H.Empty,{ref:t,className:"py-6 text-center text-sm",...r}));We.displayName=H.Empty.displayName;const Ze=e.forwardRef(({className:r,...t},a)=>u.jsx(H.Group,{ref:a,className:B("text-foreground [&_[cmdk-group-heading]]:text-muted-foreground overflow-hidden py-2 [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium",r),...t}));Ze.displayName=H.Group.displayName;const Qe=e.forwardRef(({className:r,theme:t,...a},i)=>u.jsx(H.Item,{ref:i,className:B("data-[selected=true]:bg-accent data-[selected=true]:text-accent-foreground relative flex h-8 cursor-pointer select-none items-center gap-2 px-3 py-1 text-sm outline-none transition-colors data-[disabled=true]:pointer-events-none data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",{"data-[selected=true]:bg-slate-500 data-[selected=true]:bg-opacity-25":t===ye.Dark,"data-[selected=true]:bg-slate-100":t===ye.Light},r),...a}));Qe.displayName=H.Item.displayName;const Xt=({selectedValue:r,onSelectedValueChange:t,searchValue:a,onSearchValueChange:i,items:l,isLoading:d,emptyMessage:s="No items.",emptyComponent:f,placeholder:w="Search...",hideSelectedIcon:o=!1,onLastItemVisible:y,theme:C=ye.Dark,inputProps:E,inputComponent:m,listClassNames:x,showSelectedValue:S=!1,inputRef:P})=>{const G=e.useRef(null),z=e.useRef(null),[$,V]=e.useState(!1),U=e.useMemo(()=>l.reduce((p,q)=>(p[q.value]=q.label,p),{}),[l]),L=()=>{t(""),i("")},T=p=>{var q;!((q=p.relatedTarget)!=null&&q.hasAttribute("cmdk-list"))&&U[r]!==a&&!(f&&z.current)&&L()},O=p=>{t(p),i(o&&!S?"":U[p]??""),V(!1)},Y=()=>{const p=m||u.jsx(Te,{...E,placeholder:w,fullWidth:!0});return P&&e.isValidElement(p)?e.cloneElement(p,{...E,ref:P}):p};return u.jsx("div",{className:"flex items-center",ref:G,children:u.jsx(vt,{open:$,onOpenChange:V,modal:!1,children:u.jsxs(Je,{shouldFilter:!1,children:[u.jsx(xt,{asChild:!0,children:u.jsx(H.Input,{asChild:!0,value:a,onValueChange:i,onKeyDown:p=>V(p.key!=="Escape"),onMouseDown:()=>V(p=>!!a||!p),onBlur:T,children:Y()})}),!$&&u.jsx(Le,{"aria-hidden":"true",className:"hidden"}),u.jsx(wt,{asChild:!0,onOpenAutoFocus:p=>p.preventDefault(),onInteractOutside:p=>{p.target instanceof Element&&p.target.hasAttribute("cmdk-input")&&p.preventDefault()},className:B("z-[50] w-[--radix-popover-trigger-width] p-0",x),theme:C,container:G.current,align:"start","data-testid":"autocomplete-list",children:u.jsx(be,{children:u.jsxs(Le,{children:[d&&u.jsx(H.Loading,{children:u.jsx("div",{className:"flex flex-col space-y-4 px-3 py-2",children:"Loading..."})}),l.length>0&&!d?u.jsx(Ze,{children:l.map((p,q)=>{const g=u.jsxs("div",{className:"flex h-full items-center",children:["avatar"in p&&p.avatar&&u.jsx(ut,{size:"xs",theme:C,...p.avatar}),"icon"in p&&p.icon&&u.jsx(xe,{icon:p.icon,className:"size-4 text-slate-500 dark:text-slate-400"}),"img"in p&&p.img&&u.jsx("div",{className:"flex size-5 items-center justify-center",children:u.jsx("img",{src:p.img.src,className:"size-4 rounded-sm",alt:p.img.alt})})]});return u.jsxs(Qe,{value:p.value,onMouseDown:N=>N.preventDefault(),onSelect:O,disabled:p.disabled,theme:C,children:[!o&&u.jsx(xe,{icon:lt,className:B("size-5",r===p.value?"opacity-100":"opacity-0")}),u.jsxs("div",{className:"flex items-center gap-2 px-1",children:["avatar"in p&&p.avatar||"icon"in p&&p.icon||"img"in p&&p.img?g:null,u.jsx("div",{className:"truncate text-left",children:p.label})]}),q===l.length-1&&y&&u.jsx(dt,{onVisible:y})]},p.value)})}):null,!d&&a?u.jsx(We,{ref:z,children:f||(s??"No items.")}):null]})})})]})})})},ge=r=>{const t=r.replace(/^www\./,"").split(".")[0];return t.charAt(0).toUpperCase()+t.slice(1)},Xe=r=>{try{const t=r.match(/\/icons\/([^/]+)\./);if(t!=null&&t[1])return t[1];const a=new URL(r).searchParams.get("url");if(a)return new URL(a).hostname.replace(/^www\./,"")}catch{}return""},er=async r=>{var t,a;try{return((a=(t=(await pe.post("app_tag/batch_search/",{urls:[r]})).data)==null?void 0:t[0])==null?void 0:a.id)??null}catch{return null}},tr=Ie.memo(({className:r,onChange:t,maxChipHeight:a,includeTopDomains:i=!1})=>{const[l,d]=e.useState(""),[s,f]=e.useState(null),[w,o]=e.useState({}),[y,C]=e.useState(null),[E,m]=e.useState(""),[x,S]=e.useState(""),[P,G]=e.useState(16),z=e.useRef(null),$=e.useRef(null),V=e.useRef(null),[U,L]=e.useState(!0),T=e.useRef(new Set),O=e.useRef(t),Y=e.useRef(i),p=St({includeTopDomains:i,onChange:t});e.useEffect(()=>{V.current&&L(!0)},[]),e.useEffect(()=>{$.current&&$.current.focus()},[]),e.useEffect(()=>{const c=b=>{V.current&&!V.current.contains(b.target)&&L(!1)};return document.addEventListener("mousedown",c),()=>document.removeEventListener("mousedown",c)},[]);const q=c=>{const b=c.target;b.tagName==="INPUT"||b.getAttribute("contenteditable")==="true"||b.isContentEditable||c.key.length===1&&!c.ctrlKey&&!c.metaKey&&!c.altKey&&(c.preventDefault(),$.current&&$.current.focus(),m(A=>A+c.key),L(!0))},[g,N]=e.useState([]);e.useEffect(()=>{Y.current||Me().then(c=>{var A;const b=c.map(j=>({...j,domain:j.domain.toLowerCase()}));N(b),(A=O.current)==null||A.call(O,b),b.length===0&&Ae(!1)})},[]);const D=e.useCallback(c=>{Y.current||it(c).then(()=>{var b;N(c),(b=O.current)==null||b.call(O,c)})},[]),{domains:R,isLoading:se,add:Q,remove:oe}=e.useMemo(()=>i?{domains:p.allowedDomains,isLoading:p.isLoading,add:p.addDomain,remove:p.removeDomain}:{domains:g,isLoading:!1,add:c=>{D([c,...g])},remove:c=>D(g.filter(b=>b.domain!==c))},[i,p,g,D]),me=e.useMemo(()=>{const c={};return R.forEach(({domain:b})=>{const A=w[b];c[b]=A}),c},[R,w]),te=e.useCallback(async c=>{const b=c.trim().toLowerCase();if(!b)return;const[A]=b.replace(/^https?:\/\//,"").replace(/^www\./,"").split("/");let j=null;try{j=ie(A)||null}catch{j=null}if(!j){f("Please enter a valid domain");return}const I=A;if(!I){f("Please enter a valid domain");return}if(R.some(ve=>ve.domain===I)){f(`Url ${I} is already on your allow list`);return}const J={id:await er(I)??I,domain:I,name:ge(I),icon_url:re(I,32,!0)};Q(J),d(""),f(null)},[R,Q]);e.useCallback(()=>{te(l)},[l,te]);const fe=e.useCallback(c=>{oe(c)},[oe]);e.useEffect(()=>{z.current&&G(z.current.offsetWidth)},[E]),e.useEffect(()=>{R.map(c=>c.domain).filter(c=>!T.current.has(c)).forEach(c=>{const b=re(c,32,!0),A=new Image;A.onload=()=>o(j=>({...j,[c]:!0})),A.onerror=()=>o(j=>({...j,[c]:!1})),A.src=b,T.current.add(c)})},[R]);const{data:n}=kt(),[v,k]=e.useState(E);e.useEffect(()=>{const c=setTimeout(()=>k(E),200);return()=>clearTimeout(c)},[E]);const[h,_]=e.useState([]),[M,F]=e.useState(!1),[K,X]=e.useState(null);e.useEffect(()=>{let c=!1;return(async()=>{if(!v||v.length<1){_([]);return}F(!0),X(null);try{const b=await pe.get("app_tag/search/",{params:{url:v}});c||_(b.data||[])}catch(b){c||X(b)}finally{c||F(!1)}})(),()=>{c=!0}},[v]);const et=e.useMemo(()=>{const c=(n==null?void 0:n.app_tags)??[],b={};c.forEach(j=>{const I=j.domain.toLowerCase(),J=j.name??ge(I);b[I]={label:J}}),h.forEach(j=>{const I=Xe(j.icon_url);if(!I)return;const J=I.toLowerCase(),ve=j.name||ge(J);b[J]||(b[J]={label:ve})});const A=E.trim().toLowerCase();return A?Object.entries(b).filter(([j,{label:I}])=>A?j.toLowerCase().includes(A)||I.toLowerCase().includes(A):!0).map(([j,{label:I}])=>{const J=re(j,32,!0);return{value:j,label:I,img:{src:J,alt:I}}}):[]},[n==null?void 0:n.app_tags,E,h]),tt=c=>{const b=[...h,...(n==null?void 0:n.app_tags)||[]];let A;if(b.forEach(j=>{if("icon_url"in j&&!("domain"in j)){const I=Xe(j.icon_url||"");(I==null?void 0:I.toLowerCase())===c&&(A={id:I,domain:I,name:j.name??ge(I),icon_url:j.icon_url})}else"domain"in j&&j.domain.toLowerCase()===c&&(A=j)}),A){Q(A),S(""),m("");return}te(c),S(""),m("")},rt=c=>{const b=c.target;!(b.closest('[role="button"]')||b.closest(".chip"))&&$.current&&$.current.focus()};return se?u.jsx("div",{className:B("flex flex-col gap-3 w-full",r),children:u.jsx("div",{className:"text-sm text-slate-500",children:"Loading domains..."})}):u.jsxs("div",{className:B("flex flex-col gap-3 w-full",r),onKeyDown:q,onClick:()=>{var c;L(!0),(c=$.current)==null||c.focus()},onBlur:c=>{c.currentTarget.contains(c.relatedTarget)||L(!1)},role:"button",tabIndex:0,ref:V,children:[u.jsx("div",{className:"flex w-full items-center gap-2"}),s&&u.jsx("p",{className:"m-0 font-sans text-sm leading-4 text-red-600 dark:text-red-300",children:s}),u.jsx("span",{ref:z,className:"invisible absolute px-2 text-center text-xs","aria-hidden":"true",children:E}),u.jsx(be,{style:a?{maxHeight:a,overflowY:"auto"}:void 0,onClick:rt,children:u.jsx("div",{className:B("flex-wrap bg-slate-100 group relative inline-flex w-full cursor-pointer items-center gap-2 rounded-md p-1 border border-brand-600",a&&"pb-3"),children:R.length>0&&u.jsxs(u.Fragment,{children:[R.map(c=>{const{domain:b,name:A,icon_url:j}=c,I=me[b];return u.jsx(Pe,{label:A,onMouseEnter:()=>C(b),onMouseLeave:()=>C(null),onRemove:y===b?()=>fe(b):void 0,img:I&&j?{src:j,alt:`${b} favicon`}:void 0,icon:I?void 0:_e},b)}),U&&u.jsx(Xt,{selectedValue:x,onSelectedValueChange:tt,searchValue:E,onSearchValueChange:c=>{s&&f(null),m(c)},emptyComponent:u.jsxs("div",{className:"text-xs",children:["Type the full domain ",u.jsx("div",{children:"(e.g. google.com)"})]}),inputProps:{autoFocus:!0},inputRef:$,inputComponent:u.jsx(Te,{className:"allowed-domains-input flex h-6 items-center rounded border border-dashed border-slate-400/20 bg-transparent p-0 text-center text-xs text-slate-600 focus:border-slate-400/20 focus:outline-transparent",style:{width:`${P}px`},"data-testid":"app-tag-search-input"}),items:et,hideSelectedIcon:!0,listClassNames:"w-[250px]"})]})})})]})});export{tr as A,yt as a};
