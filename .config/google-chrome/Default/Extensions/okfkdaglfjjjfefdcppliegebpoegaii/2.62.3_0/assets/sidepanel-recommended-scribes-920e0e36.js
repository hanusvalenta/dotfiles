import"./modulepreload-polyfill-3cfb730f.js";import{j as t}from"./Icon-709cfd25.js";import{r as i,R as We}from"./index-8b3efc3f.js";import{c as Be}from"./client-e8432e69.js";import{u as U,P as Oe}from"./react-redux-52a3bd12.js";import{D as Ge,a as He,b as Ye,c as qe,d as Je,t as Ve,s as Ke,e as Qe,u as Xe,S as Ze,A as et}from"./useExtensionMessagesListener-47f2b437.js";import{T as tt}from"./Toaster-fd453bc3.js";import{x as ce,s as le,y as de,z as D,A as me,v as st,w as at,B as nt,C as G,m as H}from"./store-09c6166c.js";import{p as rt}from"./production-ca86ce5a.js";import{B as ot,t as it,g as ct}from"./Badge-efc00514.js";import{b as lt}from"./index-7ec85ebb.js";import{B as dt}from"./Banner-ea20b168.js";import{T as mt}from"./TextArea-cc835e87.js";import{u as ut}from"./useBackgroundReduxState-a039e2db.js";import{u as pt,a as gt}from"./useDomainAllowlistListener-dc049a39.js";import{T as ht}from"./Toolbar-76b5973a.js";import{h as xt}from"./dwResultsDB-40675cfa.js";import{B as y}from"./Button-28102c4e.js";import{i as ft,e as bt,a as yt,b as wt}from"./importDWResultsFromFile-ac8fbdd5.js";import"./_commonjsHelpers-de833af9.js";import"./DocumentIcon-a843a224.js";import"./index-e309a1d1.js";import"./Tooltip-902b3a9d.js";import"./Label-7e7b0c43.js";import"./index-dec57878.js";import"./ScrollArea-64a9fc3d.js";import"./index-84d1a71c.js";import"./index-c412bae6.js";import"./v4-c70744d4.js";import"./index-7bc06dca.js";import"./appTagUtils-c74c75cd.js";import"./browserContext-fabb883d.js";import"./dwActionLoggingDB-f05b22f9.js";import"./dwScreenshotsDB-956b9f9a.js";const jt=({open:l,onOpenChange:p,onSubmit:a})=>{const[n,u]=i.useState(""),k=()=>{a&&n.trim()&&(a(n),u(""),p(!1),Ve({variant:"success",title:"Thank you for the feedback!",description:"We'll use this to make Discover Workflows even better."}))},C=()=>{u(""),p(!1)};return t.jsx(Ge,{open:l,onOpenChange:p,children:t.jsxs(He,{children:[t.jsx(Ye,{title:"Help us make Discover workflows better",description:"Your feedback shapes our next steps."}),t.jsx(qe,{children:t.jsx(mt,{placeholder:"Let us know how we can improve",value:n,onChange:w=>u(w.target.value),rows:4,resize:!1})}),t.jsx(Je,{primaryAction:{children:"Submit feedback",onClick:k,disabled:!n.trim()},secondaryAction:{children:"Cancel",onClick:C},primaryActionClose:!1,secondaryActionClose:!1})]})})},vt=({onFeedbackSubmit:l})=>{const[p,a]=i.useState(!1);return t.jsxs(t.Fragment,{children:[t.jsx(dt,{variant:"info",icon:lt,title:"How could Discover Workflows be better?",description:"Your feedback shapes our next steps.",actions:[{children:"Give feedback",onClick:()=>a(!0)}]}),t.jsx(jt,{open:p,onOpenChange:a,onSubmit:l})]})},kt=(l,p=1/0)=>{const[a,n]=i.useState(null),[u,k]=i.useState(!1),[C,w]=i.useState(null),[f,A]=i.useState(0),{lrr2025:j}=ce(le.getState());let h={};if(typeof j=="string")try{h=JSON.parse(j)}catch{h={}}else typeof j=="object"&&j!==null&&(h=j);const P=h!=null&&h.recommendation_refresh_hours_interval?h.recommendation_refresh_hours_interval*60*60*1e3:6e4,S=i.useCallback(async()=>{if(l){de("feature","long-running-recorder"),de("operation","fetch-task-status");try{k(!0);const o=await new Promise(N=>{chrome.runtime.sendMessage({messageType:"getSuggestedScribeTask",taskId:l},F=>{N(F)})});o.success&&o.task?(D("task_received_status",{status:o.task.status,task:o.task}),n(o.task),w(null)):(me(new Error(o.error||"Failed to fetch task status"),{extra:{context:"Error fetching task status"}}),w(o.error||"Failed to fetch task status"))}catch(o){me(o,{extra:{context:"Error in fetchTaskStatus"}}),w(o instanceof Error?o.message:"Unknown error occurred")}finally{k(!1)}}},[l]);i.useEffect(()=>{if(!l||(A(0),S(),(a==null?void 0:a.status)==="completed"||(a==null?void 0:a.status)==="failed"))return;const o=window.setInterval(()=>{if(f>=p){clearInterval(o);return}A(N=>N+1),S(),((a==null?void 0:a.status)==="completed"||(a==null?void 0:a.status)==="failed")&&clearInterval(o)},P);return()=>{clearInterval(o)}},[l,a==null?void 0:a.status,S,P,p,f]);const M=i.useCallback(()=>{S()},[S]),W=(a==null?void 0:a.status)==="completed",B=(a==null?void 0:a.status)==="failed"||(a==null?void 0:a.status)==="cancelled",R=(a==null?void 0:a.status)==="pending"||(a==null?void 0:a.status)==="running";return{task:a,loading:u,error:C,refresh:M,isCompleted:W,isFailed:B,isPending:R}},Y=l=>{var a,n;if(l.domain)return l.domain;const p=(n=(a=l.actions)==null?void 0:a[0])==null?void 0:n.url;if(p)try{return new URL(p).hostname.replace(/^www\./,"")}catch{}return""},St=`
  .text-shadow-sm {
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
  }
`;if(typeof document<"u"&&!document.getElementById("text-shadow-style")){const l=document.createElement("style");l.id="text-shadow-style",l.textContent=St,document.head.appendChild(l)}const Ct=()=>{const{workspaceScribes:l,galleryScribes:p}=U(st),{taskId:a}=U(Ke),{userData:n}=U(at),u=U(ce),[k,C]=i.useState(!1),[w,f]=i.useState(null),[A,j]=i.useState(!1),[h,P]=i.useState(!0),[S,M]=i.useState(!1),[W,B]=i.useState(0),[R,o]=i.useState(null),[N,F]=i.useState(!1),[q,J]=i.useState(!1),[V,K]=i.useState(!1),[Q,X]=i.useState(!1),{scribes:pe,loading:ge,error:Z,refresh:he}=Qe(),d=pe,{task:xe,isPending:fe,isCompleted:be,isFailed:ye}=kt(a),we=fe||!be&&!ye&&a&&xe==null,ee=ge||we;i.useEffect(()=>{chrome.storage.local.set({suggestedScribes:(d==null?void 0:d.length)||0})},[d]),Xe(),ut(),pt(),gt();const je=async()=>{await G(H.Home)},ve=e=>{D("dw_feedback_submitted",{location:"recommended_scribes",number_available_auto_capture_scribes:(d==null?void 0:d.length)||0,feedback_length:e.length})},ke=async e=>{try{D("available_auto_capture_scribes_clicked",{location:"extension",number_available_auto_capture_scribes:d.length}),D("auto_captured_scribe_clicked",{location:"extension",document_id:e});const{totalSuggestedScribes:s}=await chrome.storage.local.get(["totalSuggestedScribes"]);s||await chrome.storage.local.set({totalSuggestedScribes:(d==null?void 0:d.length)||0}),await chrome.storage.local.set({previewScribeId:e}),await G(H.RecommendedScribesSuggestedPreview)}catch{}},Se=async e=>{var s,r,c;try{D("suggested_scribe_dismissed",{location:"recommended_scribes_list",document_id:e,number_available_auto_capture_scribes:(d==null?void 0:d.length)||0});const m=((await chrome.storage.local.get(["dwScribeDeletionCount"])).dwScribeDeletionCount||0)+1;await chrome.storage.local.set({dwScribeDeletionCount:m});const b=(r=(s=n==null?void 0:n.active_organization)==null?void 0:s.super_organization)==null?void 0:r.id,g=(c=n==null?void 0:n.active_organization)==null?void 0:c.id,v=b&&g?`${b}|${g}`:null;if(v){await xt(v,e);try{chrome.runtime.sendMessage({messageType:"dwHiddenUpdated"})}catch{}await he()}(m===1||m%7===0)&&await G(H.RecommendedScribesRejectionFeedback)}catch{}},z=(u==null?void 0:u.cap1303ShouldDisplayAutocaptureImportForDev)??!1,te=!!((u==null?void 0:u.lrr2025)??(u==null?void 0:u.lrr_2025)),se=!!((u==null?void 0:u.lrrManualRefreshEnabled)??(u==null?void 0:u.lrr_manual_refresh_enabled)),[ae,_]=i.useState("idle"),[ne,I]=i.useState(null),[O,$]=i.useState(!1),[re,x]=i.useState(null),[_t,T]=i.useState("idle"),[It,E]=i.useState(null);i.useEffect(()=>{const e=s=>{if((s==null?void 0:s.messageType)==="dwManualRunStarted"&&(_("running"),I("Triggering analysis\u2026")),(s==null?void 0:s.messageType)==="dwManualRunCompleted"&&(s!=null&&s.ok?(_("success"),I("Run triggered.")):(s==null?void 0:s.error)==="timeout"?(_("timeout"),I("Timed out waiting for results.")):(_("error"),I("Failed to trigger analysis."))),(s==null?void 0:s.messageType)==="dwCleanupCompleted")if(s!=null&&s.ok){T("success");const r=typeof(s==null?void 0:s.totalDeleted)=="number"?s.totalDeleted:typeof(s==null?void 0:s.deletedCount)=="number"?s.deletedCount:void 0;E(r!=null?`Cleared ${r} objects from DW storage.`:"Cleanup succeeded.")}else(s==null?void 0:s.status)===403||(s==null?void 0:s.status)===404?(T("error"),E("Available only in local development environment")):(T("error"),E("Cleanup failed."));(s==null?void 0:s.messageType)==="dwAutopollStarted"&&($(!0),x("Autopolling\u2026")),(s==null?void 0:s.messageType)==="dwAutopollStopped"&&($(!1),x(null)),(s==null?void 0:s.messageType)==="dwAutopollFoundNewResults"&&($(!1),x("New results detected."))};try{chrome.runtime.onMessage.addListener(e)}catch{}return()=>{try{chrome.runtime.onMessage.removeListener(e)}catch{}}},[]);const Ce=async()=>{_("running"),I("Triggering analysis\u2026");try{await new Promise(e=>{chrome.runtime.sendMessage({messageType:"dwManualRun"},()=>e())})}catch{_("error"),I("Failed to trigger analysis.")}},Ne=async()=>{try{x("Checking\u2026");const e=await new Promise(s=>{chrome.runtime.sendMessage({messageType:"dwPollOnce"},r=>s(r))});e!=null&&e.success&&(e!=null&&e.stored)?x("New results detected."):e!=null&&e.success?x("No change."):x("Poll failed.")}catch{x("Poll failed.")}},_e=async e=>{var s,r;try{e?(x("Autopolling\u2026"),(s=await new Promise(c=>{chrome.runtime.sendMessage({messageType:"dwAutopollStart"},m=>c(m))}))!=null&&s.success&&$(!0)):(r=await new Promise(c=>{chrome.runtime.sendMessage({messageType:"dwAutopollStop"},m=>c(m))}))!=null&&r.success&&($(!1),x(null))}catch{}},Ie=async()=>{T("running"),E("Clearing local DW data\u2026");try{await new Promise(e=>{chrome.runtime.sendMessage({messageType:"dwClearLocal"},()=>e())}),T("success"),E("Cleared local DW databases.")}catch{T("error"),E("Local clear failed.")}},[oe,Te]=i.useState(!1),[ie,Ee]=i.useState(!0),Ae=()=>{const e=document.createElement("input");e.type="file",e.accept="application/json",e.onchange=async()=>{var r,c,m,b;const s=(r=e.files)==null?void 0:r[0];if(s)try{C(!0),f("Importing\u2026");const g=((m=(c=n==null?void 0:n.active_organization)==null?void 0:c.super_organization)==null?void 0:m.id)||"unknown",v=((b=n==null?void 0:n.active_organization)==null?void 0:b.id)||"unknown",{actionsImported:Le,scribesImported:Ue}=await ft(s,{superOrgId:g,orgId:v},{generateDummyScreenshots:oe,importUnderCurrentUser:ie,currentUserId:(n==null?void 0:n.user_id)||(n==null?void 0:n.id)||"unknown"});f(`Imported ${Ue} scribes and ${Le} actions`)}catch(g){const v=g instanceof Error?g.message:"Unknown error";f(`Import failed: ${v}`)}finally{C(!1)}},e.click()},ze=async()=>{var e,s,r;try{j(!0),f("Exporting\u2026");const c=((s=(e=n==null?void 0:n.active_organization)==null?void 0:e.super_organization)==null?void 0:s.id)||"unknown",m=((r=n==null?void 0:n.active_organization)==null?void 0:r.id)||"unknown",{fileName:b,screenshotCount:g}=await bt({superOrgId:c,orgId:m},{slim:h});f(`Exported ${g} screenshots in ${b}`)}catch(c){const m=c instanceof Error?c.message:"Unknown error";f(`Export failed: ${m}`)}finally{j(!1)}},L=async()=>{try{const e=await new Promise(s=>{chrome.runtime.sendMessage({messageType:"dwActionLogGetCount"},r=>s(r))});e!=null&&e.success&&typeof e.count=="number"&&B(e.count)}catch{}},$e=async()=>{try{const e=await new Promise(s=>{chrome.runtime.sendMessage({messageType:"dwActionLogGetEnabled"},r=>s(r))});e!=null&&e.success&&M(!!e.enabled)}catch{}};i.useEffect(()=>{z&&($e(),L())},[z]);const De=async e=>{try{M(e),await new Promise(s=>{chrome.runtime.sendMessage({messageType:"dwActionLogSetEnabled",enabled:e},r=>s(r))}),o(e?"Action logging enabled.":"Action logging disabled.")}catch{}},Pe=async()=>{try{K(!0),o("Replaying\u2026");const e=await new Promise(s=>{chrome.runtime.sendMessage({messageType:"dwActionLogReplay"},r=>s(r))});e!=null&&e.success?o(`Replayed ${e.enqueued||0} actions.`):o("Replay failed."),L()}catch{o("Replay failed.")}finally{K(!1)}},Me=()=>{const e=document.createElement("input");e.type="file",e.accept="application/json",e.onchange=async()=>{var r;const s=(r=e.files)==null?void 0:r[0];if(s)try{F(!0),o("Importing\u2026");const{actionsImported:c,screenshotsImported:m}=await yt(s);o(`Imported ${c} actions and ${m} screenshots`),L()}catch(c){const m=c instanceof Error?c.message:"Unknown error";o(`Import failed: ${m}`)}finally{F(!1)}},e.click()},Re=async()=>{var e,s,r;try{J(!0),o("Exporting\u2026");const c=((s=(e=n==null?void 0:n.active_organization)==null?void 0:e.super_organization)==null?void 0:s.id)||"unknown",m=((r=n==null?void 0:n.active_organization)==null?void 0:r.id)||"unknown",{fileName:b,actionCount:g,screenshotCount:v}=await wt({orgScope:`${c}|${m}`});o(`Exported ${g} actions, ${v} screenshots in ${b}`)}catch(c){const m=c instanceof Error?c.message:"Unknown error";o(`Export failed: ${m}`)}finally{J(!1)}},Fe=async()=>{try{X(!0),o("Clearing\u2026");const e=await new Promise(s=>{chrome.runtime.sendMessage({messageType:"dwActionLogClear"},r=>s(r))});e!=null&&e.success?o(`Cleared ${e.deleted||0} logged actions.`):o("Clear failed."),L()}catch{o("Clear failed.")}finally{X(!1)}};return t.jsxs("div",{className:"flex flex-col h-screen bg-slate-50",children:[t.jsxs("div",{className:"flex-none p-4",children:[t.jsx(ht,{user:n,onVisitWorkspaceDocuments:()=>{},onGoToOptionsPage:()=>{},onBack:je,showTeamSelector:!1,showHomeIcon:!1,showSettingsIcon:!1,centerContent:t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("h4",{className:"text-[16px] font-semibold m-0",children:"Discovered Workflows"}),(d==null?void 0:d.length)>0&&t.jsx(ot,{children:d.length})]})}),(te&&se||z)&&t.jsxs("div",{className:"mx-2 p-2 border-b border-slate-200 rounded-md",children:[te&&se&&t.jsxs("div",{className:"mb-2 p-2 rounded-md bg-slate-100 border border-slate-200",children:[t.jsx("div",{className:"mb-1 text-xs text-slate-500",children:"Server (remote)"}),t.jsxs("div",{className:"flex items-center gap-2",children:[nt,t.jsx(y,{size:"small",variant:"primary",disabled:ae==="running",onClick:Ce,children:ae==="running"?"Refreshing\u2026":"New job"}),t.jsx(y,{size:"small",variant:"secondary",disabled:O,onClick:Ne,children:O?"Polling\u2026":"Poll"}),t.jsxs("label",{className:"flex items-center gap-2 text-xs text-slate-600",children:[t.jsx("input",{type:"checkbox",checked:O,onChange:e=>_e(e.target.checked)}),"Autopoll"]}),ne&&t.jsx("span",{className:"text-xs text-slate-500",children:ne}),re&&t.jsx("span",{className:"text-xs text-slate-500",children:re})]})]}),z&&t.jsxs("div",{className:"mt-2 p-2 rounded-md bg-slate-50 border border-slate-200",children:[t.jsx("div",{className:"mb-1 text-xs text-slate-500",children:"Local (device)"}),t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsxs("label",{className:"flex items-center gap-2 text-xs text-slate-600",children:[t.jsx("input",{type:"checkbox",checked:oe,onChange:e=>Te(e.target.checked)}),"Backfill missing screenshots"]}),t.jsx(y,{size:"small",variant:"secondary",disabled:k,onClick:Ae,children:k?"Importing\u2026":"\u{1F4C2}"}),t.jsx(y,{size:"small",variant:"secondary",disabled:A,onClick:ze,children:A?"Exporting\u2026":"\u{1F4BE}"}),t.jsxs("label",{className:"flex items-center gap-2 text-xs text-slate-600",children:[t.jsx("input",{type:"checkbox",checked:h,onChange:e=>P(e.target.checked)}),"Slim"]}),w&&t.jsx("span",{className:"text-xs text-slate-500",children:w})]}),t.jsx("div",{className:"mt-2",children:t.jsxs("label",{className:"flex items-center gap-2 text-xs text-slate-600",htmlFor:"dw-dev-import-under-current",children:[t.jsx("input",{id:"dw-dev-import-under-current",type:"checkbox",checked:ie,onChange:e=>Ee(e.target.checked)}),"Import under current user"]})}),t.jsx("div",{className:"mt-2",children:t.jsx(y,{size:"small",variant:"danger",className:"w-full",onClick:Ie,children:"Clear local DW databases"})})]}),z&&t.jsxs("div",{className:"mt-2 p-2 rounded-md bg-slate-50 border border-slate-200",children:[t.jsx("div",{className:"mb-1 text-xs text-slate-500",children:"Action logging"}),t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsxs("label",{className:"flex items-center gap-2 text-xs text-slate-600",children:[t.jsx("input",{type:"checkbox",checked:S,onChange:e=>De(e.target.checked)}),"Action logging"]}),t.jsxs("span",{className:"text-xs text-slate-500",children:["Logged: ",W]}),t.jsx(y,{size:"small",variant:"primary",disabled:V,onClick:Pe,children:V?"Replaying\u2026":"Replay"}),t.jsx(y,{size:"small",variant:"secondary",disabled:N,onClick:Me,children:N?"Importing\u2026":"\u{1F4C2}"}),t.jsx(y,{size:"small",variant:"secondary",disabled:q,onClick:Re,children:q?"Exporting\u2026":"\u{1F4BE}"}),R&&t.jsx("span",{className:"text-xs text-slate-500",children:R})]}),t.jsx("div",{className:"mt-2",children:t.jsx(y,{size:"small",variant:"danger",className:"w-full",disabled:Q,onClick:Fe,children:Q?"Clearing\u2026":"Clear action logging database"})})]})]})]}),t.jsx("div",{className:"flex-1 overflow-y-auto p-4",children:t.jsxs("div",{className:"space-y-6",children:[d&&d.length>0&&t.jsxs("div",{children:[t.jsx("div",{className:"space-y-3",children:d.map(e=>{var s;return t.jsx(Ze,{location:"sidepanel",type:"auto_captured_scribe",className:"px-5 py-4",leftIcon:t.jsx(et,{appIconName:it[Y(e)]||Y(e),iconUrl:ct(Y(e),64,!0)}),title:e.title,capturedText:"",stepsText:`${(((s=e.actions)==null?void 0:s.length)||0).toString()} steps`,onCta:()=>ke(e.suggestion_id||e.id),onDelete:()=>Se((e==null?void 0:e.suggestion_id)||(e==null?void 0:e.id))},e.suggestion_id||e.id)})}),t.jsx("div",{className:"mt-6",children:t.jsx(vt,{onFeedbackSubmit:ve})})]}),l&&l.length>0&&t.jsxs("div",{children:[t.jsx("h2",{className:"text-md font-semibold mb-3",children:"Workspace Scribes"}),t.jsx("div",{className:"space-y-2",children:l.map(e=>t.jsxs("div",{className:"bg-white rounded-md p-3 border border-slate-200",children:[t.jsx("div",{className:"font-medium",children:e.name}),t.jsx("div",{className:"text-sm text-slate-500",children:e.description})]},e.id))})]}),p&&p.length>0&&t.jsxs("div",{children:[t.jsx("h2",{className:"text-md font-semibold mb-3",children:"Gallery Scribes"}),t.jsx("div",{className:"space-y-2",children:p.map(e=>t.jsxs("div",{className:"bg-white rounded-md p-3 border border-slate-200",children:[t.jsx("div",{className:"font-medium",children:e.name}),t.jsx("div",{className:"text-sm text-slate-500",children:e.description})]},e.id))})]}),ee&&t.jsx("div",{className:"mt-4 text-sm text-slate-500 text-center",children:"Loading suggested Scribes..."}),Z&&t.jsx("div",{className:"mt-4 text-sm text-red-500 text-center",children:Z}),(!d||d.length===0)&&(!l||l.length===0)&&(!p||p.length===0)&&!ee&&t.jsx("div",{className:"flex flex-col items-center justify-center py-8",children:t.jsx("p",{className:"text-slate-500",children:"No discovered workflows available"})})]})})]})},Nt=()=>t.jsxs(We.StrictMode,{children:[t.jsx("style",{type:"text/css",children:rt}),t.jsxs(Oe,{store:le,children:[t.jsx(Ct,{}),t.jsx(tt,{})]})]}),ue=document.getElementById("root");ue&&Be(ue).render(t.jsx(Nt,{}));
