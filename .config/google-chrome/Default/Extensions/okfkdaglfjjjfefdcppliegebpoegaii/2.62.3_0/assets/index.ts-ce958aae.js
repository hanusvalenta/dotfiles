import{f as O,g as M}from"./index.esm-e3d6f8ec.js";import{b5 as U,b6 as G,b0 as v,b7 as j,b1 as V,b3 as z}from"./store-09c6166c.js";import{g as Y}from"./domUtils-fa446205.js";import{g as P}from"./getTargetElementAttributes-3f1109f1.js";import{b as J}from"./options-7a3fe88d.js";import{g as Q}from"./scribeSuggestions-59cbe47c.js";import{m as Z}from"./index-7bc06dca.js";import{v as L}from"./v4-c70744d4.js";import"./_commonjsHelpers-de833af9.js";import"./index-8b3efc3f.js";import"./appTagUtils-c74c75cd.js";var ee=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};ee.SENTRY_RELEASE={id:"8effd506599f6fafb1a48c2ce96f05fa857d4332"};const te=e=>{if(!e)return"";const c=[];let m=0;for(;c.length<2&&m<=e.length;){let i=e.indexOf(`
`,m);i===-1&&(i=e.length);let a=e.slice(m,i);a.endsWith("\r")&&(a=a.slice(0,-1)),a.trim().length!==0&&c.push(a),m=i+1}const d=m<e.length;return c.join(`
`)+(d?"\u2026":"")},p=window!==window.top,A=1e3,X="data-long-running-recorder-frame-path-id";let _=!1,y=!1;const k=500,ne=5,oe=3e3;let t=null;const T=()=>{(t==null?void 0:t.timeoutId)!=null&&clearTimeout(t.timeoutId),t!=null&&t.selectElement&&(t!=null&&t.selectChangeListener)&&t.selectElement.removeEventListener("change",t.selectChangeListener,{capture:!0}),t=null};let x=0;const ae=1e3,re=e=>{if(!e)return!1;if(e instanceof HTMLInputElement&&e.type==="password")return!0;const c=["cc-number","cc-exp","cc-csc"];return!!(e instanceof HTMLInputElement&&c.includes(e.autocomplete))},F=async()=>{if(!p)return{left:0,top:0};const e=L(),c=e;return new Promise((m,d)=>{var o;let i=!1;const a=setTimeout(()=>{var n;if(!i){window.removeEventListener("message",l),console.warn("Falling back to simple offset calculation due to timeout");const r=((n=window.frameElement)==null?void 0:n.getBoundingClientRect())||{left:0,top:0};m({left:r.left,top:r.top})}},A),l=n=>{var r;((r=n.data)==null?void 0:r.iframeOffsetResponseId)===e&&(i=!0,window.removeEventListener("message",l),clearTimeout(a),m({left:n.data.left,top:n.data.top}))};window.addEventListener("message",l);try{if(window.parent){const n={tempFramePathId:c,iframeOffsetRequestId:e,left:0,top:0};window.parent.postMessage(n,"*")}else throw new Error("Cannot access parent frame")}catch{clearTimeout(a),window.removeEventListener("message",l),console.warn("Failed to send message to parent frame, falling back to simple offset");const n=((o=window.frameElement)==null?void 0:o.getBoundingClientRect())||{left:0,top:0};m({left:n.left,top:n.top})}})};window.addEventListener("message",async e=>{var c,m;if(!(!e.source||!e.data)){if((c=e.data)!=null&&c.iframeOffsetRequestId){const d=e.source,i=[...document.querySelectorAll("iframe")].find(u=>u.contentWindow===d);if(!i){console.warn("Could not find source iframe for offset calculation");return}const a=`${X}-${e.data.tempFramePathId}`;i.setAttribute(a,e.data.tempFramePathId),setTimeout(()=>{i==null||i.removeAttribute(a)},A);const l=i.getBoundingClientRect(),o=l.left,n=l.top,r=e.data.left+o,s=e.data.top+n;if(p)try{window.parent.postMessage({tempFramePathId:e.data.tempFramePathId,iframeOffsetRequestId:e.data.iframeOffsetRequestId,left:r,top:s},"*")}catch{console.warn("Failed to propagate offset message upward")}else{const u={tempFramePathId:e.data.tempFramePathId,iframeOffsetResponseId:e.data.iframeOffsetRequestId,left:r,top:s};i.contentWindow&&i.contentWindow.postMessage(u,"*")}}if((m=e.data)!=null&&m.iframeOffsetResponseId){const d=`${X}-${e.data.tempFramePathId}`,i=[...document.querySelectorAll("iframe")].find(a=>a.getAttribute(d)===e.data.tempFramePathId);if(i!=null&&i.contentWindow){i.removeAttribute(d);try{i.contentWindow.postMessage({iframeOffsetResponseId:e.data.iframeOffsetResponseId,left:e.data.left,top:e.data.top},"*")}catch{console.warn("Failed to propagate offset message downward")}}}}});const D=()=>{if(location.ancestorOrigins&&location.ancestorOrigins.length>0)return location.ancestorOrigins[location.ancestorOrigins.length-1];if(!p)return location.origin},W=async e=>{var C,R;if(re(document.activeElement)||!e.key||U(e.key))return;const c=Date.now(),{key:m,code:d,shiftKey:i,altKey:a,ctrlKey:l,metaKey:o}=e,n=G(m,d),r=window.devicePixelRatio||1;let s=null;try{e.target&&(s=O(e.target))}catch{}const u=P(e.target),f=M(e.target,{ignoreId:!0});let g=null;const h=document.activeElement;if(h){let b={left:0,top:0};try{b=await F()}catch($){if(console.warn("Failed to get accumulated frame offset for keyboard event:",$),p&&window.frameElement){const S=window.frameElement.getBoundingClientRect();b={left:S.left,top:S.top}}}const I=h.getBoundingClientRect(),H=6;g={x:(I.left+Math.min(H,Math.max(0,I.width/10))+b.left)*r,y:(I.top+I.height/2+b.top)*r}}const E={id:L(),type:"long_running_recorder_action",kind:v.KEYBOARD_ACTIONS.PRESS,direction:v.KEY_DIRECTIONS.DOWN,modifiers:{shiftKey:i,altKey:a,ctrlKey:l,metaKey:o},target_selector:s,target_xpath:f,target_tag:(C=e.target)==null?void 0:C.tagName,target_element:Y((((R=e.target)==null?void 0:R.outerHTML)||"").replace(/\s(?:src|style)="[^"]*"/gi,"")),target_element_attributes:u,key:j(n,!0),timestamp:c,url:window.location.href,top_frame_origin:D(),devicePixelRatio:r,position:g,viewport:{width:window.innerWidth,height:window.innerHeight},wasInIframe:p,scrollPosition:{x:window.scrollX,y:window.scrollY}};chrome.runtime.sendMessage({messageType:"long_running_recorder_action",action:E})},ie=e=>!e||typeof e!="string"?e:e.startsWith("Click ")?e.replace(/^Click\s/,"Double-click "):e==="Click here."?"Double-click here.":e,w=async(e,c,m)=>{const{timestamp:d}=e,i=window.devicePixelRatio||1;let a={left:0,top:0};try{a=await F()}catch{if(p&&window.frameElement){const g=window.frameElement.getBoundingClientRect();a={left:g.left,top:g.top}}}let l=null;try{e.target&&(l=O(e.target))}catch{}const o=e.target,n=P(o||{}),r=M(o,{ignoreId:!0}),s=V(o),u=m??(c===2?ie(s):s),f={id:L(),type:"long_running_recorder_action",kind:v.MOUSE_ACTIONS.CLICK,click_count:c,button:v.BUTTON_FROM_NUMBER[e.button]??"left",...e.earlyScreenshotTimestamp?{earlyScreenshotTimestamp:e.earlyScreenshotTimestamp}:{},position:{x:(e.clientX+a.left)*i,y:(e.clientY+a.top)*i},viewport:{width:window.innerWidth,height:window.innerHeight},wasInIframe:p,scrollPosition:{x:window.scrollX,y:window.scrollY},description:u,devicePixelRatio:i,target_selector:l,target_xpath:r,target_tag:o==null?void 0:o.tagName,target_element:o?Y((o.outerHTML||"").replace(/\s(?:src|style)="[^"]*"/gi,"")):void 0,target_text:o?te(o.innerText||o.textContent||"").substring(0,2048):"",target_element_attributes:n,timestamp:d,url:window.location.href,top_frame_origin:D()};chrome.runtime.sendMessage({messageType:"long_running_recorder_action",action:f})},K=async e=>{const c=Date.now(),m=e.button===0;let d=null;if(c-x>ae)try{const a=new Promise(n=>{Z.send("earlyScreenshot").then(r=>n(r??null))}),l=64,o=Date.now()+l;for(;Date.now()<o;);d=await a,d&&(x=c)}catch{}if(!m){w({timestamp:c,clientX:e.clientX,clientY:e.clientY,button:e.button,target:e.target||null,earlyScreenshotTimestamp:d},1);return}if(t){const a=c-t.timestamp,l=e.clientX-t.clientX,o=e.clientY-t.clientY,n=Math.sqrt(l*l+o*o);if(a<=k&&n<=ne){t.timeoutId!=null&&clearTimeout(t.timeoutId);const s=e.target||t.target,u=d??t.earlyScreenshotTimestamp??null;w({timestamp:c,clientX:e.clientX,clientY:e.clientY,button:e.button,target:s,earlyScreenshotTimestamp:u},2),T();return}const r={...t};r.timeoutId!=null&&clearTimeout(r.timeoutId),w({timestamp:r.timestamp,clientX:r.clientX,clientY:r.clientY,button:r.button,target:r.target,earlyScreenshotTimestamp:r.earlyScreenshotTimestamp},1),T()}t={timestamp:c,clientX:e.clientX,clientY:e.clientY,button:e.button,target:e.target||null,timeoutId:null,earlyScreenshotTimestamp:d,selectElement:null,selectChangeListener:null};const i=e.target||null;if(i&&i.tagName==="SELECT"){const a=i,l=o=>{var h,E;if(_||!y){a.removeEventListener("change",l,{capture:!0}),(t==null?void 0:t.timeoutId)!=null&&clearTimeout(t.timeoutId),t=null;return}a.removeEventListener("change",l,{capture:!0});const n=t?{...t}:null;(t==null?void 0:t.timeoutId)!=null&&clearTimeout(t.timeoutId),t=null;const r=o.target,s=((E=(h=r==null?void 0:r.options)==null?void 0:h[r.selectedIndex])==null?void 0:E.text)||"",u=(r==null?void 0:r.value)||"",f=(s||u).trim(),g=f?`Select the "${f}" option.`:"Select option";z(()=>{w({timestamp:Date.now(),clientX:(n==null?void 0:n.clientX)??e.clientX,clientY:(n==null?void 0:n.clientY)??e.clientY,button:(n==null?void 0:n.button)??e.button,target:a,earlyScreenshotTimestamp:null},1,g)})};a.addEventListener("change",l,{once:!0,capture:!0}),t&&(t.selectElement=a,t.selectChangeListener=l),t.timeoutId=window.setTimeout(()=>{if(a.removeEventListener("change",l,{capture:!0}),!t)return;const o={...t};t=null,w({timestamp:o.timestamp,clientX:o.clientX,clientY:o.clientY,button:o.button,target:o.target,earlyScreenshotTimestamp:o.earlyScreenshotTimestamp},1)},oe)}else t.timeoutId=window.setTimeout(()=>{if(!t)return;t.selectElement&&t.selectChangeListener&&t.selectElement.removeEventListener("change",t.selectChangeListener,{capture:!0});const a={...t};t=null,w({timestamp:a.timestamp,clientX:a.clientX,clientY:a.clientY,button:a.button,target:a.target,earlyScreenshotTimestamp:a.earlyScreenshotTimestamp},1)},k)},B=()=>{chrome.runtime.onMessage.addListener(e=>{e.messageType==="startRecording"||e.messageType==="browserStartRecording"||e.messageType==="openGuideMeSidepanel"||e.messageType==="guideMeStepForward"||e.messageType==="getGuideMeSessionId"||e.messageType==="startCopilot"||e.messageType==="startCopilotSearch"||e.messageType==="recaptureStep"||e.messageType==="currentVisibleAction"?(_=!0,T(),se()):(e.messageType==="endRecording"||e.messageType==="optionsChanged"||e.messageType==="browserDeleteRecording"||e.messageType==="browserCompleteCapture")&&(_=!1,T(),N())}),N()},N=()=>{y||_||(document.addEventListener("pointerdown",K,{capture:!0}),document.addEventListener("keydown",W,{capture:!0}),y=!0)},se=()=>{y&&(T(),document.removeEventListener("pointerdown",K,{capture:!0}),document.removeEventListener("keydown",W,{capture:!0}),y=!1)},le=async()=>{const e=await Q(),c=await J("recordingControlsPreference")==="floating-button";if(!e||c)return!1;try{const[m,d]=await Promise.all([new Promise(o=>{chrome.runtime.sendMessage({messageType:"getAllowedDomains"},n=>{o(Array.isArray(n==null?void 0:n.allowedDomains)?n.allowedDomains:[])})}),new Promise(o=>{chrome.runtime.sendMessage({messageType:"getAllowedAppTags"},n=>{const r=(Array.isArray(n==null?void 0:n.allowedAppTags)?n==null?void 0:n.allowedAppTags:[]).flatMap(s=>{const u=(s==null?void 0:s.domain)||"",f=(s==null?void 0:s.multi_root_domains_urls)||[],g=(s==null?void 0:s.root_domain_url)||"";return Array.from(new Set([u,...f,g])).filter(Boolean)});o(r)})})]),i=[...m,...d];if(!i||i.length===0)return!1;const a=window.location.hostname.toLowerCase();let l=null;if(window===window.top)l=a;else if(location.ancestorOrigins&&location.ancestorOrigins.length>0)try{const o=location.ancestorOrigins[location.ancestorOrigins.length-1];l=new URL(o).hostname.toLowerCase()}catch{}return!!(o=>{if(!o)return!1;const n=o.toLowerCase();return i.some(r=>{if(!r)return!1;const s=r.toLowerCase();return n===s||n.startsWith("www.")&&n.slice(4)===s||s.startsWith("www.")&&n===s.slice(4)?!0:n.endsWith(`.${s}`)})})(l)}catch(m){return console.warn("[Long Running Recorder] Failed to read allowed domains",m),!1}},q=()=>{le().then(e=>{e&&(document.readyState==="loading"?document.addEventListener("DOMContentLoaded",B):B())}).catch(e=>{console.warn("[Long Running Recorder] Error while checking enablement",e)})};chrome.runtime.onMessage.addListener(e=>{e.messageType==="optionsChanged"&&q()}),q();
