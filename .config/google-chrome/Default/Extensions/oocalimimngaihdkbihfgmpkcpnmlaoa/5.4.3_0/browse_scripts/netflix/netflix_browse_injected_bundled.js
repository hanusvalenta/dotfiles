/*******************************************************
* Copyright (C) 2018-2024 WP Interactive Media, Inc. - All Rights Reserved
* Unauthorized copying of this file, via any medium is strictly prohibited
* Proprietary and confidential
*******************************************************/
(()=>{"use strict";function t(){try{const t=sessionStorage.getItem("telepartyPremiumConfig");if(t){return JSON.parse(t)}}catch(t){}return null}var e,n=function(t,e,n,i){return new(n||(n=Promise))((function(o,r){function c(t){try{s(i.next(t))}catch(t){r(t)}}function a(t){try{s(i.throw(t))}catch(t){r(t)}}function s(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(c,a)}s((i=i.apply(t,e||[])).next())}))};function i(){return n(this,void 0,void 0,(function*(){var t=[];try{const o=yield fetch("https://www.netflix.com/manageaccountaccess"),r=yield o.text();for(var e=(new DOMParser).parseFromString(r,"text/html").querySelectorAll(".device-list-item"),n=0;n<e.length;n++){var i={};i.deviceDescription=e[n].querySelector("h2").innerText,i.lastWatched=e[n].querySelector(".last-watched").innerText,i.profileName=e[n].querySelector(".profile-name").innerText,t.push(i)}}catch(t){return}return t}))}function o(t=0){return n(this,void 0,void 0,(function*(){try{let e=[];const i=yield fetch("https://www.netflix.com/YourAccount"),o=yield i.text(),r=(new DOMParser).parseFromString(o,"text/html");let c=[];return r.querySelectorAll(".profile-link[href*='viewed'").forEach((t=>{c.push(t.href.split("viewed/")[1])})),yield Promise.all(c.map((i=>n(this,void 0,void 0,(function*(){const o=[];let r;const c=t?50:1e4,a=(e=0)=>n(this,void 0,void 0,(function*(){try{const n=yield fetch(`https://www.netflix.com/api/shakti/mre/viewingactivity?pg=${e}&pgsize=${c}&guid=${i}`),s=yield n.json();i=s.profileInfo.guid,r=s.profileInfo.profileName;let l=s.viewedItems.filter((e=>e.date>t));if(o.push(...l),s.viewedItems.length==c&&l.length===s.viewedItems.length)return yield a(e+1)}catch(t){}}));yield a(),e.push({guid:i,profileName:r,watchHistory:o})}))))),e}catch(t){return}}))}if(!window.tpBrowseInjected){window.tpBrowseInjected=!0,e=function(){if(null!=document.getElementById("native-party-button"))return;const t=document.querySelector("a.primary-button.playLink");if(null==t)return;const e=t.parentElement,n=document.createElement("button");n.setAttribute("style","background: linear-gradient(273.58deg, #9E55A0 0%, #EF3E3A 100%); color: #fff; border-style: none; border-radius: 0.375rem; padding: 1.1rem; display: flex; align-items: center; justify-content: center;"),n.setAttribute("id","native-party-button"),n.setAttribute("class","hasLabel");const i=document.querySelector("a.primary-button.playLink span"),o=document.createElement("span");return o.innerText="Start a Teleparty",o.setAttribute("style","line-height: 1.7rem; font-size: 1.4rem; text-wrap: nowrap"),o.setAttribute("class",i.getAttribute("class")),e.insertBefore(n,t.nextSibling),n.appendChild(o),[{button:n,play:()=>t.click()}]},setInterval((()=>{try{const n=e();if(n)for(const e of n){const n=e.button.t;n&&e.button.removeEventListener("click",n);const i=()=>{console.log("Native party button clicked");const n=t();if((null==n?void 0:n.serviceIsPremium)&&!(null==n?void 0:n.userHasPremium))return console.log("Redirecting non-premium user on premium service to premium page"),void window.open("https://teleparty.com/premium?ref=start-tp","_blank");localStorage.setItem("nativeParty",JSON.stringify({shouldStart:!0,expiry:Date.now()+12e4,randomId:Math.random().toString()})),e.play()};e.button.t=i,e.button.addEventListener("click",i)}}catch(t){}}),500),window.postMessage({type:"tpNetflixBrowseReady"},"*");{const t=t=>n(void 0,void 0,void 0,(function*(){const[e,n]=yield Promise.all([i(),o(t)]);window.postMessage({type:"tpSetNetflixData",data:{deviceList:e,watchHistoryList:n}},"*")}));window.addEventListener("message",(e=>{if("tpLoadNetflixData"===e.data.type){const n=e.data.lastFetch;t(n)}}))}}})();